function e(e,t){return t+e}function t(e,t){return t+e}const n={enabled:!1,strategy:{type:"constant",keys:[],keys_secondary:{logic:"and_any",keys:[]},scan_depth:"same_as_global"},probability:100,recursion:{prevent_incoming:!0,prevent_outgoing:!0,delay_until:null},effect:{sticky:null,cooldown:null,delay:null}},a=z.object({current_volume:z.coerce.number().prefault(1),last_processed_message_id:z.coerce.number().prefault(-1),volumes:z.array(z.object({volume:z.coerce.number(),start_message_id:z.coerce.number(),end_message_id:z.coerce.number()})).prefault([])}).prefault({}),o=z.object({visible_floors:z.coerce.number().transform(e=>_.clamp(e,1,100)).prefault(10),check_interval:z.coerce.number().transform(e=>_.clamp(e,5,100)).prefault(20),volume_token_threshold:z.coerce.number().transform(e=>_.clamp(e,1e3,5e4)).prefault(8e3),auto_mini_summary:z.boolean().prefault(!0),auto_volume_summary:z.boolean().prefault(!0),mini_summary_depth:z.coerce.number().transform(e=>_.clamp(e,0,99999)).prefault(9999),volume_summary_depth:z.coerce.number().transform(e=>_.clamp(e,0,99999)).prefault(9999),mini_summary_start_order:z.coerce.number().transform(e=>_.clamp(e,0,99999)).prefault(1e4),volume_start_order:z.coerce.number().transform(e=>_.clamp(e,0,99999)).prefault(100),ignore_floors:z.coerce.number().transform(e=>_.clamp(e,0,1e3)).prefault(2),custom_api:z.object({apiurl:z.string().prefault(""),key:z.string().prefault(""),model:z.string().prefault(""),source:z.string().prefault("openai")}).prefault({}),message_cleanup_regex:z.array(z.object({pattern:z.string(),flags:z.string().prefault("g"),replacement:z.string().prefault("")})).prefault([]),capture_start_tag:z.string().prefault(""),capture_end_tag:z.string().prefault(""),no_trans_tag:z.boolean().prefault(!1),no_trans_tag_value:z.string().prefault("<|no-trans|>"),custom_prompts:z.object({mini_summary_system:z.string().prefault(""),volume_summary_system:z.string().prefault(""),volume_completion_check_system:z.string().prefault("")}).prefault({})}).prefault({}),s=o.parse({});function r(){const e=getVariables({type:"script"});return o.parse(e)}function i(e){replaceVariables(e,{type:"script"})}function l(){return r()}const m=new class{queue=[];processing=!1;handlers=null;setHandlers(e){this.handlers=e}enqueue(e){"mini_summary"===e.type&&void 0!==e.message_id&&(this.queue=this.queue.filter(t=>!("mini_summary"===t.type&&t.message_id===e.message_id))),this.queue.push(e),this.processNext()}async processNext(){if(!this.processing&&0!==this.queue.length){this.processing=!0;try{const e=this.queue.shift();if(!this.handlers)return void console.error("[è‡ªåŠ¨æ€»ç»“] ä»»åŠ¡å¤„ç†å‡½æ•°æœªæ³¨å†Œ");"mini_summary"===e.type&&void 0!==e.message_id?await this.handlers.mini_summary(e.message_id):"volume_summary"===e.type&&await this.handlers.volume_summary()}catch(e){console.error("[è‡ªåŠ¨æ€»ç»“] æ€»ç»“ä»»åŠ¡æ‰§è¡Œå¤±è´¥:",e)}finally{this.processing=!1,this.queue.length>0&&await this.processNext()}}}},c="ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ•…äº‹æ€»ç»“åŠ©æ‰‹ã€‚ä½ çš„ä»»åŠ¡æ˜¯å°†è§’è‰²æ‰®æ¼”èŠå¤©è®°å½•ä¸­çš„ä¸€æ¡æ¶ˆæ¯æ€»ç»“ä¸ºç®€æ´çš„å°æ€»ç»“ã€‚\n\nè¦æ±‚ï¼š\n1. ä¿ç•™å…³é”®æƒ…èŠ‚ã€è§’è‰²è¡Œä¸ºã€æƒ…æ„Ÿå˜åŒ–å’Œé‡è¦å¯¹è¯\n2. ä½¿ç”¨ç¬¬ä¸‰äººç§°å™è¿°\n3. æ€»ç»“åº”ç®€æ´æ˜äº†ï¼Œæ§åˆ¶åœ¨ 200 å­—ä»¥å†…\n4. ä¸è¦æ·»åŠ ä»»ä½•è¯„è®ºã€åˆ†ææˆ–ä½ è‡ªå·±çš„æƒ³æ³•\n5. åªè¾“å‡ºæ€»ç»“å†…å®¹ï¼Œä¸è¦æ·»åŠ æ ‡é¢˜ã€ç¼–å·æˆ–å…¶ä»–æ ¼å¼",u="ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ•…äº‹æ€»ç»“åŠ©æ‰‹ã€‚ä½ çš„ä»»åŠ¡æ˜¯å°†ä¸€ç³»åˆ—å°æ€»ç»“åˆå¹¶ä¸ºä¸€ä¸ªå®Œæ•´çš„å·æ€»ç»“ã€‚\n\nè¦æ±‚ï¼š\n1. å°†æ‰€æœ‰å°æ€»ç»“çš„å†…å®¹æ•´åˆä¸ºè¿è´¯çš„å™è¿°\n2. ä¿ç•™ä¸»è¦æƒ…èŠ‚çº¿ã€è§’è‰²å‘å±•ã€å…³é”®äº‹ä»¶å’Œé‡è¦å¯¹è¯\n3. æŒ‰æ—¶é—´é¡ºåºç»„ç»‡å†…å®¹\n4. ä½¿ç”¨ç¬¬ä¸‰äººç§°å™è¿°\n5. æ€»ç»“åº”å…¨é¢ä½†ç²¾ç‚¼ï¼Œæ§åˆ¶åœ¨ 2000 å­—ä»¥å†…\n6. ä¸è¦æ·»åŠ ä»»ä½•è¯„è®ºã€åˆ†ææˆ–ä½ è‡ªå·±çš„æƒ³æ³•\n7. è‹¥å½“å‰æä¾›çš„å†…å®¹ä¸æ»¡è¶³å®Œæ•´ä¸€å·çš„æƒ…èŠ‚ï¼Œå¯é€‰å–ä¸ŠåŠå·/éƒ¨åˆ†è¿ç»­çš„å†…å®¹è¿›è¡Œæ€»ç»“\n8. åœ¨æ€»ç»“çš„æœ€æœ«å°¾ï¼Œä½ å¿…é¡»å•ç‹¬èµ·ä¸€è¡Œè¾“å‡ºä½ æ­¤æ¬¡æ€»ç»“çš„å†…å®¹èŒƒå›´ï¼Œæ ¼å¼ä¸ºï¼šæ‘˜è¦x-æ‘˜è¦yï¼ˆä¾‹å¦‚ï¼šæ‘˜è¦100-æ‘˜è¦150ï¼‰\n9. é™¤æ€»ç»“å†…å®¹å’Œå°¾éƒ¨çš„èŒƒå›´æ ‡è®°å¤–ï¼Œä¸è¦æ·»åŠ æ ‡é¢˜ã€ç¼–å·æˆ–å…¶ä»–å¤šä½™æ ¼å¼",p='ä½ æ˜¯ä¸€ä¸ªæ•…äº‹åˆ†æåŠ©æ‰‹ã€‚æ ¹æ®ä»¥ä¸‹æ€»ç»“å†…å®¹ï¼Œåˆ¤æ–­å½“å‰è¿™ä¸€å·æ•…äº‹æ˜¯å¦å·²ç»è¾¾åˆ°äº†ä¸€ä¸ªè‡ªç„¶çš„æ®µè½ç»“å°¾ï¼ˆå¦‚ï¼šä¸€ä¸ªç« èŠ‚ç»“æŸã€ä¸€ä¸ªäº‹ä»¶å‘Šä¸€æ®µè½ã€åœºæ™¯å¤§å¹…è½¬æ¢ç­‰ï¼‰ã€‚\n\nåªéœ€å›ç­”"114514"æˆ–"1919810"ï¼Œä¸è¦åšä»»ä½•è§£é‡Šã€‚\n- å›ç­”"114514"è¡¨ç¤ºè¿™ä¸€å·å·²ç»åˆ°äº†ä¸€ä¸ªåˆé€‚çš„æ–­ç‚¹ï¼Œå¯ä»¥å½’æ¡£\n- å›ç­”"1919810"è¡¨ç¤ºæ•…äº‹ä»åœ¨è¿›è¡Œä¸­ï¼Œä¸é€‚åˆåœ¨è¿™é‡Œæ–­å¼€';function d(){return getChatWorldbookName("current")}function h(){const e=d();return!!e&&getWorldbookNames().includes(e)}const y="[data]";async function g(){const e=d();if(!e||!h())return a.parse({});const t=(await getWorldbook(e)).find(e=>e.name===y);if(!t)return a.parse({});try{const e=JSON.parse(t.content);return a.parse(e)}catch(n){return console.error("[è‡ªåŠ¨æ€»ç»“] è§£æ [data] æ¡ç›®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼:",n),a.parse({})}}async function v(e){const t=d();if(!t||!h())return void console.warn("[è‡ªåŠ¨æ€»ç»“] ä¸–ç•Œä¹¦ä¸å­˜åœ¨ï¼Œè·³è¿‡ä¿å­˜å…ƒæ•°æ®");const n=JSON.stringify(e);await updateWorldbookWith(t,e=>{const t=e.find(e=>e.name===y);return t&&(t.content=n),e})}async function f(){const e=d();if(!e||!h())return[];const t=await getWorldbook(e),n=await g(),a=/* @__PURE__ */new Set;for(const o of n.volumes)for(let e=o.start_message_id;e<=o.end_message_id;e++)a.add(e);return t.filter(e=>{const t=e.name.match(/^\[å°æ€»ç»“-æ¥¼å±‚(\d+)\]$/);if(!t)return!1;const n=parseInt(t[1]);return!a.has(n)})}async function b(){const e=d();if(!e||!h())return;const t=l(),n=getLastMessageId()-t.visible_floors+1,a=await g(),o=/* @__PURE__ */new Set;for(const s of a.volumes)for(let e=s.start_message_id;e<=s.end_message_id;e++)o.add(e);await updateWorldbookWith(e,e=>{for(const t of e){const e=t.name.match(/^\[å°æ€»ç»“-æ¥¼å±‚(\d+)\]$/);if(!e)continue;const a=parseInt(e[1]);a>=n||o.has(a)?t.enabled=!1:t.enabled=!0}return e})}function x(e){if(e.custom_api.apiurl)return{apiurl:e.custom_api.apiurl,key:e.custom_api.key,model:e.custom_api.model,source:e.custom_api.source}}async function w(e,t,n){const a=!1!==n.no_trans_tag,o=n.no_trans_tag_value||"<|no-trans|>",s=e=>e&&e.trim()&&a?`${o}${e}`:e;return await generateRaw({should_silence:!0,custom_api:x(n),ordered_prompts:[{role:"system",content:s(e)},{role:"user",content:s(t)}]})}async function k(e){const t=l(),n=d();if(!n)throw new Error("[è‡ªåŠ¨æ€»ç»“] æœªç»‘å®šä¸–ç•Œä¹¦ï¼Œæ— æ³•ç”Ÿæˆå°æ€»ç»“");const a=(await getWorldbook(n)).filter(e=>e.name.match(/^\[å°æ€»ç»“-æ¥¼å±‚(\d+)\]$/)).map(e=>({id:parseInt(e.name.match(/æ¥¼å±‚(\d+)/)[1]),content:e.content})).filter(t=>t.id<e).sort((e,t)=>e.id-t.id).slice(-2).map(e=>e.content).join("\n"),o=getChatMessages(e);if(0===o.length)throw new Error(`[è‡ªåŠ¨æ€»ç»“] æ¥¼å±‚ ${e} ä¸å­˜åœ¨`);const s=o[0].message;if(!s||""===s.trim())return"ï¼ˆç©ºæ¶ˆæ¯ï¼‰";const r="user"===o[0].role?"user_input":"ai_output",i=function(e,t){let n=e;for(const o of t.message_cleanup_regex)try{const e=new RegExp(o.pattern,o.flags);n=n.replace(e,o.replacement)}catch(a){console.error(`[è‡ªåŠ¨æ€»ç»“] æ­£åˆ™æ¸…æ´—é”™è¯¯ (pattern: ${o.pattern}):`,a)}return n}(function(e,t,n){if(!t&&!n)return e;const a=t?`<${_.escapeRegExp(t)}>`:"^",o=n?`<${_.escapeRegExp(n)}>`:"$",s=new RegExp(`${a}([\\s\\S]*?)${o}`,"g"),r=[];let i;for(;null!==(i=s.exec(e));){const e=i[1].trim();e&&r.push(e)}if(0===r.length){const a=t&&n?`<${t}> å’Œ <${n}> ä¹‹é—´`:t?`<${t}> ä¹‹å`:`<${n}> ä¹‹å‰`;return console.warn(`[è‡ªåŠ¨æ€»ç»“] æœªåœ¨æ¶ˆæ¯ä¸­æ‰¾åˆ° ${a} çš„å†…å®¹ï¼Œå°†ä½¿ç”¨åŸå§‹æ¶ˆæ¯`),e}return r.join("\n\n")}(formatAsTavernRegexedString(s,r,"prompt"),t.capture_start_tag,t.capture_end_tag),t),m=function(e,t){let n="";return t&&(n+=`ä»¥ä¸‹æ˜¯ä¹‹å‰çš„æ€»ç»“ï¼Œä¾›ä½ äº†è§£ä¸Šä¸‹æ–‡ï¼š\n${t}\n\n---\n\n`),n+=`è¯·æ€»ç»“ä»¥ä¸‹æ¶ˆæ¯ï¼š\n\n${e}`,{system:l().custom_prompts.mini_summary_system||c,user:n}}(i,a);return await w(m.system,m.user,t)}async function I(){const e=l(),t=await f();if(0===t.length)return!1;if(t.map(e=>e.content).join("").length>e.volume_token_threshold)return!0;try{const n=function(e){let t="ä»¥ä¸‹æ˜¯æœ€è¿‘ä¸€æ®µæ—¶é—´çš„å°æ€»ç»“åºåˆ—ï¼š\n\n";return e.forEach(e=>{t+=`${e}\n\n`}),t+="è¯·åˆ¤æ–­ä»¥ä¸Šå†…å®¹æ˜¯å¦å·²ç»åˆ°äº†ä¸€ä¸ªè‡ªç„¶çš„æ®µè½ç»“å°¾ï¼Ÿ",{system:l().custom_prompts.volume_completion_check_system||p,user:t}}(t.map(e=>{const t=e.name.match(/æ¥¼å±‚(\d+)/);return`æ‘˜è¦${t?t[1]:"?"}\n${e.content}`})),a=await w(n.system,n.user,e);return!!a.includes("114514")||(a.includes("1919810")||console.warn("[è‡ªåŠ¨æ€»ç»“] å·å®Œç»“æ£€æµ‹è¿”å›äº†æ„å¤–å†…å®¹:",a),!1)}catch(n){return console.error("[è‡ªåŠ¨æ€»ç»“] å·å®Œç»“æ£€æµ‹å¤±è´¥:",n),!1}}async function W(e){const t=l(),n=await async function(){const e=d();return e&&h()?(await getWorldbook(e)).filter(e=>/^\[å·\d+-æ¥¼å±‚\d+~æ¥¼å±‚\d+\]$/.test(e.name)):[]}(),a=function(e,t){let n="";return t.length>0&&(n+="ä»¥ä¸‹æ˜¯ä¹‹å‰å„å·çš„å¤§æ€»ç»“ï¼Œä¾›ä½ äº†è§£å‰æƒ…ï¼š\n\n",t.forEach((e,t)=>{n+=`--- ç¬¬${t+1}å· ---\n${e}\n\n`}),n+="===\n\n"),n+="è¯·å°†ä»¥ä¸‹å°æ€»ç»“åˆå¹¶ä¸ºä¸€ä¸ªè¿è´¯çš„é˜¶æ®µæ€§å·æ€»ç»“ï¼š\n\n",e.forEach(e=>{n+=`${e}\n\n`}),{system:l().custom_prompts.volume_summary_system||u,user:n}}(e.map(e=>{const t=e.name.match(/æ¥¼å±‚(\d+)/);return`æ‘˜è¦${t?t[1]:"?"}\n${e.content}`}),n.sort((e,t)=>parseInt(e.name.match(/å·(\d+)/)[1])-parseInt(t.name.match(/å·(\d+)/)[1])).map(e=>e.content));return await w(a.system,a.user,t)}let C=0;async function E(t){const a=l();if(!a.auto_mini_summary)return;const o=getChatMessages(t);if(0===o.length)return;const s=o[0];if("system"!==s.role&&s.message&&""!==s.message.trim()&&!(t<a.ignore_floors)&&h())try{await async function(t){const a=d();if(!a||!h())return void console.warn("[è‡ªåŠ¨æ€»ç»“] ä¸–ç•Œä¹¦ä¸å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»ºå ä½å°æ€»ç»“");const o=`[å°æ€»ç»“-æ¥¼å±‚${t}]`;if(!(await getWorldbook(a)).find(e=>e.name===o)){const s=l();await createWorldbookEntries(a,[{...n,name:o,content:"ï¼ˆæ€»ç»“ç”Ÿæˆä¸­...ï¼‰",position:{type:"at_depth",role:"system",depth:s.mini_summary_depth,order:e(t,s.mini_summary_start_order)}}])}}(t),await b(),await async function(){const e=l(),t=getLastMessageId();if(t<0)return;const n=getChatMessages(`0-${t}`);if(0===n.length)return;const a=t-e.visible_floors+1,o=[];for(const s of n)"system"!==s.role&&(s.message_id>=a?s.is_hidden&&o.push({message_id:s.message_id,is_hidden:!1}):s.is_hidden||o.push({message_id:s.message_id,is_hidden:!0}));o.length>0&&await setChatMessages(o,{refresh:"none"}),await b()}(),C++,function(){const e=l();return!!e.auto_volume_summary&&C%e.check_interval===0&&C>0}()&&m.enqueue({type:"volume_summary"}),m.enqueue({type:"mini_summary",message_id:t})}catch(r){console.error("[è‡ªåŠ¨æ€»ç»“] æ¶ˆæ¯å¤„ç†å¤±è´¥:",r)}}const T="hilo-auto-summary-menu";function S(){const e=$("#extensionsMenu");if(!e.length)return void setTimeout(S,2e3);$(`#${T}`,e).remove();const t=$(`\n    <div class="list-group-item flex-container flexGap5 interactable" id="${T}" title="è‡ªåŠ¨æ€»ç»“è®¾ç½®">\n      <div class="fa-fw fa-solid fa-book-open extensionsMenuExtensionButton"></div>\n      <span>è‡ªåŠ¨æ€»ç»“</span>\n    </div>\n  `);t.on("click",async t=>{t.stopPropagation();const n=$("#extensionsMenuButton");n.length&&e.is(":visible")&&(n.trigger("click"),await new Promise(e=>setTimeout(e,150))),await N()}),e.append(t)}function q(e,t){return`\n    <div class="hs-regex-row" data-index="${t}" style="display: flex; gap: 5px; margin-bottom: 5px; align-items: center;">\n      <input type="text" class="hs-regex-pattern" value="${j(e.pattern)}" placeholder="æ­£åˆ™" style="flex: 3;" />\n      <input type="text" class="hs-regex-flags" value="${j(e.flags)}" placeholder="flags" style="flex: 1; max-width: 60px;" />\n      <input type="text" class="hs-regex-replacement" value="${j(e.replacement)}" placeholder="æ›¿æ¢" style="flex: 2;" />\n      <button class="hs-remove-regex menu_button" style="flex: 0 0 auto; padding: 2px 8px;">âœ•</button>\n    </div>\n  `}function j(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}async function N(){const e=r(),t=function(e){return`\n    <div id="hilo-summary-settings" style="padding: 10px;">\n      <style>\n        #hilo-summary-settings input[type="text"],\n        #hilo-summary-settings input[type="number"],\n        #hilo-summary-settings input[type="password"],\n        #hilo-summary-settings select,\n        #hilo-summary-settings textarea {\n          background-color: var(--SmartThemeSurface, #1c1c1c);\n          color: var(--SmartThemeBodyColor, #eee);\n          border: 1px solid var(--SmartThemeBorderColor, #444);\n          border-radius: 4px;\n          padding: 4px 8px;\n        }\n        #hilo-summary-settings input[type="text"]:focus,\n        #hilo-summary-settings input[type="number"]:focus,\n        #hilo-summary-settings input[type="password"]:focus,\n        #hilo-summary-settings select:focus,\n        #hilo-summary-settings textarea:focus {\n          border-color: var(--SmartThemeFocusColor, #888);\n          outline: none;\n        }\n      </style>\n      <h3 style="margin-top: 0;">ğŸ“– è‡ªåŠ¨æ€»ç»“è®¾ç½®</h3>\n\n      \x3c!-- ä¸–ç•Œä¹¦ç®¡ç† --\x3e\n      <div style="margin-bottom: 15px;">\n        <h4>ä¸–ç•Œä¹¦ç®¡ç†</h4>\n        <div style="margin-bottom: 8px; display: flex; gap: 8px; align-items: center;">\n          <label>å½“å‰ä¸–ç•Œä¹¦ï¼š</label>\n          <select id="hs-worldbook-select" style="flex: 1;">\n            <option value=""${d()?"":" selected"}>ï¼ˆæœªç»‘å®šï¼‰</option>\n            ${getWorldbookNames().map(e=>`<option value="${j(e)}" ${d()===e?"selected":""}>${j(e)}</option>`).join("")}\n          </select>\n          <button id="hs-create-worldbook" class="menu_button" style="white-space: nowrap;">ä¸€é”®åˆ›å»º</button>\n        </div>\n      </div>\n\n      \x3c!-- åŸºæœ¬è®¾ç½® --\x3e\n      <div style="margin-bottom: 15px;">\n        <h4>åŸºæœ¬è®¾ç½®</h4>\n        <div style="margin-bottom: 8px;">\n          <label>æ˜¾ç¤ºæ¥¼å±‚æ•°ï¼š</label>\n          <input type="number" id="hs-visible-floors" value="${e.visible_floors}" min="1" max="100" style="width: 80px;" />\n          <small style="color: #888;">ï¼ˆæœ€è¿‘ä¿ç•™å¤šå°‘æ¥¼å¯è§ï¼‰</small>\n        </div>\n        <div style="margin-bottom: 8px;">\n          <label>æ£€æŸ¥é—´éš”ï¼š</label>\n          <input type="number" id="hs-check-interval" value="${e.check_interval}" min="5" max="100" style="width: 80px;" />\n          <small style="color: #888;">ï¼ˆæ¯å¤šå°‘ä¸ªå°æ€»ç»“æ£€æŸ¥ä¸€æ¬¡å¤§æ€»ç»“ï¼‰</small>\n        </div>\n        <div style="margin-bottom: 8px;">\n          <label>Token é˜ˆå€¼ï¼š</label>\n          <input type="number" id="hs-volume-token-threshold" value="${e.volume_token_threshold}" min="1000" max="50000" style="width: 100px;" />\n          <small style="color: #888;">ï¼ˆå¤§æ€»ç»“è§¦å‘é˜ˆå€¼ï¼‰</small>\n        </div>\n        <div style="margin-bottom: 8px;">\n          <label>\n            <input type="checkbox" id="hs-auto-mini-summary" ${e.auto_mini_summary?"checked":""} />\n            è‡ªåŠ¨å°æ€»ç»“\n          </label>\n        </div>\n        <div style="margin-bottom: 8px;">\n          <label>\n            <input type="checkbox" id="hs-auto-volume-summary" ${e.auto_volume_summary?"checked":""} />\n            è‡ªåŠ¨å¤§æ€»ç»“\n          </label>\n        </div>\n        <div style="margin-bottom: 8px;">\n          <label>å°æ€»ç»“æ³¨å…¥æ·±åº¦ï¼š</label>\n          <input type="number" id="hs-mini-summary-depth" value="${e.mini_summary_depth}" min="0" max="99999" style="width: 100px;" />\n          <small style="color: #888;">ï¼ˆé»˜è®¤ 9999ï¼‰</small>\n        </div>\n        <div style="margin-bottom: 8px;">\n          <label>å·æ€»ç»“æ³¨å…¥æ·±åº¦ï¼š</label>\n          <input type="number" id="hs-volume-summary-depth" value="${e.volume_summary_depth}" min="0" max="99999" style="width: 100px;" />\n          <small style="color: #888;">ï¼ˆé»˜è®¤ 9999ï¼‰</small>\n        </div>\n        <div style="margin-bottom: 8px;">\n          <label>å°æ€»ç»“èµ·å§‹æ’åºï¼š</label>\n          <input type="number" id="hs-mini-start-order" value="${e.mini_summary_start_order}" min="0" max="99999" style="width: 100px;" />\n          <small style="color: #888;">ï¼ˆå°æ€»ç»“ order åŸºæ•°ï¼Œé»˜è®¤ 10000ï¼‰</small>\n        </div>\n        <div style="margin-bottom: 8px;">\n          <label>å·æ€»ç»“èµ·å§‹æ’åºï¼š</label>\n          <input type="number" id="hs-volume-start-order" value="${e.volume_start_order}" min="0" max="99999" style="width: 100px;" />\n          <small style="color: #888;">ï¼ˆå·æ€»ç»“ order åŸºæ•°ï¼Œé»˜è®¤ 100ï¼‰</small>\n        </div>\n        <div style="margin-bottom: 8px;">\n          <label>å¿½ç•¥å‰ N å±‚ï¼š</label>\n          <input type="number" id="hs-ignore-floors" value="${e.ignore_floors}" min="0" max="1000" style="width: 80px;" />\n          <small style="color: #888;">ï¼ˆè·³è¿‡å‰å¤šå°‘å±‚ä¸è¿›è¡Œæ€»ç»“ï¼‰</small>\n        </div>\n        <div style="margin-bottom: 8px;">\n          <label>å†…å®¹æ•è·æ ‡ç­¾ï¼š</label>\n          <div style="display: flex; gap: 5px; align-items: center; margin-top: 4px;">\n            <span>&lt;</span>\n            <input type="text" id="hs-capture-start-tag" value="${j(e.capture_start_tag)}" style="width: 100px;" placeholder="èµ·å§‹æ ‡ç­¾" />\n            <span>&gt; â€¦ &lt;</span>\n            <input type="text" id="hs-capture-end-tag" value="${j(e.capture_end_tag)}" style="width: 100px;" placeholder="ç»“æŸæ ‡ç­¾" />\n            <span>&gt;</span>\n          </div>\n          <small style="color: #888;">ï¼ˆä»…æ€»ç»“ä¸¤ä¸ªæ ‡ç­¾ä¹‹é—´çš„å†…å®¹ï¼Œå‡ç•™ç©ºåˆ™æ€»ç»“å…¨éƒ¨ï¼‰</small>\n        </div>\n        <div style="margin-bottom: 8px;">\n          <label>\n            <input type="checkbox" id="hs-no-trans-tag" ${e.no_trans_tag?"checked":""} />\n            é˜²åˆå¹¶æ ‡è®°\n          </label>\n          <input type="text" id="hs-no-trans-tag-value" value="${j(e.no_trans_tag_value)}" style="width: 100px; margin-left: 5px;" placeholder="<|no-trans|>" title="è‡ªå®šä¹‰é˜²åˆå¹¶æ ‡è®°" />\n          <small style="color: #888; margin-left: 5px;">ï¼ˆkeminiæˆ–noassè„šæœ¬å¼€ï¼‰</small>\n        </div>\n      </div>\n\n      \x3c!-- æ‰‹åŠ¨æ“ä½œ --\x3e\n      <div style="margin-bottom: 15px;">\n        <h4>æ‰‹åŠ¨æ“ä½œ</h4>\n        <div style="display: flex; gap: 8px; flex-wrap: nowrap;">\n          <button id="hs-manual-mini" class="menu_button" style="white-space: nowrap; flex: 1; padding: 5px 0;">æ‰‹åŠ¨æ€»ç»“</button>\n          <button id="hs-manual-volume" class="menu_button" style="white-space: nowrap; flex: 1; padding: 5px 0;">æ‰‹åŠ¨å½’æ¡£</button>\n          <button id="hs-manual-complete" class="menu_button" style="white-space: nowrap; flex: 1; padding: 5px 0;">æ‰‹åŠ¨è¡¥å…¨</button>\n        </div>\n      </div>\n\n      \x3c!-- API é…ç½® --\x3e\n      <div style="margin-bottom: 15px;">\n        <h4>API é…ç½®</h4>\n        <div style="margin-bottom: 8px;">\n          <label>API URLï¼š</label>\n          <input type="text" id="hs-custom-api-url" value="${j(e.custom_api.apiurl)}" style="width: 100%;" placeholder="https://api.example.com/v1" />\n        </div>\n        <div style="margin-bottom: 8px;">\n          <label>API Keyï¼š</label>\n          <input type="password" id="hs-custom-api-key" value="${j(e.custom_api.key)}" style="width: 100%;" placeholder="sk-..." />\n        </div>\n        <div style="margin-bottom: 8px;">\n          <label>æ¨¡å‹ï¼š</label>\n          <input type="text" id="hs-custom-api-model" value="${j(e.custom_api.model)}" style="width: 100%;" placeholder="è¾“å…¥æ¨¡å‹åç§°ï¼Œå¦‚ gpt-4o" />\n        </div>\n        <div style="margin-bottom: 8px;">\n          <label>API æºï¼š</label>\n          <select id="hs-custom-api-source" style="width: 100%;">\n            ${["openai"].map(t=>`<option value="${t}" ${e.custom_api.source===t?"selected":""}>${t}</option>`).join("")}\n          </select>\n        </div>\n      </div>\n\n      \x3c!-- è‡ªå®šä¹‰æç¤ºè¯ --\x3e\n      <details style="margin-bottom: 15px;">\n        <summary><h4 style="display: inline;">è‡ªå®šä¹‰æç¤ºè¯</h4></summary>\n        <div style="padding: 8px 0;">\n          <div style="margin-bottom: 8px;">\n            <label>å°æ€»ç»“ç³»ç»Ÿæç¤ºè¯ï¼š</label>\n            <textarea id="hs-prompt-mini" rows="5" style="width: 100%; resize: vertical;" placeholder="ä½¿ç”¨é»˜è®¤æç¤ºè¯">${j(e.custom_prompts.mini_summary_system||c)}</textarea>\n            <small style="color: #888;">ï¼ˆä¿®æ”¹åå³ä¸ºè‡ªå®šä¹‰ï¼›æ¢å¤é»˜è®¤è¯·æ¸…ç©ºæç¤ºè¯å¹¶ä¿å­˜ï¼‰</small>\n          </div>\n          <div style="margin-bottom: 8px;">\n            <label>å¤§æ€»ç»“ç³»ç»Ÿæç¤ºè¯ï¼š</label>\n            <textarea id="hs-prompt-volume" rows="5" style="width: 100%; resize: vertical;" placeholder="ä½¿ç”¨é»˜è®¤æç¤ºè¯">${j(e.custom_prompts.volume_summary_system||u)}</textarea>\n            <small style="color: #888;">ï¼ˆä¿®æ”¹åå³ä¸ºè‡ªå®šä¹‰ï¼›æ¢å¤é»˜è®¤è¯·æ¸…ç©ºæç¤ºè¯å¹¶ä¿å­˜ï¼‰</small>\n          </div>\n          <div style="margin-bottom: 8px;">\n            <label>å·å®Œç»“æ£€æµ‹ç³»ç»Ÿæç¤ºè¯ï¼š</label>\n            <textarea id="hs-prompt-completion" rows="5" style="width: 100%; resize: vertical;" placeholder="ä½¿ç”¨é»˜è®¤æç¤ºè¯">${j(e.custom_prompts.volume_completion_check_system||p)}</textarea>\n            <small style="color: #888; display: block; margin-top: 4px;">\n              ï¼ˆä¿®æ”¹åå³ä¸ºè‡ªå®šä¹‰ï¼›æ¢å¤é»˜è®¤æ¸…ç©ºå³å¯ï¼‰\n            </small>\n          </div>\n        </div>\n      </details>\n\n      \x3c!-- æ¶ˆæ¯æ¸…æ´— --\x3e\n      <details style="margin-bottom: 15px;">\n        <summary><h4 style="display: inline;">æ¶ˆæ¯æ¸…æ´—æ­£åˆ™</h4></summary>\n        <div style="padding: 8px 0;">\n          <div id="hs-regex-list">\n            ${e.message_cleanup_regex.map((e,t)=>q(e,t)).join("")}\n          </div>\n          <button id="hs-add-regex" class="menu_button" style="white-space: nowrap; flex: 1; padding: 5px 0;">+ æ·»åŠ æ­£åˆ™</button>\n        </div>\n      </details>\n    </div>\n  `}(e),n=$(t);n.css({flex:"1","overflow-y":"auto","min-height":"0","padding-right":"5px"});const a=$('<div id="hilo-summary-overlay"></div>'),o=$('<div id="hilo-summary-dialog"></div>'),l=$('<div style="display: flex; justify-content: flex-end; gap: 8px; margin-top: 15px; flex-shrink: 0; padding-top: 10px; border-top: 1px solid var(--SmartThemeBorderColor, #555);">\n    <button id="hs-reset" class="menu_button" style="margin-right: auto; white-space: nowrap; padding: 5px 15px;">é‡ç½®é»˜è®¤</button>\n    <button id="hs-cancel" class="menu_button" style="white-space: nowrap; padding: 5px 15px;">å–æ¶ˆ</button>\n    <button id="hs-save" class="menu_button" style="white-space: nowrap; padding: 5px 15px;">ä¿å­˜</button>\n  </div>');o.append(n).append(l),a.append(o),$("body").append(a);const h=window.top||window,y=()=>{const e=h.visualViewport||{width:h.innerWidth,height:h.innerHeight,offsetTop:0,offsetLeft:0},t=e.width||h.innerWidth,n=e.height||h.innerHeight;a[0].style.cssText=`\n      position: fixed !important; top: ${e.offsetTop||0}px !important; left: ${e.offsetLeft||0}px !important;\n      width: ${t}px !important; height: ${n}px !important;\n      max-width: none !important; max-height: none !important; margin: 0 !important; padding: 0 !important;\n      z-index: 10000 !important; display: flex !important; align-items: center !important; justify-content: center !important;\n      background: rgba(0,0,0,0.6) !important;\n      overflow: hidden !important;\n    `;const s=o[0];s&&t<=768?s.style.cssText=`\n        background: var(--SmartThemeBlurTintColor, #2b2b2b) !important;\n        border: none !important;\n        border-radius: 0 !important; padding: 15px !important;\n        width: ${t}px !important; height: ${n}px !important;\n        max-width: none !important; max-height: none !important; margin: 0 !important;\n        display: flex !important; flex-direction: column !important;\n        color: var(--SmartThemeBodyColor, #ccc) !important;\n        box-sizing: border-box !important;\n      `:s&&(s.style.cssText="\n        background: var(--SmartThemeBlurTintColor, #2b2b2b) !important;\n        border: 1px solid var(--SmartThemeBorderColor, #555) !important;\n        border-radius: 10px !important; padding: 20px !important; width: 90vw !important;\n        min-width: 300px !important; max-width: 700px !important; max-height: 90vh !important;\n        display: flex !important; flex-direction: column !important;\n        color: var(--SmartThemeBodyColor, #ccc) !important;\n        box-sizing: border-box !important;\n      ")};y();const g=h.visualViewport;g&&(g.addEventListener("resize",y),g.addEventListener("scroll",y)),h.addEventListener("resize",y);const _=()=>{g&&(g.removeEventListener("resize",y),g.removeEventListener("scroll",y)),h.removeEventListener("resize",y),a.remove()};a.on("click","#hs-cancel",()=>{_()}),a.on("click","#hs-reset",()=>{r();i({...s}),toastr.success("å·²é‡ç½®ä¸ºé»˜è®¤è®¾ç½®"),_(),N()}),a.on("click","#hs-save",()=>{const e=function(){const e=$(".hs-regex-row"),t=[];e.each(function(){const e=$(this),n=e.find(".hs-regex-pattern").val();n&&t.push({pattern:n,flags:e.find(".hs-regex-flags").val()||"g",replacement:e.find(".hs-regex-replacement").val()||""})});const n=($("#hs-prompt-mini").val()||"").trim(),a=($("#hs-prompt-volume").val()||"").trim(),o=($("#hs-prompt-completion").val()||"").trim();return{visible_floors:parseInt($("#hs-visible-floors").val())||20,check_interval:parseInt($("#hs-check-interval").val())||20,volume_token_threshold:parseInt($("#hs-volume-token-threshold").val())||8e3,auto_mini_summary:$("#hs-auto-mini-summary").is(":checked"),auto_volume_summary:$("#hs-auto-volume-summary").is(":checked"),mini_summary_depth:parseInt($("#hs-mini-summary-depth").val())||9999,volume_summary_depth:parseInt($("#hs-volume-summary-depth").val())||9999,mini_summary_start_order:parseInt($("#hs-mini-start-order").val())||1e4,volume_start_order:parseInt($("#hs-volume-start-order").val())||100,ignore_floors:parseInt($("#hs-ignore-floors").val())||0,capture_start_tag:($("#hs-capture-start-tag").val()||"").trim(),capture_end_tag:($("#hs-capture-end-tag").val()||"").trim(),no_trans_tag:$("#hs-no-trans-tag").is(":checked"),no_trans_tag_value:($("#hs-no-trans-tag-value").val()||"").trim(),custom_api:{apiurl:$("#hs-custom-api-url").val()||"",key:$("#hs-custom-api-key").val()||"",model:$("#hs-custom-api-model").val()||"",source:$("#hs-custom-api-source").val()||"openai"},custom_prompts:{mini_summary_system:n===c.trim()?"":n,volume_summary_system:a===u.trim()?"":a,volume_completion_check_system:o===p.trim()?"":o},message_cleanup_regex:t}}();i({...r(),...e}),toastr.success("è®¾ç½®å·²ä¿å­˜"),_()}),a.on("change","#hs-worldbook-select",async function(){const e=$(this).val();if(e)try{await async function(e){await rebindChatWorldbook("current",e),console.log(`[è‡ªåŠ¨æ€»ç»“] å·²ç»‘å®šä¸–ç•Œä¹¦: ${e}`)}(e),toastr.success(`å·²ç»‘å®šä¸–ç•Œä¹¦: ${e}`)}catch(t){toastr.error(`ç»‘å®šä¸–ç•Œä¹¦å¤±è´¥: ${e}`),console.error("[è‡ªåŠ¨æ€»ç»“] ç»‘å®šä¸–ç•Œä¹¦å¤±è´¥:",t)}else await rebindChatWorldbook("current",""),toastr.info("å·²è§£é™¤ä¸–ç•Œä¹¦ç»‘å®š")}),a.on("click","#hs-create-worldbook",async()=>{try{const e=await async function(e){const t=getCurrentCharacterName(),n=e||`${t||"æœªçŸ¥"}[è‡ªåŠ¨æ€»ç»“]`;return getWorldbookNames().includes(n)||(await createWorldbook(n,[]),console.log(`[è‡ªåŠ¨æ€»ç»“] å·²åˆ›å»ºä¸–ç•Œä¹¦: ${n}`)),await rebindChatWorldbook("current",n),console.log(`[è‡ªåŠ¨æ€»ç»“] å·²ç»‘å®šä¸–ç•Œä¹¦: ${n}`),n}(),t=$("#hs-worldbook-select");0===t.find(`option[value="${j(e)}"]`).length&&t.append(`<option value="${j(e)}">${j(e)}</option>`),t.val(e),toastr.success(`å·²åˆ›å»ºå¹¶ç»‘å®šä¸–ç•Œä¹¦: ${e}`)}catch(e){toastr.error("åˆ›å»ºä¸–ç•Œä¹¦å¤±è´¥"),console.error("[è‡ªåŠ¨æ€»ç»“] åˆ›å»ºä¸–ç•Œä¹¦å¤±è´¥:",e)}}),a.on("click","#hs-manual-mini",()=>{const e=getLastMessageId();e>=0?(m.enqueue({type:"mini_summary",message_id:e}),toastr.info(`å·²å°†æ¥¼å±‚ ${e} çš„å°æ€»ç»“ä»»åŠ¡åŠ å…¥é˜Ÿåˆ—`)):toastr.warning("å½“å‰æ²¡æœ‰èŠå¤©æ¶ˆæ¯")}),a.on("click","#hs-manual-volume",()=>{m.enqueue({type:"volume_summary"}),toastr.info("å·²å°†å¤§æ€»ç»“ä»»åŠ¡åŠ å…¥é˜Ÿåˆ—")}),a.on("click","#hs-manual-complete",async()=>{const e=r(),t=getLastMessageId(),n=e.ignore_floors;if(n>t)return void toastr.warning("æ²¡æœ‰å¯ä»¥è¡¥å…¨çš„æ¥¼å±‚ï¼ˆéƒ½åœ¨å¿½ç•¥èŒƒå›´å†…ï¼‰");const a=d();if(a){toastr.info("æ­£åœ¨æ£€æŸ¥ç¼ºå¤±å±‚æ•°...");try{const e=await getWorldbook(a),o=/* @__PURE__ */new Set;for(const t of e){const e=t.name.match(/^\[å°æ€»ç»“-æ¥¼å±‚(\d+)\]$/);e&&o.add(parseInt(e[1]))}let s=0;for(let a=n;a<=t;a++)o.has(a)||(m.enqueue({type:"mini_summary",message_id:a}),s++);s>0?(m.enqueue({type:"volume_summary"}),toastr.success(`æ£€æµ‹åˆ° ${s} ä¸ªç¼ºå¤±æ¥¼å±‚ï¼Œå·²å…¨éƒ¨åŠ å…¥è¡¥å…¨é˜Ÿåˆ—ï¼Œå¹¶åœ¨æœ€ååŠ å…¥å½’æ¡£ä»»åŠ¡`)):toastr.info("æ‰€æœ‰æ¥¼å±‚å‡å·²æœ‰å¯¹åº”å°æ€»ç»“ï¼Œæ— éœ€è¡¥å…¨")}catch(o){toastr.error("è·å–ä¸–ç•Œä¹¦æ¡ç›®å¤±è´¥ï¼Œæ— æ³•è¡¥å…¨"),console.error("[è‡ªåŠ¨æ€»ç»“] æ‰‹åŠ¨è¡¥å…¨æ£€æŸ¥å¤±è´¥:",o)}}else toastr.warning("å½“å‰èŠå¤©æœªç»‘å®šä¸–ç•Œä¹¦ï¼Œæ— æ³•æ£€æŸ¥è¡¥å…¨")});let v=e.message_cleanup_regex.length;a.on("click","#hs-add-regex",()=>{const e=q({pattern:"",flags:"g",replacement:""},v++);$("#hs-regex-list").append(e)}),a.on("click",".hs-remove-regex",function(){$(this).closest(".hs-regex-row").remove()}),a.on("click",e=>{e.target===a[0]&&_()})}m.setHandlers({mini_summary:async function(t){if(!h())return void console.warn("[è‡ªåŠ¨æ€»ç»“] ä¸–ç•Œä¹¦ä¸å­˜åœ¨ï¼Œè·³è¿‡å°æ€»ç»“ç”Ÿæˆ");const a=await k(t);await async function(t,a){const o=d();if(!o||!h())return void console.warn("[è‡ªåŠ¨æ€»ç»“] ä¸–ç•Œä¹¦ä¸å­˜åœ¨ï¼Œè·³è¿‡å†™å…¥å°æ€»ç»“");const s=`[å°æ€»ç»“-æ¥¼å±‚${t}]`;if((await getWorldbook(o)).find(e=>e.name===s))await updateWorldbookWith(o,e=>{const t=e.find(e=>e.name===s);return t&&(t.content=a),e});else{const r=l();await createWorldbookEntries(o,[{...n,name:s,content:a,position:{type:"at_depth",role:"system",depth:r.mini_summary_depth,order:e(t,r.mini_summary_start_order)}}])}}(t,a);const o=await g();o.last_processed_message_id=t,await v(o)},volume_summary:async function(){if(!h())return void console.warn("[è‡ªåŠ¨æ€»ç»“] ä¸–ç•Œä¹¦ä¸å­˜åœ¨ï¼Œè·³è¿‡å¤§æ€»ç»“ç”Ÿæˆ");const e=await g(),a=await f();if(0===a.length)return;if(!(await I()))return;const o=a.map(e=>parseInt(e.name.match(/æ¥¼å±‚(\d+)/)[1])).sort((e,t)=>e-t);let s=o[0],r=o[o.length-1];const i=await W(a),m=i.match(/æ‘˜è¦(\d+)-æ‘˜è¦(\d+)/);if(m){const e=parseInt(m[1]),t=parseInt(m[2]);e<=t?(s=e,r=t):console.warn(`[è‡ªåŠ¨æ€»ç»“] AI è¾“å‡ºçš„èŒƒå›´(æ‘˜è¦${e}-æ‘˜è¦${t})æ— æ•ˆï¼Œå›é€€ä½¿ç”¨å…¨èŒƒå›´`)}else console.warn("[è‡ªåŠ¨æ€»ç»“] å·æ€»ç»“ä¸­æœªæ‰¾åˆ°æœ‰æ•ˆçš„é¦–å°¾èŒƒå›´æ ‡è®°ï¼Œå›é€€ä½¿ç”¨å…¨èŒƒå›´");const c=i.replace(/\s*æ‘˜è¦\d+-æ‘˜è¦\d+\s*$/,"").trim();await async function(e,a,o,s){const r=d();if(!r||!h())return void console.warn("[è‡ªåŠ¨æ€»ç»“] ä¸–ç•Œä¹¦ä¸å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»ºå·æ¡ç›®");const i=`[å·${e}-æ¥¼å±‚${a}~æ¥¼å±‚${o}]`;await updateWorldbookWith(r,r=>{for(const e of r){const t=e.name.match(/^\[å°æ€»ç»“-æ¥¼å±‚(\d+)\]$/);if(!t)continue;const n=parseInt(t[1]);n>=a&&n<=o&&(e.enabled=!1)}const m=l();return r.push({...n,enabled:!0,name:i,content:s,position:{type:"at_depth",role:"system",depth:m.volume_summary_depth,order:t(e,m.volume_start_order)}}),r});const m=await g();m.current_volume=e+1,m.volumes.push({volume:e,start_message_id:a,end_message_id:o}),await v(m)}(e.current_volume,s,r,c),console.log(`[è‡ªåŠ¨æ€»ç»“] å·²å½’æ¡£å·${e.current_volume}: æ¥¼å±‚${s}~æ¥¼å±‚${r}`)}}),$(()=>{(async()=>{try{r();console.log("[è‡ªåŠ¨æ€»ç»“] è„šæœ¬å˜é‡å·²åŠ è½½");const e=getCurrentCharacterName();if(!e)return void console.log("[è‡ªåŠ¨æ€»ç»“] æœªæ‰“å¼€è§’è‰²å¡ï¼Œè„šæœ¬ä¸æ‰§è¡Œ");console.log(`[è‡ªåŠ¨æ€»ç»“] å½“å‰è§’è‰²å¡: ${e}`),h()?(await async function(){const e=d();if(!e||!h())return;if(!(await getWorldbook(e)).find(e=>e.name===y)){const t=a.parse({});await createWorldbookEntries(e,[{...n,enabled:!1,name:y,content:JSON.stringify(t)}]),console.log("[è‡ªåŠ¨æ€»ç»“] å·²åˆ›å»º [data] å…ƒæ•°æ®æ¡ç›®")}}(),await b()):console.log("[è‡ªåŠ¨æ€»ç»“] å½“å‰èŠå¤©æœªç»‘å®šä¸–ç•Œä¹¦æˆ–ä¸–ç•Œä¹¦ä¸å­˜åœ¨ï¼Œè·³è¿‡åŒæ­¥"),S(),eventOn(tavern_events.MESSAGE_RECEIVED,errorCatched(e=>{E(e)})),function(){let e=SillyTavern.getCurrentChatId();eventOn(tavern_events.CHAT_CHANGED,t=>{e!==t&&(e=t,window.location.reload())})}(),console.log("[è‡ªåŠ¨æ€»ç»“] åˆå§‹åŒ–å®Œæˆ")}catch(e){console.error("[è‡ªåŠ¨æ€»ç»“] åˆå§‹åŒ–å¤±è´¥:",e)}})()});
