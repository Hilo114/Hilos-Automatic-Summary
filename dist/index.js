function e(e,t){return t+e}function t(e,t){return t+e}const n={enabled:!1,strategy:{type:"constant",keys:[],keys_secondary:{logic:"and_any",keys:[]},scan_depth:"same_as_global"},probability:100,recursion:{prevent_incoming:!0,prevent_outgoing:!0,delay_until:null},effect:{sticky:null,cooldown:null,delay:null}},s=z.object({visible_floors:z.coerce.number().transform(e=>_.clamp(e,1,100)).prefault(20),check_interval:z.coerce.number().transform(e=>_.clamp(e,5,100)).prefault(20),volume_token_threshold:z.coerce.number().transform(e=>_.clamp(e,1e3,5e4)).prefault(8e3),auto_mini_summary:z.boolean().prefault(!0),auto_volume_summary:z.boolean().prefault(!0),mini_summary_depth:z.coerce.number().transform(e=>_.clamp(e,0,99999)).prefault(9999),volume_summary_depth:z.coerce.number().transform(e=>_.clamp(e,0,99999)).prefault(9999),mini_summary_start_order:z.coerce.number().transform(e=>_.clamp(e,0,99999)).prefault(1e4),volume_start_order:z.coerce.number().transform(e=>_.clamp(e,0,99999)).prefault(100),ignore_floors:z.coerce.number().transform(e=>_.clamp(e,0,1e3)).prefault(0),custom_api:z.object({enabled:z.boolean().prefault(!1),apiurl:z.string().prefault(""),key:z.string().prefault(""),model:z.string().prefault(""),source:z.string().prefault("openai")}).prefault({}),message_cleanup_regex:z.array(z.object({pattern:z.string(),flags:z.string().prefault("g"),replacement:z.string().prefault("")})).prefault([]),current_volume:z.coerce.number().prefault(1),last_processed_message_id:z.coerce.number().prefault(-1),volumes:z.array(z.object({volume:z.coerce.number(),start_message_id:z.coerce.number(),end_message_id:z.coerce.number()})).prefault([])}).prefault({});function a(){const e=getVariables({type:"script"});return s.parse(e)}function o(e){replaceVariables(e,{type:"script"})}function r(){return a()}const i=new class{queue=[];processing=!1;handlers=null;setHandlers(e){this.handlers=e}enqueue(e){"mini_summary"===e.type&&void 0!==e.message_id&&(this.queue=this.queue.filter(t=>!("mini_summary"===t.type&&t.message_id===e.message_id))),this.queue.push(e),this.processNext()}async processNext(){if(!this.processing&&0!==this.queue.length){this.processing=!0;try{const e=this.queue.shift();if(!this.handlers)return void console.error("[è‡ªåŠ¨æ€»ç»“] ä»»åŠ¡å¤„ç†å‡½æ•°æœªæ³¨å†Œ");"mini_summary"===e.type&&void 0!==e.message_id?await this.handlers.mini_summary(e.message_id):"volume_summary"===e.type&&await this.handlers.volume_summary()}catch(e){console.error("[è‡ªåŠ¨æ€»ç»“] æ€»ç»“ä»»åŠ¡æ‰§è¡Œå¤±è´¥:",e)}finally{this.processing=!1,this.queue.length>0&&await this.processNext()}}}};function l(){const e=getCurrentCharacterName();if(!e)throw new Error("[è‡ªåŠ¨æ€»ç»“] æœªæ‰“å¼€è§’è‰²å¡ï¼Œæ— æ³•è·å–ä¸–ç•Œä¹¦åç§°");return`${e}[è‡ªåŠ¨æ€»ç»“]`}async function m(){const e=await getWorldbook(l()),t=a(),n=/* @__PURE__ */new Set;for(const s of t.volumes)for(let e=s.start_message_id;e<=s.end_message_id;e++)n.add(e);return e.filter(e=>{const t=e.name.match(/^\[å°æ€»ç»“-æ¥¼å±‚(\d+)\]$/);if(!t)return!1;const s=parseInt(t[1]);return!n.has(s)})}async function u(){const e=r(),t=getLastMessageId()-e.visible_floors+1,n=a(),s=/* @__PURE__ */new Set;for(const a of n.volumes)for(let e=a.start_message_id;e<=a.end_message_id;e++)s.add(e);await updateWorldbookWith(l(),e=>{for(const n of e){const e=n.name.match(/^\[å°æ€»ç»“-æ¥¼å±‚(\d+)\]$/);if(!e)continue;const a=parseInt(e[1]);a>=t||s.has(a)?n.enabled=!1:n.enabled=!0}return e})}function c(e){if(e.custom_api.enabled)return{apiurl:e.custom_api.apiurl,key:e.custom_api.key,model:e.custom_api.model,source:e.custom_api.source}}async function d(e,t,n){try{return await generateRaw({should_silence:!0,custom_api:c(n),ordered_prompts:[{role:"system",content:e},{role:"user",content:t}]})}catch(s){if(n.custom_api.enabled){console.warn("[è‡ªåŠ¨æ€»ç»“] è‡ªå®šä¹‰ API å¤±è´¥ï¼Œé™çº§ä½¿ç”¨é…’é¦†å½“å‰ API:",s);return await generateRaw({should_silence:!0,ordered_prompts:[{role:"system",content:e},{role:"user",content:t}]})}throw s}}async function p(e){const t=r(),n=(await getWorldbook(l())).filter(e=>e.name.match(/^\[å°æ€»ç»“-æ¥¼å±‚(\d+)\]$/)).map(e=>({id:parseInt(e.name.match(/æ¥¼å±‚(\d+)/)[1]),content:e.content})).filter(t=>t.id<e).sort((e,t)=>e.id-t.id).slice(-2).map(e=>e.content).join("\n"),s=getChatMessages(e);if(0===s.length)throw new Error(`[è‡ªåŠ¨æ€»ç»“] æ¥¼å±‚ ${e} ä¸å­˜åœ¨`);const a=s[0].message;if(!a||""===a.trim())return"ï¼ˆç©ºæ¶ˆæ¯ï¼‰";const o=function(e,t){let n=e;for(const a of t.message_cleanup_regex)try{const e=new RegExp(a.pattern,a.flags);n=n.replace(e,a.replacement)}catch(s){console.error(`[è‡ªåŠ¨æ€»ç»“] æ­£åˆ™æ¸…æ´—é”™è¯¯ (pattern: ${a.pattern}):`,s)}return n}(a,t),i=function(e,t){let n="";return t&&(n+=`ä»¥ä¸‹æ˜¯ä¹‹å‰çš„æ€»ç»“ï¼Œä¾›ä½ äº†è§£ä¸Šä¸‹æ–‡ï¼š\n${t}\n\n---\n\n`),n+=`è¯·æ€»ç»“ä»¥ä¸‹æ¶ˆæ¯ï¼š\n\n${e}`,{system:"ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ•…äº‹æ€»ç»“åŠ©æ‰‹ã€‚ä½ çš„ä»»åŠ¡æ˜¯å°†è§’è‰²æ‰®æ¼”èŠå¤©è®°å½•ä¸­çš„ä¸€æ¡æ¶ˆæ¯æ€»ç»“ä¸ºç®€æ´çš„å°æ€»ç»“ã€‚\n\nè¦æ±‚ï¼š\n1. ä¿ç•™å…³é”®æƒ…èŠ‚ã€è§’è‰²è¡Œä¸ºã€æƒ…æ„Ÿå˜åŒ–å’Œé‡è¦å¯¹è¯\n2. ä½¿ç”¨ç¬¬ä¸‰äººç§°å™è¿°\n3. æ€»ç»“åº”ç®€æ´æ˜äº†ï¼Œæ§åˆ¶åœ¨ 200 å­—ä»¥å†…\n4. ä¸è¦æ·»åŠ ä»»ä½•è¯„è®ºã€åˆ†ææˆ–ä½ è‡ªå·±çš„æƒ³æ³•\n5. åªè¾“å‡ºæ€»ç»“å†…å®¹ï¼Œä¸è¦æ·»åŠ æ ‡é¢˜ã€ç¼–å·æˆ–å…¶ä»–æ ¼å¼",user:n}}(o,n);return await d(i.system,i.user,t)}async function h(e){const t=r(),n=await async function(){return(await getWorldbook(l())).filter(e=>/^\[å·\d+-æ¥¼å±‚\d+~æ¥¼å±‚\d+\]$/.test(e.name))}(),s=function(e,t){let n="";return t.length>0&&(n+="ä»¥ä¸‹æ˜¯ä¹‹å‰å„å·çš„å¤§æ€»ç»“ï¼Œä¾›ä½ äº†è§£å‰æƒ…ï¼š\n\n",t.forEach((e,t)=>{n+=`--- ç¬¬${t+1}å· ---\n${e}\n\n`}),n+="===\n\n"),n+="è¯·å°†ä»¥ä¸‹å°æ€»ç»“åˆå¹¶ä¸ºä¸€ä¸ªå®Œæ•´çš„å·æ€»ç»“ï¼š\n\n",e.forEach((e,t)=>{n+=`[${t+1}] ${e}\n\n`}),{system:"ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ•…äº‹æ€»ç»“åŠ©æ‰‹ã€‚ä½ çš„ä»»åŠ¡æ˜¯å°†ä¸€ç³»åˆ—å°æ€»ç»“åˆå¹¶ä¸ºä¸€ä¸ªå®Œæ•´çš„å·æ€»ç»“ã€‚\n\nè¦æ±‚ï¼š\n1. å°†æ‰€æœ‰å°æ€»ç»“çš„å†…å®¹æ•´åˆä¸ºè¿è´¯çš„å™è¿°\n2. ä¿ç•™ä¸»è¦æƒ…èŠ‚çº¿ã€è§’è‰²å‘å±•ã€å…³é”®äº‹ä»¶å’Œé‡è¦å¯¹è¯\n3. æŒ‰æ—¶é—´é¡ºåºç»„ç»‡å†…å®¹\n4. ä½¿ç”¨ç¬¬ä¸‰äººç§°å™è¿°\n5. æ€»ç»“åº”å…¨é¢ä½†ç²¾ç‚¼ï¼Œæ§åˆ¶åœ¨ 1000 å­—ä»¥å†…\n6. ä¸è¦æ·»åŠ ä»»ä½•è¯„è®ºã€åˆ†ææˆ–ä½ è‡ªå·±çš„æƒ³æ³•\n7. åªè¾“å‡ºæ€»ç»“å†…å®¹ï¼Œä¸è¦æ·»åŠ æ ‡é¢˜ã€ç¼–å·æˆ–å…¶ä»–æ ¼å¼",user:n}}(e.map(e=>e.content),n.sort((e,t)=>parseInt(e.name.match(/å·(\d+)/)[1])-parseInt(t.name.match(/å·(\d+)/)[1])).map(e=>e.content));return await d(s.system,s.user,t)}let y=0;async function g(t){const s=r();if(!s.auto_mini_summary)return;const a=getChatMessages(t);if(0===a.length)return;const o=a[0];if("system"!==o.role&&o.message&&""!==o.message.trim()&&!(t<s.ignore_floors))try{await async function(t){const s=l(),a=`[å°æ€»ç»“-æ¥¼å±‚${t}]`;if(!(await getWorldbook(s)).find(e=>e.name===a)){const o=r();await createWorldbookEntries(s,[{...n,name:a,content:"ï¼ˆæ€»ç»“ç”Ÿæˆä¸­...ï¼‰",position:{type:"at_depth",role:"system",depth:o.mini_summary_depth,order:e(t,o.mini_summary_start_order)}}])}}(t),await u(),await async function(){const e=r(),t=getLastMessageId();if(t<0)return;const n=getChatMessages(`0-${t}`);if(0===n.length)return;const s=t-e.visible_floors+1,a=[];for(const o of n)"system"!==o.role&&(o.message_id>=s?o.is_hidden&&a.push({message_id:o.message_id,is_hidden:!1}):o.is_hidden||a.push({message_id:o.message_id,is_hidden:!0}));a.length>0&&await setChatMessages(a,{refresh:"none"}),await u()}(),y++,function(){const e=r();return!!e.auto_volume_summary&&y%e.check_interval===0&&y>0}()&&i.enqueue({type:"volume_summary"}),i.enqueue({type:"mini_summary",message_id:t})}catch(m){console.error("[è‡ªåŠ¨æ€»ç»“] æ¶ˆæ¯å¤„ç†å¤±è´¥:",m)}}const v="hilo-auto-summary-menu";function f(){const e=$("#extensionsMenu");if(!e.length)return void setTimeout(f,2e3);$(`#${v}`,e).remove();const t=$(`\n    <div class="list-group-item flex-container flexGap5 interactable" id="${v}" title="è‡ªåŠ¨æ€»ç»“è®¾ç½®">\n      <div class="fa-fw fa-solid fa-book-open extensionsMenuExtensionButton"></div>\n      <span>è‡ªåŠ¨æ€»ç»“</span>\n    </div>\n  `);t.on("click",async t=>{t.stopPropagation();const n=$("#extensionsMenuButton");n.length&&e.is(":visible")&&(n.trigger("click"),await new Promise(e=>setTimeout(e,150))),await async function(){const e=a(),t=function(e){return`\n    <div id="hilo-summary-settings" style="padding: 10px; max-height: 70vh; overflow-y: auto;">\n      <h3 style="margin-top: 0;">ğŸ“– è‡ªåŠ¨æ€»ç»“è®¾ç½®</h3>\n\n      \x3c!-- åŸºæœ¬è®¾ç½® --\x3e\n      <div style="margin-bottom: 15px;">\n        <h4>åŸºæœ¬è®¾ç½®</h4>\n        <div style="margin-bottom: 8px;">\n          <label>æ˜¾ç¤ºæ¥¼å±‚æ•°ï¼š</label>\n          <input type="number" id="hs-visible-floors" value="${e.visible_floors}" min="1" max="100" style="width: 80px;" />\n          <small style="color: #888;">ï¼ˆæœ€è¿‘ä¿ç•™å¤šå°‘æ¥¼å¯è§ï¼‰</small>\n        </div>\n        <div style="margin-bottom: 8px;">\n          <label>æ£€æŸ¥é—´éš”ï¼š</label>\n          <input type="number" id="hs-check-interval" value="${e.check_interval}" min="5" max="100" style="width: 80px;" />\n          <small style="color: #888;">ï¼ˆæ¯å¤šå°‘ä¸ªå°æ€»ç»“æ£€æŸ¥ä¸€æ¬¡å¤§æ€»ç»“ï¼‰</small>\n        </div>\n        <div style="margin-bottom: 8px;">\n          <label>Token é˜ˆå€¼ï¼š</label>\n          <input type="number" id="hs-volume-token-threshold" value="${e.volume_token_threshold}" min="1000" max="50000" style="width: 100px;" />\n          <small style="color: #888;">ï¼ˆå¤§æ€»ç»“è§¦å‘é˜ˆå€¼ï¼‰</small>\n        </div>\n        <div style="margin-bottom: 8px;">\n          <label>\n            <input type="checkbox" id="hs-auto-mini-summary" ${e.auto_mini_summary?"checked":""} />\n            è‡ªåŠ¨å°æ€»ç»“\n          </label>\n        </div>\n        <div style="margin-bottom: 8px;">\n          <label>\n            <input type="checkbox" id="hs-auto-volume-summary" ${e.auto_volume_summary?"checked":""} />\n            è‡ªåŠ¨å¤§æ€»ç»“\n          </label>\n        </div>\n        <div style="margin-bottom: 8px;">\n          <label>å°æ€»ç»“æ³¨å…¥æ·±åº¦ï¼š</label>\n          <input type="number" id="hs-mini-summary-depth" value="${e.mini_summary_depth}" min="0" max="99999" style="width: 100px;" />\n          <small style="color: #888;">ï¼ˆé»˜è®¤ 9999ï¼‰</small>\n        </div>\n        <div style="margin-bottom: 8px;">\n          <label>å·æ€»ç»“æ³¨å…¥æ·±åº¦ï¼š</label>\n          <input type="number" id="hs-volume-summary-depth" value="${e.volume_summary_depth}" min="0" max="99999" style="width: 100px;" />\n          <small style="color: #888;">ï¼ˆé»˜è®¤ 9999ï¼‰</small>\n        </div>\n        <div style="margin-bottom: 8px;">\n          <label>å°æ€»ç»“èµ·å§‹æ’åºï¼š</label>\n          <input type="number" id="hs-mini-start-order" value="${e.mini_summary_start_order}" min="0" max="99999" style="width: 100px;" />\n          <small style="color: #888;">ï¼ˆå°æ€»ç»“ order åŸºæ•°ï¼Œé»˜è®¤ 10000ï¼‰</small>\n        </div>\n        <div style="margin-bottom: 8px;">\n          <label>å·æ€»ç»“èµ·å§‹æ’åºï¼š</label>\n          <input type="number" id="hs-volume-start-order" value="${e.volume_start_order}" min="0" max="99999" style="width: 100px;" />\n          <small style="color: #888;">ï¼ˆå·æ€»ç»“ order åŸºæ•°ï¼Œé»˜è®¤ 100ï¼‰</small>\n        </div>\n        <div style="margin-bottom: 8px;">\n          <label>å¿½ç•¥å‰ N å±‚ï¼š</label>\n          <input type="number" id="hs-ignore-floors" value="${e.ignore_floors}" min="0" max="1000" style="width: 80px;" />\n          <small style="color: #888;">ï¼ˆè·³è¿‡å‰å¤šå°‘å±‚ä¸è¿›è¡Œæ€»ç»“ï¼‰</small>\n        </div>\n      </div>\n\n      \x3c!-- æ‰‹åŠ¨æ“ä½œ --\x3e\n      <div style="margin-bottom: 15px;">\n        <h4>æ‰‹åŠ¨æ“ä½œ</h4>\n        <div style="display: flex; gap: 8px;">\n          <button id="hs-manual-mini" class="menu_button">æ‰‹åŠ¨æ€»ç»“</button>\n          <button id="hs-manual-volume" class="menu_button">æ‰‹åŠ¨å½’æ¡£</button>\n        </div>\n      </div>\n\n      \x3c!-- è‡ªå®šä¹‰ API --\x3e\n      <details style="margin-bottom: 15px;">\n        <summary><h4 style="display: inline;">è‡ªå®šä¹‰ API</h4></summary>\n        <div style="padding: 8px 0;">\n          <div style="margin-bottom: 8px;">\n            <label>\n              <input type="checkbox" id="hs-custom-api-enabled" ${e.custom_api.enabled?"checked":""} />\n              å¯ç”¨è‡ªå®šä¹‰ API\n            </label>\n          </div>\n          <div style="margin-bottom: 8px;">\n            <label>API URLï¼š</label>\n            <input type="text" id="hs-custom-api-url" value="${x(e.custom_api.apiurl)}" style="width: 100%;" placeholder="https://api.example.com/v1" />\n          </div>\n          <div style="margin-bottom: 8px;">\n            <label>API Keyï¼š</label>\n            <input type="password" id="hs-custom-api-key" value="${x(e.custom_api.key)}" style="width: 100%;" placeholder="sk-..." />\n          </div>\n          <div style="margin-bottom: 8px;">\n            <label>æ¨¡å‹åç§°ï¼š</label>\n            <input type="text" id="hs-custom-api-model" value="${x(e.custom_api.model)}" style="width: 100%;" placeholder="gpt-4" />\n          </div>\n          <div style="margin-bottom: 8px;">\n            <label>API æºï¼š</label>\n            <select id="hs-custom-api-source" style="width: 100%;">\n              ${["openai"].map(t=>`<option value="${t}" ${e.custom_api.source===t?"selected":""}>${t}</option>`).join("")}\n            </select>\n          </div>\n        </div>\n      </details>\n\n      \x3c!-- æ¶ˆæ¯æ¸…æ´— --\x3e\n      <details style="margin-bottom: 15px;">\n        <summary><h4 style="display: inline;">æ¶ˆæ¯æ¸…æ´—æ­£åˆ™</h4></summary>\n        <div style="padding: 8px 0;">\n          <div id="hs-regex-list">\n            ${e.message_cleanup_regex.map((e,t)=>b(e,t)).join("")}\n          </div>\n          <button id="hs-add-regex" class="menu_button" style="margin-top: 5px;">+ æ·»åŠ æ­£åˆ™</button>\n        </div>\n      </details>\n    </div>\n  `}(e),n=$(t),s=$('<div id="hilo-summary-overlay" style="\n    position: fixed; top: 0; left: 0; right: 0; bottom: 0;\n    background: rgba(0,0,0,0.6); z-index: 9998;\n    display: flex; justify-content: center; align-items: center;\n  "></div>'),r=$('<div style="\n    background: var(--SmartThemeBlurTintColor, #2b2b2b);\n    border: 1px solid var(--SmartThemeBorderColor, #555);\n    border-radius: 10px; padding: 20px; min-width: 400px;\n    max-width: 600px; max-height: 80vh; overflow-y: auto;\n    color: var(--SmartThemeBodyColor, #ccc);\n  "></div>'),l=$('<div style="display: flex; justify-content: flex-end; gap: 8px; margin-top: 15px;">\n    <button id="hs-cancel" class="menu_button">å–æ¶ˆ</button>\n    <button id="hs-save" class="menu_button">ä¿å­˜</button>\n  </div>');r.append(n).append(l),s.append(r),$("body").append(s),s.on("click","#hs-cancel",()=>{s.remove()}),s.on("click","#hs-save",()=>{const e=function(){const e=$(".hs-regex-row"),t=[];return e.each(function(){const e=$(this),n=e.find(".hs-regex-pattern").val();n&&t.push({pattern:n,flags:e.find(".hs-regex-flags").val()||"g",replacement:e.find(".hs-regex-replacement").val()||""})}),{visible_floors:parseInt($("#hs-visible-floors").val())||20,check_interval:parseInt($("#hs-check-interval").val())||20,volume_token_threshold:parseInt($("#hs-volume-token-threshold").val())||8e3,auto_mini_summary:$("#hs-auto-mini-summary").is(":checked"),auto_volume_summary:$("#hs-auto-volume-summary").is(":checked"),mini_summary_depth:parseInt($("#hs-mini-summary-depth").val())||9999,volume_summary_depth:parseInt($("#hs-volume-summary-depth").val())||9999,mini_summary_start_order:parseInt($("#hs-mini-start-order").val())||1e4,volume_start_order:parseInt($("#hs-volume-start-order").val())||100,ignore_floors:parseInt($("#hs-ignore-floors").val())||0,custom_api:{enabled:$("#hs-custom-api-enabled").is(":checked"),apiurl:$("#hs-custom-api-url").val()||"",key:$("#hs-custom-api-key").val()||"",model:$("#hs-custom-api-model").val()||"",source:$("#hs-custom-api-source").val()||"openai"},message_cleanup_regex:t}}();o({...a(),...e}),toastr.success("è®¾ç½®å·²ä¿å­˜"),s.remove()}),s.on("click","#hs-manual-mini",()=>{const e=getLastMessageId();e>=0?(i.enqueue({type:"mini_summary",message_id:e}),toastr.info(`å·²å°†æ¥¼å±‚ ${e} çš„å°æ€»ç»“ä»»åŠ¡åŠ å…¥é˜Ÿåˆ—`)):toastr.warning("å½“å‰æ²¡æœ‰èŠå¤©æ¶ˆæ¯")}),s.on("click","#hs-manual-volume",()=>{i.enqueue({type:"volume_summary"}),toastr.info("å·²å°†å¤§æ€»ç»“ä»»åŠ¡åŠ å…¥é˜Ÿåˆ—")});let m=e.message_cleanup_regex.length;s.on("click","#hs-add-regex",()=>{const e=b({pattern:"",flags:"g",replacement:""},m++);$("#hs-regex-list").append(e)}),s.on("click",".hs-remove-regex",function(){$(this).closest(".hs-regex-row").remove()}),s.on("click",e=>{e.target===s[0]&&s.remove()})}()}),e.append(t)}function b(e,t){return`\n    <div class="hs-regex-row" data-index="${t}" style="display: flex; gap: 5px; margin-bottom: 5px; align-items: center;">\n      <input type="text" class="hs-regex-pattern" value="${x(e.pattern)}" placeholder="æ­£åˆ™" style="flex: 3;" />\n      <input type="text" class="hs-regex-flags" value="${x(e.flags)}" placeholder="flags" style="flex: 1; max-width: 60px;" />\n      <input type="text" class="hs-regex-replacement" value="${x(e.replacement)}" placeholder="æ›¿æ¢" style="flex: 2;" />\n      <button class="hs-remove-regex menu_button" style="flex: 0 0 auto; padding: 2px 8px;">âœ•</button>\n    </div>\n  `}function x(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}i.setHandlers({mini_summary:async function(t){const s=await p(t);await async function(t,s){const a=l(),o=`[å°æ€»ç»“-æ¥¼å±‚${t}]`;if((await getWorldbook(a)).find(e=>e.name===o))await updateWorldbookWith(a,e=>{const t=e.find(e=>e.name===o);return t&&(t.content=s),e});else{const i=r();await createWorldbookEntries(a,[{...n,name:o,content:s,position:{type:"at_depth",role:"system",depth:i.mini_summary_depth,order:e(t,i.mini_summary_start_order)}}])}}(t,s);const i=a();i.last_processed_message_id=t,o(i)},volume_summary:async function(){const e=a(),s=await m();if(0===s.length)return;if(!(await async function(){const e=r(),t=await m();if(0===t.length)return!1;if(t.map(e=>e.content).join("").length>e.volume_token_threshold)return!0;try{const n=function(e){let t="ä»¥ä¸‹æ˜¯æœ€è¿‘ä¸€æ®µæ—¶é—´çš„å°æ€»ç»“åºåˆ—ï¼š\n\n";return e.forEach((e,n)=>{t+=`[${n+1}] ${e}\n\n`}),t+="è¯·åˆ¤æ–­ä»¥ä¸Šå†…å®¹æ˜¯å¦å·²ç»åˆ°äº†ä¸€ä¸ªè‡ªç„¶çš„æ®µè½ç»“å°¾ï¼Ÿ",{system:'ä½ æ˜¯ä¸€ä¸ªæ•…äº‹åˆ†æåŠ©æ‰‹ã€‚æ ¹æ®ä»¥ä¸‹æ€»ç»“å†…å®¹ï¼Œåˆ¤æ–­å½“å‰è¿™ä¸€å·æ•…äº‹æ˜¯å¦å·²ç»è¾¾åˆ°äº†ä¸€ä¸ªè‡ªç„¶çš„æ®µè½ç»“å°¾ï¼ˆå¦‚ï¼šä¸€ä¸ªç« èŠ‚ç»“æŸã€ä¸€ä¸ªäº‹ä»¶å‘Šä¸€æ®µè½ã€åœºæ™¯å¤§å¹…è½¬æ¢ç­‰ï¼‰ã€‚\n\nåªéœ€å›ç­”"114514"æˆ–"1919810"ï¼Œä¸è¦åšä»»ä½•è§£é‡Šã€‚\n- å›ç­”"114514"è¡¨ç¤ºè¿™ä¸€å·å·²ç»åˆ°äº†ä¸€ä¸ªåˆé€‚çš„æ–­ç‚¹ï¼Œå¯ä»¥å½’æ¡£\n- å›ç­”"1919810"è¡¨ç¤ºæ•…äº‹ä»åœ¨è¿›è¡Œä¸­ï¼Œä¸é€‚åˆåœ¨è¿™é‡Œæ–­å¼€',user:t}}(t.map(e=>e.content)),s=await d(n.system,n.user,e);return!!s.includes("114514")||(s.includes("1919810")||console.warn("[è‡ªåŠ¨æ€»ç»“] å·å®Œç»“æ£€æµ‹è¿”å›äº†æ„å¤–å†…å®¹:",s),!1)}catch(n){return console.error("[è‡ªåŠ¨æ€»ç»“] å·å®Œç»“æ£€æµ‹å¤±è´¥:",n),!1}}()))return;const i=s.map(e=>parseInt(e.name.match(/æ¥¼å±‚(\d+)/)[1])).sort((e,t)=>e-t),u=i[0],c=i[i.length-1],p=await h(s);await async function(e,s,i,m){const u=l(),c=`[å·${e}-æ¥¼å±‚${s}~æ¥¼å±‚${i}]`;await updateWorldbookWith(u,a=>{for(const e of a){const t=e.name.match(/^\[å°æ€»ç»“-æ¥¼å±‚(\d+)\]$/);if(!t)continue;const n=parseInt(t[1]);n>=s&&n<=i&&(e.enabled=!1)}const o=r();return a.push({...n,enabled:!0,name:c,content:m,position:{type:"at_depth",role:"system",depth:o.volume_summary_depth,order:t(e,o.volume_start_order)}}),a});const d=a();d.current_volume=e+1,d.volumes.push({volume:e,start_message_id:s,end_message_id:i}),o(d)}(e.current_volume,u,c,p),console.log(`[è‡ªåŠ¨æ€»ç»“] å·²å½’æ¡£å·${e.current_volume}: æ¥¼å±‚${u}~æ¥¼å±‚${c}`)}}),$(()=>{(async()=>{try{a();console.log("[è‡ªåŠ¨æ€»ç»“] è„šæœ¬å˜é‡å·²åŠ è½½");const e=getCurrentCharacterName();if(!e)return void console.log("[è‡ªåŠ¨æ€»ç»“] æœªæ‰“å¼€è§’è‰²å¡ï¼Œè„šæœ¬ä¸æ‰§è¡Œ");console.log(`[è‡ªåŠ¨æ€»ç»“] å½“å‰è§’è‰²å¡: ${e}`),await async function(){const e=l(),t=getGlobalWorldbookNames().filter(t=>!t.endsWith("[è‡ªåŠ¨æ€»ç»“]")||t===e);t.includes(e)||t.push(e),await rebindGlobalWorldbooks(t)}(),await async function(){const e=l();getWorldbookNames().includes(e)||(await createWorldbook(e,[]),console.log(`[è‡ªåŠ¨æ€»ç»“] å·²åˆ›å»ºä¸–ç•Œä¹¦: ${e}`))}(),await u(),f(),eventOn(tavern_events.MESSAGE_RECEIVED,errorCatched(e=>{g(e)})),function(){let e=SillyTavern.getCurrentChatId();eventOn(tavern_events.CHAT_CHANGED,t=>{e!==t&&(e=t,window.location.reload())})}(),console.log("[è‡ªåŠ¨æ€»ç»“] åˆå§‹åŒ–å®Œæˆ")}catch(e){console.error("[è‡ªåŠ¨æ€»ç»“] åˆå§‹åŒ–å¤±è´¥:",e)}})()});
