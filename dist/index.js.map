{"version":3,"file":"index.js","sources":["../src/config.ts","../src/queue.ts","../src/worldbook.ts","../src/summary.ts","../src/prompts.ts","../src/trigger.ts","../src/chat-manager.ts","../src/ui.ts","../src/index.ts"],"sourcesContent":["/**\n * è®¾ç½®å’Œå…ƒæ•°æ®ç®¡ç†\n * - Zod schema å®šä¹‰ï¼ˆåˆå¹¶ç”¨æˆ·è®¾ç½® + è¿è¡Œæ—¶å…ƒæ•°æ®ï¼‰\n * - è„šæœ¬å˜é‡è¯»å†™\n * - æ¡ç›®é…ç½®å¸¸é‡\n */\n\nimport type { PartialDeep } from 'type-fest';\n\n// ========== å¸¸é‡ ==========\n\n/** æ ¹æ®æ¥¼å±‚ ID è®¡ç®—å°æ€»ç»“æ¡ç›®çš„ order å€¼ */\nexport function getMiniSummaryOrder(message_id: number, base: number): number {\n  return base + message_id;\n}\n\n/** æ ¹æ®å·å·è®¡ç®—å·æ¡ç›®çš„ order å€¼ */\nexport function getVolumeOrder(volume: number, base: number): number {\n  return base + volume;\n}\n\n// ========== æ¡ç›®é»˜è®¤é…ç½® ==========\n\n/** åŸºç¡€æ¡ç›®é»˜è®¤é…ç½®ï¼ˆä¸å« positionï¼Œç”±è°ƒç”¨æ–¹æ ¹æ®è®¾ç½®åŠ¨æ€æŒ‡å®šï¼‰ */\nexport const ENTRY_DEFAULTS: PartialDeep<WorldbookEntry> = {\n  enabled: false,\n  strategy: {\n    type: 'constant',\n    keys: [],\n    keys_secondary: { logic: 'and_any', keys: [] },\n    scan_depth: 'same_as_global',\n  },\n  probability: 100,\n  recursion: { prevent_incoming: true, prevent_outgoing: true, delay_until: null },\n  effect: { sticky: null, cooldown: null, delay: null },\n};\n\n// ========== Zod Schema ==========\n\n/** è„šæœ¬æ•°æ® schemaï¼šåˆå¹¶ç”¨æˆ·è®¾ç½® + è¿è¡Œæ—¶å…ƒæ•°æ® */\nexport const ScriptData = z\n  .object({\n    // === ç”¨æˆ·è®¾ç½® ===\n    /** æœ€è¿‘ä¿ç•™æ˜¾ç¤ºçš„æ¥¼å±‚æ•° */\n    visible_floors: z.coerce\n      .number()\n      .transform(v => _.clamp(v, 1, 100))\n      .prefault(20),\n    /** æ¯å¤šå°‘ä¸ªå°æ€»ç»“è§¦å‘ä¸€æ¬¡å¤§æ€»ç»“æ£€æŸ¥ */\n    check_interval: z.coerce\n      .number()\n      .transform(v => _.clamp(v, 5, 100))\n      .prefault(20),\n    /** å¤§æ€»ç»“ token é˜ˆå€¼ */\n    volume_token_threshold: z.coerce\n      .number()\n      .transform(v => _.clamp(v, 1000, 50000))\n      .prefault(8000),\n    /** æ˜¯å¦å¯ç”¨è‡ªåŠ¨å°æ€»ç»“ */\n    auto_mini_summary: z.boolean().prefault(true),\n    /** æ˜¯å¦å¯ç”¨è‡ªåŠ¨å¤§æ€»ç»“ */\n    auto_volume_summary: z.boolean().prefault(true),\n    /** å°æ€»ç»“æ³¨å…¥æ·±åº¦ï¼ˆat_depthï¼‰ */\n    mini_summary_depth: z.coerce\n      .number()\n      .transform(v => _.clamp(v, 0, 99999))\n      .prefault(9999),\n    /** å·æ€»ç»“æ³¨å…¥æ·±åº¦ï¼ˆat_depthï¼‰ */\n    volume_summary_depth: z.coerce\n      .number()\n      .transform(v => _.clamp(v, 0, 99999))\n      .prefault(9999),\n    /** å°æ€»ç»“èµ·å§‹æ’åº order åŸºæ•° */\n    mini_summary_start_order: z.coerce\n      .number()\n      .transform(v => _.clamp(v, 0, 99999))\n      .prefault(10000),\n    /** å·æ€»ç»“èµ·å§‹æ’åº order åŸºæ•° */\n    volume_start_order: z.coerce\n      .number()\n      .transform(v => _.clamp(v, 0, 99999))\n      .prefault(100),\n    /** å¿½ç•¥å‰å¤šå°‘å±‚æ¶ˆæ¯ä¸è¿›è¡Œæ€»ç»“ */\n    ignore_floors: z.coerce\n      .number()\n      .transform(v => _.clamp(v, 0, 1000))\n      .prefault(0),\n    /** è‡ªå®šä¹‰ API é…ç½® */\n    custom_api: z\n      .object({\n        enabled: z.boolean().prefault(false),\n        apiurl: z.string().prefault(''),\n        key: z.string().prefault(''),\n        model: z.string().prefault(''),\n        source: z.string().prefault('openai'),\n      })\n      .prefault({}),\n    /** æ¶ˆæ¯æ¸…æ´—æ­£åˆ™åˆ—è¡¨ */\n    message_cleanup_regex: z\n      .array(\n        z.object({\n          pattern: z.string(),\n          flags: z.string().prefault('g'),\n          replacement: z.string().prefault(''),\n        })\n      )\n      .prefault([]),\n    /** å†…å®¹æ•è·æ ‡ç­¾ï¼ˆä»…æ€»ç»“ç”±è¯¥æ ‡ç­¾åŒ…è£¹çš„å†…å®¹ï¼Œä¸ºç©ºåˆ™æ€»ç»“å…¨éƒ¨å†…å®¹ï¼‰ */\n    capture_tag: z.string().prefault(''),\n\n    // === è¿è¡Œæ—¶å…ƒæ•°æ® ===\n    /** å½“å‰å·å· */\n    current_volume: z.coerce.number().prefault(1),\n    /** ä¸Šæ¬¡å¤„ç†åˆ°çš„æ¥¼å±‚ ID */\n    last_processed_message_id: z.coerce.number().prefault(-1),\n    /** å·²å½’æ¡£çš„å·ä¿¡æ¯ */\n    volumes: z\n      .array(\n        z.object({\n          volume: z.coerce.number(),\n          start_message_id: z.coerce.number(),\n          end_message_id: z.coerce.number(),\n        })\n      )\n      .prefault([]),\n  })\n  .prefault({});\n\nexport type ScriptDataType = z.output<typeof ScriptData>;\n\n// ========== è„šæœ¬å˜é‡è¯»å†™ ==========\n\n/** è·å–è„šæœ¬æ•°æ®ï¼ˆè®¾ç½® + å…ƒæ•°æ®ï¼‰ */\nexport function getScriptData(): ScriptDataType {\n  const raw = getVariables({ type: 'script' });\n  return ScriptData.parse(raw);\n}\n\n/** ä¿å­˜è„šæœ¬æ•°æ® */\nexport function saveScriptData(data: ScriptDataType): void {\n  replaceVariables(data as Record<string, any>, { type: 'script' });\n}\n\n/** è·å–è®¾ç½®ï¼ˆScriptData çš„åˆ«åï¼Œæ–¹ä¾¿è¯­ä¹‰ä½¿ç”¨ï¼‰ */\nexport function getSettings(): ScriptDataType {\n  return getScriptData();\n}\n","/**\n * ä»»åŠ¡é˜Ÿåˆ—\n * - ä¸²è¡Œå¤„ç†æ€»ç»“ä»»åŠ¡ï¼Œé¿å…å¹¶å‘å†²çª\n * - åŒä¸€æ¥¼å±‚çš„å°æ€»ç»“ä»»åŠ¡å»é‡\n */\n\nexport type TaskType = 'mini_summary' | 'volume_summary';\n\nexport type SummaryTask = {\n  type: TaskType;\n  message_id?: number;\n};\n\ntype TaskHandler = {\n  mini_summary: (message_id: number) => Promise<void>;\n  volume_summary: () => Promise<void>;\n};\n\nexport class TaskQueue {\n  private queue: SummaryTask[] = [];\n  private processing = false;\n  private handlers: TaskHandler | null = null;\n\n  /** æ³¨å†Œä»»åŠ¡å¤„ç†å‡½æ•° */\n  setHandlers(handlers: TaskHandler): void {\n    this.handlers = handlers;\n  }\n\n  /** å°†ä»»åŠ¡åŠ å…¥é˜Ÿåˆ— */\n  enqueue(task: SummaryTask): void {\n    // å»é‡ï¼šåŒä¸€æ¥¼å±‚çš„å°æ€»ç»“ä»»åŠ¡åªä¿ç•™æœ€æ–°çš„\n    if (task.type === 'mini_summary' && task.message_id !== undefined) {\n      this.queue = this.queue.filter(\n        t => !(t.type === 'mini_summary' && t.message_id === task.message_id)\n      );\n    }\n    this.queue.push(task);\n    void this.processNext();\n  }\n\n  /** ä¾æ¬¡å¤„ç†é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ */\n  private async processNext(): Promise<void> {\n    if (this.processing || this.queue.length === 0) return;\n    this.processing = true;\n\n    try {\n      const task = this.queue.shift()!;\n      if (!this.handlers) {\n        console.error('[è‡ªåŠ¨æ€»ç»“] ä»»åŠ¡å¤„ç†å‡½æ•°æœªæ³¨å†Œ');\n        return;\n      }\n\n      if (task.type === 'mini_summary' && task.message_id !== undefined) {\n        await this.handlers.mini_summary(task.message_id);\n      } else if (task.type === 'volume_summary') {\n        await this.handlers.volume_summary();\n      }\n    } catch (e) {\n      console.error('[è‡ªåŠ¨æ€»ç»“] æ€»ç»“ä»»åŠ¡æ‰§è¡Œå¤±è´¥:', e);\n    } finally {\n      this.processing = false;\n      if (this.queue.length > 0) {\n        await this.processNext();\n      }\n    }\n  }\n}\n\n/** å…¨å±€ä»»åŠ¡é˜Ÿåˆ—å®ä¾‹ */\nexport const taskQueue = new TaskQueue();\n","/**\n * ä¸–ç•Œä¹¦æ“ä½œ\n * - åˆ›å»º/è¯»/å†™/åˆ‡æ¢/åŒæ­¥ enabled\n * - å°æ€»ç»“æ¡ç›®ç®¡ç†\n * - å·æ¡ç›®ç®¡ç†\n */\n\nimport {\n  getScriptData,\n  getSettings,\n  saveScriptData,\n  getMiniSummaryOrder,\n  getVolumeOrder,\n  ENTRY_DEFAULTS,\n} from '@/config';\n\n// ========== ä¸–ç•Œä¹¦åç§° ==========\n\n/** è¿”å›å½“å‰è§’è‰²å¡çš„æ€»ç»“ä¸–ç•Œä¹¦åç§° */\nexport function getWorldbookName(): string {\n  const charName = getCurrentCharacterName();\n  if (!charName) {\n    throw new Error('[è‡ªåŠ¨æ€»ç»“] æœªæ‰“å¼€è§’è‰²å¡ï¼Œæ— æ³•è·å–ä¸–ç•Œä¹¦åç§°');\n  }\n  return `${charName}[è‡ªåŠ¨æ€»ç»“]`;\n}\n\n// ========== ä¸–ç•Œä¹¦ç”Ÿå‘½å‘¨æœŸ ==========\n\n/** ç¡®ä¿å½“å‰è§’è‰²å¡çš„æ€»ç»“ä¸–ç•Œä¹¦å­˜åœ¨ï¼Œä¸å­˜åœ¨åˆ™åˆ›å»º */\nexport async function ensureWorldbook(): Promise<void> {\n  const name = getWorldbookName();\n  const existingNames = getWorldbookNames();\n  if (!existingNames.includes(name)) {\n    await createWorldbook(name, []);\n    console.log(`[è‡ªåŠ¨æ€»ç»“] å·²åˆ›å»ºä¸–ç•Œä¹¦: ${name}`);\n  }\n}\n\n/**\n * ä»å…¨å±€ä¸–ç•Œä¹¦åˆ—è¡¨ä¸­ç§»é™¤å…¶ä»–è§’è‰²å¡çš„æ€»ç»“ä¸–ç•Œä¹¦ï¼Œç¡®ä¿å½“å‰è§’è‰²å¡çš„åœ¨åˆ—è¡¨ä¸­\n */\nexport async function switchToCurrentCharWorldbook(): Promise<void> {\n  const currentName = getWorldbookName();\n  const globalBooks = getGlobalWorldbookNames();\n  // è¿‡æ»¤æ‰å…¶ä»–è§’è‰²å¡çš„[è‡ªåŠ¨æ€»ç»“]ä¸–ç•Œä¹¦ï¼Œä¿ç•™å½“å‰çš„\n  const filtered = globalBooks.filter(name => !name.endsWith('[è‡ªåŠ¨æ€»ç»“]') || name === currentName);\n  if (!filtered.includes(currentName)) {\n    filtered.push(currentName);\n  }\n  await rebindGlobalWorldbooks(filtered);\n}\n\n// ========== å°æ€»ç»“æ¡ç›®æ“ä½œ ==========\n\n/** è·å–æŒ‡å®šæ¥¼å±‚çš„å°æ€»ç»“æ¡ç›® */\nexport async function getMiniSummaryEntry(message_id: number): Promise<WorldbookEntry | undefined> {\n  const worldbook = await getWorldbook(getWorldbookName());\n  const entryName = `[å°æ€»ç»“-æ¥¼å±‚${message_id}]`;\n  return worldbook.find(e => e.name === entryName);\n}\n\n/** åˆ›å»ºæˆ–æ›¿æ¢æŒ‡å®šæ¥¼å±‚çš„å°æ€»ç»“æ¡ç›® */\nexport async function upsertMiniSummaryEntry(message_id: number, content: string): Promise<void> {\n  const worldbookName = getWorldbookName();\n  const entryName = `[å°æ€»ç»“-æ¥¼å±‚${message_id}]`;\n\n  const worldbook = await getWorldbook(worldbookName);\n  const existing = worldbook.find(e => e.name === entryName);\n\n  if (existing) {\n    // å·²å­˜åœ¨åˆ™æ›¿æ¢ content\n    await updateWorldbookWith(worldbookName, wb => {\n      const entry = wb.find(e => e.name === entryName);\n      if (entry) {\n        entry.content = content;\n      }\n      return wb;\n    });\n  } else {\n    // ä¸å­˜åœ¨åˆ™æ–°å»º\n    const settings = getSettings();\n    await createWorldbookEntries(worldbookName, [\n      {\n        ...ENTRY_DEFAULTS,\n        name: entryName,\n        content,\n        position: {\n          type: 'at_depth',\n          role: 'system',\n          depth: settings.mini_summary_depth,\n          order: getMiniSummaryOrder(message_id, settings.mini_summary_start_order),\n        },\n      },\n    ]);\n  }\n}\n\n/** åˆ›å»ºç©ºå ä½å°æ€»ç»“æ¡ç›®ï¼ˆåŒæ­¥é˜¶æ®µä½¿ç”¨ï¼‰ */\nexport async function createPlaceholderMiniSummary(message_id: number): Promise<void> {\n  const worldbookName = getWorldbookName();\n  const entryName = `[å°æ€»ç»“-æ¥¼å±‚${message_id}]`;\n\n  const worldbook = await getWorldbook(worldbookName);\n  const existing = worldbook.find(e => e.name === entryName);\n\n  if (!existing) {\n    const settings = getSettings();\n    await createWorldbookEntries(worldbookName, [\n      {\n        ...ENTRY_DEFAULTS,\n        name: entryName,\n        content: 'ï¼ˆæ€»ç»“ç”Ÿæˆä¸­...ï¼‰',\n        position: {\n          type: 'at_depth',\n          role: 'system',\n          depth: settings.mini_summary_depth,\n          order: getMiniSummaryOrder(message_id, settings.mini_summary_start_order),\n        },\n      },\n    ]);\n  }\n}\n\n/** è·å–æ‰€æœ‰æœªå½’æ¡£ï¼ˆéå·è¦†ç›–èŒƒå›´å†…ï¼‰çš„å°æ€»ç»“æ¡ç›® */\nexport async function getUnarchivedMiniSummaries(): Promise<WorldbookEntry[]> {\n  const worldbook = await getWorldbook(getWorldbookName());\n  const metadata = getScriptData();\n\n  // æ”¶é›†å·²å½’æ¡£çš„æ¥¼å±‚ ID\n  const archivedIds = new Set<number>();\n  for (const vol of metadata.volumes) {\n    for (let id = vol.start_message_id; id <= vol.end_message_id; id++) {\n      archivedIds.add(id);\n    }\n  }\n\n  return worldbook.filter(entry => {\n    const match = entry.name.match(/^\\[å°æ€»ç»“-æ¥¼å±‚(\\d+)\\]$/);\n    if (!match) return false;\n    const id = parseInt(match[1]);\n    return !archivedIds.has(id);\n  });\n}\n\n// ========== enabled åŒæ­¥ ==========\n\n/** æ ¹æ®æ¥¼å±‚å¯è§æ€§å’Œå½’æ¡£çŠ¶æ€åŒæ­¥æ‰€æœ‰å°æ€»ç»“çš„ enabled */\nexport async function syncMiniSummaryEnabled(): Promise<void> {\n  const settings = getSettings();\n  const lastId = getLastMessageId();\n  const visibleThreshold = lastId - settings.visible_floors + 1;\n  const metadata = getScriptData();\n\n  // æ”¶é›†å·²å½’æ¡£çš„æ¥¼å±‚ ID èŒƒå›´\n  const archivedIds = new Set<number>();\n  for (const vol of metadata.volumes) {\n    for (let id = vol.start_message_id; id <= vol.end_message_id; id++) {\n      archivedIds.add(id);\n    }\n  }\n\n  await updateWorldbookWith(getWorldbookName(), worldbook => {\n    for (const entry of worldbook) {\n      const match = entry.name.match(/^\\[å°æ€»ç»“-æ¥¼å±‚(\\d+)\\]$/);\n      if (!match) continue;\n      const id = parseInt(match[1]);\n\n      if (id >= visibleThreshold) {\n        // å¯è§æ¥¼å±‚ â†’ ä¸æ³¨å…¥\n        entry.enabled = false;\n      } else if (archivedIds.has(id)) {\n        // å·²å½’æ¡£ â†’ ä¸æ³¨å…¥\n        entry.enabled = false;\n      } else {\n        // å·²éšè—ä¸”æœªå½’æ¡£ â†’ æ³¨å…¥\n        entry.enabled = true;\n      }\n    }\n    return worldbook;\n  });\n}\n\n// ========== å·æ¡ç›®æ“ä½œ ==========\n\n/** åˆ›å»ºå·æ¡ç›®å¹¶å…³é—­å¯¹åº”èŒƒå›´å†…çš„å°æ€»ç»“ */\nexport async function createVolumeEntry(\n  volume: number,\n  start_id: number,\n  end_id: number,\n  content: string\n): Promise<void> {\n  const worldbookName = getWorldbookName();\n  const entryName = `[å·${volume}-æ¥¼å±‚${start_id}~æ¥¼å±‚${end_id}]`;\n\n  await updateWorldbookWith(worldbookName, worldbook => {\n    // 1. å…³é—­è¯¥èŒƒå›´å†…çš„å°æ€»ç»“æ¡ç›®\n    for (const entry of worldbook) {\n      const match = entry.name.match(/^\\[å°æ€»ç»“-æ¥¼å±‚(\\d+)\\]$/);\n      if (!match) continue;\n      const id = parseInt(match[1]);\n      if (id >= start_id && id <= end_id) {\n        entry.enabled = false;\n      }\n    }\n\n    // 2. æ·»åŠ å·æ¡ç›®\n    const settings = getSettings();\n    worldbook.push({\n      ...ENTRY_DEFAULTS,\n      enabled: true,\n      name: entryName,\n      content,\n      position: {\n        type: 'at_depth',\n        role: 'system',\n        depth: settings.volume_summary_depth,\n        order: getVolumeOrder(volume, settings.volume_start_order),\n      },\n    } as WorldbookEntry);\n\n    return worldbook;\n  });\n\n  // 3. æ›´æ–°è„šæœ¬å˜é‡å…ƒæ•°æ®\n  const data = getScriptData();\n  data.current_volume = volume + 1;\n  data.volumes.push({ volume, start_message_id: start_id, end_message_id: end_id });\n  saveScriptData(data);\n}\n\n/** è·å–æ‰€æœ‰å·²æœ‰å·æ¡ç›® */\nexport async function getVolumes(): Promise<WorldbookEntry[]> {\n  const worldbook = await getWorldbook(getWorldbookName());\n  return worldbook.filter(entry => /^\\[å·\\d+-æ¥¼å±‚\\d+~æ¥¼å±‚\\d+\\]$/.test(entry.name));\n}\n","/**\n * æ€»ç»“æ ¸å¿ƒé€»è¾‘\n * - æ¶ˆæ¯æ¸…æ´—\n * - å°æ€»ç»“ç”Ÿæˆ\n * - å¤§æ€»ç»“ç”Ÿæˆ\n * - å¤§æ€»ç»“è§¦å‘æ£€æŸ¥\n */\n\nimport { getScriptData, getSettings, saveScriptData, type ScriptDataType } from '@/config';\nimport {\n  getMiniSummaryPrompt,\n  getVolumeSummaryPrompt,\n  getVolumeCompletionCheckPrompt,\n} from '@/prompts';\nimport {\n  getWorldbookName,\n  upsertMiniSummaryEntry,\n  getUnarchivedMiniSummaries,\n  getVolumes,\n  createVolumeEntry,\n} from '@/worldbook';\n\n// ========== æ¶ˆæ¯æ¸…æ´— ==========\n\n/** ä»æ¶ˆæ¯ä¸­æå–ç”±æ•è·æ ‡ç­¾åŒ…è£¹çš„å†…å®¹ï¼Œè‹¥æœªé…ç½®æ ‡ç­¾æˆ–æœªåŒ¹é…åˆ°åˆ™è¿”å›åŸæ–‡ */\nexport function extractTaggedContent(message: string, tag: string): string {\n  if (!tag) return message;\n\n  // æ„å»ºåŒ¹é…æ­£åˆ™ï¼šåŒ¹é…æ‰€æœ‰ <tag>...</tag> ä¹‹é—´çš„å†…å®¹ï¼ˆæ”¯æŒå¤šæ®µã€è·¨è¡Œï¼‰\n  const regex = new RegExp(`<${_.escapeRegExp(tag)}>([\\\\s\\\\S]*?)</${_.escapeRegExp(tag)}>`, 'g');\n  const matches: string[] = [];\n  let match: RegExpExecArray | null;\n  while ((match = regex.exec(message)) !== null) {\n    const content = match[1].trim();\n    if (content) {\n      matches.push(content);\n    }\n  }\n\n  if (matches.length === 0) {\n    console.warn(`[è‡ªåŠ¨æ€»ç»“] æœªåœ¨æ¶ˆæ¯ä¸­æ‰¾åˆ° <${tag}> æ ‡ç­¾åŒ…è£¹çš„å†…å®¹ï¼Œå°†ä½¿ç”¨åŸå§‹æ¶ˆæ¯`);\n    return message;\n  }\n\n  return matches.join('\\n\\n');\n}\n\n/** ä½¿ç”¨ç”¨æˆ·è‡ªå®šä¹‰æ­£åˆ™æ¸…æ´—æ¶ˆæ¯å†…å®¹ */\nexport function cleanMessage(message: string, settings: ScriptDataType): string {\n  let cleaned = message;\n  for (const regex of settings.message_cleanup_regex) {\n    try {\n      const re = new RegExp(regex.pattern, regex.flags);\n      cleaned = cleaned.replace(re, regex.replacement);\n    } catch (e) {\n      console.error(`[è‡ªåŠ¨æ€»ç»“] æ­£åˆ™æ¸…æ´—é”™è¯¯ (pattern: ${regex.pattern}):`, e);\n      // è·³è¿‡æ— æ•ˆæ­£åˆ™\n    }\n  }\n  return cleaned;\n}\n\n// ========== AI ç”Ÿæˆè¾…åŠ© ==========\n\n/** æ„å»º generateRaw çš„è‡ªå®šä¹‰ API é…ç½® */\nfunction buildCustomApi(settings: ScriptDataType): Record<string, any> | undefined {\n  if (!settings.custom_api.enabled) return undefined;\n  return {\n    apiurl: settings.custom_api.apiurl,\n    key: settings.custom_api.key,\n    model: settings.custom_api.model,\n    source: settings.custom_api.source,\n  };\n}\n\n/** è°ƒç”¨ AI ç”Ÿæˆæ–‡æœ¬ */\nasync function callAI(\n  systemPrompt: string,\n  userPrompt: string,\n  settings: ScriptDataType\n): Promise<string> {\n  try {\n    const result = await generateRaw({\n      should_silence: true,\n      custom_api: buildCustomApi(settings) as any,\n      ordered_prompts: [\n        { role: 'system', content: systemPrompt },\n        { role: 'user', content: userPrompt },\n      ],\n    });\n    return result;\n  } catch (e) {\n    // è‡ªå®šä¹‰ API å¤±è´¥æ—¶é™çº§ä½¿ç”¨é…’é¦†å½“å‰ API\n    if (settings.custom_api.enabled) {\n      console.warn('[è‡ªåŠ¨æ€»ç»“] è‡ªå®šä¹‰ API å¤±è´¥ï¼Œé™çº§ä½¿ç”¨é…’é¦†å½“å‰ API:', e);\n      const result = await generateRaw({\n        should_silence: true,\n        ordered_prompts: [\n          { role: 'system', content: systemPrompt },\n          { role: 'user', content: userPrompt },\n        ],\n      });\n      return result;\n    }\n    throw e;\n  }\n}\n\n// ========== å°æ€»ç»“ ==========\n\n/** ç”Ÿæˆå•æ¡æ¶ˆæ¯çš„å°æ€»ç»“å†…å®¹ */\nexport async function generateMiniSummaryContent(message_id: number): Promise<string> {\n  const settings = getSettings();\n  const worldbook = await getWorldbook(getWorldbookName());\n\n  // è·å–å‰ 2 ä¸ªå°æ€»ç»“ä½œä¸ºä¸Šä¸‹æ–‡\n  const allMiniEntries = worldbook\n    .filter(e => e.name.match(/^\\[å°æ€»ç»“-æ¥¼å±‚(\\d+)\\]$/))\n    .map(e => ({\n      id: parseInt(e.name.match(/æ¥¼å±‚(\\d+)/)![1]),\n      content: e.content,\n    }))\n    .filter(e => e.id < message_id)\n    .sort((a, b) => a.id - b.id)\n    .slice(-2);\n\n  const context = allMiniEntries.map(e => e.content).join('\\n');\n\n  // è·å–å¹¶æ¸…æ´—å½“å‰æ¥¼å±‚æ¶ˆæ¯\n  const messages = getChatMessages(message_id);\n  if (messages.length === 0) {\n    throw new Error(`[è‡ªåŠ¨æ€»ç»“] æ¥¼å±‚ ${message_id} ä¸å­˜åœ¨`);\n  }\n  const rawMessage = messages[0].message;\n\n  // è·³è¿‡ç©ºæ¶ˆæ¯\n  if (!rawMessage || rawMessage.trim() === '') {\n    return 'ï¼ˆç©ºæ¶ˆæ¯ï¼‰';\n  }\n\n  // åº”ç”¨é…’é¦†æ­£åˆ™è¿‡æ»¤ï¼ˆæ ¹æ®æ¶ˆæ¯è§’è‰²ç¡®å®š sourceï¼‰\n  const source = messages[0].role === 'user' ? 'user_input' : 'ai_output';\n  const regexedMessage = formatAsTavernRegexedString(rawMessage, source, 'prompt');\n\n  // æå–æ•è·æ ‡ç­¾å†…å®¹\n  const extracted = extractTaggedContent(regexedMessage, settings.capture_tag);\n\n  const cleaned = cleanMessage(extracted, settings);\n  const prompt = getMiniSummaryPrompt(cleaned, context);\n\n  return await callAI(prompt.system, prompt.user, settings);\n}\n\n/** å¤„ç†å°æ€»ç»“ä»»åŠ¡ - ç”Ÿæˆå†…å®¹å¹¶å†™å…¥å·²åˆ›å»ºçš„æ¡ç›® */\nexport async function handleMiniSummary(message_id: number): Promise<void> {\n  // ç”Ÿæˆå°æ€»ç»“å†…å®¹\n  const summary = await generateMiniSummaryContent(message_id);\n\n  // å°†ç»“æœå†™å…¥å·²å­˜åœ¨çš„æ¡ç›®ï¼ˆupsert å¤„ç†ï¼Œè‹¥æ¡ç›®ä¸å­˜åœ¨ä¹Ÿä¼šåˆ›å»ºï¼‰\n  await upsertMiniSummaryEntry(message_id, summary);\n\n  // æ›´æ–°å…ƒæ•°æ®\n  const data = getScriptData();\n  data.last_processed_message_id = message_id;\n  saveScriptData(data);\n}\n\n// ========== å¤§æ€»ç»“ ==========\n\n/** æ£€æŸ¥æ˜¯å¦åº”è¯¥è§¦å‘å¤§æ€»ç»“ */\nexport async function shouldTriggerVolumeSummary(): Promise<boolean> {\n  const settings = getSettings();\n  const unarchivedEntries = await getUnarchivedMiniSummaries();\n\n  if (unarchivedEntries.length === 0) return false;\n\n  // æ£€æŸ¥ token é˜ˆå€¼ï¼ˆç®€å•ç”¨å­—ç¬¦æ•°ä¼°ç®— token æ•°ï¼Œä¸­æ–‡çº¦ 1 å­— â‰ˆ 1-2 tokenï¼‰\n  const totalContent = unarchivedEntries.map(e => e.content).join('');\n  const estimatedTokens = totalContent.length; // ç²—ç•¥ä¼°ç®—\n\n  if (estimatedTokens > settings.volume_token_threshold) {\n    return true;\n  }\n\n  // AI åˆ¤æ–­æ˜¯å¦ä¸€å·å·²å®Œç»“\n  try {\n    const miniSummaries = unarchivedEntries.map(e => e.content);\n    const prompt = getVolumeCompletionCheckPrompt(miniSummaries);\n    const result = await callAI(prompt.system, prompt.user, settings);\n    // æ£€æŸ¥å›ç­”ä¸­æ˜¯å¦åŒ…å« 114514ï¼ˆå®Œç»“ï¼‰æˆ– 1919810ï¼ˆæœªå®Œç»“ï¼‰\n    if (result.includes('114514')) return true;\n    if (result.includes('1919810')) return false;\n    // éƒ½ä¸åŒ…å«æ—¶é»˜è®¤ä¸è§¦å‘\n    console.warn('[è‡ªåŠ¨æ€»ç»“] å·å®Œç»“æ£€æµ‹è¿”å›äº†æ„å¤–å†…å®¹:', result);\n    return false;\n  } catch (e) {\n    console.error('[è‡ªåŠ¨æ€»ç»“] å·å®Œç»“æ£€æµ‹å¤±è´¥:', e);\n    return false;\n  }\n}\n\n/** ç”Ÿæˆå¤§æ€»ç»“å†…å®¹ */\nexport async function generateVolumeSummaryContent(\n  mini_summaries: WorldbookEntry[]\n): Promise<string> {\n  const settings = getSettings();\n  const volumes = await getVolumes();\n\n  const miniContents = mini_summaries.map(e => e.content);\n  const previousVolumeContents = volumes\n    .sort((a, b) => {\n      const aVol = parseInt(a.name.match(/å·(\\d+)/)![1]);\n      const bVol = parseInt(b.name.match(/å·(\\d+)/)![1]);\n      return aVol - bVol;\n    })\n    .map(e => e.content);\n\n  const prompt = getVolumeSummaryPrompt(miniContents, previousVolumeContents);\n  return await callAI(prompt.system, prompt.user, settings);\n}\n\n/** æ‰§è¡Œå®Œæ•´çš„å¤§æ€»ç»“æµç¨‹ */\nexport async function performVolumeSummary(): Promise<void> {\n  const data = getScriptData();\n  const unarchivedEntries = await getUnarchivedMiniSummaries();\n\n  if (unarchivedEntries.length === 0) return;\n\n  // å…ˆæ£€æŸ¥æ˜¯å¦æ»¡è¶³å¤§æ€»ç»“æ¡ä»¶\n  const shouldTrigger = await shouldTriggerVolumeSummary();\n  if (!shouldTrigger) return;\n\n  // æå–æ¥¼å±‚ ID èŒƒå›´\n  const ids = unarchivedEntries\n    .map(e => parseInt(e.name.match(/æ¥¼å±‚(\\d+)/)![1]))\n    .sort((a, b) => a - b);\n\n  const start_id = ids[0];\n  const end_id = ids[ids.length - 1];\n\n  // ç”Ÿæˆå¤§æ€»ç»“\n  const content = await generateVolumeSummaryContent(unarchivedEntries);\n\n  // åˆ›å»ºå·æ¡ç›®å¹¶å…³é—­å¯¹åº”å°æ€»ç»“\n  await createVolumeEntry(data.current_volume, start_id, end_id, content);\n\n  console.log(`[è‡ªåŠ¨æ€»ç»“] å·²å½’æ¡£å·${data.current_volume}: æ¥¼å±‚${start_id}~æ¥¼å±‚${end_id}`);\n}\n","/**\n * AI æ€»ç»“æç¤ºè¯æ¨¡æ¿\n */\n\n/** å°æ€»ç»“ç³»ç»Ÿæç¤ºè¯ */\nconst MINI_SUMMARY_SYSTEM = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ•…äº‹æ€»ç»“åŠ©æ‰‹ã€‚ä½ çš„ä»»åŠ¡æ˜¯å°†è§’è‰²æ‰®æ¼”èŠå¤©è®°å½•ä¸­çš„ä¸€æ¡æ¶ˆæ¯æ€»ç»“ä¸ºç®€æ´çš„å°æ€»ç»“ã€‚\n\nè¦æ±‚ï¼š\n1. ä¿ç•™å…³é”®æƒ…èŠ‚ã€è§’è‰²è¡Œä¸ºã€æƒ…æ„Ÿå˜åŒ–å’Œé‡è¦å¯¹è¯\n2. ä½¿ç”¨ç¬¬ä¸‰äººç§°å™è¿°\n3. æ€»ç»“åº”ç®€æ´æ˜äº†ï¼Œæ§åˆ¶åœ¨ 200 å­—ä»¥å†…\n4. ä¸è¦æ·»åŠ ä»»ä½•è¯„è®ºã€åˆ†ææˆ–ä½ è‡ªå·±çš„æƒ³æ³•\n5. åªè¾“å‡ºæ€»ç»“å†…å®¹ï¼Œä¸è¦æ·»åŠ æ ‡é¢˜ã€ç¼–å·æˆ–å…¶ä»–æ ¼å¼`;\n\n/** å°æ€»ç»“æç¤ºè¯ */\nexport function getMiniSummaryPrompt(\n  message: string,\n  context: string\n): { system: string; user: string } {\n  let userPrompt = '';\n  if (context) {\n    userPrompt += `ä»¥ä¸‹æ˜¯ä¹‹å‰çš„æ€»ç»“ï¼Œä¾›ä½ äº†è§£ä¸Šä¸‹æ–‡ï¼š\\n${context}\\n\\n---\\n\\n`;\n  }\n  userPrompt += `è¯·æ€»ç»“ä»¥ä¸‹æ¶ˆæ¯ï¼š\\n\\n${message}`;\n\n  return {\n    system: MINI_SUMMARY_SYSTEM,\n    user: userPrompt,\n  };\n}\n\n/** å¤§æ€»ç»“ç³»ç»Ÿæç¤ºè¯ */\nconst VOLUME_SUMMARY_SYSTEM = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ•…äº‹æ€»ç»“åŠ©æ‰‹ã€‚ä½ çš„ä»»åŠ¡æ˜¯å°†ä¸€ç³»åˆ—å°æ€»ç»“åˆå¹¶ä¸ºä¸€ä¸ªå®Œæ•´çš„å·æ€»ç»“ã€‚\n\nè¦æ±‚ï¼š\n1. å°†æ‰€æœ‰å°æ€»ç»“çš„å†…å®¹æ•´åˆä¸ºè¿è´¯çš„å™è¿°\n2. ä¿ç•™ä¸»è¦æƒ…èŠ‚çº¿ã€è§’è‰²å‘å±•ã€å…³é”®äº‹ä»¶å’Œé‡è¦å¯¹è¯\n3. æŒ‰æ—¶é—´é¡ºåºç»„ç»‡å†…å®¹\n4. ä½¿ç”¨ç¬¬ä¸‰äººç§°å™è¿°\n5. æ€»ç»“åº”å…¨é¢ä½†ç²¾ç‚¼ï¼Œæ§åˆ¶åœ¨ 1000 å­—ä»¥å†…\n6. ä¸è¦æ·»åŠ ä»»ä½•è¯„è®ºã€åˆ†ææˆ–ä½ è‡ªå·±çš„æƒ³æ³•\n7. åªè¾“å‡ºæ€»ç»“å†…å®¹ï¼Œä¸è¦æ·»åŠ æ ‡é¢˜ã€ç¼–å·æˆ–å…¶ä»–æ ¼å¼`;\n\n/** å¤§æ€»ç»“æç¤ºè¯ */\nexport function getVolumeSummaryPrompt(\n  mini_summaries: string[],\n  previous_volumes: string[]\n): { system: string; user: string } {\n  let userPrompt = '';\n  if (previous_volumes.length > 0) {\n    userPrompt += `ä»¥ä¸‹æ˜¯ä¹‹å‰å„å·çš„å¤§æ€»ç»“ï¼Œä¾›ä½ äº†è§£å‰æƒ…ï¼š\\n\\n`;\n    previous_volumes.forEach((vol, i) => {\n      userPrompt += `--- ç¬¬${i + 1}å· ---\\n${vol}\\n\\n`;\n    });\n    userPrompt += `===\\n\\n`;\n  }\n  userPrompt += `è¯·å°†ä»¥ä¸‹å°æ€»ç»“åˆå¹¶ä¸ºä¸€ä¸ªå®Œæ•´çš„å·æ€»ç»“ï¼š\\n\\n`;\n  mini_summaries.forEach((summary, i) => {\n    userPrompt += `[${i + 1}] ${summary}\\n\\n`;\n  });\n\n  return {\n    system: VOLUME_SUMMARY_SYSTEM,\n    user: userPrompt,\n  };\n}\n\n/** å·å®Œç»“æ£€æµ‹ç³»ç»Ÿæç¤ºè¯ */\nconst VOLUME_COMPLETION_CHECK_SYSTEM = `ä½ æ˜¯ä¸€ä¸ªæ•…äº‹åˆ†æåŠ©æ‰‹ã€‚æ ¹æ®ä»¥ä¸‹æ€»ç»“å†…å®¹ï¼Œåˆ¤æ–­å½“å‰è¿™ä¸€å·æ•…äº‹æ˜¯å¦å·²ç»è¾¾åˆ°äº†ä¸€ä¸ªè‡ªç„¶çš„æ®µè½ç»“å°¾ï¼ˆå¦‚ï¼šä¸€ä¸ªç« èŠ‚ç»“æŸã€ä¸€ä¸ªäº‹ä»¶å‘Šä¸€æ®µè½ã€åœºæ™¯å¤§å¹…è½¬æ¢ç­‰ï¼‰ã€‚\n\nåªéœ€å›ç­”\"114514\"æˆ–\"1919810\"ï¼Œä¸è¦åšä»»ä½•è§£é‡Šã€‚\n- å›ç­”\"114514\"è¡¨ç¤ºè¿™ä¸€å·å·²ç»åˆ°äº†ä¸€ä¸ªåˆé€‚çš„æ–­ç‚¹ï¼Œå¯ä»¥å½’æ¡£\n- å›ç­”\"1919810\"è¡¨ç¤ºæ•…äº‹ä»åœ¨è¿›è¡Œä¸­ï¼Œä¸é€‚åˆåœ¨è¿™é‡Œæ–­å¼€`;\n\n/** å·å®Œç»“æ£€æµ‹æç¤ºè¯ */\nexport function getVolumeCompletionCheckPrompt(mini_summaries: string[]): {\n  system: string;\n  user: string;\n} {\n  let userPrompt = `ä»¥ä¸‹æ˜¯æœ€è¿‘ä¸€æ®µæ—¶é—´çš„å°æ€»ç»“åºåˆ—ï¼š\\n\\n`;\n  mini_summaries.forEach((summary, i) => {\n    userPrompt += `[${i + 1}] ${summary}\\n\\n`;\n  });\n  userPrompt += `è¯·åˆ¤æ–­ä»¥ä¸Šå†…å®¹æ˜¯å¦å·²ç»åˆ°äº†ä¸€ä¸ªè‡ªç„¶çš„æ®µè½ç»“å°¾ï¼Ÿ`;\n\n  return {\n    system: VOLUME_COMPLETION_CHECK_SYSTEM,\n    user: userPrompt,\n  };\n}\n","/**\n * è§¦å‘å™¨\n * - ç›‘å¬ MESSAGE_RECEIVED äº‹ä»¶\n * - åŒæ­¥é˜¶æ®µï¼šåˆ›å»ºå ä½æ¡ç›® â†’ åŒæ­¥ enabled â†’ æ›´æ–°æ¥¼å±‚å¯è§æ€§\n * - å¼‚æ­¥é˜¶æ®µï¼šå°†ä»»åŠ¡åŠ å…¥é˜Ÿåˆ—\n */\n\nimport { getSettings } from '@/config';\nimport { taskQueue } from '@/queue';\nimport { createPlaceholderMiniSummary, syncMiniSummaryEnabled } from '@/worldbook';\nimport { updateFloorVisibility } from '@/chat-manager';\n\n/** å°æ€»ç»“è®¡æ•°å™¨ï¼ˆç”¨äºå¤§æ€»ç»“æ£€æŸ¥é—´éš”ï¼‰ */\nlet miniSummaryCount = 0;\n\n/** æ£€æŸ¥æ˜¯å¦åº”è¯¥è§¦å‘å¤§æ€»ç»“æ£€æŸ¥ */\nfunction shouldCheckVolumeSummary(): boolean {\n  const settings = getSettings();\n  if (!settings.auto_volume_summary) return false;\n  return miniSummaryCount % settings.check_interval === 0 && miniSummaryCount > 0;\n}\n\n/** MESSAGE_RECEIVED äº‹ä»¶å¤„ç†å‡½æ•° */\nasync function onMessageReceived(message_id: number): Promise<void> {\n  const settings = getSettings();\n\n  // å¦‚æœæœªå¯ç”¨è‡ªåŠ¨å°æ€»ç»“ï¼Œç›´æ¥è¿”å›\n  if (!settings.auto_mini_summary) return;\n\n  // è·³è¿‡ç³»ç»Ÿæ¶ˆæ¯\n  const messages = getChatMessages(message_id);\n  if (messages.length === 0) return;\n  const msg = messages[0];\n  if (msg.role === 'system') return;\n  if (!msg.message || msg.message.trim() === '') return;\n\n  // å¿½ç•¥å‰ N å±‚çš„æ¶ˆæ¯\n  if (message_id < settings.ignore_floors) return;\n\n  try {\n    // === åŒæ­¥é˜¶æ®µ ===\n\n    // 1. æ–°å»ºå½“å‰æ¥¼å±‚çš„å°æ€»ç»“ä¸–ç•Œä¹¦æ¡ç›®ï¼ˆå†…å®¹ä¸ºç©ºå ä½ï¼‰\n    await createPlaceholderMiniSummary(message_id);\n\n    // 2. åŒæ­¥å°æ€»ç»“ enabled çŠ¶æ€\n    await syncMiniSummaryEnabled();\n\n    // 3. è°ƒæ•´æ¥¼å±‚éšè—ä¸æ˜¾ç¤º\n    await updateFloorVisibility();\n\n    // === å¼‚æ­¥é˜Ÿåˆ—é˜¶æ®µ ===\n\n    // 4. é€’å¢è®¡æ•°å™¨\n    miniSummaryCount++;\n\n    // 5. å¤§æ€»ç»“æ£€æŸ¥ï¼ˆå¦‚æœæ»¡è¶³é—´éš”æ¡ä»¶ï¼Œå°†å¤§æ€»ç»“ä»»åŠ¡åŠ å…¥é˜Ÿåˆ—ï¼‰\n    if (shouldCheckVolumeSummary()) {\n      taskQueue.enqueue({ type: 'volume_summary' });\n    }\n\n    // 6. å°†å°æ€»ç»“ç”Ÿæˆä»»åŠ¡åŠ å…¥å¼‚æ­¥é˜Ÿåˆ—\n    taskQueue.enqueue({ type: 'mini_summary', message_id });\n  } catch (e) {\n    console.error('[è‡ªåŠ¨æ€»ç»“] æ¶ˆæ¯å¤„ç†å¤±è´¥:', e);\n  }\n}\n\n/** æ³¨å†Œäº‹ä»¶ç›‘å¬ */\nexport function registerListeners(): EventOnReturn {\n  return eventOn(\n    tavern_events.MESSAGE_RECEIVED,\n    errorCatched((message_id: number) => {\n      void onMessageReceived(message_id);\n    })\n  );\n}\n","/**\n * èŠå¤©æ¥¼å±‚ç®¡ç†\n * - éšè—/æ˜¾ç¤ºæ¥¼å±‚\n * - ä¸å°æ€»ç»“ enabled çŠ¶æ€è”åŠ¨\n */\n\nimport { getSettings } from '@/config';\nimport { syncMiniSummaryEnabled } from '@/worldbook';\n\n/** æ ¹æ®è®¾ç½®æ›´æ–°æ¥¼å±‚éšè—çŠ¶æ€ */\nexport async function updateFloorVisibility(): Promise<void> {\n  const settings = getSettings();\n  const lastId = getLastMessageId();\n\n  if (lastId < 0) return;\n\n  // è·å–æ‰€æœ‰æ¥¼å±‚\n  const allMessages = getChatMessages(`0-${lastId}`);\n  if (allMessages.length === 0) return;\n\n  const visibleThreshold = lastId - settings.visible_floors + 1;\n\n  // æ„å»ºéœ€è¦æ›´æ–°çš„æ¶ˆæ¯åˆ—è¡¨\n  const updates: Array<{ message_id: number; is_hidden: boolean }> = [];\n\n  for (const msg of allMessages) {\n    if (msg.role === 'system') continue; // è·³è¿‡ç³»ç»Ÿæ¶ˆæ¯\n\n    if (msg.message_id >= visibleThreshold) {\n      // æœ€è¿‘ N æ¥¼è®¾ä¸ºå¯è§\n      if (msg.is_hidden) {\n        updates.push({ message_id: msg.message_id, is_hidden: false });\n      }\n    } else {\n      // æ›´æ—©çš„æ¥¼å±‚è®¾ä¸ºéšè—\n      if (!msg.is_hidden) {\n        updates.push({ message_id: msg.message_id, is_hidden: true });\n      }\n    }\n  }\n\n  // æ‰¹é‡æ›´æ–°æ¥¼å±‚å¯è§æ€§\n  if (updates.length > 0) {\n    await setChatMessages(updates, { refresh: 'none' });\n  }\n\n  // åŒæ­¥å°æ€»ç»“ enabled çŠ¶æ€\n  await syncMiniSummaryEnabled();\n}\n","/**\n * è®¾ç½® UI å¼¹çª—\n * - é€šè¿‡é…’é¦†æ‰©å±•èœå•å…¥å£æ‰“å¼€\n * - æä¾›å„é¡¹è®¾ç½®ä¸æ‰‹åŠ¨æ“ä½œæŒ‰é’®\n */\n\nimport { getScriptData, saveScriptData, type ScriptDataType } from '@/config';\nimport { taskQueue } from '@/queue';\n\n// ========== èœå•æ³¨å…¥ ==========\n\nconst MENU_ID = 'hilo-auto-summary-menu';\n\n/** å‘æ‰©å±•èœå•æ³¨å…¥å…¥å£ */\nexport function addMenuItem(): void {\n  const $extensionsMenu = $('#extensionsMenu');\n  if (!$extensionsMenu.length) {\n    setTimeout(addMenuItem, 2000);\n    return;\n  }\n\n  // ç§»é™¤æ—§çš„èœå•é¡¹ï¼ˆè„šæœ¬é‡è½½åæ—§çš„ç‚¹å‡»å¤„ç†å‡½æ•°å·²å¤±æ•ˆï¼‰\n  $(`#${MENU_ID}`, $extensionsMenu).remove();\n\n  const $item = $(`\n    <div class=\"list-group-item flex-container flexGap5 interactable\" id=\"${MENU_ID}\" title=\"è‡ªåŠ¨æ€»ç»“è®¾ç½®\">\n      <div class=\"fa-fw fa-solid fa-book-open extensionsMenuExtensionButton\"></div>\n      <span>è‡ªåŠ¨æ€»ç»“</span>\n    </div>\n  `);\n\n  $item.on('click', async e => {\n    e.stopPropagation();\n    const $menuBtn = $('#extensionsMenuButton');\n    if ($menuBtn.length && $extensionsMenu.is(':visible')) {\n      $menuBtn.trigger('click');\n      await new Promise(r => setTimeout(r, 150));\n    }\n    await openSettingsPopup();\n  });\n\n  $extensionsMenu.append($item);\n}\n\n// ========== è®¾ç½®å¼¹çª— ==========\n\n/** æ„å»ºè®¾ç½®å¼¹çª— HTML */\nfunction buildSettingsHtml(data: ScriptDataType): string {\n  return `\n    <div id=\"hilo-summary-settings\" style=\"padding: 10px; max-height: 70vh; overflow-y: auto;\">\n      <h3 style=\"margin-top: 0;\">ğŸ“– è‡ªåŠ¨æ€»ç»“è®¾ç½®</h3>\n\n      <!-- åŸºæœ¬è®¾ç½® -->\n      <div style=\"margin-bottom: 15px;\">\n        <h4>åŸºæœ¬è®¾ç½®</h4>\n        <div style=\"margin-bottom: 8px;\">\n          <label>æ˜¾ç¤ºæ¥¼å±‚æ•°ï¼š</label>\n          <input type=\"number\" id=\"hs-visible-floors\" value=\"${data.visible_floors}\" min=\"1\" max=\"100\" style=\"width: 80px;\" />\n          <small style=\"color: #888;\">ï¼ˆæœ€è¿‘ä¿ç•™å¤šå°‘æ¥¼å¯è§ï¼‰</small>\n        </div>\n        <div style=\"margin-bottom: 8px;\">\n          <label>æ£€æŸ¥é—´éš”ï¼š</label>\n          <input type=\"number\" id=\"hs-check-interval\" value=\"${data.check_interval}\" min=\"5\" max=\"100\" style=\"width: 80px;\" />\n          <small style=\"color: #888;\">ï¼ˆæ¯å¤šå°‘ä¸ªå°æ€»ç»“æ£€æŸ¥ä¸€æ¬¡å¤§æ€»ç»“ï¼‰</small>\n        </div>\n        <div style=\"margin-bottom: 8px;\">\n          <label>Token é˜ˆå€¼ï¼š</label>\n          <input type=\"number\" id=\"hs-volume-token-threshold\" value=\"${data.volume_token_threshold}\" min=\"1000\" max=\"50000\" style=\"width: 100px;\" />\n          <small style=\"color: #888;\">ï¼ˆå¤§æ€»ç»“è§¦å‘é˜ˆå€¼ï¼‰</small>\n        </div>\n        <div style=\"margin-bottom: 8px;\">\n          <label>\n            <input type=\"checkbox\" id=\"hs-auto-mini-summary\" ${data.auto_mini_summary ? 'checked' : ''} />\n            è‡ªåŠ¨å°æ€»ç»“\n          </label>\n        </div>\n        <div style=\"margin-bottom: 8px;\">\n          <label>\n            <input type=\"checkbox\" id=\"hs-auto-volume-summary\" ${data.auto_volume_summary ? 'checked' : ''} />\n            è‡ªåŠ¨å¤§æ€»ç»“\n          </label>\n        </div>\n        <div style=\"margin-bottom: 8px;\">\n          <label>å°æ€»ç»“æ³¨å…¥æ·±åº¦ï¼š</label>\n          <input type=\"number\" id=\"hs-mini-summary-depth\" value=\"${data.mini_summary_depth}\" min=\"0\" max=\"99999\" style=\"width: 100px;\" />\n          <small style=\"color: #888;\">ï¼ˆé»˜è®¤ 9999ï¼‰</small>\n        </div>\n        <div style=\"margin-bottom: 8px;\">\n          <label>å·æ€»ç»“æ³¨å…¥æ·±åº¦ï¼š</label>\n          <input type=\"number\" id=\"hs-volume-summary-depth\" value=\"${data.volume_summary_depth}\" min=\"0\" max=\"99999\" style=\"width: 100px;\" />\n          <small style=\"color: #888;\">ï¼ˆé»˜è®¤ 9999ï¼‰</small>\n        </div>\n        <div style=\"margin-bottom: 8px;\">\n          <label>å°æ€»ç»“èµ·å§‹æ’åºï¼š</label>\n          <input type=\"number\" id=\"hs-mini-start-order\" value=\"${data.mini_summary_start_order}\" min=\"0\" max=\"99999\" style=\"width: 100px;\" />\n          <small style=\"color: #888;\">ï¼ˆå°æ€»ç»“ order åŸºæ•°ï¼Œé»˜è®¤ 10000ï¼‰</small>\n        </div>\n        <div style=\"margin-bottom: 8px;\">\n          <label>å·æ€»ç»“èµ·å§‹æ’åºï¼š</label>\n          <input type=\"number\" id=\"hs-volume-start-order\" value=\"${data.volume_start_order}\" min=\"0\" max=\"99999\" style=\"width: 100px;\" />\n          <small style=\"color: #888;\">ï¼ˆå·æ€»ç»“ order åŸºæ•°ï¼Œé»˜è®¤ 100ï¼‰</small>\n        </div>\n        <div style=\"margin-bottom: 8px;\">\n          <label>å¿½ç•¥å‰ N å±‚ï¼š</label>\n          <input type=\"number\" id=\"hs-ignore-floors\" value=\"${data.ignore_floors}\" min=\"0\" max=\"1000\" style=\"width: 80px;\" />\n          <small style=\"color: #888;\">ï¼ˆè·³è¿‡å‰å¤šå°‘å±‚ä¸è¿›è¡Œæ€»ç»“ï¼‰</small>\n        </div>\n        <div style=\"margin-bottom: 8px;\">\n          <label>å†…å®¹æ•è·æ ‡ç­¾ï¼š</label>\n          <input type=\"text\" id=\"hs-capture-tag\" value=\"${escapeHtml(data.capture_tag)}\" style=\"width: 120px;\" placeholder=\"å¦‚ content\" />\n          <small style=\"color: #888;\">ï¼ˆä»…æ€»ç»“ &lt;æ ‡ç­¾&gt;â€¦&lt;/æ ‡ç­¾&gt; å†…çš„å†…å®¹ï¼Œç•™ç©ºåˆ™æ€»ç»“å…¨éƒ¨ï¼‰</small>\n        </div>\n      </div>\n\n      <!-- æ‰‹åŠ¨æ“ä½œ -->\n      <div style=\"margin-bottom: 15px;\">\n        <h4>æ‰‹åŠ¨æ“ä½œ</h4>\n        <div style=\"display: flex; gap: 8px;\">\n          <button id=\"hs-manual-mini\" class=\"menu_button\">æ‰‹åŠ¨æ€»ç»“</button>\n          <button id=\"hs-manual-volume\" class=\"menu_button\">æ‰‹åŠ¨å½’æ¡£</button>\n        </div>\n      </div>\n\n      <!-- è‡ªå®šä¹‰ API -->\n      <details style=\"margin-bottom: 15px;\">\n        <summary><h4 style=\"display: inline;\">è‡ªå®šä¹‰ API</h4></summary>\n        <div style=\"padding: 8px 0;\">\n          <div style=\"margin-bottom: 8px;\">\n            <label>\n              <input type=\"checkbox\" id=\"hs-custom-api-enabled\" ${data.custom_api.enabled ? 'checked' : ''} />\n              å¯ç”¨è‡ªå®šä¹‰ API\n            </label>\n          </div>\n          <div style=\"margin-bottom: 8px;\">\n            <label>API URLï¼š</label>\n            <input type=\"text\" id=\"hs-custom-api-url\" value=\"${escapeHtml(data.custom_api.apiurl)}\" style=\"width: 100%;\" placeholder=\"https://api.example.com/v1\" />\n          </div>\n          <div style=\"margin-bottom: 8px;\">\n            <label>API Keyï¼š</label>\n            <input type=\"password\" id=\"hs-custom-api-key\" value=\"${escapeHtml(data.custom_api.key)}\" style=\"width: 100%;\" placeholder=\"sk-...\" />\n          </div>\n          <div style=\"margin-bottom: 8px;\">\n            <label>æ¨¡å‹åç§°ï¼š</label>\n            <input type=\"text\" id=\"hs-custom-api-model\" value=\"${escapeHtml(data.custom_api.model)}\" style=\"width: 100%;\" placeholder=\"gpt-4\" />\n          </div>\n          <div style=\"margin-bottom: 8px;\">\n            <label>API æºï¼š</label>\n            <select id=\"hs-custom-api-source\" style=\"width: 100%;\">\n              ${['openai']\n                .map(\n                  s =>\n                    `<option value=\"${s}\" ${data.custom_api.source === s ? 'selected' : ''}>${s}</option>`\n                )\n                .join('')}\n            </select>\n          </div>\n        </div>\n      </details>\n\n      <!-- æ¶ˆæ¯æ¸…æ´— -->\n      <details style=\"margin-bottom: 15px;\">\n        <summary><h4 style=\"display: inline;\">æ¶ˆæ¯æ¸…æ´—æ­£åˆ™</h4></summary>\n        <div style=\"padding: 8px 0;\">\n          <div id=\"hs-regex-list\">\n            ${data.message_cleanup_regex.map((r, i) => buildRegexRowHtml(r, i)).join('')}\n          </div>\n          <button id=\"hs-add-regex\" class=\"menu_button\" style=\"margin-top: 5px;\">+ æ·»åŠ æ­£åˆ™</button>\n        </div>\n      </details>\n    </div>\n  `;\n}\n\n/** æ„å»ºå•è¡Œæ­£åˆ™ HTML */\nfunction buildRegexRowHtml(\n  regex: { pattern: string; flags: string; replacement: string },\n  index: number\n): string {\n  return `\n    <div class=\"hs-regex-row\" data-index=\"${index}\" style=\"display: flex; gap: 5px; margin-bottom: 5px; align-items: center;\">\n      <input type=\"text\" class=\"hs-regex-pattern\" value=\"${escapeHtml(regex.pattern)}\" placeholder=\"æ­£åˆ™\" style=\"flex: 3;\" />\n      <input type=\"text\" class=\"hs-regex-flags\" value=\"${escapeHtml(regex.flags)}\" placeholder=\"flags\" style=\"flex: 1; max-width: 60px;\" />\n      <input type=\"text\" class=\"hs-regex-replacement\" value=\"${escapeHtml(regex.replacement)}\" placeholder=\"æ›¿æ¢\" style=\"flex: 2;\" />\n      <button class=\"hs-remove-regex menu_button\" style=\"flex: 0 0 auto; padding: 2px 8px;\">âœ•</button>\n    </div>\n  `;\n}\n\n/** HTML è½¬ä¹‰ */\nfunction escapeHtml(str: string): string {\n  return str\n    .replace(/&/g, '&amp;')\n    .replace(/</g, '&lt;')\n    .replace(/>/g, '&gt;')\n    .replace(/\"/g, '&quot;')\n    .replace(/'/g, '&#039;');\n}\n\n/** ä»å¼¹çª—æ”¶é›†è®¾ç½®æ•°æ® */\nfunction collectSettingsFromPopup(): Partial<ScriptDataType> {\n  const regexRows = $('.hs-regex-row');\n  const regexList: { pattern: string; flags: string; replacement: string }[] = [];\n  regexRows.each(function () {\n    const $row = $(this);\n    const pattern = $row.find('.hs-regex-pattern').val() as string;\n    if (pattern) {\n      regexList.push({\n        pattern,\n        flags: ($row.find('.hs-regex-flags').val() as string) || 'g',\n        replacement: ($row.find('.hs-regex-replacement').val() as string) || '',\n      });\n    }\n  });\n\n  return {\n    visible_floors: parseInt($('#hs-visible-floors').val() as string) || 20,\n    check_interval: parseInt($('#hs-check-interval').val() as string) || 20,\n    volume_token_threshold: parseInt($('#hs-volume-token-threshold').val() as string) || 8000,\n    auto_mini_summary: $('#hs-auto-mini-summary').is(':checked'),\n    auto_volume_summary: $('#hs-auto-volume-summary').is(':checked'),\n    mini_summary_depth: parseInt($('#hs-mini-summary-depth').val() as string) || 9999,\n    volume_summary_depth: parseInt($('#hs-volume-summary-depth').val() as string) || 9999,\n    mini_summary_start_order: parseInt($('#hs-mini-start-order').val() as string) || 10000,\n    volume_start_order: parseInt($('#hs-volume-start-order').val() as string) || 100,\n    ignore_floors: parseInt($('#hs-ignore-floors').val() as string) || 0,\n    capture_tag: (($('#hs-capture-tag').val() as string) || '').trim(),\n    custom_api: {\n      enabled: $('#hs-custom-api-enabled').is(':checked'),\n      apiurl: ($('#hs-custom-api-url').val() as string) || '',\n      key: ($('#hs-custom-api-key').val() as string) || '',\n      model: ($('#hs-custom-api-model').val() as string) || '',\n      source: ($('#hs-custom-api-source').val() as string) || 'openai',\n    },\n    message_cleanup_regex: regexList,\n  };\n}\n\n/** æ‰“å¼€è®¾ç½®å¼¹çª— */\nasync function openSettingsPopup(): Promise<void> {\n  const data = getScriptData();\n  const html = buildSettingsHtml(data);\n\n  const $popup = $(html);\n\n  // ä½¿ç”¨é…’é¦†çš„ callGenericPopupï¼ˆå¦‚æœå¯ç”¨ï¼‰æˆ–åˆ›å»ºç®€å•å¼¹çª—\n  const $overlay = $(`<div id=\"hilo-summary-overlay\" style=\"\n    position: fixed; top: 0; left: 0; right: 0; bottom: 0;\n    background: rgba(0,0,0,0.6); z-index: 9998;\n    display: flex; justify-content: center; align-items: center;\n  \"></div>`);\n\n  const $dialog = $(`<div style=\"\n    background: var(--SmartThemeBlurTintColor, #2b2b2b);\n    border: 1px solid var(--SmartThemeBorderColor, #555);\n    border-radius: 10px; padding: 20px; min-width: 400px;\n    max-width: 600px; max-height: 80vh; overflow-y: auto;\n    color: var(--SmartThemeBodyColor, #ccc);\n  \"></div>`);\n\n  const $buttons =\n    $(`<div style=\"display: flex; justify-content: flex-end; gap: 8px; margin-top: 15px;\">\n    <button id=\"hs-cancel\" class=\"menu_button\">å–æ¶ˆ</button>\n    <button id=\"hs-save\" class=\"menu_button\">ä¿å­˜</button>\n  </div>`);\n\n  $dialog.append($popup).append($buttons);\n  $overlay.append($dialog);\n  $('body').append($overlay);\n\n  // äº‹ä»¶ç»‘å®š\n  $overlay.on('click', '#hs-cancel', () => {\n    $overlay.remove();\n  });\n\n  $overlay.on('click', '#hs-save', () => {\n    const newSettings = collectSettingsFromPopup();\n    const currentData = getScriptData();\n    const merged = { ...currentData, ...newSettings };\n    saveScriptData(merged as ScriptDataType);\n    toastr.success('è®¾ç½®å·²ä¿å­˜');\n    $overlay.remove();\n  });\n\n  // æ‰‹åŠ¨æ€»ç»“\n  $overlay.on('click', '#hs-manual-mini', () => {\n    const lastId = getLastMessageId();\n    if (lastId >= 0) {\n      taskQueue.enqueue({ type: 'mini_summary', message_id: lastId });\n      toastr.info(`å·²å°†æ¥¼å±‚ ${lastId} çš„å°æ€»ç»“ä»»åŠ¡åŠ å…¥é˜Ÿåˆ—`);\n    } else {\n      toastr.warning('å½“å‰æ²¡æœ‰èŠå¤©æ¶ˆæ¯');\n    }\n  });\n\n  // æ‰‹åŠ¨å½’æ¡£\n  $overlay.on('click', '#hs-manual-volume', () => {\n    taskQueue.enqueue({ type: 'volume_summary' });\n    toastr.info('å·²å°†å¤§æ€»ç»“ä»»åŠ¡åŠ å…¥é˜Ÿåˆ—');\n  });\n\n  // æ·»åŠ æ­£åˆ™\n  let regexIndex = data.message_cleanup_regex.length;\n  $overlay.on('click', '#hs-add-regex', () => {\n    const newRow = buildRegexRowHtml({ pattern: '', flags: 'g', replacement: '' }, regexIndex++);\n    $('#hs-regex-list').append(newRow);\n  });\n\n  // åˆ é™¤æ­£åˆ™\n  $overlay.on('click', '.hs-remove-regex', function () {\n    $(this).closest('.hs-regex-row').remove();\n  });\n\n  // ç‚¹å‡»é®ç½©å…³é—­\n  $overlay.on('click', e => {\n    if (e.target === $overlay[0]) {\n      $overlay.remove();\n    }\n  });\n}\n","/**\n * è„šæœ¬å…¥å£\n * - åˆå§‹åŒ–æµç¨‹\n * - äº‹ä»¶ç›‘å¬æ³¨å†Œ\n * - èŠå¤©å˜æ›´é‡è½½\n */\n\nimport { getScriptData } from '@/config';\nimport { taskQueue } from '@/queue';\nimport { handleMiniSummary, performVolumeSummary } from '@/summary';\nimport { ensureWorldbook, switchToCurrentCharWorldbook, syncMiniSummaryEnabled } from '@/worldbook';\nimport { registerListeners } from '@/trigger';\nimport { addMenuItem } from '@/ui';\n\n/** èŠå¤©å˜æ›´æ—¶é‡è½½è„šæœ¬ */\nfunction reloadOnChatChange(): EventOnReturn {\n  let chat_id = SillyTavern.getCurrentChatId();\n  return eventOn(tavern_events.CHAT_CHANGED, (new_chat_id: string) => {\n    if (chat_id !== new_chat_id) {\n      chat_id = new_chat_id;\n      window.location.reload();\n    }\n  });\n}\n\n// æ³¨å†Œä»»åŠ¡å¤„ç†å‡½æ•°åˆ°é˜Ÿåˆ—\ntaskQueue.setHandlers({\n  mini_summary: handleMiniSummary,\n  volume_summary: performVolumeSummary,\n});\n$(() => {\n  void (async () => {\n    try {\n      // 1. åŠ è½½è„šæœ¬å˜é‡ï¼ˆè®¾ç½® + å…ƒæ•°æ®ï¼‰\n      const _data = getScriptData();\n      console.log('[è‡ªåŠ¨æ€»ç»“] è„šæœ¬å˜é‡å·²åŠ è½½');\n\n      // 2. è·å–å½“å‰è§’è‰²å¡åç§° - æ— è§’è‰²å¡åˆ™é€€å‡º\n      const charName = getCurrentCharacterName();\n      if (!charName) {\n        console.log('[è‡ªåŠ¨æ€»ç»“] æœªæ‰“å¼€è§’è‰²å¡ï¼Œè„šæœ¬ä¸æ‰§è¡Œ');\n        return;\n      }\n      console.log(`[è‡ªåŠ¨æ€»ç»“] å½“å‰è§’è‰²å¡: ${charName}`);\n\n      // 3. åˆ‡æ¢ä¸–ç•Œä¹¦ - å¸è½½å…¶ä»–è§’è‰²å¡çš„æ€»ç»“ä¸–ç•Œä¹¦ï¼ŒåŠ è½½å½“å‰è§’è‰²å¡çš„\n      await switchToCurrentCharWorldbook();\n\n      // 4. ç¡®ä¿å½“å‰è§’è‰²å¡ä¸–ç•Œä¹¦å­˜åœ¨\n      await ensureWorldbook();\n\n      // 5. åŒæ­¥å°æ€»ç»“ enabled çŠ¶æ€\n      await syncMiniSummaryEnabled();\n\n      // 6. æ³¨å†Œæ‰©å±•èœå•å…¥å£\n      addMenuItem();\n\n      // 7. æ³¨å†Œäº‹ä»¶ç›‘å¬\n      registerListeners();\n\n      // 8. èŠå¤©å˜æ›´æ—¶é‡è½½\n      reloadOnChatChange();\n\n      console.log('[è‡ªåŠ¨æ€»ç»“] åˆå§‹åŒ–å®Œæˆ');\n    } catch (e) {\n      console.error('[è‡ªåŠ¨æ€»ç»“] åˆå§‹åŒ–å¤±è´¥:', e);\n    }\n  })();\n});\n"],"names":["getMiniSummaryOrder","message_id","base","getVolumeOrder","volume","ENTRY_DEFAULTS","enabled","strategy","type","keys","keys_secondary","logic","scan_depth","probability","recursion","prevent_incoming","prevent_outgoing","delay_until","effect","sticky","cooldown","delay","ScriptData","z","object","visible_floors","coerce","number","transform","v","_","clamp","prefault","check_interval","volume_token_threshold","auto_mini_summary","boolean","auto_volume_summary","mini_summary_depth","volume_summary_depth","mini_summary_start_order","volume_start_order","ignore_floors","custom_api","apiurl","string","key","model","source","message_cleanup_regex","array","pattern","flags","replacement","capture_tag","current_volume","last_processed_message_id","volumes","start_message_id","end_message_id","getScriptData","raw","getVariables","parse","saveScriptData","data","replaceVariables","getSettings","taskQueue","queue","processing","handlers","setHandlers","this","enqueue","task","filter","t","push","processNext","length","shift","console","error","mini_summary","volume_summary","e","getWorldbookName","charName","getCurrentCharacterName","Error","async","getUnarchivedMiniSummaries","worldbook","getWorldbook","metadata","archivedIds","Set","vol","id","add","entry","match","name","parseInt","has","syncMiniSummaryEnabled","settings","visibleThreshold","getLastMessageId","updateWorldbookWith","buildCustomApi","callAI","systemPrompt","userPrompt","generateRaw","should_silence","ordered_prompts","role","content","warn","generateMiniSummaryContent","context","map","sort","a","b","slice","join","messages","getChatMessages","rawMessage","message","trim","cleaned","regex","re","RegExp","replace","cleanMessage","tag","escapeRegExp","matches","exec","extractTaggedContent","formatAsTavernRegexedString","prompt","system","user","getMiniSummaryPrompt","generateVolumeSummaryContent","mini_summaries","test","getVolumes","previous_volumes","forEach","i","summary","getVolumeSummaryPrompt","miniSummaryCount","onMessageReceived","msg","worldbookName","entryName","find","createWorldbookEntries","position","depth","order","createPlaceholderMiniSummary","lastId","allMessages","updates","is_hidden","setChatMessages","refresh","updateFloorVisibility","shouldCheckVolumeSummary","MENU_ID","addMenuItem","$extensionsMenu","$","setTimeout","remove","$item","on","stopPropagation","$menuBtn","is","trigger","Promise","r","html","escapeHtml","s","buildRegexRowHtml","buildSettingsHtml","$popup","$overlay","$dialog","$buttons","append","newSettings","regexRows","regexList","each","$row","val","collectSettingsFromPopup","toastr","success","info","warning","regexIndex","newRow","closest","target","openSettingsPopup","index","str","wb","upsertMiniSummaryEntry","unarchivedEntries","getVolumeCompletionCheckPrompt","result","includes","shouldTriggerVolumeSummary","ids","start_id","end_id","createVolumeEntry","log","currentName","filtered","getGlobalWorldbookNames","endsWith","rebindGlobalWorldbooks","switchToCurrentCharWorldbook","getWorldbookNames","createWorldbook","ensureWorldbook","eventOn","tavern_events","MESSAGE_RECEIVED","errorCatched","chat_id","SillyTavern","getCurrentChatId","CHAT_CHANGED","new_chat_id","window","location","reload","reloadOnChatChange"],"mappings":"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"}