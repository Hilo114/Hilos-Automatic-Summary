{"version":3,"file":"index.js","sources":["../src/config.ts","../src/queue.ts","../src/worldbook.ts","../src/summary.ts","../src/prompts.ts","../src/trigger.ts","../src/chat-manager.ts","../src/ui.ts","../src/index.ts"],"sourcesContent":["/**\r\n * è®¾ç½®å’Œå…ƒæ•°æ®ç®¡ç†\r\n * - Zod schema å®šä¹‰ï¼ˆåˆå¹¶ç”¨æˆ·è®¾ç½® + è¿è¡Œæ—¶å…ƒæ•°æ®ï¼‰\r\n * - è„šæœ¬å˜é‡è¯»å†™\r\n * - æ¡ç›®é…ç½®å¸¸é‡\r\n */\r\n\r\nimport type { PartialDeep } from 'type-fest';\r\n\r\n// ========== å¸¸é‡ ==========\r\n\r\n/** æ ¹æ®æ¥¼å±‚ ID è®¡ç®—å°æ€»ç»“æ¡ç›®çš„ order å€¼ */\r\nexport function getMiniSummaryOrder(message_id: number, base: number): number {\r\n    return base + message_id;\r\n}\r\n\r\n/** æ ¹æ®å·å·è®¡ç®—å·æ¡ç›®çš„ order å€¼ */\r\nexport function getVolumeOrder(volume: number, base: number): number {\r\n    return base + volume;\r\n}\r\n\r\n// ========== æ¡ç›®é»˜è®¤é…ç½® ==========\r\n\r\n/** åŸºç¡€æ¡ç›®é»˜è®¤é…ç½®ï¼ˆä¸å« positionï¼Œç”±è°ƒç”¨æ–¹æ ¹æ®è®¾ç½®åŠ¨æ€æŒ‡å®šï¼‰ */\r\nexport const ENTRY_DEFAULTS: PartialDeep<WorldbookEntry> = {\r\n    enabled: false,\r\n    strategy: {\r\n        type: 'constant',\r\n        keys: [],\r\n        keys_secondary: { logic: 'and_any', keys: [] },\r\n        scan_depth: 'same_as_global',\r\n    },\r\n    probability: 100,\r\n    recursion: { prevent_incoming: true, prevent_outgoing: true, delay_until: null },\r\n    effect: { sticky: null, cooldown: null, delay: null },\r\n};\r\n\r\n// ========== Zod Schema ==========\r\n\r\n/** è„šæœ¬æ•°æ® schemaï¼šåˆå¹¶ç”¨æˆ·è®¾ç½® + è¿è¡Œæ—¶å…ƒæ•°æ® */\r\nexport const ScriptData = z.object({\r\n    // === ç”¨æˆ·è®¾ç½® ===\r\n    /** æœ€è¿‘ä¿ç•™æ˜¾ç¤ºçš„æ¥¼å±‚æ•° */\r\n    visible_floors: z.coerce\r\n        .number()\r\n        .transform((v) => _.clamp(v, 1, 100))\r\n        .prefault(20),\r\n    /** æ¯å¤šå°‘ä¸ªå°æ€»ç»“è§¦å‘ä¸€æ¬¡å¤§æ€»ç»“æ£€æŸ¥ */\r\n    check_interval: z.coerce\r\n        .number()\r\n        .transform((v) => _.clamp(v, 5, 100))\r\n        .prefault(20),\r\n    /** å¤§æ€»ç»“ token é˜ˆå€¼ */\r\n    volume_token_threshold: z.coerce\r\n        .number()\r\n        .transform((v) => _.clamp(v, 1000, 50000))\r\n        .prefault(8000),\r\n    /** æ˜¯å¦å¯ç”¨è‡ªåŠ¨å°æ€»ç»“ */\r\n    auto_mini_summary: z.boolean().prefault(true),\r\n    /** æ˜¯å¦å¯ç”¨è‡ªåŠ¨å¤§æ€»ç»“ */\r\n    auto_volume_summary: z.boolean().prefault(true),\r\n    /** å°æ€»ç»“æ³¨å…¥æ·±åº¦ï¼ˆat_depthï¼‰ */\r\n    mini_summary_depth: z.coerce\r\n        .number()\r\n        .transform((v) => _.clamp(v, 0, 99999))\r\n        .prefault(9999),\r\n    /** å·æ€»ç»“æ³¨å…¥æ·±åº¦ï¼ˆat_depthï¼‰ */\r\n    volume_summary_depth: z.coerce\r\n        .number()\r\n        .transform((v) => _.clamp(v, 0, 99999))\r\n        .prefault(9999),\r\n    /** å°æ€»ç»“èµ·å§‹æ’åº order åŸºæ•° */\r\n    mini_summary_start_order: z.coerce\r\n        .number()\r\n        .transform((v) => _.clamp(v, 0, 99999))\r\n        .prefault(10000),\r\n    /** å·æ€»ç»“èµ·å§‹æ’åº order åŸºæ•° */\r\n    volume_start_order: z.coerce\r\n        .number()\r\n        .transform((v) => _.clamp(v, 0, 99999))\r\n        .prefault(100),\r\n    /** å¿½ç•¥å‰å¤šå°‘å±‚æ¶ˆæ¯ä¸è¿›è¡Œæ€»ç»“ */\r\n    ignore_floors: z.coerce\r\n        .number()\r\n        .transform((v) => _.clamp(v, 0, 1000))\r\n        .prefault(0),\r\n    /** è‡ªå®šä¹‰ API é…ç½® */\r\n    custom_api: z\r\n        .object({\r\n            enabled: z.boolean().prefault(false),\r\n            apiurl: z.string().prefault(''),\r\n            key: z.string().prefault(''),\r\n            model: z.string().prefault(''),\r\n            source: z.string().prefault('openai'),\r\n        })\r\n        .prefault({}),\r\n    /** æ¶ˆæ¯æ¸…æ´—æ­£åˆ™åˆ—è¡¨ */\r\n    message_cleanup_regex: z\r\n        .array(\r\n            z.object({\r\n                pattern: z.string(),\r\n                flags: z.string().prefault('g'),\r\n                replacement: z.string().prefault(''),\r\n            }),\r\n        )\r\n        .prefault([]),\r\n\r\n    // === è¿è¡Œæ—¶å…ƒæ•°æ® ===\r\n    /** å½“å‰å·å· */\r\n    current_volume: z.coerce.number().prefault(1),\r\n    /** ä¸Šæ¬¡å¤„ç†åˆ°çš„æ¥¼å±‚ ID */\r\n    last_processed_message_id: z.coerce.number().prefault(-1),\r\n    /** å·²å½’æ¡£çš„å·ä¿¡æ¯ */\r\n    volumes: z\r\n        .array(\r\n            z.object({\r\n                volume: z.coerce.number(),\r\n                start_message_id: z.coerce.number(),\r\n                end_message_id: z.coerce.number(),\r\n            }),\r\n        )\r\n        .prefault([]),\r\n}).prefault({});\r\n\r\nexport type ScriptDataType = z.output<typeof ScriptData>;\r\n\r\n// ========== è„šæœ¬å˜é‡è¯»å†™ ==========\r\n\r\n/** è·å–è„šæœ¬æ•°æ®ï¼ˆè®¾ç½® + å…ƒæ•°æ®ï¼‰ */\r\nexport function getScriptData(): ScriptDataType {\r\n    const raw = getVariables({ type: 'script' });\r\n    return ScriptData.parse(raw);\r\n}\r\n\r\n/** ä¿å­˜è„šæœ¬æ•°æ® */\r\nexport function saveScriptData(data: ScriptDataType): void {\r\n    replaceVariables(data as Record<string, any>, { type: 'script' });\r\n}\r\n\r\n/** è·å–è®¾ç½®ï¼ˆScriptData çš„åˆ«åï¼Œæ–¹ä¾¿è¯­ä¹‰ä½¿ç”¨ï¼‰ */\r\nexport function getSettings(): ScriptDataType {\r\n    return getScriptData();\r\n}\r\n","/**\r\n * ä»»åŠ¡é˜Ÿåˆ—\r\n * - ä¸²è¡Œå¤„ç†æ€»ç»“ä»»åŠ¡ï¼Œé¿å…å¹¶å‘å†²çª\r\n * - åŒä¸€æ¥¼å±‚çš„å°æ€»ç»“ä»»åŠ¡å»é‡\r\n */\r\n\r\nexport type TaskType = 'mini_summary' | 'volume_summary';\r\n\r\nexport type SummaryTask = {\r\n    type: TaskType;\r\n    message_id?: number;\r\n};\r\n\r\ntype TaskHandler = {\r\n    mini_summary: (message_id: number) => Promise<void>;\r\n    volume_summary: () => Promise<void>;\r\n};\r\n\r\nexport class TaskQueue {\r\n    private queue: SummaryTask[] = [];\r\n    private processing = false;\r\n    private handlers: TaskHandler | null = null;\r\n\r\n    /** æ³¨å†Œä»»åŠ¡å¤„ç†å‡½æ•° */\r\n    setHandlers(handlers: TaskHandler): void {\r\n        this.handlers = handlers;\r\n    }\r\n\r\n    /** å°†ä»»åŠ¡åŠ å…¥é˜Ÿåˆ— */\r\n    enqueue(task: SummaryTask): void {\r\n        // å»é‡ï¼šåŒä¸€æ¥¼å±‚çš„å°æ€»ç»“ä»»åŠ¡åªä¿ç•™æœ€æ–°çš„\r\n        if (task.type === 'mini_summary' && task.message_id !== undefined) {\r\n            this.queue = this.queue.filter(\r\n                (t) => !(t.type === 'mini_summary' && t.message_id === task.message_id),\r\n            );\r\n        }\r\n        this.queue.push(task);\r\n        void this.processNext();\r\n    }\r\n\r\n    /** ä¾æ¬¡å¤„ç†é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ */\r\n    private async processNext(): Promise<void> {\r\n        if (this.processing || this.queue.length === 0) return;\r\n        this.processing = true;\r\n\r\n        try {\r\n            const task = this.queue.shift()!;\r\n            if (!this.handlers) {\r\n                console.error('[è‡ªåŠ¨æ€»ç»“] ä»»åŠ¡å¤„ç†å‡½æ•°æœªæ³¨å†Œ');\r\n                return;\r\n            }\r\n\r\n            if (task.type === 'mini_summary' && task.message_id !== undefined) {\r\n                await this.handlers.mini_summary(task.message_id);\r\n            } else if (task.type === 'volume_summary') {\r\n                await this.handlers.volume_summary();\r\n            }\r\n        } catch (e) {\r\n            console.error('[è‡ªåŠ¨æ€»ç»“] æ€»ç»“ä»»åŠ¡æ‰§è¡Œå¤±è´¥:', e);\r\n        } finally {\r\n            this.processing = false;\r\n            if (this.queue.length > 0) {\r\n                await this.processNext();\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\n/** å…¨å±€ä»»åŠ¡é˜Ÿåˆ—å®ä¾‹ */\r\nexport const taskQueue = new TaskQueue();\r\n","/**\r\n * ä¸–ç•Œä¹¦æ“ä½œ\r\n * - åˆ›å»º/è¯»/å†™/åˆ‡æ¢/åŒæ­¥ enabled\r\n * - å°æ€»ç»“æ¡ç›®ç®¡ç†\r\n * - å·æ¡ç›®ç®¡ç†\r\n */\r\n\r\nimport {\r\n    getScriptData,\r\n    getSettings,\r\n    saveScriptData,\r\n    getMiniSummaryOrder,\r\n    getVolumeOrder,\r\n    ENTRY_DEFAULTS,\r\n} from '@/config';\r\n\r\n// ========== ä¸–ç•Œä¹¦åç§° ==========\r\n\r\n/** è¿”å›å½“å‰è§’è‰²å¡çš„æ€»ç»“ä¸–ç•Œä¹¦åç§° */\r\nexport function getWorldbookName(): string {\r\n    const charName = getCurrentCharacterName();\r\n    if (!charName) {\r\n        throw new Error('[è‡ªåŠ¨æ€»ç»“] æœªæ‰“å¼€è§’è‰²å¡ï¼Œæ— æ³•è·å–ä¸–ç•Œä¹¦åç§°');\r\n    }\r\n    return `${charName}[è‡ªåŠ¨æ€»ç»“]`;\r\n}\r\n\r\n// ========== ä¸–ç•Œä¹¦ç”Ÿå‘½å‘¨æœŸ ==========\r\n\r\n/** ç¡®ä¿å½“å‰è§’è‰²å¡çš„æ€»ç»“ä¸–ç•Œä¹¦å­˜åœ¨ï¼Œä¸å­˜åœ¨åˆ™åˆ›å»º */\r\nexport async function ensureWorldbook(): Promise<void> {\r\n    const name = getWorldbookName();\r\n    const existingNames = getWorldbookNames();\r\n    if (!existingNames.includes(name)) {\r\n        await createWorldbook(name, []);\r\n        console.log(`[è‡ªåŠ¨æ€»ç»“] å·²åˆ›å»ºä¸–ç•Œä¹¦: ${name}`);\r\n    }\r\n}\r\n\r\n/**\r\n * ä»å…¨å±€ä¸–ç•Œä¹¦åˆ—è¡¨ä¸­ç§»é™¤å…¶ä»–è§’è‰²å¡çš„æ€»ç»“ä¸–ç•Œä¹¦ï¼Œç¡®ä¿å½“å‰è§’è‰²å¡çš„åœ¨åˆ—è¡¨ä¸­\r\n */\r\nexport async function switchToCurrentCharWorldbook(): Promise<void> {\r\n    const currentName = getWorldbookName();\r\n    const globalBooks = getGlobalWorldbookNames();\r\n    // è¿‡æ»¤æ‰å…¶ä»–è§’è‰²å¡çš„[è‡ªåŠ¨æ€»ç»“]ä¸–ç•Œä¹¦ï¼Œä¿ç•™å½“å‰çš„\r\n    const filtered = globalBooks.filter(\r\n        (name) => !name.endsWith('[è‡ªåŠ¨æ€»ç»“]') || name === currentName,\r\n    );\r\n    if (!filtered.includes(currentName)) {\r\n        filtered.push(currentName);\r\n    }\r\n    await rebindGlobalWorldbooks(filtered);\r\n}\r\n\r\n// ========== å°æ€»ç»“æ¡ç›®æ“ä½œ ==========\r\n\r\n/** è·å–æŒ‡å®šæ¥¼å±‚çš„å°æ€»ç»“æ¡ç›® */\r\nexport async function getMiniSummaryEntry(\r\n    message_id: number,\r\n): Promise<WorldbookEntry | undefined> {\r\n    const worldbook = await getWorldbook(getWorldbookName());\r\n    const entryName = `[å°æ€»ç»“-æ¥¼å±‚${message_id}]`;\r\n    return worldbook.find((e) => e.name === entryName);\r\n}\r\n\r\n/** åˆ›å»ºæˆ–æ›¿æ¢æŒ‡å®šæ¥¼å±‚çš„å°æ€»ç»“æ¡ç›® */\r\nexport async function upsertMiniSummaryEntry(\r\n    message_id: number,\r\n    content: string,\r\n): Promise<void> {\r\n    const worldbookName = getWorldbookName();\r\n    const entryName = `[å°æ€»ç»“-æ¥¼å±‚${message_id}]`;\r\n\r\n    const worldbook = await getWorldbook(worldbookName);\r\n    const existing = worldbook.find((e) => e.name === entryName);\r\n\r\n    if (existing) {\r\n        // å·²å­˜åœ¨åˆ™æ›¿æ¢ content\r\n        await updateWorldbookWith(worldbookName, (wb) => {\r\n            const entry = wb.find((e) => e.name === entryName);\r\n            if (entry) {\r\n                entry.content = content;\r\n            }\r\n            return wb;\r\n        });\r\n    } else {\r\n        // ä¸å­˜åœ¨åˆ™æ–°å»º\r\n        const settings = getSettings();\r\n        await createWorldbookEntries(worldbookName, [\r\n            {\r\n                ...ENTRY_DEFAULTS,\r\n                name: entryName,\r\n                content,\r\n                position: {\r\n                    type: 'at_depth',\r\n                    role: 'system',\r\n                    depth: settings.mini_summary_depth,\r\n                    order: getMiniSummaryOrder(message_id, settings.mini_summary_start_order),\r\n                },\r\n            },\r\n        ]);\r\n    }\r\n}\r\n\r\n/** åˆ›å»ºç©ºå ä½å°æ€»ç»“æ¡ç›®ï¼ˆåŒæ­¥é˜¶æ®µä½¿ç”¨ï¼‰ */\r\nexport async function createPlaceholderMiniSummary(message_id: number): Promise<void> {\r\n    const worldbookName = getWorldbookName();\r\n    const entryName = `[å°æ€»ç»“-æ¥¼å±‚${message_id}]`;\r\n\r\n    const worldbook = await getWorldbook(worldbookName);\r\n    const existing = worldbook.find((e) => e.name === entryName);\r\n\r\n    if (!existing) {\r\n        const settings = getSettings();\r\n        await createWorldbookEntries(worldbookName, [\r\n            {\r\n                ...ENTRY_DEFAULTS,\r\n                name: entryName,\r\n                content: 'ï¼ˆæ€»ç»“ç”Ÿæˆä¸­...ï¼‰',\r\n                position: {\r\n                    type: 'at_depth',\r\n                    role: 'system',\r\n                    depth: settings.mini_summary_depth,\r\n                    order: getMiniSummaryOrder(message_id, settings.mini_summary_start_order),\r\n                },\r\n            },\r\n        ]);\r\n    }\r\n}\r\n\r\n/** è·å–æ‰€æœ‰æœªå½’æ¡£ï¼ˆéå·è¦†ç›–èŒƒå›´å†…ï¼‰çš„å°æ€»ç»“æ¡ç›® */\r\nexport async function getUnarchivedMiniSummaries(): Promise<WorldbookEntry[]> {\r\n    const worldbook = await getWorldbook(getWorldbookName());\r\n    const metadata = getScriptData();\r\n\r\n    // æ”¶é›†å·²å½’æ¡£çš„æ¥¼å±‚ ID\r\n    const archivedIds = new Set<number>();\r\n    for (const vol of metadata.volumes) {\r\n        for (let id = vol.start_message_id; id <= vol.end_message_id; id++) {\r\n            archivedIds.add(id);\r\n        }\r\n    }\r\n\r\n    return worldbook.filter((entry) => {\r\n        const match = entry.name.match(/^\\[å°æ€»ç»“-æ¥¼å±‚(\\d+)\\]$/);\r\n        if (!match) return false;\r\n        const id = parseInt(match[1]);\r\n        return !archivedIds.has(id);\r\n    });\r\n}\r\n\r\n// ========== enabled åŒæ­¥ ==========\r\n\r\n/** æ ¹æ®æ¥¼å±‚å¯è§æ€§å’Œå½’æ¡£çŠ¶æ€åŒæ­¥æ‰€æœ‰å°æ€»ç»“çš„ enabled */\r\nexport async function syncMiniSummaryEnabled(): Promise<void> {\r\n    const settings = getSettings();\r\n    const lastId = getLastMessageId();\r\n    const visibleThreshold = lastId - settings.visible_floors + 1;\r\n    const metadata = getScriptData();\r\n\r\n    // æ”¶é›†å·²å½’æ¡£çš„æ¥¼å±‚ ID èŒƒå›´\r\n    const archivedIds = new Set<number>();\r\n    for (const vol of metadata.volumes) {\r\n        for (let id = vol.start_message_id; id <= vol.end_message_id; id++) {\r\n            archivedIds.add(id);\r\n        }\r\n    }\r\n\r\n    await updateWorldbookWith(getWorldbookName(), (worldbook) => {\r\n        for (const entry of worldbook) {\r\n            const match = entry.name.match(/^\\[å°æ€»ç»“-æ¥¼å±‚(\\d+)\\]$/);\r\n            if (!match) continue;\r\n            const id = parseInt(match[1]);\r\n\r\n            if (id >= visibleThreshold) {\r\n                // å¯è§æ¥¼å±‚ â†’ ä¸æ³¨å…¥\r\n                entry.enabled = false;\r\n            } else if (archivedIds.has(id)) {\r\n                // å·²å½’æ¡£ â†’ ä¸æ³¨å…¥\r\n                entry.enabled = false;\r\n            } else {\r\n                // å·²éšè—ä¸”æœªå½’æ¡£ â†’ æ³¨å…¥\r\n                entry.enabled = true;\r\n            }\r\n        }\r\n        return worldbook;\r\n    });\r\n}\r\n\r\n// ========== å·æ¡ç›®æ“ä½œ ==========\r\n\r\n/** åˆ›å»ºå·æ¡ç›®å¹¶å…³é—­å¯¹åº”èŒƒå›´å†…çš„å°æ€»ç»“ */\r\nexport async function createVolumeEntry(\r\n    volume: number,\r\n    start_id: number,\r\n    end_id: number,\r\n    content: string,\r\n): Promise<void> {\r\n    const worldbookName = getWorldbookName();\r\n    const entryName = `[å·${volume}-æ¥¼å±‚${start_id}~æ¥¼å±‚${end_id}]`;\r\n\r\n    await updateWorldbookWith(worldbookName, (worldbook) => {\r\n        // 1. å…³é—­è¯¥èŒƒå›´å†…çš„å°æ€»ç»“æ¡ç›®\r\n        for (const entry of worldbook) {\r\n            const match = entry.name.match(/^\\[å°æ€»ç»“-æ¥¼å±‚(\\d+)\\]$/);\r\n            if (!match) continue;\r\n            const id = parseInt(match[1]);\r\n            if (id >= start_id && id <= end_id) {\r\n                entry.enabled = false;\r\n            }\r\n        }\r\n\r\n        // 2. æ·»åŠ å·æ¡ç›®\r\n        const settings = getSettings();\r\n        worldbook.push({\r\n            ...ENTRY_DEFAULTS,\r\n            enabled: true,\r\n            name: entryName,\r\n            content,\r\n            position: {\r\n                type: 'at_depth',\r\n                role: 'system',\r\n                depth: settings.volume_summary_depth,\r\n                order: getVolumeOrder(volume, settings.volume_start_order),\r\n            },\r\n        } as WorldbookEntry);\r\n\r\n        return worldbook;\r\n    });\r\n\r\n    // 3. æ›´æ–°è„šæœ¬å˜é‡å…ƒæ•°æ®\r\n    const data = getScriptData();\r\n    data.current_volume = volume + 1;\r\n    data.volumes.push({ volume, start_message_id: start_id, end_message_id: end_id });\r\n    saveScriptData(data);\r\n}\r\n\r\n/** è·å–æ‰€æœ‰å·²æœ‰å·æ¡ç›® */\r\nexport async function getVolumes(): Promise<WorldbookEntry[]> {\r\n    const worldbook = await getWorldbook(getWorldbookName());\r\n    return worldbook.filter((entry) => /^\\[å·\\d+-æ¥¼å±‚\\d+~æ¥¼å±‚\\d+\\]$/.test(entry.name));\r\n}\r\n","/**\r\n * æ€»ç»“æ ¸å¿ƒé€»è¾‘\r\n * - æ¶ˆæ¯æ¸…æ´—\r\n * - å°æ€»ç»“ç”Ÿæˆ\r\n * - å¤§æ€»ç»“ç”Ÿæˆ\r\n * - å¤§æ€»ç»“è§¦å‘æ£€æŸ¥\r\n */\r\n\r\nimport { getScriptData, getSettings, saveScriptData, type ScriptDataType } from '@/config';\r\nimport {\r\n    getMiniSummaryPrompt,\r\n    getVolumeSummaryPrompt,\r\n    getVolumeCompletionCheckPrompt,\r\n} from '@/prompts';\r\nimport {\r\n    getWorldbookName,\r\n    upsertMiniSummaryEntry,\r\n    getUnarchivedMiniSummaries,\r\n    getVolumes,\r\n    createVolumeEntry,\r\n} from '@/worldbook';\r\n\r\n// ========== æ¶ˆæ¯æ¸…æ´— ==========\r\n\r\n/** ä½¿ç”¨ç”¨æˆ·è‡ªå®šä¹‰æ­£åˆ™æ¸…æ´—æ¶ˆæ¯å†…å®¹ */\r\nexport function cleanMessage(message: string, settings: ScriptDataType): string {\r\n    let cleaned = message;\r\n    for (const regex of settings.message_cleanup_regex) {\r\n        try {\r\n            const re = new RegExp(regex.pattern, regex.flags);\r\n            cleaned = cleaned.replace(re, regex.replacement);\r\n        } catch (e) {\r\n            console.error(`[è‡ªåŠ¨æ€»ç»“] æ­£åˆ™æ¸…æ´—é”™è¯¯ (pattern: ${regex.pattern}):`, e);\r\n            // è·³è¿‡æ— æ•ˆæ­£åˆ™\r\n        }\r\n    }\r\n    return cleaned;\r\n}\r\n\r\n// ========== AI ç”Ÿæˆè¾…åŠ© ==========\r\n\r\n/** æ„å»º generateRaw çš„è‡ªå®šä¹‰ API é…ç½® */\r\nfunction buildCustomApi(settings: ScriptDataType): Record<string, any> | undefined {\r\n    if (!settings.custom_api.enabled) return undefined;\r\n    return {\r\n        apiurl: settings.custom_api.apiurl,\r\n        key: settings.custom_api.key,\r\n        model: settings.custom_api.model,\r\n        source: settings.custom_api.source,\r\n    };\r\n}\r\n\r\n/** è°ƒç”¨ AI ç”Ÿæˆæ–‡æœ¬ */\r\nasync function callAI(\r\n    systemPrompt: string,\r\n    userPrompt: string,\r\n    settings: ScriptDataType,\r\n): Promise<string> {\r\n    try {\r\n        const result = await generateRaw({\r\n            should_silence: true,\r\n            custom_api: buildCustomApi(settings) as any,\r\n            ordered_prompts: [\r\n                { role: 'system', content: systemPrompt },\r\n                { role: 'user', content: userPrompt },\r\n            ],\r\n        });\r\n        return result;\r\n    } catch (e) {\r\n        // è‡ªå®šä¹‰ API å¤±è´¥æ—¶é™çº§ä½¿ç”¨é…’é¦†å½“å‰ API\r\n        if (settings.custom_api.enabled) {\r\n            console.warn('[è‡ªåŠ¨æ€»ç»“] è‡ªå®šä¹‰ API å¤±è´¥ï¼Œé™çº§ä½¿ç”¨é…’é¦†å½“å‰ API:', e);\r\n            const result = await generateRaw({\r\n                should_silence: true,\r\n                ordered_prompts: [\r\n                    { role: 'system', content: systemPrompt },\r\n                    { role: 'user', content: userPrompt },\r\n                ],\r\n            });\r\n            return result;\r\n        }\r\n        throw e;\r\n    }\r\n}\r\n\r\n// ========== å°æ€»ç»“ ==========\r\n\r\n/** ç”Ÿæˆå•æ¡æ¶ˆæ¯çš„å°æ€»ç»“å†…å®¹ */\r\nexport async function generateMiniSummaryContent(message_id: number): Promise<string> {\r\n    const settings = getSettings();\r\n    const worldbook = await getWorldbook(getWorldbookName());\r\n\r\n    // è·å–å‰ 2 ä¸ªå°æ€»ç»“ä½œä¸ºä¸Šä¸‹æ–‡\r\n    const allMiniEntries = worldbook\r\n        .filter((e) => e.name.match(/^\\[å°æ€»ç»“-æ¥¼å±‚(\\d+)\\]$/))\r\n        .map((e) => ({\r\n            id: parseInt(e.name.match(/æ¥¼å±‚(\\d+)/)![1]),\r\n            content: e.content,\r\n        }))\r\n        .filter((e) => e.id < message_id)\r\n        .sort((a, b) => a.id - b.id)\r\n        .slice(-2);\r\n\r\n    const context = allMiniEntries.map((e) => e.content).join('\\n');\r\n\r\n    // è·å–å¹¶æ¸…æ´—å½“å‰æ¥¼å±‚æ¶ˆæ¯\r\n    const messages = getChatMessages(message_id);\r\n    if (messages.length === 0) {\r\n        throw new Error(`[è‡ªåŠ¨æ€»ç»“] æ¥¼å±‚ ${message_id} ä¸å­˜åœ¨`);\r\n    }\r\n    const message = messages[0].message;\r\n\r\n    // è·³è¿‡ç©ºæ¶ˆæ¯\r\n    if (!message || message.trim() === '') {\r\n        return 'ï¼ˆç©ºæ¶ˆæ¯ï¼‰';\r\n    }\r\n\r\n    const cleaned = cleanMessage(message, settings);\r\n    const prompt = getMiniSummaryPrompt(cleaned, context);\r\n\r\n    return await callAI(prompt.system, prompt.user, settings);\r\n}\r\n\r\n/** å¤„ç†å°æ€»ç»“ä»»åŠ¡ - ç”Ÿæˆå†…å®¹å¹¶å†™å…¥å·²åˆ›å»ºçš„æ¡ç›® */\r\nexport async function handleMiniSummary(message_id: number): Promise<void> {\r\n    // ç”Ÿæˆå°æ€»ç»“å†…å®¹\r\n    const summary = await generateMiniSummaryContent(message_id);\r\n\r\n    // å°†ç»“æœå†™å…¥å·²å­˜åœ¨çš„æ¡ç›®ï¼ˆupsert å¤„ç†ï¼Œè‹¥æ¡ç›®ä¸å­˜åœ¨ä¹Ÿä¼šåˆ›å»ºï¼‰\r\n    await upsertMiniSummaryEntry(message_id, summary);\r\n\r\n    // æ›´æ–°å…ƒæ•°æ®\r\n    const data = getScriptData();\r\n    data.last_processed_message_id = message_id;\r\n    saveScriptData(data);\r\n}\r\n\r\n// ========== å¤§æ€»ç»“ ==========\r\n\r\n/** æ£€æŸ¥æ˜¯å¦åº”è¯¥è§¦å‘å¤§æ€»ç»“ */\r\nexport async function shouldTriggerVolumeSummary(): Promise<boolean> {\r\n    const settings = getSettings();\r\n    const unarchivedEntries = await getUnarchivedMiniSummaries();\r\n\r\n    if (unarchivedEntries.length === 0) return false;\r\n\r\n    // æ£€æŸ¥ token é˜ˆå€¼ï¼ˆç®€å•ç”¨å­—ç¬¦æ•°ä¼°ç®— token æ•°ï¼Œä¸­æ–‡çº¦ 1 å­— â‰ˆ 1-2 tokenï¼‰\r\n    const totalContent = unarchivedEntries.map((e) => e.content).join('');\r\n    const estimatedTokens = totalContent.length; // ç²—ç•¥ä¼°ç®—\r\n\r\n    if (estimatedTokens > settings.volume_token_threshold) {\r\n        return true;\r\n    }\r\n\r\n    // AI åˆ¤æ–­æ˜¯å¦ä¸€å·å·²å®Œç»“\r\n    try {\r\n        const miniSummaries = unarchivedEntries.map((e) => e.content);\r\n        const prompt = getVolumeCompletionCheckPrompt(miniSummaries);\r\n        const result = await callAI(prompt.system, prompt.user, settings);\r\n        // æ£€æŸ¥å›ç­”ä¸­æ˜¯å¦åŒ…å« 114514ï¼ˆå®Œç»“ï¼‰æˆ– 1919810ï¼ˆæœªå®Œç»“ï¼‰\r\n        if (result.includes('114514')) return true;\r\n        if (result.includes('1919810')) return false;\r\n        // éƒ½ä¸åŒ…å«æ—¶é»˜è®¤ä¸è§¦å‘\r\n        console.warn('[è‡ªåŠ¨æ€»ç»“] å·å®Œç»“æ£€æµ‹è¿”å›äº†æ„å¤–å†…å®¹:', result);\r\n        return false;\r\n    } catch (e) {\r\n        console.error('[è‡ªåŠ¨æ€»ç»“] å·å®Œç»“æ£€æµ‹å¤±è´¥:', e);\r\n        return false;\r\n    }\r\n}\r\n\r\n/** ç”Ÿæˆå¤§æ€»ç»“å†…å®¹ */\r\nexport async function generateVolumeSummaryContent(\r\n    mini_summaries: WorldbookEntry[],\r\n): Promise<string> {\r\n    const settings = getSettings();\r\n    const volumes = await getVolumes();\r\n\r\n    const miniContents = mini_summaries.map((e) => e.content);\r\n    const previousVolumeContents = volumes\r\n        .sort((a, b) => {\r\n            const aVol = parseInt(a.name.match(/å·(\\d+)/)![1]);\r\n            const bVol = parseInt(b.name.match(/å·(\\d+)/)![1]);\r\n            return aVol - bVol;\r\n        })\r\n        .map((e) => e.content);\r\n\r\n    const prompt = getVolumeSummaryPrompt(miniContents, previousVolumeContents);\r\n    return await callAI(prompt.system, prompt.user, settings);\r\n}\r\n\r\n/** æ‰§è¡Œå®Œæ•´çš„å¤§æ€»ç»“æµç¨‹ */\r\nexport async function performVolumeSummary(): Promise<void> {\r\n    const data = getScriptData();\r\n    const unarchivedEntries = await getUnarchivedMiniSummaries();\r\n\r\n    if (unarchivedEntries.length === 0) return;\r\n\r\n    // å…ˆæ£€æŸ¥æ˜¯å¦æ»¡è¶³å¤§æ€»ç»“æ¡ä»¶\r\n    const shouldTrigger = await shouldTriggerVolumeSummary();\r\n    if (!shouldTrigger) return;\r\n\r\n    // æå–æ¥¼å±‚ ID èŒƒå›´\r\n    const ids = unarchivedEntries\r\n        .map((e) => parseInt(e.name.match(/æ¥¼å±‚(\\d+)/)![1]))\r\n        .sort((a, b) => a - b);\r\n\r\n    const start_id = ids[0];\r\n    const end_id = ids[ids.length - 1];\r\n\r\n    // ç”Ÿæˆå¤§æ€»ç»“\r\n    const content = await generateVolumeSummaryContent(unarchivedEntries);\r\n\r\n    // åˆ›å»ºå·æ¡ç›®å¹¶å…³é—­å¯¹åº”å°æ€»ç»“\r\n    await createVolumeEntry(data.current_volume, start_id, end_id, content);\r\n\r\n    console.log(\r\n        `[è‡ªåŠ¨æ€»ç»“] å·²å½’æ¡£å·${data.current_volume}: æ¥¼å±‚${start_id}~æ¥¼å±‚${end_id}`,\r\n    );\r\n}\r\n","/**\r\n * AI æ€»ç»“æç¤ºè¯æ¨¡æ¿\r\n */\r\n\r\n/** å°æ€»ç»“ç³»ç»Ÿæç¤ºè¯ */\r\nconst MINI_SUMMARY_SYSTEM = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ•…äº‹æ€»ç»“åŠ©æ‰‹ã€‚ä½ çš„ä»»åŠ¡æ˜¯å°†è§’è‰²æ‰®æ¼”èŠå¤©è®°å½•ä¸­çš„ä¸€æ¡æ¶ˆæ¯æ€»ç»“ä¸ºç®€æ´çš„å°æ€»ç»“ã€‚\r\n\r\nè¦æ±‚ï¼š\r\n1. ä¿ç•™å…³é”®æƒ…èŠ‚ã€è§’è‰²è¡Œä¸ºã€æƒ…æ„Ÿå˜åŒ–å’Œé‡è¦å¯¹è¯\r\n2. ä½¿ç”¨ç¬¬ä¸‰äººç§°å™è¿°\r\n3. æ€»ç»“åº”ç®€æ´æ˜äº†ï¼Œæ§åˆ¶åœ¨ 200 å­—ä»¥å†…\r\n4. ä¸è¦æ·»åŠ ä»»ä½•è¯„è®ºã€åˆ†ææˆ–ä½ è‡ªå·±çš„æƒ³æ³•\r\n5. åªè¾“å‡ºæ€»ç»“å†…å®¹ï¼Œä¸è¦æ·»åŠ æ ‡é¢˜ã€ç¼–å·æˆ–å…¶ä»–æ ¼å¼`;\r\n\r\n/** å°æ€»ç»“æç¤ºè¯ */\r\nexport function getMiniSummaryPrompt(\r\n    message: string,\r\n    context: string,\r\n): { system: string; user: string } {\r\n    let userPrompt = '';\r\n    if (context) {\r\n        userPrompt += `ä»¥ä¸‹æ˜¯ä¹‹å‰çš„æ€»ç»“ï¼Œä¾›ä½ äº†è§£ä¸Šä¸‹æ–‡ï¼š\\n${context}\\n\\n---\\n\\n`;\r\n    }\r\n    userPrompt += `è¯·æ€»ç»“ä»¥ä¸‹æ¶ˆæ¯ï¼š\\n\\n${message}`;\r\n\r\n    return {\r\n        system: MINI_SUMMARY_SYSTEM,\r\n        user: userPrompt,\r\n    };\r\n}\r\n\r\n/** å¤§æ€»ç»“ç³»ç»Ÿæç¤ºè¯ */\r\nconst VOLUME_SUMMARY_SYSTEM = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ•…äº‹æ€»ç»“åŠ©æ‰‹ã€‚ä½ çš„ä»»åŠ¡æ˜¯å°†ä¸€ç³»åˆ—å°æ€»ç»“åˆå¹¶ä¸ºä¸€ä¸ªå®Œæ•´çš„å·æ€»ç»“ã€‚\r\n\r\nè¦æ±‚ï¼š\r\n1. å°†æ‰€æœ‰å°æ€»ç»“çš„å†…å®¹æ•´åˆä¸ºè¿è´¯çš„å™è¿°\r\n2. ä¿ç•™ä¸»è¦æƒ…èŠ‚çº¿ã€è§’è‰²å‘å±•ã€å…³é”®äº‹ä»¶å’Œé‡è¦å¯¹è¯\r\n3. æŒ‰æ—¶é—´é¡ºåºç»„ç»‡å†…å®¹\r\n4. ä½¿ç”¨ç¬¬ä¸‰äººç§°å™è¿°\r\n5. æ€»ç»“åº”å…¨é¢ä½†ç²¾ç‚¼ï¼Œæ§åˆ¶åœ¨ 1000 å­—ä»¥å†…\r\n6. ä¸è¦æ·»åŠ ä»»ä½•è¯„è®ºã€åˆ†ææˆ–ä½ è‡ªå·±çš„æƒ³æ³•\r\n7. åªè¾“å‡ºæ€»ç»“å†…å®¹ï¼Œä¸è¦æ·»åŠ æ ‡é¢˜ã€ç¼–å·æˆ–å…¶ä»–æ ¼å¼`;\r\n\r\n/** å¤§æ€»ç»“æç¤ºè¯ */\r\nexport function getVolumeSummaryPrompt(\r\n    mini_summaries: string[],\r\n    previous_volumes: string[],\r\n): { system: string; user: string } {\r\n    let userPrompt = '';\r\n    if (previous_volumes.length > 0) {\r\n        userPrompt += `ä»¥ä¸‹æ˜¯ä¹‹å‰å„å·çš„å¤§æ€»ç»“ï¼Œä¾›ä½ äº†è§£å‰æƒ…ï¼š\\n\\n`;\r\n        previous_volumes.forEach((vol, i) => {\r\n            userPrompt += `--- ç¬¬${i + 1}å· ---\\n${vol}\\n\\n`;\r\n        });\r\n        userPrompt += `===\\n\\n`;\r\n    }\r\n    userPrompt += `è¯·å°†ä»¥ä¸‹å°æ€»ç»“åˆå¹¶ä¸ºä¸€ä¸ªå®Œæ•´çš„å·æ€»ç»“ï¼š\\n\\n`;\r\n    mini_summaries.forEach((summary, i) => {\r\n        userPrompt += `[${i + 1}] ${summary}\\n\\n`;\r\n    });\r\n\r\n    return {\r\n        system: VOLUME_SUMMARY_SYSTEM,\r\n        user: userPrompt,\r\n    };\r\n}\r\n\r\n/** å·å®Œç»“æ£€æµ‹ç³»ç»Ÿæç¤ºè¯ */\r\nconst VOLUME_COMPLETION_CHECK_SYSTEM = `ä½ æ˜¯ä¸€ä¸ªæ•…äº‹åˆ†æåŠ©æ‰‹ã€‚æ ¹æ®ä»¥ä¸‹æ€»ç»“å†…å®¹ï¼Œåˆ¤æ–­å½“å‰è¿™ä¸€å·æ•…äº‹æ˜¯å¦å·²ç»è¾¾åˆ°äº†ä¸€ä¸ªè‡ªç„¶çš„æ®µè½ç»“å°¾ï¼ˆå¦‚ï¼šä¸€ä¸ªç« èŠ‚ç»“æŸã€ä¸€ä¸ªäº‹ä»¶å‘Šä¸€æ®µè½ã€åœºæ™¯å¤§å¹…è½¬æ¢ç­‰ï¼‰ã€‚\r\n\r\nåªéœ€å›ç­”\"114514\"æˆ–\"1919810\"ï¼Œä¸è¦åšä»»ä½•è§£é‡Šã€‚\r\n- å›ç­”\"114514\"è¡¨ç¤ºè¿™ä¸€å·å·²ç»åˆ°äº†ä¸€ä¸ªåˆé€‚çš„æ–­ç‚¹ï¼Œå¯ä»¥å½’æ¡£\r\n- å›ç­”\"1919810\"è¡¨ç¤ºæ•…äº‹ä»åœ¨è¿›è¡Œä¸­ï¼Œä¸é€‚åˆåœ¨è¿™é‡Œæ–­å¼€`;\r\n\r\n/** å·å®Œç»“æ£€æµ‹æç¤ºè¯ */\r\nexport function getVolumeCompletionCheckPrompt(mini_summaries: string[]): {\r\n    system: string;\r\n    user: string;\r\n} {\r\n    let userPrompt = `ä»¥ä¸‹æ˜¯æœ€è¿‘ä¸€æ®µæ—¶é—´çš„å°æ€»ç»“åºåˆ—ï¼š\\n\\n`;\r\n    mini_summaries.forEach((summary, i) => {\r\n        userPrompt += `[${i + 1}] ${summary}\\n\\n`;\r\n    });\r\n    userPrompt += `è¯·åˆ¤æ–­ä»¥ä¸Šå†…å®¹æ˜¯å¦å·²ç»åˆ°äº†ä¸€ä¸ªè‡ªç„¶çš„æ®µè½ç»“å°¾ï¼Ÿ`;\r\n\r\n    return {\r\n        system: VOLUME_COMPLETION_CHECK_SYSTEM,\r\n        user: userPrompt,\r\n    };\r\n}\r\n","/**\r\n * è§¦å‘å™¨\r\n * - ç›‘å¬ MESSAGE_RECEIVED äº‹ä»¶\r\n * - åŒæ­¥é˜¶æ®µï¼šåˆ›å»ºå ä½æ¡ç›® â†’ åŒæ­¥ enabled â†’ æ›´æ–°æ¥¼å±‚å¯è§æ€§\r\n * - å¼‚æ­¥é˜¶æ®µï¼šå°†ä»»åŠ¡åŠ å…¥é˜Ÿåˆ—\r\n */\r\n\r\nimport { getSettings } from '@/config';\r\nimport { taskQueue } from '@/queue';\r\nimport { createPlaceholderMiniSummary, syncMiniSummaryEnabled } from '@/worldbook';\r\nimport { updateFloorVisibility } from '@/chat-manager';\r\n\r\n/** å°æ€»ç»“è®¡æ•°å™¨ï¼ˆç”¨äºå¤§æ€»ç»“æ£€æŸ¥é—´éš”ï¼‰ */\r\nlet miniSummaryCount = 0;\r\n\r\n/** æ£€æŸ¥æ˜¯å¦åº”è¯¥è§¦å‘å¤§æ€»ç»“æ£€æŸ¥ */\r\nfunction shouldCheckVolumeSummary(): boolean {\r\n    const settings = getSettings();\r\n    if (!settings.auto_volume_summary) return false;\r\n    return miniSummaryCount % settings.check_interval === 0 && miniSummaryCount > 0;\r\n}\r\n\r\n/** MESSAGE_RECEIVED äº‹ä»¶å¤„ç†å‡½æ•° */\r\nasync function onMessageReceived(message_id: number): Promise<void> {\r\n    const settings = getSettings();\r\n\r\n    // å¦‚æœæœªå¯ç”¨è‡ªåŠ¨å°æ€»ç»“ï¼Œç›´æ¥è¿”å›\r\n    if (!settings.auto_mini_summary) return;\r\n\r\n    // è·³è¿‡ç³»ç»Ÿæ¶ˆæ¯\r\n    const messages = getChatMessages(message_id);\r\n    if (messages.length === 0) return;\r\n    const msg = messages[0];\r\n    if (msg.role === 'system') return;\r\n    if (!msg.message || msg.message.trim() === '') return;\r\n\r\n    // å¿½ç•¥å‰ N å±‚çš„æ¶ˆæ¯\r\n    if (message_id < settings.ignore_floors) return;\r\n\r\n    try {\r\n        // === åŒæ­¥é˜¶æ®µ ===\r\n\r\n        // 1. æ–°å»ºå½“å‰æ¥¼å±‚çš„å°æ€»ç»“ä¸–ç•Œä¹¦æ¡ç›®ï¼ˆå†…å®¹ä¸ºç©ºå ä½ï¼‰\r\n        await createPlaceholderMiniSummary(message_id);\r\n\r\n        // 2. åŒæ­¥å°æ€»ç»“ enabled çŠ¶æ€\r\n        await syncMiniSummaryEnabled();\r\n\r\n        // 3. è°ƒæ•´æ¥¼å±‚éšè—ä¸æ˜¾ç¤º\r\n        await updateFloorVisibility();\r\n\r\n        // === å¼‚æ­¥é˜Ÿåˆ—é˜¶æ®µ ===\r\n\r\n        // 4. é€’å¢è®¡æ•°å™¨\r\n        miniSummaryCount++;\r\n\r\n        // 5. å¤§æ€»ç»“æ£€æŸ¥ï¼ˆå¦‚æœæ»¡è¶³é—´éš”æ¡ä»¶ï¼Œå°†å¤§æ€»ç»“ä»»åŠ¡åŠ å…¥é˜Ÿåˆ—ï¼‰\r\n        if (shouldCheckVolumeSummary()) {\r\n            taskQueue.enqueue({ type: 'volume_summary' });\r\n        }\r\n\r\n        // 6. å°†å°æ€»ç»“ç”Ÿæˆä»»åŠ¡åŠ å…¥å¼‚æ­¥é˜Ÿåˆ—\r\n        taskQueue.enqueue({ type: 'mini_summary', message_id });\r\n    } catch (e) {\r\n        console.error('[è‡ªåŠ¨æ€»ç»“] æ¶ˆæ¯å¤„ç†å¤±è´¥:', e);\r\n    }\r\n}\r\n\r\n/** æ³¨å†Œäº‹ä»¶ç›‘å¬ */\r\nexport function registerListeners(): EventOnReturn {\r\n    return eventOn(\r\n        tavern_events.MESSAGE_RECEIVED,\r\n        errorCatched((message_id: number) => {\r\n            void onMessageReceived(message_id);\r\n        }),\r\n    );\r\n}\r\n","/**\r\n * èŠå¤©æ¥¼å±‚ç®¡ç†\r\n * - éšè—/æ˜¾ç¤ºæ¥¼å±‚\r\n * - ä¸å°æ€»ç»“ enabled çŠ¶æ€è”åŠ¨\r\n */\r\n\r\nimport { getSettings } from '@/config';\r\nimport { syncMiniSummaryEnabled } from '@/worldbook';\r\n\r\n/** æ ¹æ®è®¾ç½®æ›´æ–°æ¥¼å±‚éšè—çŠ¶æ€ */\r\nexport async function updateFloorVisibility(): Promise<void> {\r\n    const settings = getSettings();\r\n    const lastId = getLastMessageId();\r\n\r\n    if (lastId < 0) return;\r\n\r\n    // è·å–æ‰€æœ‰æ¥¼å±‚\r\n    const allMessages = getChatMessages(`0-${lastId}`);\r\n    if (allMessages.length === 0) return;\r\n\r\n    const visibleThreshold = lastId - settings.visible_floors + 1;\r\n\r\n    // æ„å»ºéœ€è¦æ›´æ–°çš„æ¶ˆæ¯åˆ—è¡¨\r\n    const updates: Array<{ message_id: number; is_hidden: boolean }> = [];\r\n\r\n    for (const msg of allMessages) {\r\n        if (msg.role === 'system') continue; // è·³è¿‡ç³»ç»Ÿæ¶ˆæ¯\r\n\r\n        if (msg.message_id >= visibleThreshold) {\r\n            // æœ€è¿‘ N æ¥¼è®¾ä¸ºå¯è§\r\n            if (msg.is_hidden) {\r\n                updates.push({ message_id: msg.message_id, is_hidden: false });\r\n            }\r\n        } else {\r\n            // æ›´æ—©çš„æ¥¼å±‚è®¾ä¸ºéšè—\r\n            if (!msg.is_hidden) {\r\n                updates.push({ message_id: msg.message_id, is_hidden: true });\r\n            }\r\n        }\r\n    }\r\n\r\n    // æ‰¹é‡æ›´æ–°æ¥¼å±‚å¯è§æ€§\r\n    if (updates.length > 0) {\r\n        await setChatMessages(updates, { refresh: 'none' });\r\n    }\r\n\r\n    // åŒæ­¥å°æ€»ç»“ enabled çŠ¶æ€\r\n    await syncMiniSummaryEnabled();\r\n}\r\n","/**\r\n * è®¾ç½® UI å¼¹çª—\r\n * - é€šè¿‡é…’é¦†æ‰©å±•èœå•å…¥å£æ‰“å¼€\r\n * - æä¾›å„é¡¹è®¾ç½®ä¸æ‰‹åŠ¨æ“ä½œæŒ‰é’®\r\n */\r\n\r\nimport { getScriptData, saveScriptData, type ScriptDataType } from '@/config';\r\nimport { taskQueue } from '@/queue';\r\n\r\n// ========== èœå•æ³¨å…¥ ==========\r\n\r\nconst MENU_ID = 'hilo-auto-summary-menu';\r\n\r\n/** å‘æ‰©å±•èœå•æ³¨å…¥å…¥å£ */\r\nexport function addMenuItem(): void {\r\n    const $extensionsMenu = $('#extensionsMenu');\r\n    if (!$extensionsMenu.length) {\r\n        setTimeout(addMenuItem, 2000);\r\n        return;\r\n    }\r\n\r\n    // ç§»é™¤æ—§çš„èœå•é¡¹ï¼ˆè„šæœ¬é‡è½½åæ—§çš„ç‚¹å‡»å¤„ç†å‡½æ•°å·²å¤±æ•ˆï¼‰\r\n    $(`#${MENU_ID}`, $extensionsMenu).remove();\r\n\r\n    const $item = $(`\r\n    <div class=\"list-group-item flex-container flexGap5 interactable\" id=\"${MENU_ID}\" title=\"è‡ªåŠ¨æ€»ç»“è®¾ç½®\">\r\n      <div class=\"fa-fw fa-solid fa-book-open extensionsMenuExtensionButton\"></div>\r\n      <span>è‡ªåŠ¨æ€»ç»“</span>\r\n    </div>\r\n  `);\r\n\r\n    $item.on('click', async (e) => {\r\n        e.stopPropagation();\r\n        const $menuBtn = $('#extensionsMenuButton');\r\n        if ($menuBtn.length && $extensionsMenu.is(':visible')) {\r\n            $menuBtn.trigger('click');\r\n            await new Promise((r) => setTimeout(r, 150));\r\n        }\r\n        await openSettingsPopup();\r\n    });\r\n\r\n    $extensionsMenu.append($item);\r\n}\r\n\r\n// ========== è®¾ç½®å¼¹çª— ==========\r\n\r\n/** æ„å»ºè®¾ç½®å¼¹çª— HTML */\r\nfunction buildSettingsHtml(data: ScriptDataType): string {\r\n    return `\r\n    <div id=\"hilo-summary-settings\" style=\"padding: 10px; max-height: 70vh; overflow-y: auto;\">\r\n      <h3 style=\"margin-top: 0;\">ğŸ“– è‡ªåŠ¨æ€»ç»“è®¾ç½®</h3>\r\n\r\n      <!-- åŸºæœ¬è®¾ç½® -->\r\n      <div style=\"margin-bottom: 15px;\">\r\n        <h4>åŸºæœ¬è®¾ç½®</h4>\r\n        <div style=\"margin-bottom: 8px;\">\r\n          <label>æ˜¾ç¤ºæ¥¼å±‚æ•°ï¼š</label>\r\n          <input type=\"number\" id=\"hs-visible-floors\" value=\"${data.visible_floors}\" min=\"1\" max=\"100\" style=\"width: 80px;\" />\r\n          <small style=\"color: #888;\">ï¼ˆæœ€è¿‘ä¿ç•™å¤šå°‘æ¥¼å¯è§ï¼‰</small>\r\n        </div>\r\n        <div style=\"margin-bottom: 8px;\">\r\n          <label>æ£€æŸ¥é—´éš”ï¼š</label>\r\n          <input type=\"number\" id=\"hs-check-interval\" value=\"${data.check_interval}\" min=\"5\" max=\"100\" style=\"width: 80px;\" />\r\n          <small style=\"color: #888;\">ï¼ˆæ¯å¤šå°‘ä¸ªå°æ€»ç»“æ£€æŸ¥ä¸€æ¬¡å¤§æ€»ç»“ï¼‰</small>\r\n        </div>\r\n        <div style=\"margin-bottom: 8px;\">\r\n          <label>Token é˜ˆå€¼ï¼š</label>\r\n          <input type=\"number\" id=\"hs-volume-token-threshold\" value=\"${data.volume_token_threshold}\" min=\"1000\" max=\"50000\" style=\"width: 100px;\" />\r\n          <small style=\"color: #888;\">ï¼ˆå¤§æ€»ç»“è§¦å‘é˜ˆå€¼ï¼‰</small>\r\n        </div>\r\n        <div style=\"margin-bottom: 8px;\">\r\n          <label>\r\n            <input type=\"checkbox\" id=\"hs-auto-mini-summary\" ${data.auto_mini_summary ? 'checked' : ''} />\r\n            è‡ªåŠ¨å°æ€»ç»“\r\n          </label>\r\n        </div>\r\n        <div style=\"margin-bottom: 8px;\">\r\n          <label>\r\n            <input type=\"checkbox\" id=\"hs-auto-volume-summary\" ${data.auto_volume_summary ? 'checked' : ''} />\r\n            è‡ªåŠ¨å¤§æ€»ç»“\r\n          </label>\r\n        </div>\r\n        <div style=\"margin-bottom: 8px;\">\r\n          <label>å°æ€»ç»“æ³¨å…¥æ·±åº¦ï¼š</label>\r\n          <input type=\"number\" id=\"hs-mini-summary-depth\" value=\"${data.mini_summary_depth}\" min=\"0\" max=\"99999\" style=\"width: 100px;\" />\r\n          <small style=\"color: #888;\">ï¼ˆé»˜è®¤ 9999ï¼‰</small>\r\n        </div>\r\n        <div style=\"margin-bottom: 8px;\">\r\n          <label>å·æ€»ç»“æ³¨å…¥æ·±åº¦ï¼š</label>\r\n          <input type=\"number\" id=\"hs-volume-summary-depth\" value=\"${data.volume_summary_depth}\" min=\"0\" max=\"99999\" style=\"width: 100px;\" />\r\n          <small style=\"color: #888;\">ï¼ˆé»˜è®¤ 9999ï¼‰</small>\r\n        </div>\r\n        <div style=\"margin-bottom: 8px;\">\r\n          <label>å°æ€»ç»“èµ·å§‹æ’åºï¼š</label>\r\n          <input type=\"number\" id=\"hs-mini-start-order\" value=\"${data.mini_summary_start_order}\" min=\"0\" max=\"99999\" style=\"width: 100px;\" />\r\n          <small style=\"color: #888;\">ï¼ˆå°æ€»ç»“ order åŸºæ•°ï¼Œé»˜è®¤ 10000ï¼‰</small>\r\n        </div>\r\n        <div style=\"margin-bottom: 8px;\">\r\n          <label>å·æ€»ç»“èµ·å§‹æ’åºï¼š</label>\r\n          <input type=\"number\" id=\"hs-volume-start-order\" value=\"${data.volume_start_order}\" min=\"0\" max=\"99999\" style=\"width: 100px;\" />\r\n          <small style=\"color: #888;\">ï¼ˆå·æ€»ç»“ order åŸºæ•°ï¼Œé»˜è®¤ 100ï¼‰</small>\r\n        </div>\r\n        <div style=\"margin-bottom: 8px;\">\r\n          <label>å¿½ç•¥å‰ N å±‚ï¼š</label>\r\n          <input type=\"number\" id=\"hs-ignore-floors\" value=\"${data.ignore_floors}\" min=\"0\" max=\"1000\" style=\"width: 80px;\" />\r\n          <small style=\"color: #888;\">ï¼ˆè·³è¿‡å‰å¤šå°‘å±‚ä¸è¿›è¡Œæ€»ç»“ï¼‰</small>\r\n        </div>\r\n      </div>\r\n\r\n      <!-- æ‰‹åŠ¨æ“ä½œ -->\r\n      <div style=\"margin-bottom: 15px;\">\r\n        <h4>æ‰‹åŠ¨æ“ä½œ</h4>\r\n        <div style=\"display: flex; gap: 8px;\">\r\n          <button id=\"hs-manual-mini\" class=\"menu_button\">æ‰‹åŠ¨æ€»ç»“</button>\r\n          <button id=\"hs-manual-volume\" class=\"menu_button\">æ‰‹åŠ¨å½’æ¡£</button>\r\n        </div>\r\n      </div>\r\n\r\n      <!-- è‡ªå®šä¹‰ API -->\r\n      <details style=\"margin-bottom: 15px;\">\r\n        <summary><h4 style=\"display: inline;\">è‡ªå®šä¹‰ API</h4></summary>\r\n        <div style=\"padding: 8px 0;\">\r\n          <div style=\"margin-bottom: 8px;\">\r\n            <label>\r\n              <input type=\"checkbox\" id=\"hs-custom-api-enabled\" ${data.custom_api.enabled ? 'checked' : ''} />\r\n              å¯ç”¨è‡ªå®šä¹‰ API\r\n            </label>\r\n          </div>\r\n          <div style=\"margin-bottom: 8px;\">\r\n            <label>API URLï¼š</label>\r\n            <input type=\"text\" id=\"hs-custom-api-url\" value=\"${escapeHtml(data.custom_api.apiurl)}\" style=\"width: 100%;\" placeholder=\"https://api.example.com/v1\" />\r\n          </div>\r\n          <div style=\"margin-bottom: 8px;\">\r\n            <label>API Keyï¼š</label>\r\n            <input type=\"password\" id=\"hs-custom-api-key\" value=\"${escapeHtml(data.custom_api.key)}\" style=\"width: 100%;\" placeholder=\"sk-...\" />\r\n          </div>\r\n          <div style=\"margin-bottom: 8px;\">\r\n            <label>æ¨¡å‹åç§°ï¼š</label>\r\n            <input type=\"text\" id=\"hs-custom-api-model\" value=\"${escapeHtml(data.custom_api.model)}\" style=\"width: 100%;\" placeholder=\"gpt-4\" />\r\n          </div>\r\n          <div style=\"margin-bottom: 8px;\">\r\n            <label>API æºï¼š</label>\r\n            <select id=\"hs-custom-api-source\" style=\"width: 100%;\">\r\n              ${['openai'].map(\r\n        (s) => `<option value=\"${s}\" ${data.custom_api.source === s ? 'selected' : ''}>${s}</option>`,\r\n    ).join('')}\r\n            </select>\r\n          </div>\r\n        </div>\r\n      </details>\r\n\r\n      <!-- æ¶ˆæ¯æ¸…æ´— -->\r\n      <details style=\"margin-bottom: 15px;\">\r\n        <summary><h4 style=\"display: inline;\">æ¶ˆæ¯æ¸…æ´—æ­£åˆ™</h4></summary>\r\n        <div style=\"padding: 8px 0;\">\r\n          <div id=\"hs-regex-list\">\r\n            ${data.message_cleanup_regex.map((r, i) => buildRegexRowHtml(r, i)).join('')}\r\n          </div>\r\n          <button id=\"hs-add-regex\" class=\"menu_button\" style=\"margin-top: 5px;\">+ æ·»åŠ æ­£åˆ™</button>\r\n        </div>\r\n      </details>\r\n    </div>\r\n  `;\r\n}\r\n\r\n/** æ„å»ºå•è¡Œæ­£åˆ™ HTML */\r\nfunction buildRegexRowHtml(\r\n    regex: { pattern: string; flags: string; replacement: string },\r\n    index: number,\r\n): string {\r\n    return `\r\n    <div class=\"hs-regex-row\" data-index=\"${index}\" style=\"display: flex; gap: 5px; margin-bottom: 5px; align-items: center;\">\r\n      <input type=\"text\" class=\"hs-regex-pattern\" value=\"${escapeHtml(regex.pattern)}\" placeholder=\"æ­£åˆ™\" style=\"flex: 3;\" />\r\n      <input type=\"text\" class=\"hs-regex-flags\" value=\"${escapeHtml(regex.flags)}\" placeholder=\"flags\" style=\"flex: 1; max-width: 60px;\" />\r\n      <input type=\"text\" class=\"hs-regex-replacement\" value=\"${escapeHtml(regex.replacement)}\" placeholder=\"æ›¿æ¢\" style=\"flex: 2;\" />\r\n      <button class=\"hs-remove-regex menu_button\" style=\"flex: 0 0 auto; padding: 2px 8px;\">âœ•</button>\r\n    </div>\r\n  `;\r\n}\r\n\r\n/** HTML è½¬ä¹‰ */\r\nfunction escapeHtml(str: string): string {\r\n    return str\r\n        .replace(/&/g, '&amp;')\r\n        .replace(/</g, '&lt;')\r\n        .replace(/>/g, '&gt;')\r\n        .replace(/\"/g, '&quot;')\r\n        .replace(/'/g, '&#039;');\r\n}\r\n\r\n/** ä»å¼¹çª—æ”¶é›†è®¾ç½®æ•°æ® */\r\nfunction collectSettingsFromPopup(): Partial<ScriptDataType> {\r\n    const regexRows = $('.hs-regex-row');\r\n    const regexList: { pattern: string; flags: string; replacement: string }[] = [];\r\n    regexRows.each(function () {\r\n        const $row = $(this);\r\n        const pattern = $row.find('.hs-regex-pattern').val() as string;\r\n        if (pattern) {\r\n            regexList.push({\r\n                pattern,\r\n                flags: ($row.find('.hs-regex-flags').val() as string) || 'g',\r\n                replacement: ($row.find('.hs-regex-replacement').val() as string) || '',\r\n            });\r\n        }\r\n    });\r\n\r\n    return {\r\n        visible_floors: parseInt($('#hs-visible-floors').val() as string) || 20,\r\n        check_interval: parseInt($('#hs-check-interval').val() as string) || 20,\r\n        volume_token_threshold: parseInt($('#hs-volume-token-threshold').val() as string) || 8000,\r\n        auto_mini_summary: $('#hs-auto-mini-summary').is(':checked'),\r\n        auto_volume_summary: $('#hs-auto-volume-summary').is(':checked'),\r\n        mini_summary_depth: parseInt($('#hs-mini-summary-depth').val() as string) || 9999,\r\n        volume_summary_depth: parseInt($('#hs-volume-summary-depth').val() as string) || 9999,\r\n        mini_summary_start_order: parseInt($('#hs-mini-start-order').val() as string) || 10000,\r\n        volume_start_order: parseInt($('#hs-volume-start-order').val() as string) || 100,\r\n        ignore_floors: parseInt($('#hs-ignore-floors').val() as string) || 0,\r\n        custom_api: {\r\n            enabled: $('#hs-custom-api-enabled').is(':checked'),\r\n            apiurl: ($('#hs-custom-api-url').val() as string) || '',\r\n            key: ($('#hs-custom-api-key').val() as string) || '',\r\n            model: ($('#hs-custom-api-model').val() as string) || '',\r\n            source: ($('#hs-custom-api-source').val() as string) || 'openai',\r\n        },\r\n        message_cleanup_regex: regexList,\r\n    };\r\n}\r\n\r\n/** æ‰“å¼€è®¾ç½®å¼¹çª— */\r\nasync function openSettingsPopup(): Promise<void> {\r\n    const data = getScriptData();\r\n    const html = buildSettingsHtml(data);\r\n\r\n    const $popup = $(html);\r\n\r\n    // ä½¿ç”¨é…’é¦†çš„ callGenericPopupï¼ˆå¦‚æœå¯ç”¨ï¼‰æˆ–åˆ›å»ºç®€å•å¼¹çª—\r\n    const $overlay = $(`<div id=\"hilo-summary-overlay\" style=\"\r\n    position: fixed; top: 0; left: 0; right: 0; bottom: 0;\r\n    background: rgba(0,0,0,0.6); z-index: 9998;\r\n    display: flex; justify-content: center; align-items: center;\r\n  \"></div>`);\r\n\r\n    const $dialog = $(`<div style=\"\r\n    background: var(--SmartThemeBlurTintColor, #2b2b2b);\r\n    border: 1px solid var(--SmartThemeBorderColor, #555);\r\n    border-radius: 10px; padding: 20px; min-width: 400px;\r\n    max-width: 600px; max-height: 80vh; overflow-y: auto;\r\n    color: var(--SmartThemeBodyColor, #ccc);\r\n  \"></div>`);\r\n\r\n    const $buttons = $(`<div style=\"display: flex; justify-content: flex-end; gap: 8px; margin-top: 15px;\">\r\n    <button id=\"hs-cancel\" class=\"menu_button\">å–æ¶ˆ</button>\r\n    <button id=\"hs-save\" class=\"menu_button\">ä¿å­˜</button>\r\n  </div>`);\r\n\r\n    $dialog.append($popup).append($buttons);\r\n    $overlay.append($dialog);\r\n    $('body').append($overlay);\r\n\r\n    // äº‹ä»¶ç»‘å®š\r\n    $overlay.on('click', '#hs-cancel', () => {\r\n        $overlay.remove();\r\n    });\r\n\r\n    $overlay.on('click', '#hs-save', () => {\r\n        const newSettings = collectSettingsFromPopup();\r\n        const currentData = getScriptData();\r\n        const merged = { ...currentData, ...newSettings };\r\n        saveScriptData(merged as ScriptDataType);\r\n        toastr.success('è®¾ç½®å·²ä¿å­˜');\r\n        $overlay.remove();\r\n    });\r\n\r\n    // æ‰‹åŠ¨æ€»ç»“\r\n    $overlay.on('click', '#hs-manual-mini', () => {\r\n        const lastId = getLastMessageId();\r\n        if (lastId >= 0) {\r\n            taskQueue.enqueue({ type: 'mini_summary', message_id: lastId });\r\n            toastr.info(`å·²å°†æ¥¼å±‚ ${lastId} çš„å°æ€»ç»“ä»»åŠ¡åŠ å…¥é˜Ÿåˆ—`);\r\n        } else {\r\n            toastr.warning('å½“å‰æ²¡æœ‰èŠå¤©æ¶ˆæ¯');\r\n        }\r\n    });\r\n\r\n    // æ‰‹åŠ¨å½’æ¡£\r\n    $overlay.on('click', '#hs-manual-volume', () => {\r\n        taskQueue.enqueue({ type: 'volume_summary' });\r\n        toastr.info('å·²å°†å¤§æ€»ç»“ä»»åŠ¡åŠ å…¥é˜Ÿåˆ—');\r\n    });\r\n\r\n    // æ·»åŠ æ­£åˆ™\r\n    let regexIndex = data.message_cleanup_regex.length;\r\n    $overlay.on('click', '#hs-add-regex', () => {\r\n        const newRow = buildRegexRowHtml({ pattern: '', flags: 'g', replacement: '' }, regexIndex++);\r\n        $('#hs-regex-list').append(newRow);\r\n    });\r\n\r\n    // åˆ é™¤æ­£åˆ™\r\n    $overlay.on('click', '.hs-remove-regex', function () {\r\n        $(this).closest('.hs-regex-row').remove();\r\n    });\r\n\r\n    // ç‚¹å‡»é®ç½©å…³é—­\r\n    $overlay.on('click', (e) => {\r\n        if (e.target === $overlay[0]) {\r\n            $overlay.remove();\r\n        }\r\n    });\r\n}\r\n","/**\r\n * è„šæœ¬å…¥å£\r\n * - åˆå§‹åŒ–æµç¨‹\r\n * - äº‹ä»¶ç›‘å¬æ³¨å†Œ\r\n * - èŠå¤©å˜æ›´é‡è½½\r\n */\r\n\r\nimport { getScriptData } from '@/config';\r\nimport { taskQueue } from '@/queue';\r\nimport { handleMiniSummary, performVolumeSummary } from '@/summary';\r\nimport {\r\n    ensureWorldbook,\r\n    switchToCurrentCharWorldbook,\r\n    syncMiniSummaryEnabled,\r\n} from '@/worldbook';\r\nimport { registerListeners } from '@/trigger';\r\nimport { addMenuItem } from '@/ui';\r\n\r\n/** èŠå¤©å˜æ›´æ—¶é‡è½½è„šæœ¬ */\r\nfunction reloadOnChatChange(): EventOnReturn {\r\n    let chat_id = SillyTavern.getCurrentChatId();\r\n    return eventOn(tavern_events.CHAT_CHANGED, (new_chat_id: string) => {\r\n        if (chat_id !== new_chat_id) {\r\n            chat_id = new_chat_id;\r\n            window.location.reload();\r\n        }\r\n    });\r\n}\r\n\r\n// æ³¨å†Œä»»åŠ¡å¤„ç†å‡½æ•°åˆ°é˜Ÿåˆ—\r\ntaskQueue.setHandlers({\r\n    mini_summary: handleMiniSummary,\r\n    volume_summary: performVolumeSummary,\r\n});\r\n$(() => {\r\n    void (async () => {\r\n        try {\r\n            // 1. åŠ è½½è„šæœ¬å˜é‡ï¼ˆè®¾ç½® + å…ƒæ•°æ®ï¼‰\r\n            const _data = getScriptData();\r\n            console.log('[è‡ªåŠ¨æ€»ç»“] è„šæœ¬å˜é‡å·²åŠ è½½');\r\n\r\n            // 2. è·å–å½“å‰è§’è‰²å¡åç§° - æ— è§’è‰²å¡åˆ™é€€å‡º\r\n            const charName = getCurrentCharacterName();\r\n            if (!charName) {\r\n                console.log('[è‡ªåŠ¨æ€»ç»“] æœªæ‰“å¼€è§’è‰²å¡ï¼Œè„šæœ¬ä¸æ‰§è¡Œ');\r\n                return;\r\n            }\r\n            console.log(`[è‡ªåŠ¨æ€»ç»“] å½“å‰è§’è‰²å¡: ${charName}`);\r\n\r\n            // 3. åˆ‡æ¢ä¸–ç•Œä¹¦ - å¸è½½å…¶ä»–è§’è‰²å¡çš„æ€»ç»“ä¸–ç•Œä¹¦ï¼ŒåŠ è½½å½“å‰è§’è‰²å¡çš„\r\n            await switchToCurrentCharWorldbook();\r\n\r\n            // 4. ç¡®ä¿å½“å‰è§’è‰²å¡ä¸–ç•Œä¹¦å­˜åœ¨\r\n            await ensureWorldbook();\r\n\r\n            // 5. åŒæ­¥å°æ€»ç»“ enabled çŠ¶æ€\r\n            await syncMiniSummaryEnabled();\r\n\r\n            // 6. æ³¨å†Œæ‰©å±•èœå•å…¥å£\r\n            addMenuItem();\r\n\r\n            // 7. æ³¨å†Œäº‹ä»¶ç›‘å¬\r\n            registerListeners();\r\n\r\n            // 8. èŠå¤©å˜æ›´æ—¶é‡è½½\r\n            reloadOnChatChange();\r\n\r\n            console.log('[è‡ªåŠ¨æ€»ç»“] åˆå§‹åŒ–å®Œæˆ');\r\n        } catch (e) {\r\n            console.error('[è‡ªåŠ¨æ€»ç»“] åˆå§‹åŒ–å¤±è´¥:', e);\r\n        }\r\n    })();\r\n});\r\n"],"names":["getMiniSummaryOrder","message_id","base","getVolumeOrder","volume","ENTRY_DEFAULTS","enabled","strategy","type","keys","keys_secondary","logic","scan_depth","probability","recursion","prevent_incoming","prevent_outgoing","delay_until","effect","sticky","cooldown","delay","ScriptData","z","object","visible_floors","coerce","number","transform","v","_","clamp","prefault","check_interval","volume_token_threshold","auto_mini_summary","boolean","auto_volume_summary","mini_summary_depth","volume_summary_depth","mini_summary_start_order","volume_start_order","ignore_floors","custom_api","apiurl","string","key","model","source","message_cleanup_regex","array","pattern","flags","replacement","current_volume","last_processed_message_id","volumes","start_message_id","end_message_id","getScriptData","raw","getVariables","parse","saveScriptData","data","replaceVariables","getSettings","taskQueue","queue","processing","handlers","setHandlers","this","enqueue","task","filter","t","push","processNext","length","shift","console","error","mini_summary","volume_summary","e","getWorldbookName","charName","getCurrentCharacterName","Error","async","getUnarchivedMiniSummaries","worldbook","getWorldbook","metadata","archivedIds","Set","vol","id","add","entry","match","name","parseInt","has","syncMiniSummaryEnabled","settings","visibleThreshold","getLastMessageId","updateWorldbookWith","buildCustomApi","callAI","systemPrompt","userPrompt","generateRaw","should_silence","ordered_prompts","role","content","warn","generateMiniSummaryContent","context","map","sort","a","b","slice","join","messages","getChatMessages","message","trim","cleaned","regex","re","RegExp","replace","cleanMessage","prompt","system","user","getMiniSummaryPrompt","generateVolumeSummaryContent","mini_summaries","test","getVolumes","previous_volumes","forEach","i","summary","getVolumeSummaryPrompt","miniSummaryCount","onMessageReceived","msg","worldbookName","entryName","find","createWorldbookEntries","position","depth","order","createPlaceholderMiniSummary","lastId","allMessages","updates","is_hidden","setChatMessages","refresh","updateFloorVisibility","shouldCheckVolumeSummary","MENU_ID","addMenuItem","$extensionsMenu","$","setTimeout","remove","$item","on","stopPropagation","$menuBtn","is","trigger","Promise","r","html","escapeHtml","s","buildRegexRowHtml","buildSettingsHtml","$popup","$overlay","$dialog","$buttons","append","newSettings","regexRows","regexList","each","$row","val","collectSettingsFromPopup","toastr","success","info","warning","regexIndex","newRow","closest","target","openSettingsPopup","index","str","wb","upsertMiniSummaryEntry","unarchivedEntries","getVolumeCompletionCheckPrompt","result","includes","shouldTriggerVolumeSummary","ids","start_id","end_id","createVolumeEntry","log","currentName","filtered","getGlobalWorldbookNames","endsWith","rebindGlobalWorldbooks","switchToCurrentCharWorldbook","getWorldbookNames","createWorldbook","ensureWorldbook","eventOn","tavern_events","MESSAGE_RECEIVED","errorCatched","chat_id","SillyTavern","getCurrentChatId","CHAT_CHANGED","new_chat_id","window","location","reload","reloadOnChatChange"],"mappings":"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"}