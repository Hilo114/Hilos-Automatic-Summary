{"version":3,"file":"index.js","sources":["../src/config.ts","../src/queue.ts","../src/prompts.ts","../src/worldbook.ts","../src/summary.ts","../src/trigger.ts","../src/chat-manager.ts","../src/ui.ts","../src/index.ts"],"sourcesContent":["/**\n * è®¾ç½®å’Œå…ƒæ•°æ®ç®¡ç†\n * - Zod schema å®šä¹‰ï¼ˆåˆå¹¶ç”¨æˆ·è®¾ç½® + è¿è¡Œæ—¶å…ƒæ•°æ®ï¼‰\n * - è„šæœ¬å˜é‡è¯»å†™\n * - æ¡ç›®é…ç½®å¸¸é‡\n */\n\nimport type { PartialDeep } from 'type-fest';\n\n// ========== å¸¸é‡ ==========\n\n/** æ ¹æ®æ¥¼å±‚ ID è®¡ç®—å°æ€»ç»“æ¡ç›®çš„ order å€¼ */\nexport function getMiniSummaryOrder(message_id: number, base: number): number {\n  return base + message_id;\n}\n\n/** æ ¹æ®å·å·è®¡ç®—å·æ¡ç›®çš„ order å€¼ */\nexport function getVolumeOrder(volume: number, base: number): number {\n  return base + volume;\n}\n\n// ========== æ¡ç›®é»˜è®¤é…ç½® ==========\n\n/** åŸºç¡€æ¡ç›®é»˜è®¤é…ç½®ï¼ˆä¸å« positionï¼Œç”±è°ƒç”¨æ–¹æ ¹æ®è®¾ç½®åŠ¨æ€æŒ‡å®šï¼‰ */\nexport const ENTRY_DEFAULTS: PartialDeep<WorldbookEntry> = {\n  enabled: false,\n  strategy: {\n    type: 'constant',\n    keys: [],\n    keys_secondary: { logic: 'and_any', keys: [] },\n    scan_depth: 'same_as_global',\n  },\n  probability: 100,\n  recursion: { prevent_incoming: true, prevent_outgoing: true, delay_until: null },\n  effect: { sticky: null, cooldown: null, delay: null },\n};\n\n// ========== Zod Schema ==========\n\n/** è¿è¡Œæ—¶å…ƒæ•°æ® schemaï¼ˆå­˜å‚¨åœ¨ä¸–ç•Œä¹¦ [data] æ¡ç›®ä¸­ï¼‰ */\nexport const MetaData = z\n  .object({\n    /** å½“å‰å·å· */\n    current_volume: z.coerce.number().prefault(1),\n    /** ä¸Šæ¬¡å¤„ç†åˆ°çš„æ¥¼å±‚ ID */\n    last_processed_message_id: z.coerce.number().prefault(-1),\n    /** å·²å½’æ¡£çš„å·ä¿¡æ¯ */\n    volumes: z\n      .array(\n        z.object({\n          volume: z.coerce.number(),\n          start_message_id: z.coerce.number(),\n          end_message_id: z.coerce.number(),\n        })\n      )\n      .prefault([]),\n  })\n  .prefault({});\n\nexport type MetaDataType = z.output<typeof MetaData>;\n\n/** è„šæœ¬æ•°æ® schemaï¼šç”¨æˆ·è®¾ç½® */\nexport const ScriptData = z\n  .object({\n    /** æœ€è¿‘ä¿ç•™æ˜¾ç¤ºçš„æ¥¼å±‚æ•° */\n    visible_floors: z.coerce\n      .number()\n      .transform(v => _.clamp(v, 1, 100))\n      .prefault(10),\n    /** æ¯å¤šå°‘ä¸ªå°æ€»ç»“è§¦å‘ä¸€æ¬¡å¤§æ€»ç»“æ£€æŸ¥ */\n    check_interval: z.coerce\n      .number()\n      .transform(v => _.clamp(v, 5, 100))\n      .prefault(20),\n    /** å¤§æ€»ç»“ token é˜ˆå€¼ */\n    volume_token_threshold: z.coerce\n      .number()\n      .transform(v => _.clamp(v, 1000, 50000))\n      .prefault(8000),\n    /** æ˜¯å¦å¯ç”¨è‡ªåŠ¨å°æ€»ç»“ */\n    auto_mini_summary: z.boolean().prefault(true),\n    /** æ˜¯å¦å¯ç”¨è‡ªåŠ¨å¤§æ€»ç»“ */\n    auto_volume_summary: z.boolean().prefault(true),\n    /** å°æ€»ç»“æ³¨å…¥æ·±åº¦ï¼ˆat_depthï¼‰ */\n    mini_summary_depth: z.coerce\n      .number()\n      .transform(v => _.clamp(v, 0, 99999))\n      .prefault(9999),\n    /** å·æ€»ç»“æ³¨å…¥æ·±åº¦ï¼ˆat_depthï¼‰ */\n    volume_summary_depth: z.coerce\n      .number()\n      .transform(v => _.clamp(v, 0, 99999))\n      .prefault(9999),\n    /** é˜Ÿåˆ—ä»»åŠ¡å†·å´é—´éš”ï¼ˆç§’ï¼‰ */\n    task_cooldown: z.coerce\n      .number()\n      .transform(v => Math.max(0, v))\n      .prefault(5),\n    /** å°æ€»ç»“èµ·å§‹æ’åº order åŸºæ•° */\n    mini_summary_start_order: z.coerce\n      .number()\n      .transform(v => _.clamp(v, 0, 99999))\n      .prefault(10000),\n    /** å·æ€»ç»“èµ·å§‹æ’åº order åŸºæ•° */\n    volume_start_order: z.coerce\n      .number()\n      .transform(v => _.clamp(v, 0, 99999))\n      .prefault(100),\n    /** å¿½ç•¥å‰å¤šå°‘å±‚æ¶ˆæ¯ä¸è¿›è¡Œæ€»ç»“ */\n    ignore_floors: z.coerce\n      .number()\n      .transform(v => _.clamp(v, 0, 1000))\n      .prefault(2),\n    /** æœ€å¤§å›å¤ token æ•°ï¼ˆ0 è¡¨ç¤ºè·Ÿéšé¢„è®¾ï¼‰ */\n    max_tokens: z.coerce\n      .number()\n      .transform(v => Math.max(0, Math.round(v)))\n      .prefault(0),\n    /** API é…ç½® */\n    custom_api: z\n      .object({\n        apiurl: z.string().prefault(''),\n        key: z.string().prefault(''),\n        model: z.string().prefault(''),\n        source: z.string().prefault('openai'),\n      })\n      .prefault({}),\n    /** æ¶ˆæ¯æ¸…æ´—æ­£åˆ™åˆ—è¡¨ */\n    message_cleanup_regex: z\n      .array(\n        z.object({\n          pattern: z.string(),\n          flags: z.string().prefault('g'),\n          replacement: z.string().prefault(''),\n        })\n      )\n      .prefault([]),\n    /** å†…å®¹æ•è·æ ‡ç­¾åˆ—è¡¨ï¼ˆæå–æ¯ç»„èµ·å§‹/ç»“æŸæ ‡ç­¾ä¹‹é—´çš„å†…å®¹ï¼Œå‡ä¸ºç©ºåˆ™æ€»ç»“å…¨éƒ¨ï¼‰ */\n    capture_tags: z\n      .array(\n        z.object({\n          start_tag: z.string().prefault(''),\n          end_tag: z.string().prefault(''),\n        })\n      )\n      .prefault([]),\n    /** æ˜¯å¦å¯ç”¨åç½®æ€»ç»“ï¼ˆå»¶è¿Ÿåˆ°ä¸‹ä¸€æ¡æ¶ˆæ¯åˆ°è¾¾æ—¶æ‰å¯¹ä¸Šä¸€æ¡è¿›è¡Œæ€»ç»“ï¼‰ */\n    deferred_summary: z.boolean().prefault(false),\n    /** æ˜¯å¦å¯ç”¨é˜²åˆå¹¶æ ‡è®°ï¼ˆkemini/noassè„šæœ¬ç”¨åˆ°ï¼‰ */\n    no_trans_tag: z.boolean().prefault(false),\n    /** é˜²åˆå¹¶æ ‡è®°å†…å®¹ */\n    no_trans_tag_value: z.string().prefault('<|no-trans|>'),\n    /** è‡ªå®šä¹‰æç¤ºè¯ï¼ˆç©ºå­—ç¬¦ä¸²è¡¨ç¤ºä½¿ç”¨é»˜è®¤ï¼‰ */\n    custom_prompts: z\n      .object({\n        mini_summary_system: z.string().prefault(''),\n        volume_summary_system: z.string().prefault(''),\n        volume_completion_check_system: z.string().prefault(''),\n      })\n      .prefault({}),\n  })\n  .prefault({});\n\nexport type ScriptDataType = z.output<typeof ScriptData>;\n\n/** é»˜è®¤è®¾ç½®å€¼ï¼ˆç”¨äºé‡ç½®åŠŸèƒ½ï¼‰ */\nexport const DEFAULT_SETTINGS: Partial<ScriptDataType> = ScriptData.parse({});\n\n// ========== è„šæœ¬å˜é‡è¯»å†™ ==========\n\n/** è·å–è„šæœ¬æ•°æ®ï¼ˆè®¾ç½® + å…ƒæ•°æ®ï¼‰ */\nexport function getScriptData(): ScriptDataType {\n  const raw = getVariables({ type: 'script' });\n  return ScriptData.parse(raw);\n}\n\n/** ä¿å­˜è„šæœ¬æ•°æ® */\nexport function saveScriptData(data: ScriptDataType): void {\n  replaceVariables(data as Record<string, any>, { type: 'script' });\n}\n\n/** è·å–è®¾ç½®ï¼ˆScriptData çš„åˆ«åï¼Œæ–¹ä¾¿è¯­ä¹‰ä½¿ç”¨ï¼‰ */\nexport function getSettings(): ScriptDataType {\n  return getScriptData();\n}\n","/**\n * ä»»åŠ¡é˜Ÿåˆ—\n * - ä¸²è¡Œå¤„ç†æ€»ç»“ä»»åŠ¡ï¼Œé¿å…å¹¶å‘å†²çª\n * - åŒä¸€æ¥¼å±‚çš„å°æ€»ç»“ä»»åŠ¡å»é‡\n */\n\nimport { getSettings } from '@/config';\n\nexport type TaskType = 'mini_summary' | 'volume_summary';\n\nexport type SummaryTask = {\n  type: TaskType;\n  message_id?: number;\n};\n\ntype TaskHandler = {\n  mini_summary: (message_id: number) => Promise<void>;\n  volume_summary: () => Promise<void>;\n};\n\nexport class TaskQueue {\n  private queue: SummaryTask[] = [];\n  private processing = false;\n  private handlers: TaskHandler | null = null;\n\n  /** æ³¨å†Œä»»åŠ¡å¤„ç†å‡½æ•° */\n  setHandlers(handlers: TaskHandler): void {\n    this.handlers = handlers;\n  }\n\n  /** å°†ä»»åŠ¡åŠ å…¥é˜Ÿåˆ— */\n  enqueue(task: SummaryTask): void {\n    // å»é‡ï¼šåŒä¸€æ¥¼å±‚çš„å°æ€»ç»“ä»»åŠ¡åªä¿ç•™æœ€æ–°çš„\n    if (task.type === 'mini_summary' && task.message_id !== undefined) {\n      this.queue = this.queue.filter(\n        t => !(t.type === 'mini_summary' && t.message_id === task.message_id)\n      );\n    }\n    this.queue.push(task);\n    void this.processNext();\n  }\n\n  /** ä¾æ¬¡å¤„ç†é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ */\n  private async processNext(): Promise<void> {\n    if (this.processing || this.queue.length === 0) return;\n    this.processing = true;\n\n    try {\n      const task = this.queue.shift()!;\n      if (!this.handlers) {\n        console.error('[è‡ªåŠ¨æ€»ç»“] ä»»åŠ¡å¤„ç†å‡½æ•°æœªæ³¨å†Œ');\n        return;\n      }\n\n      if (task.type === 'mini_summary' && task.message_id !== undefined) {\n        await this.handlers.mini_summary(task.message_id);\n      } else if (task.type === 'volume_summary') {\n        await this.handlers.volume_summary();\n      }\n\n      // æ·»åŠ ä»»åŠ¡æ‰§è¡Œåçš„å†·å´é—´éš”\n      const settings = getSettings();\n      if (settings.task_cooldown > 0) {\n        await new Promise(resolve => setTimeout(resolve, settings.task_cooldown * 1000));\n      }\n    } catch (e) {\n      console.error('[è‡ªåŠ¨æ€»ç»“] æ€»ç»“ä»»åŠ¡æ‰§è¡Œå¤±è´¥:', e);\n    } finally {\n      this.processing = false;\n      if (this.queue.length > 0) {\n        await this.processNext();\n      }\n    }\n  }\n}\n\n/** å…¨å±€ä»»åŠ¡é˜Ÿåˆ—å®ä¾‹ */\nexport const taskQueue = new TaskQueue();\n","/**\n * AI æ€»ç»“æç¤ºè¯æ¨¡æ¿\n * - æ”¯æŒè‡ªå®šä¹‰æç¤ºè¯è¦†ç›–é»˜è®¤å€¼\n */\n\nimport { getSettings } from '@/config';\n\n// ========== é»˜è®¤æç¤ºè¯ ==========\n\n/** å°æ€»ç»“ç³»ç»Ÿæç¤ºè¯ï¼ˆé»˜è®¤ï¼‰ */\nexport const DEFAULT_MINI_SUMMARY_SYSTEM = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ•…äº‹æ€»ç»“åŠ©æ‰‹ã€‚ä½ çš„ä»»åŠ¡æ˜¯å°†è§’è‰²æ‰®æ¼”èŠå¤©è®°å½•ä¸­çš„ä¸€æ¡æ¶ˆæ¯æ€»ç»“ä¸ºç®€æ´çš„å°æ€»ç»“ã€‚\n\nè¦æ±‚ï¼š\n1. ä¿ç•™å…³é”®æƒ…èŠ‚ã€è§’è‰²è¡Œä¸ºã€æƒ…æ„Ÿå˜åŒ–å’Œé‡è¦å¯¹è¯\n2. ä½¿ç”¨ç¬¬ä¸‰äººç§°å™è¿°\n3. æ€»ç»“åº”ç®€æ´æ˜äº†ï¼Œæ§åˆ¶åœ¨ 300 å­—ä»¥å†…\n4. ä¸è¦æ·»åŠ ä»»ä½•è¯„è®ºã€åˆ†ææˆ–ä½ è‡ªå·±çš„æƒ³æ³•\n5. åªè¾“å‡ºæ€»ç»“å†…å®¹ï¼Œä¸è¦æ·»åŠ æ ‡é¢˜ã€ç¼–å·æˆ–å…¶ä»–æ ¼å¼`;\n\n/** å¤§æ€»ç»“ç³»ç»Ÿæç¤ºè¯ï¼ˆé»˜è®¤ï¼‰ */\nexport const DEFAULT_VOLUME_SUMMARY_SYSTEM = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ•…äº‹æ€»ç»“åŠ©æ‰‹ã€‚ä½ çš„ä»»åŠ¡æ˜¯å°†ä¸€ç³»åˆ—å°æ€»ç»“åˆå¹¶ä¸ºä¸€ä¸ªå®Œæ•´çš„å·æ€»ç»“ã€‚\n\nè¦æ±‚ï¼š\n1. å°†æ‰€æœ‰å°æ€»ç»“çš„å†…å®¹æ•´åˆä¸ºè¿è´¯çš„å™è¿°\n2. ä¿ç•™ä¸»è¦æƒ…èŠ‚çº¿ã€è§’è‰²å‘å±•ã€å…³é”®äº‹ä»¶å’Œé‡è¦å¯¹è¯\n3. æŒ‰æ—¶é—´é¡ºåºç»„ç»‡å†…å®¹\n4. ä½¿ç”¨ç¬¬ä¸‰äººç§°å™è¿°\n5. æ€»ç»“åº”å…¨é¢ä½†ç²¾ç‚¼ï¼Œæ§åˆ¶åœ¨ 2000 å­—ä»¥å†…\n6. ä¸è¦æ·»åŠ ä»»ä½•è¯„è®ºã€åˆ†ææˆ–ä½ è‡ªå·±çš„æƒ³æ³•\n7. è‹¥å½“å‰æä¾›çš„å†…å®¹ä¸æ»¡è¶³å®Œæ•´ä¸€å·çš„æƒ…èŠ‚ï¼Œå¯é€‰å–ä¸ŠåŠå·/éƒ¨åˆ†è¿ç»­çš„å†…å®¹è¿›è¡Œæ€»ç»“\n8. åœ¨æ€»ç»“çš„æœ€æœ«å°¾ï¼Œä½ å¿…é¡»å•ç‹¬èµ·ä¸€è¡Œè¾“å‡ºä½ æ­¤æ¬¡æ€»ç»“çš„å†…å®¹èŒƒå›´ï¼Œæ ¼å¼ä¸ºï¼šæ‘˜è¦x-æ‘˜è¦yï¼ˆä¾‹å¦‚ï¼šæ‘˜è¦100-æ‘˜è¦150ï¼‰\n9. é™¤æ€»ç»“å†…å®¹å’Œå°¾éƒ¨çš„èŒƒå›´æ ‡è®°å¤–ï¼Œä¸è¦æ·»åŠ æ ‡é¢˜ã€ç¼–å·æˆ–å…¶ä»–å¤šä½™æ ¼å¼`;\n\n/** å·å®Œç»“æ£€æµ‹ç³»ç»Ÿæç¤ºè¯ï¼ˆé»˜è®¤ï¼‰ */\nexport const DEFAULT_VOLUME_COMPLETION_CHECK_SYSTEM = `ä½ æ˜¯ä¸€ä¸ªæ•…äº‹åˆ†æåŠ©æ‰‹ã€‚æ ¹æ®ä»¥ä¸‹æ€»ç»“å†…å®¹ï¼Œåˆ¤æ–­å½“å‰è¿™ä¸€å·æ•…äº‹æ˜¯å¦å·²ç»è¾¾åˆ°äº†ä¸€ä¸ªè‡ªç„¶çš„æ®µè½ç»“å°¾ï¼ˆå¦‚ï¼šä¸€ä¸ªç« èŠ‚ç»“æŸã€ä¸€ä¸ªäº‹ä»¶å‘Šä¸€æ®µè½ã€åœºæ™¯å¤§å¹…è½¬æ¢ç­‰ï¼‰ã€‚\n\nåªéœ€å›ç­”\"114514\"æˆ–\"1919810\"ï¼Œä¸è¦åšä»»ä½•è§£é‡Šã€‚\n- å›ç­”\"114514\"è¡¨ç¤ºè¿™ä¸€å·å·²ç»åˆ°äº†ä¸€ä¸ªåˆé€‚çš„æ–­ç‚¹ï¼Œå¯ä»¥å½’æ¡£\n- å›ç­”\"1919810\"è¡¨ç¤ºæ•…äº‹ä»åœ¨è¿›è¡Œä¸­ï¼Œä¸é€‚åˆåœ¨è¿™é‡Œæ–­å¼€`;\n\n// ========== è·å–æœ‰æ•ˆæç¤ºè¯ ==========\n\n/** è·å–å½“å‰ç”Ÿæ•ˆçš„å°æ€»ç»“ç³»ç»Ÿæç¤ºè¯ */\nfunction getMiniSummarySystemPrompt(): string {\n  const settings = getSettings();\n  return settings.custom_prompts.mini_summary_system || DEFAULT_MINI_SUMMARY_SYSTEM;\n}\n\n/** è·å–å½“å‰ç”Ÿæ•ˆçš„å¤§æ€»ç»“ç³»ç»Ÿæç¤ºè¯ */\nfunction getVolumeSummarySystemPrompt(): string {\n  const settings = getSettings();\n  return settings.custom_prompts.volume_summary_system || DEFAULT_VOLUME_SUMMARY_SYSTEM;\n}\n\n/** è·å–å½“å‰ç”Ÿæ•ˆçš„å·å®Œç»“æ£€æµ‹ç³»ç»Ÿæç¤ºè¯ */\nfunction getVolumeCompletionCheckSystemPrompt(): string {\n  const settings = getSettings();\n  return (\n    settings.custom_prompts.volume_completion_check_system || DEFAULT_VOLUME_COMPLETION_CHECK_SYSTEM\n  );\n}\n\n// ========== æç¤ºè¯æ„å»º ==========\n\n/** å°æ€»ç»“æç¤ºè¯ */\nexport function getMiniSummaryPrompt(\n  message: string,\n  context: string\n): { system: string; user: string } {\n  let userPrompt = '';\n  if (context) {\n    userPrompt += `ä»¥ä¸‹æ˜¯ä¹‹å‰çš„æ€»ç»“ï¼Œä¾›ä½ äº†è§£ä¸Šä¸‹æ–‡ï¼š\\n${context}\\n\\n---\\n\\n`;\n  }\n  userPrompt += `è¯·æ€»ç»“ä»¥ä¸‹æ¶ˆæ¯ï¼š\\n\\n${message}`;\n\n  return {\n    system: getMiniSummarySystemPrompt(),\n    user: userPrompt,\n  };\n}\n\n/** å¤§æ€»ç»“æç¤ºè¯ */\nexport function getVolumeSummaryPrompt(\n  mini_summaries: string[],\n  previous_volumes: string[]\n): { system: string; user: string } {\n  let userPrompt = '';\n  if (previous_volumes.length > 0) {\n    userPrompt += `ä»¥ä¸‹æ˜¯ä¹‹å‰å„å·çš„å¤§æ€»ç»“ï¼Œä¾›ä½ äº†è§£å‰æƒ…ï¼š\\n\\n`;\n    previous_volumes.forEach((vol, i) => {\n      userPrompt += `--- ç¬¬${i + 1}å· ---\\n${vol}\\n\\n`;\n    });\n    userPrompt += `===\\n\\n`;\n  }\n  userPrompt += `è¯·å°†ä»¥ä¸‹å°æ€»ç»“åˆå¹¶ä¸ºä¸€ä¸ªè¿è´¯çš„é˜¶æ®µæ€§å·æ€»ç»“ï¼š\\n\\n`;\n  mini_summaries.forEach(summary => {\n    userPrompt += `${summary}\\n\\n`;\n  });\n\n  return {\n    system: getVolumeSummarySystemPrompt(),\n    user: userPrompt,\n  };\n}\n\n/** å·å®Œç»“æ£€æµ‹æç¤ºè¯ */\nexport function getVolumeCompletionCheckPrompt(mini_summaries: string[]): {\n  system: string;\n  user: string;\n} {\n  let userPrompt = `ä»¥ä¸‹æ˜¯æœ€è¿‘ä¸€æ®µæ—¶é—´çš„å°æ€»ç»“åºåˆ—ï¼š\\n\\n`;\n  mini_summaries.forEach(summary => {\n    userPrompt += `${summary}\\n\\n`;\n  });\n  userPrompt += `è¯·åˆ¤æ–­ä»¥ä¸Šå†…å®¹æ˜¯å¦å·²ç»åˆ°äº†ä¸€ä¸ªè‡ªç„¶çš„æ®µè½ç»“å°¾ï¼Ÿ`;\n\n  return {\n    system: getVolumeCompletionCheckSystemPrompt(),\n    user: userPrompt,\n  };\n}\n","/**\n * ä¸–ç•Œä¹¦æ“ä½œ\n * - åˆ›å»º/è¯»/å†™/ç»‘å®š\n * - å°æ€»ç»“æ¡ç›®ç®¡ç†\n * - å·æ¡ç›®ç®¡ç†\n * - ä¸–ç•Œä¹¦ä¸å­˜åœ¨æ—¶è·³è¿‡æ‰§è¡Œ\n */\n\nimport {\n  getSettings,\n  MetaData,\n  type MetaDataType,\n  getMiniSummaryOrder,\n  getVolumeOrder,\n  ENTRY_DEFAULTS,\n} from '@/config';\n\n// ========== ä¸–ç•Œä¹¦åç§°ä¸å­˜åœ¨æ€§ ==========\n\n/** è¿”å›å½“å‰èŠå¤©ç»‘å®šçš„æ€»ç»“ä¸–ç•Œä¹¦åç§°ï¼Œæœªç»‘å®šæˆ–æœªæ‰“å¼€èŠå¤©åˆ™è¿”å› null */\nexport function getWorldbookName(): string | null {\n  try {\n    return getChatWorldbookName('current');\n  } catch {\n    return null;\n  }\n}\n\n/** æ£€æŸ¥å½“å‰ç»‘å®šçš„ä¸–ç•Œä¹¦æ˜¯å¦å­˜åœ¨ */\nexport function worldbookExists(): boolean {\n  const name = getWorldbookName();\n  if (!name) return false;\n  return getWorldbookNames().includes(name);\n}\n\n// ========== ä¸–ç•Œä¹¦åˆ›å»ºä¸ç»‘å®š ==========\n\n/** ä¸€é”®åˆ›å»ºä¸–ç•Œä¹¦å¹¶ç»‘å®šåˆ°å½“å‰èŠå¤© */\nexport async function createWorldbookForChat(name?: string): Promise<string> {\n  const charName = getCurrentCharacterName();\n  const worldbookName = name || `${charName || 'æœªçŸ¥'}[è‡ªåŠ¨æ€»ç»“]`;\n\n  const existingNames = getWorldbookNames();\n  if (!existingNames.includes(worldbookName)) {\n    await createWorldbook(worldbookName, []);\n    console.log(`[è‡ªåŠ¨æ€»ç»“] å·²åˆ›å»ºä¸–ç•Œä¹¦: ${worldbookName}`);\n  }\n\n  // ç»‘å®šåˆ°èŠå¤©æ–‡ä»¶ï¼ˆåŸç”Ÿæœºåˆ¶ï¼‰\n  await rebindChatWorldbook('current', worldbookName);\n\n  console.log(`[è‡ªåŠ¨æ€»ç»“] å·²ç»‘å®šä¸–ç•Œä¹¦: ${worldbookName}`);\n  return worldbookName;\n}\n\n/** å°†å·²æœ‰ä¸–ç•Œä¹¦ç»‘å®šåˆ°å½“å‰èŠå¤© */\nexport async function bindWorldbookForChat(name: string): Promise<void> {\n  // ç»‘å®šåˆ°èŠå¤©æ–‡ä»¶ï¼ˆåŸç”Ÿæœºåˆ¶ï¼‰\n  await rebindChatWorldbook('current', name);\n\n  console.log(`[è‡ªåŠ¨æ€»ç»“] å·²ç»‘å®šä¸–ç•Œä¹¦: ${name}`);\n}\n\n// ========== [data] å…ƒæ•°æ®æ¡ç›®æ“ä½œ ==========\n\nconst DATA_ENTRY_NAME = '[data]';\n\n/** ç¡®ä¿ä¸–ç•Œä¹¦ä¸­å­˜åœ¨ [data] æ¡ç›®ï¼Œä¸å­˜åœ¨åˆ™åˆ›å»º */\nexport async function ensureDataEntry(): Promise<void> {\n  const worldbookName = getWorldbookName();\n  if (!worldbookName || !worldbookExists()) return;\n\n  const worldbook = await getWorldbook(worldbookName);\n  const existing = worldbook.find(e => e.name === DATA_ENTRY_NAME);\n\n  if (!existing) {\n    const defaultData = MetaData.parse({});\n    await createWorldbookEntries(worldbookName, [\n      {\n        ...ENTRY_DEFAULTS,\n        enabled: false,\n        name: DATA_ENTRY_NAME,\n        content: JSON.stringify(defaultData),\n      },\n    ]);\n    console.log('[è‡ªåŠ¨æ€»ç»“] å·²åˆ›å»º [data] å…ƒæ•°æ®æ¡ç›®');\n  }\n}\n\n/** ä»ä¸–ç•Œä¹¦ [data] æ¡ç›®è¯»å–è¿è¡Œæ—¶å…ƒæ•°æ® */\nexport async function getMetaData(): Promise<MetaDataType> {\n  const worldbookName = getWorldbookName();\n  if (!worldbookName || !worldbookExists()) {\n    return MetaData.parse({});\n  }\n\n  const worldbook = await getWorldbook(worldbookName);\n  const entry = worldbook.find(e => e.name === DATA_ENTRY_NAME);\n\n  if (!entry) {\n    return MetaData.parse({});\n  }\n\n  try {\n    const raw = JSON.parse(entry.content);\n    return MetaData.parse(raw);\n  } catch (e) {\n    console.error('[è‡ªåŠ¨æ€»ç»“] è§£æ [data] æ¡ç›®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼:', e);\n    return MetaData.parse({});\n  }\n}\n\n/** å°†è¿è¡Œæ—¶å…ƒæ•°æ®ä¿å­˜åˆ°ä¸–ç•Œä¹¦ [data] æ¡ç›® */\nexport async function saveMetaData(data: MetaDataType): Promise<void> {\n  const worldbookName = getWorldbookName();\n  if (!worldbookName || !worldbookExists()) {\n    console.warn('[è‡ªåŠ¨æ€»ç»“] ä¸–ç•Œä¹¦ä¸å­˜åœ¨ï¼Œè·³è¿‡ä¿å­˜å…ƒæ•°æ®');\n    return;\n  }\n\n  const content = JSON.stringify(data);\n\n  await updateWorldbookWith(worldbookName, wb => {\n    const entry = wb.find(e => e.name === DATA_ENTRY_NAME);\n    if (entry) {\n      entry.content = content;\n    }\n    return wb;\n  });\n}\n\n// ========== å°æ€»ç»“æ¡ç›®æ“ä½œ ==========\n\n/** è·å–æŒ‡å®šæ¥¼å±‚çš„å°æ€»ç»“æ¡ç›® */\nexport async function getMiniSummaryEntry(message_id: number): Promise<WorldbookEntry | undefined> {\n  const name = getWorldbookName();\n  if (!name || !worldbookExists()) return undefined;\n\n  const worldbook = await getWorldbook(name);\n  const entryName = `[å°æ€»ç»“-æ¥¼å±‚${message_id}]`;\n  return worldbook.find(e => e.name === entryName);\n}\n\n/** åˆ›å»ºæˆ–æ›¿æ¢æŒ‡å®šæ¥¼å±‚çš„å°æ€»ç»“æ¡ç›® */\nexport async function upsertMiniSummaryEntry(message_id: number, content: string): Promise<void> {\n  const worldbookName = getWorldbookName();\n  if (!worldbookName || !worldbookExists()) {\n    console.warn('[è‡ªåŠ¨æ€»ç»“] ä¸–ç•Œä¹¦ä¸å­˜åœ¨ï¼Œè·³è¿‡å†™å…¥å°æ€»ç»“');\n    return;\n  }\n\n  const entryName = `[å°æ€»ç»“-æ¥¼å±‚${message_id}]`;\n  const worldbook = await getWorldbook(worldbookName);\n  const existing = worldbook.find(e => e.name === entryName);\n\n  if (existing) {\n    // å·²å­˜åœ¨åˆ™æ›¿æ¢ content\n    await updateWorldbookWith(worldbookName, wb => {\n      const entry = wb.find(e => e.name === entryName);\n      if (entry) {\n        entry.content = content;\n      }\n      return wb;\n    });\n  } else {\n    // ä¸å­˜åœ¨åˆ™æ–°å»º\n    const settings = getSettings();\n    await createWorldbookEntries(worldbookName, [\n      {\n        ...ENTRY_DEFAULTS,\n        name: entryName,\n        content,\n        position: {\n          type: 'at_depth',\n          role: 'system',\n          depth: settings.mini_summary_depth,\n          order: getMiniSummaryOrder(message_id, settings.mini_summary_start_order),\n        },\n      },\n    ]);\n  }\n}\n\n/** åˆ›å»ºç©ºå ä½å°æ€»ç»“æ¡ç›®ï¼ˆåŒæ­¥é˜¶æ®µä½¿ç”¨ï¼‰ */\nexport async function createPlaceholderMiniSummary(message_id: number): Promise<void> {\n  const worldbookName = getWorldbookName();\n  if (!worldbookName || !worldbookExists()) {\n    console.warn('[è‡ªåŠ¨æ€»ç»“] ä¸–ç•Œä¹¦ä¸å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»ºå ä½å°æ€»ç»“');\n    return;\n  }\n\n  const entryName = `[å°æ€»ç»“-æ¥¼å±‚${message_id}]`;\n  const worldbook = await getWorldbook(worldbookName);\n  const existing = worldbook.find(e => e.name === entryName);\n\n  if (!existing) {\n    const settings = getSettings();\n    await createWorldbookEntries(worldbookName, [\n      {\n        ...ENTRY_DEFAULTS,\n        name: entryName,\n        content: 'ï¼ˆæ€»ç»“ç”Ÿæˆä¸­...ï¼‰',\n        position: {\n          type: 'at_depth',\n          role: 'system',\n          depth: settings.mini_summary_depth,\n          order: getMiniSummaryOrder(message_id, settings.mini_summary_start_order),\n        },\n      },\n    ]);\n  }\n}\n\n/** è·å–æ‰€æœ‰æœªå½’æ¡£çš„å°æ€»ç»“æ¡ç›® */\nexport async function getUnarchivedMiniSummaries(): Promise<WorldbookEntry[]> {\n  const name = getWorldbookName();\n  if (!name || !worldbookExists()) return [];\n\n  const worldbook = await getWorldbook(name);\n  const metadata = await getMetaData();\n\n  // æ”¶é›†å·²å½’æ¡£çš„æ¥¼å±‚ ID\n  const archivedIds = new Set<number>();\n  for (const vol of metadata.volumes) {\n    for (let id = vol.start_message_id; id <= vol.end_message_id; id++) {\n      archivedIds.add(id);\n    }\n  }\n\n  return worldbook.filter(entry => {\n    const match = entry.name.match(/^\\[å°æ€»ç»“-æ¥¼å±‚(\\d+)\\]$/);\n    if (!match) return false;\n    const id = parseInt(match[1]);\n    return !archivedIds.has(id);\n  });\n}\n\n// ========== enabled åŒæ­¥ ==========\n\n/** æ ¹æ®æ¥¼å±‚å¯è§æ€§å’Œå½’æ¡£çŠ¶æ€åŒæ­¥æ‰€æœ‰å°æ€»ç»“çš„ enabled */\nexport async function syncMiniSummaryEnabled(): Promise<void> {\n  const name = getWorldbookName();\n  if (!name || !worldbookExists()) return;\n\n  const settings = getSettings();\n  const lastId = getLastMessageId();\n  const visibleThreshold = lastId - settings.visible_floors + 1;\n  const metadata = await getMetaData();\n\n  // æ”¶é›†å·²å½’æ¡£çš„æ¥¼å±‚ ID èŒƒå›´\n  const archivedIds = new Set<number>();\n  for (const vol of metadata.volumes) {\n    for (let id = vol.start_message_id; id <= vol.end_message_id; id++) {\n      archivedIds.add(id);\n    }\n  }\n\n  await updateWorldbookWith(name, worldbook => {\n    for (const entry of worldbook) {\n      const match = entry.name.match(/^\\[å°æ€»ç»“-æ¥¼å±‚(\\d+)\\]$/);\n      if (!match) continue;\n      const id = parseInt(match[1]);\n\n      if (id >= visibleThreshold) {\n        // å¯è§æ¥¼å±‚ â†’ ä¸æ³¨å…¥\n        entry.enabled = false;\n      } else if (archivedIds.has(id)) {\n        // å·²å½’æ¡£ â†’ ä¸æ³¨å…¥\n        entry.enabled = false;\n      } else {\n        // å·²éšè—ä¸”æœªå½’æ¡£ â†’ æ³¨å…¥\n        entry.enabled = true;\n      }\n    }\n    return worldbook;\n  });\n}\n\n// ========== å·æ¡ç›®æ“ä½œ ==========\n\n/** åˆ›å»ºå·æ¡ç›®å¹¶å…³é—­å¯¹åº”èŒƒå›´å†…çš„å°æ€»ç»“ */\nexport async function createVolumeEntry(\n  volume: number,\n  start_id: number,\n  end_id: number,\n  content: string\n): Promise<void> {\n  const worldbookName = getWorldbookName();\n  if (!worldbookName || !worldbookExists()) {\n    console.warn('[è‡ªåŠ¨æ€»ç»“] ä¸–ç•Œä¹¦ä¸å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»ºå·æ¡ç›®');\n    return;\n  }\n\n  const entryName = `[å·${volume}-æ¥¼å±‚${start_id}~æ¥¼å±‚${end_id}]`;\n\n  await updateWorldbookWith(worldbookName, worldbook => {\n    // 1. å…³é—­è¯¥èŒƒå›´å†…çš„å°æ€»ç»“æ¡ç›®\n    for (const entry of worldbook) {\n      const match = entry.name.match(/^\\[å°æ€»ç»“-æ¥¼å±‚(\\d+)\\]$/);\n      if (!match) continue;\n      const id = parseInt(match[1]);\n      if (id >= start_id && id <= end_id) {\n        entry.enabled = false;\n      }\n    }\n\n    // 2. æ·»åŠ å·æ¡ç›®\n    const settings = getSettings();\n    worldbook.push({\n      ...ENTRY_DEFAULTS,\n      enabled: true,\n      name: entryName,\n      content,\n      position: {\n        type: 'at_depth',\n        role: 'system',\n        depth: settings.volume_summary_depth,\n        order: getVolumeOrder(volume, settings.volume_start_order),\n      },\n    } as WorldbookEntry);\n\n    return worldbook;\n  });\n\n  // 3. æ›´æ–°å…ƒæ•°æ®\n  const meta = await getMetaData();\n  meta.current_volume = volume + 1;\n  meta.volumes.push({ volume, start_message_id: start_id, end_message_id: end_id });\n  await saveMetaData(meta);\n}\n\n/** è·å–æ‰€æœ‰å·²æœ‰å·æ¡ç›® */\nexport async function getVolumes(): Promise<WorldbookEntry[]> {\n  const name = getWorldbookName();\n  if (!name || !worldbookExists()) return [];\n\n  const worldbook = await getWorldbook(name);\n  return worldbook.filter(entry => /^\\[å·\\d+-æ¥¼å±‚\\d+~æ¥¼å±‚\\d+\\]$/.test(entry.name));\n}\n","/**\n * æ€»ç»“æ ¸å¿ƒé€»è¾‘\n * - æ¶ˆæ¯æ¸…æ´—\n * - å°æ€»ç»“ç”Ÿæˆ\n * - å¤§æ€»ç»“ç”Ÿæˆ\n * - å¤§æ€»ç»“è§¦å‘æ£€æŸ¥\n */\n\nimport { getSettings, type ScriptDataType } from '@/config';\nimport {\n  getMiniSummaryPrompt,\n  getVolumeSummaryPrompt,\n  getVolumeCompletionCheckPrompt,\n} from '@/prompts';\nimport {\n  getWorldbookName,\n  worldbookExists,\n  upsertMiniSummaryEntry,\n  getUnarchivedMiniSummaries,\n  getVolumes,\n  createVolumeEntry,\n  getMetaData,\n  saveMetaData,\n} from '@/worldbook';\n\n// ========== æ¶ˆæ¯æ¸…æ´— ==========\n\n/** ä»æ¶ˆæ¯ä¸­æå–ç”±èµ·å§‹æ ‡ç­¾å’Œç»“æŸæ ‡ç­¾ä¹‹é—´çš„å†…å®¹ï¼Œè‹¥æœªé…ç½®æ ‡ç­¾æˆ–æœªåŒ¹é…åˆ°åˆ™è¿”å›åŸæ–‡ */\nexport function extractTaggedContent(\n  message: string,\n  captureTags: { start_tag: string; end_tag: string }[]\n): string {\n  // è¿‡æ»¤æ‰èµ·å§‹å’Œç»“æŸæ ‡ç­¾éƒ½ä¸ºç©ºçš„ç»„\n  const validTags = captureTags.filter(t => t.start_tag || t.end_tag);\n  if (validTags.length === 0) return message;\n\n  const allMatches: string[] = [];\n\n  for (const { start_tag: startTag, end_tag: endTag } of validTags) {\n    // æ„å»ºåŒ¹é…æ­£åˆ™\n    const startPattern = startTag ? `<${_.escapeRegExp(startTag)}>` : '^';\n    const endPattern = endTag ? `<${_.escapeRegExp(endTag)}>` : '$';\n    const regex = new RegExp(`${startPattern}([\\\\s\\\\S]*?)${endPattern}`, 'g');\n\n    let groupMatched = false;\n    let match: RegExpExecArray | null;\n    while ((match = regex.exec(message)) !== null) {\n      const content = match[1].trim();\n      if (content) {\n        allMatches.push(content);\n        groupMatched = true;\n      }\n    }\n\n    if (!groupMatched) {\n      const tagDesc =\n        startTag && endTag\n          ? `<${startTag}> å’Œ <${endTag}> ä¹‹é—´`\n          : startTag\n            ? `<${startTag}> ä¹‹å`\n            : `<${endTag}> ä¹‹å‰`;\n      console.warn(`[è‡ªåŠ¨æ€»ç»“] æœªåœ¨æ¶ˆæ¯ä¸­æ‰¾åˆ° ${tagDesc} çš„å†…å®¹`);\n    }\n  }\n\n  if (allMatches.length === 0) {\n    console.warn(`[è‡ªåŠ¨æ€»ç»“] æ‰€æœ‰æ•è·æ ‡ç­¾å‡æœªåŒ¹é…åˆ°å†…å®¹ï¼Œå°†ä½¿ç”¨åŸå§‹æ¶ˆæ¯`);\n    return message;\n  }\n\n  return allMatches.join('\\n\\n');\n}\n\n/** ä½¿ç”¨ç”¨æˆ·è‡ªå®šä¹‰æ­£åˆ™æ¸…æ´—æ¶ˆæ¯å†…å®¹ */\nexport function cleanMessage(message: string, settings: ScriptDataType): string {\n  let cleaned = message;\n  for (const regex of settings.message_cleanup_regex) {\n    try {\n      const re = new RegExp(regex.pattern, regex.flags);\n      cleaned = cleaned.replace(re, regex.replacement);\n    } catch (e) {\n      console.error(`[è‡ªåŠ¨æ€»ç»“] æ­£åˆ™æ¸…æ´—é”™è¯¯ (pattern: ${regex.pattern}):`, e);\n      // è·³è¿‡æ— æ•ˆæ­£åˆ™\n    }\n  }\n  return cleaned;\n}\n\n// ========== AI ç”Ÿæˆè¾…åŠ© ==========\n\n/** æ„å»º generateRaw çš„ API é…ç½® */\nfunction buildCustomApi(settings: ScriptDataType): Record<string, any> | undefined {\n  if (!settings.custom_api.apiurl) return undefined;\n  const api: Record<string, any> = {\n    apiurl: settings.custom_api.apiurl,\n    key: settings.custom_api.key,\n    model: settings.custom_api.model,\n    source: settings.custom_api.source,\n  };\n  // å°† max_tokens ä¼ é€’ç»™è‡ªå®šä¹‰ API\n  if (settings.max_tokens > 0) {\n    api.max_tokens = settings.max_tokens;\n  }\n  return api;\n}\n\n/** è°ƒç”¨ AI ç”Ÿæˆæ–‡æœ¬ */\nasync function callAI(\n  systemPrompt: string,\n  userPrompt: string,\n  settings: ScriptDataType\n): Promise<string> {\n  const useNoTrans = settings.no_trans_tag !== false;\n  const NO_TRANS = settings.no_trans_tag_value || '<|no-trans|>';\n  const wrapContent = (text: string) => {\n    if (!text || !text.trim()) return text;\n    return useNoTrans ? `${NO_TRANS}${text}` : text;\n  };\n\n  const generateConfig: Record<string, any> = {\n    should_silence: true,\n    ordered_prompts: [\n      { role: 'system', content: wrapContent(systemPrompt) },\n      { role: 'user', content: wrapContent(userPrompt) },\n    ],\n  };\n  const customApi = buildCustomApi(settings);\n  if (customApi) {\n    generateConfig.custom_api = customApi;\n  } else if (settings.max_tokens > 0) {\n    // å³ä½¿æ²¡æœ‰è‡ªå®šä¹‰ APIï¼Œä¹Ÿå¯ä»¥é€šè¿‡ custom_api ä¼ é€’ max_tokens\n    generateConfig.custom_api = { max_tokens: settings.max_tokens };\n  }\n  const result = await generateRaw(generateConfig as any);\n  return result;\n}\n\n// ========== å°æ€»ç»“ ==========\n\n/** ç”Ÿæˆå•æ¡æ¶ˆæ¯çš„å°æ€»ç»“å†…å®¹ */\nexport async function generateMiniSummaryContent(message_id: number): Promise<string> {\n  const settings = getSettings();\n  const worldbookName = getWorldbookName();\n  if (!worldbookName) {\n    throw new Error('[è‡ªåŠ¨æ€»ç»“] æœªç»‘å®šä¸–ç•Œä¹¦ï¼Œæ— æ³•ç”Ÿæˆå°æ€»ç»“');\n  }\n  const worldbook = await getWorldbook(worldbookName);\n\n  // è·å–å‰ 2 ä¸ªå°æ€»ç»“ä½œä¸ºä¸Šä¸‹æ–‡\n  const allMiniEntries = worldbook\n    .filter(e => e.name.match(/^\\[å°æ€»ç»“-æ¥¼å±‚(\\d+)\\]$/))\n    .map(e => ({\n      id: parseInt(e.name.match(/æ¥¼å±‚(\\d+)/)![1]),\n      content: e.content,\n    }))\n    .filter(e => e.id < message_id)\n    .sort((a, b) => a.id - b.id)\n    .slice(-2);\n\n  const context = allMiniEntries.map(e => e.content).join('\\n');\n\n  // è·å–å¹¶æ¸…æ´—å½“å‰æ¥¼å±‚æ¶ˆæ¯\n  const messages = getChatMessages(message_id);\n  if (messages.length === 0) {\n    throw new Error(`[è‡ªåŠ¨æ€»ç»“] æ¥¼å±‚ ${message_id} ä¸å­˜åœ¨`);\n  }\n  const rawMessage = messages[0].message;\n\n  // è·³è¿‡ç©ºæ¶ˆæ¯\n  if (!rawMessage || rawMessage.trim() === '') {\n    return 'ï¼ˆç©ºæ¶ˆæ¯ï¼‰';\n  }\n\n  // åˆ¤æ–­æ˜¯å¦é…ç½®äº†æœ‰æ•ˆçš„æ•è·æ ‡ç­¾\n  const hasCaptureTags = settings.capture_tags.some(t => t.start_tag || t.end_tag);\n\n  let processedMessage: string;\n  if (hasCaptureTags) {\n    // æœ‰æ•è·æ ‡ç­¾æ—¶ï¼Œç›´æ¥å¯¹åŸå§‹æ¶ˆæ¯åº”ç”¨æ ‡ç­¾æ•è·ï¼Œä¸åº”ç”¨é…’é¦†æ­£åˆ™æ¸…æ´—\n    processedMessage = extractTaggedContent(rawMessage, settings.capture_tags);\n  } else {\n    // æ— æ•è·æ ‡ç­¾æ—¶ï¼Œåº”ç”¨é…’é¦†æ­£åˆ™è¿‡æ»¤åä½¿ç”¨å…¨æ–‡\n    const source = messages[0].role === 'user' ? 'user_input' : 'ai_output';\n    processedMessage = formatAsTavernRegexedString(rawMessage, source, 'prompt');\n  }\n\n  const extracted = processedMessage;\n\n  const cleaned = cleanMessage(extracted, settings);\n  const prompt = getMiniSummaryPrompt(cleaned, context);\n\n  return await callAI(prompt.system, prompt.user, settings);\n}\n\n/** å¤„ç†å°æ€»ç»“ä»»åŠ¡ - ç”Ÿæˆå†…å®¹å¹¶å†™å…¥å·²åˆ›å»ºçš„æ¡ç›® */\nexport async function handleMiniSummary(message_id: number): Promise<void> {\n  // ä¸–ç•Œä¹¦ä¸å­˜åœ¨åˆ™è·³è¿‡\n  if (!worldbookExists()) {\n    console.warn('[è‡ªåŠ¨æ€»ç»“] ä¸–ç•Œä¹¦ä¸å­˜åœ¨ï¼Œè·³è¿‡å°æ€»ç»“ç”Ÿæˆ');\n    return;\n  }\n\n  // ç”Ÿæˆå°æ€»ç»“å†…å®¹\n  const summary = await generateMiniSummaryContent(message_id);\n\n  // å°†ç»“æœå†™å…¥å·²å­˜åœ¨çš„æ¡ç›®ï¼ˆupsert å¤„ç†ï¼Œè‹¥æ¡ç›®ä¸å­˜åœ¨ä¹Ÿä¼šåˆ›å»ºï¼‰\n  await upsertMiniSummaryEntry(message_id, summary);\n\n  // æ›´æ–°å…ƒæ•°æ®\n  const meta = await getMetaData();\n  meta.last_processed_message_id = message_id;\n  await saveMetaData(meta);\n}\n\n// ========== å¤§æ€»ç»“ ==========\n\n/** æ£€æŸ¥æ˜¯å¦åº”è¯¥è§¦å‘å¤§æ€»ç»“ */\nexport async function shouldTriggerVolumeSummary(): Promise<boolean> {\n  const settings = getSettings();\n  const unarchivedEntries = await getUnarchivedMiniSummaries();\n\n  if (unarchivedEntries.length === 0) return false;\n\n  // æ£€æŸ¥ token é˜ˆå€¼ï¼ˆç®€å•ç”¨å­—ç¬¦æ•°ä¼°ç®— token æ•°ï¼Œä¸­æ–‡çº¦ 1 å­— â‰ˆ 1-2 tokenï¼‰\n  const totalContent = unarchivedEntries.map(e => e.content).join('');\n  const estimatedTokens = totalContent.length; // ç²—ç•¥ä¼°ç®—\n\n  if (estimatedTokens > settings.volume_token_threshold) {\n    return true;\n  }\n\n  // AI åˆ¤æ–­æ˜¯å¦ä¸€å·å·²å®Œç»“\n  try {\n    const miniSummaries = unarchivedEntries.map(e => {\n      const match = e.name.match(/æ¥¼å±‚(\\d+)/);\n      const id = match ? match[1] : '?';\n      return `æ‘˜è¦${id}\\n${e.content}`;\n    });\n    const prompt = getVolumeCompletionCheckPrompt(miniSummaries);\n    const result = await callAI(prompt.system, prompt.user, settings);\n    // æ£€æŸ¥å›ç­”ä¸­æ˜¯å¦åŒ…å« 114514ï¼ˆå®Œç»“ï¼‰æˆ– 1919810ï¼ˆæœªå®Œç»“ï¼‰\n    if (result.includes('114514')) return true;\n    if (result.includes('1919810')) return false;\n    // éƒ½ä¸åŒ…å«æ—¶é»˜è®¤ä¸è§¦å‘\n    console.warn('[è‡ªåŠ¨æ€»ç»“] å·å®Œç»“æ£€æµ‹è¿”å›äº†æ„å¤–å†…å®¹:', result);\n    return false;\n  } catch (e) {\n    console.error('[è‡ªåŠ¨æ€»ç»“] å·å®Œç»“æ£€æµ‹å¤±è´¥:', e);\n    return false;\n  }\n}\n\n/** ç”Ÿæˆå¤§æ€»ç»“å†…å®¹ */\nexport async function generateVolumeSummaryContent(\n  mini_summaries: WorldbookEntry[]\n): Promise<string> {\n  const settings = getSettings();\n  const volumes = await getVolumes();\n\n  const miniContents = mini_summaries.map(e => {\n    const match = e.name.match(/æ¥¼å±‚(\\d+)/);\n    const id = match ? match[1] : '?';\n    return `æ‘˜è¦${id}\\n${e.content}`;\n  });\n  const previousVolumeContents = volumes\n    .sort((a, b) => {\n      const aVol = parseInt(a.name.match(/å·(\\d+)/)![1]);\n      const bVol = parseInt(b.name.match(/å·(\\d+)/)![1]);\n      return aVol - bVol;\n    })\n    .map(e => e.content);\n\n  const prompt = getVolumeSummaryPrompt(miniContents, previousVolumeContents);\n  return await callAI(prompt.system, prompt.user, settings);\n}\n\n/** æ‰§è¡Œå®Œæ•´çš„å¤§æ€»ç»“æµç¨‹ */\nexport async function performVolumeSummary(): Promise<void> {\n  // ä¸–ç•Œä¹¦ä¸å­˜åœ¨åˆ™è·³è¿‡\n  if (!worldbookExists()) {\n    console.warn('[è‡ªåŠ¨æ€»ç»“] ä¸–ç•Œä¹¦ä¸å­˜åœ¨ï¼Œè·³è¿‡å¤§æ€»ç»“ç”Ÿæˆ');\n    return;\n  }\n\n  const meta = await getMetaData();\n  const unarchivedEntries = await getUnarchivedMiniSummaries();\n\n  if (unarchivedEntries.length === 0) return;\n\n  // å…ˆæ£€æŸ¥æ˜¯å¦æ»¡è¶³å¤§æ€»ç»“æ¡ä»¶\n  const shouldTrigger = await shouldTriggerVolumeSummary();\n  if (!shouldTrigger) return;\n\n  // æå–æ¥¼å±‚ ID èŒƒå›´\n  const ids = unarchivedEntries\n    .map(e => parseInt(e.name.match(/æ¥¼å±‚(\\d+)/)![1]))\n    .sort((a, b) => a - b);\n\n  let start_id = ids[0];\n  let end_id = ids[ids.length - 1];\n\n  // ç”Ÿæˆå¤§æ€»ç»“\n  const content = await generateVolumeSummaryContent(unarchivedEntries);\n\n  // å°è¯•æå–è®¾å®šçš„èŒƒå›´\n  const match = content.match(/æ‘˜è¦(\\d+)-æ‘˜è¦(\\d+)/);\n  if (match) {\n    const parsedStart = parseInt(match[1]);\n    const parsedEnd = parseInt(match[2]);\n    if (parsedStart <= parsedEnd) {\n      start_id = parsedStart;\n      end_id = parsedEnd;\n    } else {\n      console.warn(\n        `[è‡ªåŠ¨æ€»ç»“] AI è¾“å‡ºçš„èŒƒå›´(æ‘˜è¦${parsedStart}-æ‘˜è¦${parsedEnd})æ— æ•ˆï¼Œå›é€€ä½¿ç”¨å…¨èŒƒå›´`\n      );\n    }\n  } else {\n    console.warn('[è‡ªåŠ¨æ€»ç»“] å·æ€»ç»“ä¸­æœªæ‰¾åˆ°æœ‰æ•ˆçš„é¦–å°¾èŒƒå›´æ ‡è®°ï¼Œå›é€€ä½¿ç”¨å…¨èŒƒå›´');\n  }\n\n  // æ¸…é™¤ç»“å°¾çš„æŒ‡å®šæ ‡è®°è¡Œå¹¶å­˜å…¥\n  const finalContent = content.replace(/\\s*æ‘˜è¦\\d+-æ‘˜è¦\\d+\\s*$/, '').trim();\n\n  // åˆ›å»ºå·æ¡ç›®å¹¶å…³é—­å¯¹åº”å°æ€»ç»“\n  await createVolumeEntry(meta.current_volume, start_id, end_id, finalContent);\n\n  console.log(`[è‡ªåŠ¨æ€»ç»“] å·²å½’æ¡£å·${meta.current_volume}: æ¥¼å±‚${start_id}~æ¥¼å±‚${end_id}`);\n}\n","/**\n * è§¦å‘å™¨\n * - ç›‘å¬ MESSAGE_RECEIVED äº‹ä»¶\n * - åŒæ­¥é˜¶æ®µï¼šåˆ›å»ºå ä½æ¡ç›® â†’ åŒæ­¥ enabled â†’ æ›´æ–°æ¥¼å±‚å¯è§æ€§\n * - å¼‚æ­¥é˜¶æ®µï¼šå°†ä»»åŠ¡åŠ å…¥é˜Ÿåˆ—\n */\n\nimport { getSettings } from '@/config';\nimport { taskQueue } from '@/queue';\nimport { createPlaceholderMiniSummary, syncMiniSummaryEnabled, worldbookExists } from '@/worldbook';\nimport { updateFloorVisibility } from '@/chat-manager';\n\n/** å°æ€»ç»“è®¡æ•°å™¨ï¼ˆç”¨äºå¤§æ€»ç»“æ£€æŸ¥é—´éš”ï¼‰ */\nlet miniSummaryCount = 0;\n\n/** åç½®æ€»ç»“ï¼šä¸Šä¸€æ¡å¾…æ€»ç»“çš„æ¶ˆæ¯ ID */\nlet pendingMessageId: number | null = null;\n\n/** æ£€æŸ¥æ˜¯å¦åº”è¯¥è§¦å‘å¤§æ€»ç»“æ£€æŸ¥ */\nfunction shouldCheckVolumeSummary(): boolean {\n  const settings = getSettings();\n  if (!settings.auto_volume_summary) return false;\n  return miniSummaryCount % settings.check_interval === 0 && miniSummaryCount > 0;\n}\n\n/** MESSAGE_RECEIVED äº‹ä»¶å¤„ç†å‡½æ•° */\nasync function onMessageReceived(message_id: number): Promise<void> {\n  const settings = getSettings();\n\n  // å¦‚æœæœªå¯ç”¨è‡ªåŠ¨å°æ€»ç»“ï¼Œç›´æ¥è¿”å›\n  if (!settings.auto_mini_summary) return;\n\n  // è·³è¿‡ç³»ç»Ÿæ¶ˆæ¯\n  const messages = getChatMessages(message_id);\n  if (messages.length === 0) return;\n  const msg = messages[0];\n  if (msg.role === 'system') return;\n  if (!msg.message || msg.message.trim() === '') return;\n\n  // å¿½ç•¥å‰ N å±‚çš„æ¶ˆæ¯\n  if (message_id < settings.ignore_floors) return;\n\n  // ä¸–ç•Œä¹¦ä¸å­˜åœ¨åˆ™è·³è¿‡\n  if (!worldbookExists()) return;\n\n  try {\n    // === åç½®æ€»ç»“é€»è¾‘ ===\n    if (settings.deferred_summary) {\n      // åç½®æ¨¡å¼ï¼šå…ˆå¤„ç†ä¸Šä¸€æ¡å¾…æ€»ç»“çš„æ¶ˆæ¯\n      if (pendingMessageId !== null) {\n        await createPlaceholderMiniSummary(pendingMessageId);\n        miniSummaryCount++;\n        if (shouldCheckVolumeSummary()) {\n          taskQueue.enqueue({ type: 'volume_summary' });\n        }\n        taskQueue.enqueue({ type: 'mini_summary', message_id: pendingMessageId });\n      }\n      // è®°ä½å½“å‰æ¶ˆæ¯ä¸ºå¾…å¤„ç†\n      pendingMessageId = message_id;\n    } else {\n      // === å³æ—¶æ¨¡å¼ï¼ˆåŸæœ‰é€»è¾‘ï¼‰ ===\n\n      // 1. æ–°å»ºå½“å‰æ¥¼å±‚çš„å°æ€»ç»“ä¸–ç•Œä¹¦æ¡ç›®ï¼ˆå†…å®¹ä¸ºç©ºå ä½ï¼‰\n      await createPlaceholderMiniSummary(message_id);\n\n      // 2. é€’å¢è®¡æ•°å™¨\n      miniSummaryCount++;\n\n      // 3. å¤§æ€»ç»“æ£€æŸ¥ï¼ˆå¦‚æœæ»¡è¶³é—´éš”æ¡ä»¶ï¼Œå°†å¤§æ€»ç»“ä»»åŠ¡åŠ å…¥é˜Ÿåˆ—ï¼‰\n      if (shouldCheckVolumeSummary()) {\n        taskQueue.enqueue({ type: 'volume_summary' });\n      }\n\n      // 4. å°†å°æ€»ç»“ç”Ÿæˆä»»åŠ¡åŠ å…¥å¼‚æ­¥é˜Ÿåˆ—\n      taskQueue.enqueue({ type: 'mini_summary', message_id });\n    }\n\n    // === åŒæ­¥é˜¶æ®µï¼ˆä¸¤ç§æ¨¡å¼å…±ç”¨ï¼‰ ===\n\n    // åŒæ­¥å°æ€»ç»“ enabled çŠ¶æ€\n    await syncMiniSummaryEnabled();\n\n    // è°ƒæ•´æ¥¼å±‚éšè—ä¸æ˜¾ç¤º\n    await updateFloorVisibility();\n  } catch (e) {\n    console.error('[è‡ªåŠ¨æ€»ç»“] æ¶ˆæ¯å¤„ç†å¤±è´¥:', e);\n  }\n}\n\n/** æ³¨å†Œäº‹ä»¶ç›‘å¬ */\nexport function registerListeners(): EventOnReturn {\n  return eventOn(\n    tavern_events.MESSAGE_RECEIVED,\n    errorCatched((message_id: number) => {\n      void onMessageReceived(message_id);\n    })\n  );\n}\n","/**\n * èŠå¤©æ¥¼å±‚ç®¡ç†\n * - éšè—/æ˜¾ç¤ºæ¥¼å±‚\n * - ä¸å°æ€»ç»“ enabled çŠ¶æ€è”åŠ¨\n */\n\nimport { getSettings } from '@/config';\nimport { syncMiniSummaryEnabled } from '@/worldbook';\n\n/** æ ¹æ®è®¾ç½®æ›´æ–°æ¥¼å±‚éšè—çŠ¶æ€ */\nexport async function updateFloorVisibility(): Promise<void> {\n  const settings = getSettings();\n  const lastId = getLastMessageId();\n\n  if (lastId < 0) return;\n\n  // è·å–æ‰€æœ‰æ¥¼å±‚\n  const allMessages = getChatMessages(`0-${lastId}`);\n  if (allMessages.length === 0) return;\n\n  const visibleThreshold = lastId - settings.visible_floors + 1;\n\n  // æ„å»ºéœ€è¦æ›´æ–°çš„æ¶ˆæ¯åˆ—è¡¨\n  const updates: Array<{ message_id: number; is_hidden: boolean }> = [];\n\n  for (const msg of allMessages) {\n    if (msg.role === 'system') continue; // è·³è¿‡ç³»ç»Ÿæ¶ˆæ¯\n\n    if (msg.message_id >= visibleThreshold) {\n      // æœ€è¿‘ N æ¥¼è®¾ä¸ºå¯è§\n      if (msg.is_hidden) {\n        updates.push({ message_id: msg.message_id, is_hidden: false });\n      }\n    } else {\n      // æ›´æ—©çš„æ¥¼å±‚è®¾ä¸ºéšè—\n      if (!msg.is_hidden) {\n        updates.push({ message_id: msg.message_id, is_hidden: true });\n      }\n    }\n  }\n\n  // æ‰¹é‡æ›´æ–°æ¥¼å±‚å¯è§æ€§\n  if (updates.length > 0) {\n    await setChatMessages(updates, { refresh: 'none' });\n  }\n\n  // åŒæ­¥å°æ€»ç»“ enabled çŠ¶æ€\n  await syncMiniSummaryEnabled();\n}\n","/**\n * è®¾ç½® UI å¼¹çª—\n * - é€šè¿‡é…’é¦†æ‰©å±•èœå•å…¥å£æ‰“å¼€\n * - æä¾›å„é¡¹è®¾ç½®ä¸æ‰‹åŠ¨æ“ä½œæŒ‰é’®\n */\n\nimport { getScriptData, saveScriptData, DEFAULT_SETTINGS, type ScriptDataType } from '@/config';\nimport { taskQueue } from '@/queue';\nimport {\n  createWorldbookForChat,\n  bindWorldbookForChat,\n  worldbookExists,\n  getWorldbookName,\n} from '@/worldbook';\nimport {\n  DEFAULT_MINI_SUMMARY_SYSTEM,\n  DEFAULT_VOLUME_SUMMARY_SYSTEM,\n  DEFAULT_VOLUME_COMPLETION_CHECK_SYSTEM,\n} from '@/prompts';\n\n// ========== èœå•æ³¨å…¥ ==========\n\nconst MENU_ID = 'hilo-auto-summary-menu';\n\n/** å‘æ‰©å±•èœå•æ³¨å…¥å…¥å£ */\nexport function addMenuItem(): void {\n  const $extensionsMenu = $('#extensionsMenu');\n  if (!$extensionsMenu.length) {\n    setTimeout(addMenuItem, 2000);\n    return;\n  }\n\n  // ç§»é™¤æ—§çš„èœå•é¡¹ï¼ˆè„šæœ¬é‡è½½åæ—§çš„ç‚¹å‡»å¤„ç†å‡½æ•°å·²å¤±æ•ˆï¼‰\n  $(`#${MENU_ID}`, $extensionsMenu).remove();\n\n  const $item = $(`\n    <div class=\"list-group-item flex-container flexGap5 interactable\" id=\"${MENU_ID}\" title=\"è‡ªåŠ¨æ€»ç»“è®¾ç½®\">\n      <div class=\"fa-fw fa-solid fa-book-open extensionsMenuExtensionButton\"></div>\n      <span>è‡ªåŠ¨æ€»ç»“</span>\n    </div>\n  `);\n\n  $item.on('click', async e => {\n    e.stopPropagation();\n    const $menuBtn = $('#extensionsMenuButton');\n    if ($menuBtn.length && $extensionsMenu.is(':visible')) {\n      $menuBtn.trigger('click');\n      await new Promise(r => setTimeout(r, 150));\n    }\n    await openSettingsPopup();\n  });\n\n  $extensionsMenu.append($item);\n}\n\n// ========== è®¾ç½®å¼¹çª— ==========\n\n/** å®‰å…¨è·å–ä¸–ç•Œä¹¦ååˆ—è¡¨ï¼ˆæœªæ‰“å¼€èŠå¤©æ—¶è¿”å›ç©ºæ•°ç»„ï¼‰ */\nfunction safeGetWorldbookNames(): string[] {\n  try {\n    return getWorldbookNames();\n  } catch {\n    return [];\n  }\n}\n\n/** æ„å»ºè®¾ç½®å¼¹çª— HTML */\nfunction buildSettingsHtml(data: ScriptDataType): string {\n  const currentWbName = getWorldbookName();\n  const wbNames = safeGetWorldbookNames();\n\n  return `\n    <div id=\"hilo-summary-settings\" style=\"padding: 10px;\">\n      <style>\n        #hilo-summary-settings input[type=\"text\"],\n        #hilo-summary-settings input[type=\"number\"],\n        #hilo-summary-settings input[type=\"password\"],\n        #hilo-summary-settings select,\n        #hilo-summary-settings textarea {\n          background-color: var(--SmartThemeSurface, #1c1c1c);\n          color: var(--SmartThemeBodyColor, #eee);\n          border: 1px solid var(--SmartThemeBorderColor, #444);\n          border-radius: 4px;\n          padding: 4px 8px;\n        }\n        #hilo-summary-settings input[type=\"text\"]:focus,\n        #hilo-summary-settings input[type=\"number\"]:focus,\n        #hilo-summary-settings input[type=\"password\"]:focus,\n        #hilo-summary-settings select:focus,\n        #hilo-summary-settings textarea:focus {\n          border-color: var(--SmartThemeFocusColor, #888);\n          outline: none;\n        }\n      </style>\n      <h3 style=\"margin-top: 0;\">ğŸ“– è‡ªåŠ¨æ€»ç»“è®¾ç½®</h3>\n\n      <!-- ä¸–ç•Œä¹¦ç®¡ç† -->\n      <div style=\"margin-bottom: 15px;\">\n        <h4>ä¸–ç•Œä¹¦ç®¡ç†</h4>\n        <div style=\"margin-bottom: 8px; display: flex; gap: 8px; align-items: center;\">\n          <label>å½“å‰ä¸–ç•Œä¹¦ï¼š</label>\n          <select id=\"hs-worldbook-select\" style=\"flex: 1;\">\n            <option value=\"\"${!currentWbName ? ' selected' : ''}>ï¼ˆæœªç»‘å®šï¼‰</option>\n            ${wbNames\n              .map(\n                name =>\n                  `<option value=\"${escapeHtml(name)}\" ${currentWbName === name ? 'selected' : ''}>${escapeHtml(name)}</option>`\n              )\n              .join('')}\n          </select>\n          <button id=\"hs-create-worldbook\" class=\"menu_button\" style=\"white-space: nowrap;\">ä¸€é”®åˆ›å»º</button>\n        </div>\n      </div>\n\n      <!-- åŸºæœ¬è®¾ç½® -->\n      <div style=\"margin-bottom: 15px;\">\n        <h4>åŸºæœ¬è®¾ç½®</h4>\n        <div style=\"margin-bottom: 8px;\">\n          <label>æ˜¾ç¤ºæ¥¼å±‚æ•°ï¼š</label>\n          <input type=\"number\" id=\"hs-visible-floors\" value=\"${data.visible_floors}\" min=\"1\" max=\"100\" style=\"width: 80px;\" />\n          <small style=\"color: #888;\">ï¼ˆæœ€è¿‘ä¿ç•™å¤šå°‘æ¥¼å¯è§ï¼‰</small>\n        </div>\n        <div style=\"margin-bottom: 8px;\">\n          <label>æ£€æŸ¥é—´éš”ï¼š</label>\n          <input type=\"number\" id=\"hs-check-interval\" value=\"${data.check_interval}\" min=\"5\" max=\"100\" style=\"width: 80px;\" />\n          <small style=\"color: #888;\">ï¼ˆæ¯å¤šå°‘ä¸ªå°æ€»ç»“æ£€æŸ¥ä¸€æ¬¡å¤§æ€»ç»“ï¼‰</small>\n        </div>\n        <div style=\"margin-bottom: 8px;\">\n          <label>Token é˜ˆå€¼ï¼š</label>\n          <input type=\"number\" id=\"hs-volume-token-threshold\" value=\"${data.volume_token_threshold}\" min=\"1000\" max=\"50000\" style=\"width: 100px;\" />\n          <small style=\"color: #888;\">ï¼ˆå¤§æ€»ç»“è§¦å‘é˜ˆå€¼ï¼‰</small>\n        </div>\n        <div style=\"margin-bottom: 8px;\">\n          <label>\n            <input type=\"checkbox\" id=\"hs-auto-mini-summary\" ${data.auto_mini_summary ? 'checked' : ''} />\n            è‡ªåŠ¨å°æ€»ç»“\n          </label>\n        </div>\n        <div style=\"margin-bottom: 8px;\">\n          <label>\n            <input type=\"checkbox\" id=\"hs-auto-volume-summary\" ${data.auto_volume_summary ? 'checked' : ''} />\n            è‡ªåŠ¨å¤§æ€»ç»“\n          </label>\n        </div>\n        <div style=\"margin-bottom: 8px;\">\n          <label>\n            <input type=\"checkbox\" id=\"hs-deferred-summary\" ${data.deferred_summary ? 'checked' : ''} />\n            å»¶è¿Ÿæ€»ç»“\n          </label>\n          <small style=\"color: #888;\">ï¼ˆå¯ç”¨åå°†åœ¨ä¸‹ä¸€æ¬¡å›å¤åˆ°è¾¾åæ‰å¯¹ä¸Šä¸€æ¡æ¶ˆæ¯è¿›è¡Œæ€»ç»“ï¼‰</small>\n        </div>\n        <div style=\"margin-bottom: 8px;\">\n          <label>å°æ€»ç»“æ³¨å…¥æ·±åº¦ï¼š</label>\n          <input type=\"number\" id=\"hs-mini-summary-depth\" value=\"${data.mini_summary_depth}\" min=\"0\" max=\"99999\" style=\"width: 100px;\" />\n          <small style=\"color: #888;\">ï¼ˆé»˜è®¤ 9999ï¼‰</small>\n        </div>\n        <div style=\"margin-bottom: 8px;\">\n          <label>å·æ€»ç»“æ³¨å…¥æ·±åº¦ï¼š</label>\n          <input type=\"number\" id=\"hs-volume-summary-depth\" value=\"${data.volume_summary_depth}\" min=\"0\" max=\"99999\" style=\"width: 100px;\" />\n          <small style=\"color: #888;\">ï¼ˆé»˜è®¤ 9999ï¼‰</small>\n        </div>\n        <div style=\"margin-bottom: 8px;\">\n          <label>å°æ€»ç»“èµ·å§‹æ’åºï¼š</label>\n          <input type=\"number\" id=\"hs-mini-start-order\" value=\"${data.mini_summary_start_order}\" min=\"0\" max=\"99999\" style=\"width: 100px;\" />\n          <small style=\"color: #888;\">ï¼ˆå°æ€»ç»“ order åŸºæ•°ï¼Œé»˜è®¤ 10000ï¼‰</small>\n        </div>\n        <div style=\"margin-bottom: 8px;\">\n          <label>å·æ€»ç»“èµ·å§‹æ’åºï¼š</label>\n          <input type=\"number\" id=\"hs-volume-start-order\" value=\"${data.volume_start_order}\" min=\"0\" max=\"99999\" style=\"width: 100px;\" />\n          <small style=\"color: #888;\">ï¼ˆå·æ€»ç»“ order åŸºæ•°ï¼Œé»˜è®¤ 100ï¼‰</small>\n        </div>\n        <div style=\"margin-bottom: 8px;\">\n          <label>å¿½ç•¥å‰ N å±‚ï¼š</label>\n          <input type=\"number\" id=\"hs-ignore-floors\" value=\"${data.ignore_floors}\" min=\"0\" max=\"1000\" style=\"width: 80px;\" />\n          <small style=\"color: #888;\">ï¼ˆè·³è¿‡å‰å¤šå°‘å±‚ä¸è¿›è¡Œæ€»ç»“ï¼‰</small>\n        </div>\n        <div style=\"margin-bottom: 8px;\">\n          <label>ä»»åŠ¡å†·å´é—´éš”ï¼š</label>\n          <input type=\"number\" id=\"hs-task-cooldown\" value=\"${data.task_cooldown}\" min=\"0\" max=\"300\" style=\"width: 80px;\" />\n          <small style=\"color: #888;\">ï¼ˆç§’ï¼Œé˜²å¹¶å‘å†²çªä¸ API é€Ÿç‡é™åˆ¶ï¼‰</small>\n        </div>\n        <div style=\"margin-bottom: 8px;\">\n          <label>æœ€å¤§å›å¤ Tokenï¼š</label>\n          <input type=\"number\" id=\"hs-max-tokens\" value=\"${data.max_tokens}\" min=\"0\" max=\"128000\" style=\"width: 100px;\" />\n          <small style=\"color: #888;\">ï¼ˆ0 = è·Ÿéšé¢„è®¾ï¼Œå»ºè®® 300~2000ï¼‰</small>\n        </div>\n        <!-- å†…å®¹æ•è·æ ‡ç­¾ -->\n        <details style=\"margin-bottom: 8px;\">\n          <summary style=\"cursor: pointer;\">å†…å®¹æ•è·æ ‡ç­¾ <small style=\"color: #888;\">ï¼ˆä»…æ€»ç»“æ ‡ç­¾ä¹‹é—´çš„å†…å®¹ï¼Œåˆ—è¡¨ä¸ºç©ºåˆ™æ€»ç»“å…¨éƒ¨ï¼‰</small></summary>\n          <div style=\"padding: 8px 0;\">\n            <div id=\"hs-capture-tags-list\">\n              ${data.capture_tags.map((t, i) => buildCaptureTagRowHtml(t, i)).join('')}\n            </div>\n            <button id=\"hs-add-capture-tag\" class=\"menu_button\" style=\"white-space: nowrap; flex: 1; padding: 5px 0;\">+ æ·»åŠ æ•è·æ ‡ç­¾</button>\n          </div>\n        </details>\n        <div style=\"margin-bottom: 8px;\">\n          <label>\n            <input type=\"checkbox\" id=\"hs-no-trans-tag\" ${data.no_trans_tag ? 'checked' : ''} />\n            é˜²åˆå¹¶æ ‡è®°\n          </label>\n          <input type=\"text\" id=\"hs-no-trans-tag-value\" value=\"${escapeHtml(data.no_trans_tag_value)}\" style=\"width: 100px; margin-left: 5px;\" placeholder=\"<|no-trans|>\" title=\"è‡ªå®šä¹‰é˜²åˆå¹¶æ ‡è®°\" />\n          <small style=\"color: #888; margin-left: 5px;\">ï¼ˆkeminiæˆ–noassè„šæœ¬å¼€ï¼‰</small>\n        </div>\n      </div>\n\n      <!-- æ‰‹åŠ¨æ“ä½œ -->\n      <div style=\"margin-bottom: 15px;\">\n        <h4>æ‰‹åŠ¨æ“ä½œ</h4>\n        <div style=\"display: flex; gap: 8px; flex-wrap: nowrap;\">\n          <button id=\"hs-manual-mini\" class=\"menu_button\" style=\"white-space: nowrap; flex: 1; padding: 5px 0;\">æ‰‹åŠ¨æ€»ç»“</button>\n          <button id=\"hs-manual-volume\" class=\"menu_button\" style=\"white-space: nowrap; flex: 1; padding: 5px 0;\">æ‰‹åŠ¨å½’æ¡£</button>\n          <button id=\"hs-manual-complete\" class=\"menu_button\" style=\"white-space: nowrap; flex: 1; padding: 5px 0;\">æ‰‹åŠ¨è¡¥å…¨</button>\n        </div>\n      </div>\n\n      <!-- API é…ç½® -->\n      <div style=\"margin-bottom: 15px;\">\n        <h4>API é…ç½®</h4>\n        <div style=\"margin-bottom: 8px;\">\n          <label>API URLï¼š</label>\n          <input type=\"text\" id=\"hs-custom-api-url\" value=\"${escapeHtml(data.custom_api.apiurl)}\" style=\"width: 100%;\" placeholder=\"https://api.example.com/v1\" />\n        </div>\n        <div style=\"margin-bottom: 8px;\">\n          <label>API Keyï¼š</label>\n          <input type=\"password\" id=\"hs-custom-api-key\" value=\"${escapeHtml(data.custom_api.key)}\" style=\"width: 100%;\" placeholder=\"sk-...\" />\n        </div>\n        <div style=\"margin-bottom: 8px;\">\n          <label>æ¨¡å‹ï¼š</label>\n          <div style=\"display: flex; gap: 5px; align-items: center;\">\n            <input type=\"text\" id=\"hs-custom-api-model\" value=\"${escapeHtml(data.custom_api.model)}\" style=\"flex: 1;\" placeholder=\"è¾“å…¥æ¨¡å‹åç§°ï¼Œå¦‚ gpt-4o\" list=\"hs-model-datalist\" />\n            <datalist id=\"hs-model-datalist\"></datalist>\n            <button id=\"hs-fetch-models\" class=\"menu_button\" style=\"white-space: nowrap; padding: 4px 10px;\">è·å–æ¨¡å‹</button>\n          </div>\n        </div>\n        <div style=\"margin-bottom: 8px;\">\n          <label>API æºï¼š</label>\n          <select id=\"hs-custom-api-source\" style=\"width: 100%;\">\n            ${['openai']\n              .map(\n                s =>\n                  `<option value=\"${s}\" ${data.custom_api.source === s ? 'selected' : ''}>${s}</option>`\n              )\n              .join('')}\n          </select>\n        </div>\n      </div>\n\n      <!-- è‡ªå®šä¹‰æç¤ºè¯ -->\n      <details style=\"margin-bottom: 15px;\">\n        <summary><h4 style=\"display: inline;\">è‡ªå®šä¹‰æç¤ºè¯</h4></summary>\n        <div style=\"padding: 8px 0;\">\n          <div style=\"margin-bottom: 8px;\">\n            <label>å°æ€»ç»“ç³»ç»Ÿæç¤ºè¯ï¼š</label>\n            <textarea id=\"hs-prompt-mini\" rows=\"5\" style=\"width: 100%; resize: vertical;\" placeholder=\"ä½¿ç”¨é»˜è®¤æç¤ºè¯\">${escapeHtml(data.custom_prompts.mini_summary_system || DEFAULT_MINI_SUMMARY_SYSTEM)}</textarea>\n            <small style=\"color: #888;\">ï¼ˆä¿®æ”¹åå³ä¸ºè‡ªå®šä¹‰ï¼›æ¢å¤é»˜è®¤è¯·æ¸…ç©ºæç¤ºè¯å¹¶ä¿å­˜ï¼‰</small>\n          </div>\n          <div style=\"margin-bottom: 8px;\">\n            <label>å¤§æ€»ç»“ç³»ç»Ÿæç¤ºè¯ï¼š</label>\n            <textarea id=\"hs-prompt-volume\" rows=\"5\" style=\"width: 100%; resize: vertical;\" placeholder=\"ä½¿ç”¨é»˜è®¤æç¤ºè¯\">${escapeHtml(data.custom_prompts.volume_summary_system || DEFAULT_VOLUME_SUMMARY_SYSTEM)}</textarea>\n            <small style=\"color: #888;\">ï¼ˆä¿®æ”¹åå³ä¸ºè‡ªå®šä¹‰ï¼›æ¢å¤é»˜è®¤è¯·æ¸…ç©ºæç¤ºè¯å¹¶ä¿å­˜ï¼‰</small>\n          </div>\n          <div style=\"margin-bottom: 8px;\">\n            <label>å·å®Œç»“æ£€æµ‹ç³»ç»Ÿæç¤ºè¯ï¼š</label>\n            <textarea id=\"hs-prompt-completion\" rows=\"5\" style=\"width: 100%; resize: vertical;\" placeholder=\"ä½¿ç”¨é»˜è®¤æç¤ºè¯\">${escapeHtml(data.custom_prompts.volume_completion_check_system || DEFAULT_VOLUME_COMPLETION_CHECK_SYSTEM)}</textarea>\n            <small style=\"color: #888; display: block; margin-top: 4px;\">\n              ï¼ˆä¿®æ”¹åå³ä¸ºè‡ªå®šä¹‰ï¼›æ¢å¤é»˜è®¤æ¸…ç©ºå³å¯ï¼‰\n            </small>\n          </div>\n        </div>\n      </details>\n\n      <!-- æ¶ˆæ¯æ¸…æ´— -->\n      <details style=\"margin-bottom: 15px;\">\n        <summary><h4 style=\"display: inline;\">æ¶ˆæ¯æ¸…æ´—æ­£åˆ™</h4></summary>\n        <div style=\"padding: 8px 0;\">\n          <div id=\"hs-regex-list\">\n            ${data.message_cleanup_regex.map((r, i) => buildRegexRowHtml(r, i)).join('')}\n          </div>\n          <button id=\"hs-add-regex\" class=\"menu_button\" style=\"white-space: nowrap; flex: 1; padding: 5px 0;\">+ æ·»åŠ æ­£åˆ™</button>\n        </div>\n      </details>\n    </div>\n  `;\n}\n\n/** æ„å»ºå•è¡Œæ•è·æ ‡ç­¾ HTML */\nfunction buildCaptureTagRowHtml(\n  tag: { start_tag: string; end_tag: string },\n  index: number\n): string {\n  return `\n    <div class=\"hs-capture-tag-row\" data-index=\"${index}\" style=\"display: flex; gap: 5px; margin-bottom: 5px; align-items: center;\">\n      <span>&lt;</span>\n      <input type=\"text\" class=\"hs-capture-start-tag\" value=\"${escapeHtml(tag.start_tag)}\" placeholder=\"èµ·å§‹æ ‡ç­¾\" style=\"flex: 1;\" />\n      <span>&gt; â€¦ &lt;</span>\n      <input type=\"text\" class=\"hs-capture-end-tag\" value=\"${escapeHtml(tag.end_tag)}\" placeholder=\"ç»“æŸæ ‡ç­¾\" style=\"flex: 1;\" />\n      <span>&gt;</span>\n      <button class=\"hs-remove-capture-tag menu_button\" style=\"flex: 0 0 auto; padding: 2px 8px;\">âœ•</button>\n    </div>\n  `;\n}\n\n/** ä»å¼¹çª—æ”¶é›†æ•è·æ ‡ç­¾æ•°æ® */\nfunction collectCaptureTagsFromPopup(): { start_tag: string; end_tag: string }[] {\n  const tagRows = $('.hs-capture-tag-row');\n  const tagList: { start_tag: string; end_tag: string }[] = [];\n  tagRows.each(function () {\n    const $row = $(this);\n    const startTag = (($row.find('.hs-capture-start-tag').val() as string) || '').trim();\n    const endTag = (($row.find('.hs-capture-end-tag').val() as string) || '').trim();\n    // ä¿ç•™è‡³å°‘æœ‰ä¸€ä¸ªæ ‡ç­¾ä¸ä¸ºç©ºçš„è¡Œ\n    if (startTag || endTag) {\n      tagList.push({ start_tag: startTag, end_tag: endTag });\n    }\n  });\n  return tagList;\n}\n\n/** æ„å»ºå•è¡Œæ­£åˆ™ HTML */\nfunction buildRegexRowHtml(\n  regex: { pattern: string; flags: string; replacement: string },\n  index: number\n): string {\n  return `\n    <div class=\"hs-regex-row\" data-index=\"${index}\" style=\"display: flex; gap: 5px; margin-bottom: 5px; align-items: center;\">\n      <input type=\"text\" class=\"hs-regex-pattern\" value=\"${escapeHtml(regex.pattern)}\" placeholder=\"æ­£åˆ™\" style=\"flex: 3;\" />\n      <input type=\"text\" class=\"hs-regex-flags\" value=\"${escapeHtml(regex.flags)}\" placeholder=\"flags\" style=\"flex: 1; max-width: 60px;\" />\n      <input type=\"text\" class=\"hs-regex-replacement\" value=\"${escapeHtml(regex.replacement)}\" placeholder=\"æ›¿æ¢\" style=\"flex: 2;\" />\n      <button class=\"hs-remove-regex menu_button\" style=\"flex: 0 0 auto; padding: 2px 8px;\">âœ•</button>\n    </div>\n  `;\n}\n\n/** HTML è½¬ä¹‰ */\nfunction escapeHtml(str: string): string {\n  return str\n    .replace(/&/g, '&amp;')\n    .replace(/</g, '&lt;')\n    .replace(/>/g, '&gt;')\n    .replace(/\"/g, '&quot;')\n    .replace(/'/g, '&#039;');\n}\n\n/** ä»å¼¹çª—æ”¶é›†è®¾ç½®æ•°æ® */\nfunction collectSettingsFromPopup(): Partial<ScriptDataType> {\n  const regexRows = $('.hs-regex-row');\n  const regexList: { pattern: string; flags: string; replacement: string }[] = [];\n  regexRows.each(function () {\n    const $row = $(this);\n    const pattern = $row.find('.hs-regex-pattern').val() as string;\n    if (pattern) {\n      regexList.push({\n        pattern,\n        flags: ($row.find('.hs-regex-flags').val() as string) || 'g',\n        replacement: ($row.find('.hs-regex-replacement').val() as string) || '',\n      });\n    }\n  });\n\n  const miniPrompt = (($('#hs-prompt-mini').val() as string) || '').trim();\n  const volumePrompt = (($('#hs-prompt-volume').val() as string) || '').trim();\n  const completionPrompt = (($('#hs-prompt-completion').val() as string) || '').trim();\n\n  return {\n    visible_floors: parseInt($('#hs-visible-floors').val() as string) || 20,\n    check_interval: parseInt($('#hs-check-interval').val() as string) || 20,\n    volume_token_threshold: parseInt($('#hs-volume-token-threshold').val() as string) || 8000,\n    auto_mini_summary: $('#hs-auto-mini-summary').is(':checked'),\n    auto_volume_summary: $('#hs-auto-volume-summary').is(':checked'),\n    deferred_summary: $('#hs-deferred-summary').is(':checked'),\n    mini_summary_depth: parseInt($('#hs-mini-summary-depth').val() as string) || 9999,\n    volume_summary_depth: parseInt($('#hs-volume-summary-depth').val() as string) || 9999,\n    mini_summary_start_order: parseInt($('#hs-mini-start-order').val() as string) || 10000,\n    volume_start_order: parseInt($('#hs-volume-start-order').val() as string) || 100,\n    ignore_floors: parseInt($('#hs-ignore-floors').val() as string) || 0,\n    task_cooldown: parseInt($('#hs-task-cooldown').val() as string) || 5,\n    max_tokens: parseInt($('#hs-max-tokens').val() as string) || 0,\n    capture_tags: collectCaptureTagsFromPopup(),\n    no_trans_tag: $('#hs-no-trans-tag').is(':checked'),\n    no_trans_tag_value: (($('#hs-no-trans-tag-value').val() as string) || '').trim(),\n    custom_api: {\n      apiurl: ($('#hs-custom-api-url').val() as string) || '',\n      key: ($('#hs-custom-api-key').val() as string) || '',\n      model: ($('#hs-custom-api-model').val() as string) || '',\n      source: ($('#hs-custom-api-source').val() as string) || 'openai',\n    },\n    custom_prompts: {\n      mini_summary_system: miniPrompt === DEFAULT_MINI_SUMMARY_SYSTEM.trim() ? '' : miniPrompt,\n      volume_summary_system:\n        volumePrompt === DEFAULT_VOLUME_SUMMARY_SYSTEM.trim() ? '' : volumePrompt,\n      volume_completion_check_system:\n        completionPrompt === DEFAULT_VOLUME_COMPLETION_CHECK_SYSTEM.trim() ? '' : completionPrompt,\n    },\n    message_cleanup_regex: regexList,\n  };\n}\n\n/** æ‰“å¼€è®¾ç½®å¼¹çª— */\nasync function openSettingsPopup(): Promise<void> {\n  const data = getScriptData();\n  const html = buildSettingsHtml(data);\n\n  const $popup = $(html);\n\n  $popup.css({\n    flex: '1',\n    'overflow-y': 'auto',\n    'min-height': '0',\n    'padding-right': '5px',\n  });\n\n  // ä½¿ç”¨é…’é¦†çš„ callGenericPopupæˆ–åˆ›å»ºç®€å•å¼¹çª—\n  const $overlay = $(`<div id=\"hilo-summary-overlay\"></div>`);\n\n  const $dialog = $(`<div id=\"hilo-summary-dialog\"></div>`);\n\n  const $buttons =\n    $(`<div style=\"display: flex; justify-content: flex-end; gap: 8px; margin-top: 15px; flex-shrink: 0; padding-top: 10px; border-top: 1px solid var(--SmartThemeBorderColor, #555);\">\n    <button id=\"hs-reset\" class=\"menu_button\" style=\"margin-right: auto; white-space: nowrap; padding: 5px 15px;\">é‡ç½®é»˜è®¤</button>\n    <button id=\"hs-cancel\" class=\"menu_button\" style=\"white-space: nowrap; padding: 5px 15px;\">å–æ¶ˆ</button>\n    <button id=\"hs-save\" class=\"menu_button\" style=\"white-space: nowrap; padding: 5px 15px;\">ä¿å­˜</button>\n  </div>`);\n\n  $dialog.append($popup).append($buttons);\n  $overlay.append($dialog);\n  $('body').append($overlay);\n\n  const win = window.top || window;\n  const fitOverlay = () => {\n    const vp = win.visualViewport || {\n      width: win.innerWidth,\n      height: win.innerHeight,\n      offsetTop: 0,\n      offsetLeft: 0,\n    };\n    const w = vp.width || win.innerWidth;\n    const h = vp.height || win.innerHeight;\n    $overlay[0].style.cssText = `\n      position: fixed !important; top: ${vp.offsetTop || 0}px !important; left: ${vp.offsetLeft || 0}px !important;\n      width: ${w}px !important; height: ${h}px !important;\n      max-width: none !important; max-height: none !important; margin: 0 !important; padding: 0 !important;\n      z-index: 10000 !important; display: flex !important; align-items: center !important; justify-content: center !important;\n      background: rgba(0,0,0,0.6) !important;\n      overflow: hidden !important;\n    `;\n    const panel = $dialog[0];\n    if (panel && w <= 768) {\n      panel.style.cssText = `\n        background: var(--SmartThemeBlurTintColor, #2b2b2b) !important;\n        border: none !important;\n        border-radius: 0 !important; padding: 15px !important;\n        width: ${w}px !important; height: ${h}px !important;\n        max-width: none !important; max-height: none !important; margin: 0 !important;\n        display: flex !important; flex-direction: column !important;\n        color: var(--SmartThemeBodyColor, #ccc) !important;\n        box-sizing: border-box !important;\n      `;\n    } else if (panel) {\n      panel.style.cssText = `\n        background: var(--SmartThemeBlurTintColor, #2b2b2b) !important;\n        border: 1px solid var(--SmartThemeBorderColor, #555) !important;\n        border-radius: 10px !important; padding: 20px !important; width: 90vw !important;\n        min-width: 300px !important; max-width: 700px !important; max-height: 90vh !important;\n        display: flex !important; flex-direction: column !important;\n        color: var(--SmartThemeBodyColor, #ccc) !important;\n        box-sizing: border-box !important;\n      `;\n    }\n  };\n\n  fitOverlay();\n  const vpObj = win.visualViewport;\n  if (vpObj) {\n    vpObj.addEventListener('resize', fitOverlay);\n    vpObj.addEventListener('scroll', fitOverlay);\n  }\n  win.addEventListener('resize', fitOverlay);\n\n  const cleanupResize = () => {\n    if (vpObj) {\n      vpObj.removeEventListener('resize', fitOverlay);\n      vpObj.removeEventListener('scroll', fitOverlay);\n    }\n    win.removeEventListener('resize', fitOverlay);\n  };\n\n  const closeOverlay = () => {\n    cleanupResize();\n    $overlay.remove();\n  };\n\n  // äº‹ä»¶ç»‘å®š\n  $overlay.on('click', '#hs-cancel', () => {\n    closeOverlay();\n  });\n\n  // é‡ç½®é»˜è®¤è®¾ç½®\n  $overlay.on('click', '#hs-reset', () => {\n    const currentData = getScriptData();\n    // é‡ç½®ç”¨æˆ·è®¾ç½®ï¼ˆè¿è¡Œæ—¶å…ƒæ•°æ®å­˜åœ¨ä¸–ç•Œä¹¦ä¸­ï¼Œä¸å—å½±å“ï¼‰\n    const resetData = { ...DEFAULT_SETTINGS } as ScriptDataType;\n    saveScriptData(resetData);\n    toastr.success('å·²é‡ç½®ä¸ºé»˜è®¤è®¾ç½®');\n    closeOverlay();\n    // é‡æ–°æ‰“å¼€å¼¹çª—ä»¥åˆ·æ–° UI\n    void openSettingsPopup();\n  });\n\n  $overlay.on('click', '#hs-save', () => {\n    const newSettings = collectSettingsFromPopup();\n    const currentData = getScriptData();\n    const merged = { ...currentData, ...newSettings };\n    saveScriptData(merged as ScriptDataType);\n    toastr.success('è®¾ç½®å·²ä¿å­˜');\n    closeOverlay();\n  });\n\n  // ä¸–ç•Œä¹¦é€‰æ‹©å˜æ›´\n  $overlay.on('change', '#hs-worldbook-select', async function () {\n    const selected = $(this).val() as string;\n    if (selected) {\n      try {\n        await bindWorldbookForChat(selected);\n        toastr.success(`å·²ç»‘å®šä¸–ç•Œä¹¦: ${selected}`);\n      } catch (e) {\n        toastr.error(`ç»‘å®šä¸–ç•Œä¹¦å¤±è´¥: ${selected}`);\n        console.error('[è‡ªåŠ¨æ€»ç»“] ç»‘å®šä¸–ç•Œä¹¦å¤±è´¥:', e);\n      }\n    } else {\n      // è§£ç»‘ï¼šç»‘å®šç©ºå­—ç¬¦ä¸²ä»¥è§£é™¤\n      await rebindChatWorldbook('current', '');\n      toastr.info('å·²è§£é™¤ä¸–ç•Œä¹¦ç»‘å®š');\n    }\n  });\n\n  // ä¸€é”®åˆ›å»ºä¸–ç•Œä¹¦\n  $overlay.on('click', '#hs-create-worldbook', async () => {\n    try {\n      const name = await createWorldbookForChat();\n      // åˆ·æ–°ä¸‹æ‹‰æ¡†\n      const $select = $('#hs-worldbook-select');\n      // å¦‚æœä¸‹æ‹‰æ¡†ä¸­æ²¡æœ‰è¯¥é€‰é¡¹åˆ™æ·»åŠ \n      if ($select.find(`option[value=\"${escapeHtml(name)}\"]`).length === 0) {\n        $select.append(`<option value=\"${escapeHtml(name)}\">${escapeHtml(name)}</option>`);\n      }\n      $select.val(name);\n      toastr.success(`å·²åˆ›å»ºå¹¶ç»‘å®šä¸–ç•Œä¹¦: ${name}`);\n    } catch (e) {\n      toastr.error('åˆ›å»ºä¸–ç•Œä¹¦å¤±è´¥');\n      console.error('[è‡ªåŠ¨æ€»ç»“] åˆ›å»ºä¸–ç•Œä¹¦å¤±è´¥:', e);\n    }\n  });\n\n  // æ‰‹åŠ¨æ€»ç»“\n  $overlay.on('click', '#hs-manual-mini', () => {\n    const lastId = getLastMessageId();\n    if (lastId >= 0) {\n      taskQueue.enqueue({ type: 'mini_summary', message_id: lastId });\n      toastr.info(`å·²å°†æ¥¼å±‚ ${lastId} çš„å°æ€»ç»“ä»»åŠ¡åŠ å…¥é˜Ÿåˆ—`);\n    } else {\n      toastr.warning('å½“å‰æ²¡æœ‰èŠå¤©æ¶ˆæ¯');\n    }\n  });\n\n  // æ‰‹åŠ¨å½’æ¡£\n  $overlay.on('click', '#hs-manual-volume', () => {\n    taskQueue.enqueue({ type: 'volume_summary' });\n    toastr.info('å·²å°†å¤§æ€»ç»“ä»»åŠ¡åŠ å…¥é˜Ÿåˆ—');\n  });\n\n  // æ‰‹åŠ¨è¡¥å…¨\n  $overlay.on('click', '#hs-manual-complete', async () => {\n    const data = getScriptData();\n    const lastId = getLastMessageId();\n\n    const startId = data.ignore_floors;\n    if (startId > lastId) {\n      toastr.warning('æ²¡æœ‰å¯ä»¥è¡¥å…¨çš„æ¥¼å±‚ï¼ˆéƒ½åœ¨å¿½ç•¥èŒƒå›´å†…ï¼‰');\n      return;\n    }\n\n    const wbName = getWorldbookName();\n    if (!wbName) {\n      toastr.warning('å½“å‰èŠå¤©æœªç»‘å®šä¸–ç•Œä¹¦ï¼Œæ— æ³•æ£€æŸ¥è¡¥å…¨');\n      return;\n    }\n\n    toastr.info('æ­£åœ¨æ£€æŸ¥ç¼ºå¤±å±‚æ•°...');\n    try {\n      const wb = await getWorldbook(wbName);\n      const existingFloors = new Set<number>();\n      for (const entry of wb) {\n        const match = entry.name.match(/^\\[å°æ€»ç»“-æ¥¼å±‚(\\d+)\\]$/);\n        if (match) {\n          existingFloors.add(parseInt(match[1]));\n        }\n      }\n\n      let count = 0;\n      const msgs = getChatMessages(`${startId}-${lastId}`);\n      for (const msg of msgs) {\n        // ä»…å¤„ç† AI æ¶ˆæ¯ï¼ˆæ’é™¤ user å’Œ system æ¶ˆæ¯ï¼‰\n        if (msg.role === 'user' || msg.role === 'system') continue;\n\n        if (!existingFloors.has(msg.message_id)) {\n          taskQueue.enqueue({ type: 'mini_summary', message_id: msg.message_id });\n          count++;\n        }\n      }\n\n      if (count > 0) {\n        taskQueue.enqueue({ type: 'volume_summary' });\n        toastr.success(`æ£€æµ‹åˆ° ${count} ä¸ªç¼ºå¤±æ¥¼å±‚ï¼Œå·²å…¨éƒ¨åŠ å…¥è¡¥å…¨é˜Ÿåˆ—ï¼Œå¹¶åœ¨æœ€ååŠ å…¥å½’æ¡£ä»»åŠ¡`);\n      } else {\n        toastr.info('æ‰€æœ‰æ¥¼å±‚å‡å·²æœ‰å¯¹åº”å°æ€»ç»“ï¼Œæ— éœ€è¡¥å…¨');\n      }\n    } catch (e) {\n      toastr.error('è·å–ä¸–ç•Œä¹¦æ¡ç›®å¤±è´¥ï¼Œæ— æ³•è¡¥å…¨');\n      console.error('[è‡ªåŠ¨æ€»ç»“] æ‰‹åŠ¨è¡¥å…¨æ£€æŸ¥å¤±è´¥:', e);\n    }\n  });\n\n  // è·å–æ¨¡å‹åˆ—è¡¨\n  $overlay.on('click', '#hs-fetch-models', async () => {\n    const apiUrl = (($('#hs-custom-api-url').val() as string) || '').trim();\n    const apiKey = (($('#hs-custom-api-key').val() as string) || '').trim();\n\n    if (!apiUrl) {\n      toastr.warning('è¯·å…ˆå¡«å†™ API URL');\n      return;\n    }\n\n    const $btn = $('#hs-fetch-models');\n    $btn.prop('disabled', true).text('è·å–ä¸­...');\n\n    try {\n      // å°è¯• /v1/models å’Œ /models ä¸¤ç§è·¯å¾„\n      const baseUrl = apiUrl.replace(/\\/+$/, '');\n      const urls = baseUrl.endsWith('/v1')\n        ? [`${baseUrl}/models`]\n        : [`${baseUrl}/v1/models`, `${baseUrl}/models`];\n\n      let models: string[] = [];\n      for (const url of urls) {\n        try {\n          const headers: Record<string, string> = { 'Content-Type': 'application/json' };\n          if (apiKey) headers['Authorization'] = `Bearer ${apiKey}`;\n\n          const resp = await fetch(url, { method: 'GET', headers });\n          if (!resp.ok) continue;\n\n          const json = await resp.json();\n          if (json.data && Array.isArray(json.data)) {\n            models = json.data\n              .map((m: any) => m.id || m.name || '')\n              .filter((id: string) => id)\n              .sort();\n            break;\n          }\n        } catch {\n          // å°è¯•ä¸‹ä¸€ä¸ª URL\n        }\n      }\n\n      if (models.length === 0) {\n        toastr.warning('æœªè·å–åˆ°æ¨¡å‹åˆ—è¡¨ï¼Œè¯·æ£€æŸ¥ API URL å’Œ Key');\n        return;\n      }\n\n      // å¡«å…… datalist\n      const $datalist = $('#hs-model-datalist');\n      $datalist.empty();\n      for (const model of models) {\n        $datalist.append(`<option value=\"${escapeHtml(model)}\">`);\n      }\n\n      toastr.success(`å·²è·å– ${models.length} ä¸ªæ¨¡å‹`);\n\n      // èšç„¦è¾“å…¥æ¡†ä»¥æ˜¾ç¤ºå»ºè®®åˆ—è¡¨\n      $('#hs-custom-api-model').trigger('focus');\n    } catch (e) {\n      toastr.error('è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥');\n      console.error('[è‡ªåŠ¨æ€»ç»“] è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥:', e);\n    } finally {\n      $btn.prop('disabled', false).text('è·å–æ¨¡å‹');\n    }\n  });\n\n  // æ·»åŠ æ­£åˆ™\n  let regexIndex = data.message_cleanup_regex.length;\n  $overlay.on('click', '#hs-add-regex', () => {\n    const newRow = buildRegexRowHtml({ pattern: '', flags: 'g', replacement: '' }, regexIndex++);\n    $('#hs-regex-list').append(newRow);\n  });\n\n  // åˆ é™¤æ­£åˆ™\n  $overlay.on('click', '.hs-remove-regex', function () {\n    $(this).closest('.hs-regex-row').remove();\n  });\n\n  // æ·»åŠ æ•è·æ ‡ç­¾\n  let captureTagIndex = data.capture_tags.length;\n  $overlay.on('click', '#hs-add-capture-tag', () => {\n    const newRow = buildCaptureTagRowHtml({ start_tag: '', end_tag: '' }, captureTagIndex++);\n    $('#hs-capture-tags-list').append(newRow);\n  });\n\n  // åˆ é™¤æ•è·æ ‡ç­¾\n  $overlay.on('click', '.hs-remove-capture-tag', function () {\n    $(this).closest('.hs-capture-tag-row').remove();\n  });\n\n  // ç‚¹å‡»é®ç½©å…³é—­\n  $overlay.on('click', e => {\n    if (e.target === $overlay[0]) {\n      closeOverlay();\n    }\n  });\n}\n","/**\n * è„šæœ¬å…¥å£\n * - åˆå§‹åŒ–æµç¨‹\n * - äº‹ä»¶ç›‘å¬æ³¨å†Œ\n * - èŠå¤©å˜æ›´é‡è½½\n */\n\nimport { getScriptData } from '@/config';\nimport { taskQueue } from '@/queue';\nimport { handleMiniSummary, performVolumeSummary } from '@/summary';\nimport { worldbookExists, syncMiniSummaryEnabled, ensureDataEntry } from '@/worldbook';\nimport { registerListeners } from '@/trigger';\nimport { addMenuItem } from '@/ui';\n\n/** èŠå¤©å˜æ›´æ—¶é‡è½½è„šæœ¬ */\nfunction reloadOnChatChange(): EventOnReturn {\n  let chat_id = SillyTavern.getCurrentChatId();\n  return eventOn(tavern_events.CHAT_CHANGED, (new_chat_id: string) => {\n    if (chat_id !== new_chat_id) {\n      chat_id = new_chat_id;\n      window.location.reload();\n    }\n  });\n}\n\n// æ³¨å†Œä»»åŠ¡å¤„ç†å‡½æ•°åˆ°é˜Ÿåˆ—\ntaskQueue.setHandlers({\n  mini_summary: handleMiniSummary,\n  volume_summary: performVolumeSummary,\n});\n$(() => {\n  void (async () => {\n    try {\n      // 1. åŠ è½½è„šæœ¬å˜é‡ï¼ˆè®¾ç½® + å…ƒæ•°æ®ï¼‰\n      const _data = getScriptData();\n      console.log('[è‡ªåŠ¨æ€»ç»“] è„šæœ¬å˜é‡å·²åŠ è½½');\n\n      // 2. æ³¨å†Œæ‰©å±•èœå•å…¥å£\n      addMenuItem();\n\n      // 3. æ³¨å†Œäº‹ä»¶ç›‘å¬\n      registerListeners();\n\n      // 4. èŠå¤©å˜æ›´æ—¶é‡è½½\n      reloadOnChatChange();\n\n      // 5. è·å–å½“å‰è§’è‰²å¡åç§° - æ— è§’è‰²å¡åˆ™é€€å‡º\n      const charName = getCurrentCharacterName();\n      const chatId = SillyTavern.getCurrentChatId();\n      if (!charName || !chatId) {\n        console.log('[è‡ªåŠ¨æ€»ç»“] æœªæ‰“å¼€è§’è‰²å¡æˆ–èŠå¤©ï¼Œéƒ¨åˆ†åˆå§‹åŒ–å»¶è¿Ÿè‡³æ‰“å¼€å');\n        return;\n      }\n      console.log(`[è‡ªåŠ¨æ€»ç»“] å½“å‰è§’è‰²å¡: ${charName}`);\n\n      // 6. ç¡®ä¿ [data] æ¡ç›®å­˜åœ¨å¹¶åŒæ­¥å°æ€»ç»“ enabled çŠ¶æ€ï¼ˆä»…åœ¨ä¸–ç•Œä¹¦å­˜åœ¨æ—¶ï¼‰\n      if (worldbookExists()) {\n        await ensureDataEntry();\n        await syncMiniSummaryEnabled();\n      } else {\n        console.log('[è‡ªåŠ¨æ€»ç»“] å½“å‰èŠå¤©æœªç»‘å®šä¸–ç•Œä¹¦æˆ–ä¸–ç•Œä¹¦ä¸å­˜åœ¨ï¼Œè·³è¿‡åŒæ­¥');\n      }\n\n      console.log('[è‡ªåŠ¨æ€»ç»“] åˆå§‹åŒ–å®Œæˆ');\n    } catch (e) {\n      console.error('[è‡ªåŠ¨æ€»ç»“] åˆå§‹åŒ–å¤±è´¥:', e);\n    }\n  })();\n});\n"],"names":["getMiniSummaryOrder","message_id","base","getVolumeOrder","volume","ENTRY_DEFAULTS","enabled","strategy","type","keys","keys_secondary","logic","scan_depth","probability","recursion","prevent_incoming","prevent_outgoing","delay_until","effect","sticky","cooldown","delay","MetaData","z","object","current_volume","coerce","number","prefault","last_processed_message_id","volumes","array","start_message_id","end_message_id","ScriptData","visible_floors","transform","v","_","clamp","check_interval","volume_token_threshold","auto_mini_summary","boolean","auto_volume_summary","mini_summary_depth","volume_summary_depth","task_cooldown","Math","max","mini_summary_start_order","volume_start_order","ignore_floors","max_tokens","round","custom_api","apiurl","string","key","model","source","message_cleanup_regex","pattern","flags","replacement","capture_tags","start_tag","end_tag","deferred_summary","no_trans_tag","no_trans_tag_value","custom_prompts","mini_summary_system","volume_summary_system","volume_completion_check_system","DEFAULT_SETTINGS","parse","getScriptData","raw","getVariables","saveScriptData","data","replaceVariables","getSettings","taskQueue","queue","processing","handlers","setHandlers","this","enqueue","task","filter","t","push","processNext","length","shift","console","error","mini_summary","volume_summary","settings","Promise","resolve","setTimeout","e","DEFAULT_MINI_SUMMARY_SYSTEM","DEFAULT_VOLUME_SUMMARY_SYSTEM","DEFAULT_VOLUME_COMPLETION_CHECK_SYSTEM","getWorldbookName","getChatWorldbookName","worldbookExists","name","getWorldbookNames","includes","DATA_ENTRY_NAME","async","getMetaData","worldbookName","entry","getWorldbook","find","JSON","content","saveMetaData","warn","stringify","updateWorldbookWith","wb","createPlaceholderMiniSummary","entryName","createWorldbookEntries","position","role","depth","order","getUnarchivedMiniSummaries","worldbook","metadata","archivedIds","Set","vol","id","add","match","parseInt","has","syncMiniSummaryEnabled","visibleThreshold","getLastMessageId","callAI","systemPrompt","userPrompt","useNoTrans","NO_TRANS","wrapContent","text","trim","generateConfig","should_silence","ordered_prompts","customApi","api","buildCustomApi","generateRaw","generateMiniSummaryContent","Error","context","map","sort","a","b","slice","join","messages","getChatMessages","rawMessage","message","processedMessage","some","captureTags","validTags","allMatches","startTag","endTag","startPattern","escapeRegExp","endPattern","regex","RegExp","groupMatched","exec","tagDesc","extractTaggedContent","formatAsTavernRegexedString","cleaned","re","replace","cleanMessage","prompt","system","user","getMiniSummaryPrompt","shouldTriggerVolumeSummary","unarchivedEntries","mini_summaries","forEach","summary","getVolumeCompletionCheckPrompt","result","generateVolumeSummaryContent","test","getVolumes","previous_volumes","i","getVolumeSummaryPrompt","miniSummaryCount","pendingMessageId","shouldCheckVolumeSummary","onMessageReceived","msg","lastId","allMessages","updates","is_hidden","setChatMessages","refresh","updateFloorVisibility","MENU_ID","addMenuItem","$extensionsMenu","$","remove","$item","on","stopPropagation","$menuBtn","is","trigger","r","openSettingsPopup","append","buildSettingsHtml","currentWbName","wbNames","safeGetWorldbookNames","escapeHtml","buildCaptureTagRowHtml","s","buildRegexRowHtml","tag","index","collectCaptureTagsFromPopup","tagRows","tagList","each","$row","val","str","html","$popup","css","flex","$overlay","$dialog","$buttons","win","window","top","fitOverlay","vp","visualViewport","width","innerWidth","height","innerHeight","offsetTop","offsetLeft","w","h","style","cssText","panel","vpObj","addEventListener","closeOverlay","removeEventListener","toastr","success","newSettings","regexRows","regexList","miniPrompt","volumePrompt","completionPrompt","collectSettingsFromPopup","selected","rebindChatWorldbook","log","bindWorldbookForChat","info","charName","getCurrentCharacterName","createWorldbook","createWorldbookForChat","$select","warning","startId","wbName","existingFloors","count","msgs","apiUrl","apiKey","$btn","prop","baseUrl","urls","endsWith","models","url","headers","resp","fetch","method","ok","json","Array","isArray","m","$datalist","empty","regexIndex","newRow","closest","captureTagIndex","target","upsertMiniSummaryEntry","meta","ids","start_id","end_id","parsedStart","parsedEnd","finalContent","createVolumeEntry","eventOn","tavern_events","MESSAGE_RECEIVED","errorCatched","chat_id","SillyTavern","getCurrentChatId","CHAT_CHANGED","new_chat_id","location","reload","reloadOnChatChange","chatId","defaultData","ensureDataEntry"],"mappings":"AAYO,SAASA,EAAoBC,EAAoBC,GACtD,OAAOA,EAAOD,CAChB,CAGO,SAASE,EAAeC,EAAgBF,GAC7C,OAAOA,EAAOE,CAChB,CAKO,MAAMC,EAA8C,CACzDC,SAAS,EACTC,SAAU,CACRC,KAAM,WACNC,KAAM,GACNC,eAAgB,CAAEC,MAAO,UAAWF,KAAM,IAC1CG,WAAY,kBAEdC,YAAa,IACbC,UAAW,CAAEC,kBAAkB,EAAMC,kBAAkB,EAAMC,YAAa,MAC1EC,OAAQ,CAAEC,OAAQ,KAAMC,SAAU,KAAMC,MAAO,OAMpCC,EAAWC,EACrBC,OAAO,CAENC,eAAgBF,EAAEG,OAAOC,SAASC,SAAS,GAE3CC,0BAA2BN,EAAEG,OAAOC,SAASC,UAAS,GAEtDE,QAASP,EACNQ,MACCR,EAAEC,OAAO,CACPpB,OAAQmB,EAAEG,OAAOC,SACjBK,iBAAkBT,EAAEG,OAAOC,SAC3BM,eAAgBV,EAAEG,OAAOC,YAG5BC,SAAS,MAEbA,SAAS,IAKCM,EAAaX,EACvBC,OAAO,CAENW,eAAgBZ,EAAEG,OACfC,SACAS,UAAUC,GAAKC,EAAEC,MAAMF,EAAG,EAAG,MAC7BT,SAAS,IAEZY,eAAgBjB,EAAEG,OACfC,SACAS,UAAUC,GAAKC,EAAEC,MAAMF,EAAG,EAAG,MAC7BT,SAAS,IAEZa,uBAAwBlB,EAAEG,OACvBC,SACAS,UAAUC,GAAKC,EAAEC,MAAMF,EAAG,IAAM,MAChCT,SAAS,KAEZc,kBAAmBnB,EAAEoB,UAAUf,UAAS,GAExCgB,oBAAqBrB,EAAEoB,UAAUf,UAAS,GAE1CiB,mBAAoBtB,EAAEG,OACnBC,SACAS,UAAUC,GAAKC,EAAEC,MAAMF,EAAG,EAAG,QAC7BT,SAAS,MAEZkB,qBAAsBvB,EAAEG,OACrBC,SACAS,UAAUC,GAAKC,EAAEC,MAAMF,EAAG,EAAG,QAC7BT,SAAS,MAEZmB,cAAexB,EAAEG,OACdC,SACAS,UAAUC,GAAKW,KAAKC,IAAI,EAAGZ,IAC3BT,SAAS,GAEZsB,yBAA0B3B,EAAEG,OACzBC,SACAS,UAAUC,GAAKC,EAAEC,MAAMF,EAAG,EAAG,QAC7BT,SAAS,KAEZuB,mBAAoB5B,EAAEG,OACnBC,SACAS,UAAUC,GAAKC,EAAEC,MAAMF,EAAG,EAAG,QAC7BT,SAAS,KAEZwB,cAAe7B,EAAEG,OACdC,SACAS,UAAUC,GAAKC,EAAEC,MAAMF,EAAG,EAAG,MAC7BT,SAAS,GAEZyB,WAAY9B,EAAEG,OACXC,SACAS,UAAUC,GAAKW,KAAKC,IAAI,EAAGD,KAAKM,MAAMjB,KACtCT,SAAS,GAEZ2B,WAAYhC,EACTC,OAAO,CACNgC,OAAQjC,EAAEkC,SAAS7B,SAAS,IAC5B8B,IAAKnC,EAAEkC,SAAS7B,SAAS,IACzB+B,MAAOpC,EAAEkC,SAAS7B,SAAS,IAC3BgC,OAAQrC,EAAEkC,SAAS7B,SAAS,YAE7BA,SAAS,IAEZiC,sBAAuBtC,EACpBQ,MACCR,EAAEC,OAAO,CACPsC,QAASvC,EAAEkC,SACXM,MAAOxC,EAAEkC,SAAS7B,SAAS,KAC3BoC,YAAazC,EAAEkC,SAAS7B,SAAS,OAGpCA,SAAS,IAEZqC,aAAc1C,EACXQ,MACCR,EAAEC,OAAO,CACP0C,UAAW3C,EAAEkC,SAAS7B,SAAS,IAC/BuC,QAAS5C,EAAEkC,SAAS7B,SAAS,OAGhCA,SAAS,IAEZwC,iBAAkB7C,EAAEoB,UAAUf,UAAS,GAEvCyC,aAAc9C,EAAEoB,UAAUf,UAAS,GAEnC0C,mBAAoB/C,EAAEkC,SAAS7B,SAAS,gBAExC2C,eAAgBhD,EACbC,OAAO,CACNgD,oBAAqBjD,EAAEkC,SAAS7B,SAAS,IACzC6C,sBAAuBlD,EAAEkC,SAAS7B,SAAS,IAC3C8C,+BAAgCnD,EAAEkC,SAAS7B,SAAS,MAErDA,SAAS,CAAA,KAEbA,SAAS,IAKC+C,EAA4CzC,EAAW0C,MAAM,IAKnE,SAASC,IACd,MAAMC,EAAMC,aAAa,CAAEvE,KAAM,WACjC,OAAO0B,EAAW0C,MAAME,EAC1B,CAGO,SAASE,EAAeC,GAC7BC,iBAAiBD,EAA6B,CAAEzE,KAAM,UACxD,CAGO,SAAS2E,IACd,OAAON,GACT,CC3GO,MAAMO,EAAY,IAzDlB,MACGC,MAAuB,GACvBC,YAAa,EACbC,SAA+B,KAGvC,WAAAC,CAAYD,GACVE,KAAKF,SAAWA,CAClB,CAGA,OAAAG,CAAQC,GAEY,iBAAdA,EAAKnF,WAA+C,IAApBmF,EAAK1F,aACvCwF,KAAKJ,MAAQI,KAAKJ,MAAMO,YACJ,iBAAXC,EAAErF,MAA2BqF,EAAE5F,aAAe0F,EAAK1F,cAG9DwF,KAAKJ,MAAMS,KAAKH,GACXF,KAAKM,aACZ,CAGA,iBAAcA,GACZ,IAAIN,KAAKH,YAAoC,IAAtBG,KAAKJ,MAAMW,OAAlC,CACAP,KAAKH,YAAa,EAElB,IACE,MAAMK,EAAOF,KAAKJ,MAAMY,QACxB,IAAKR,KAAKF,SAER,YADAW,QAAQC,MAAM,oBAIE,iBAAdR,EAAKnF,WAA+C,IAApBmF,EAAK1F,iBACjCwF,KAAKF,SAASa,aAAaT,EAAK1F,YACf,mBAAd0F,EAAKnF,YACRiF,KAAKF,SAASc,iBAItB,MAAMC,EAAWnB,IACbmB,EAASvD,cAAgB,SACrB,IAAIwD,QAAQC,GAAWC,WAAWD,EAAkC,IAAzBF,EAASvD,eAE9D,OAAS2D,GACPR,QAAQC,MAAM,mBAAoBO,EACpC,CAAA,QACEjB,KAAKH,YAAa,EACdG,KAAKJ,MAAMW,OAAS,SAChBP,KAAKM,aAEf,CA5BgD,CA6BlD,GC/DWY,EAA8B,uKAU9BC,EAAgC,wTAchCC,EAAyC,mLCd/C,SAASC,IACd,IACE,OAAOC,qBAAqB,UAC9B,CAAA,MACE,OAAO,IACT,CACF,CAGO,SAASC,IACd,MAAMC,EAAOH,IACb,QAAKG,GACEC,oBAAoBC,SAASF,EACtC,CAgCA,MAAMG,EAAkB,SAyBxBC,eAAsBC,IACpB,MAAMC,EAAgBT,IACtB,IAAKS,IAAkBP,IACrB,OAAO1F,EAASsD,MAAM,IAGxB,MACM4C,SADkBC,aAAaF,IACbG,KAAKhB,GAAKA,EAAEO,OAASG,GAE7C,IAAKI,EACH,OAAOlG,EAASsD,MAAM,IAGxB,IACE,MAAME,EAAM6C,KAAK/C,MAAM4C,EAAMI,SAC7B,OAAOtG,EAASsD,MAAME,EACxB,OAAS4B,GAEP,OADAR,QAAQC,MAAM,+BAAgCO,GACvCpF,EAASsD,MAAM,GACxB,CACF,CAGAyC,eAAsBQ,EAAa5C,GACjC,MAAMsC,EAAgBT,IACtB,IAAKS,IAAkBP,IAErB,YADAd,QAAQ4B,KAAK,yBAIf,MAAMF,EAAUD,KAAKI,UAAU9C,SAEzB+C,oBAAoBT,EAAeU,IACvC,MAAMT,EAAQS,EAAGP,KAAKhB,GAAKA,EAAEO,OAASG,GAItC,OAHII,IACFA,EAAMI,QAAUA,GAEXK,GAEX,CAuDAZ,eAAsBa,EAA6BjI,GACjD,MAAMsH,EAAgBT,IACtB,IAAKS,IAAkBP,IAErB,YADAd,QAAQ4B,KAAK,2BAIf,MAAMK,EAAY,UAAUlI,KAI5B,WAHwBwH,aAAaF,IACVG,KAAKhB,GAAKA,EAAEO,OAASkB,GAEjC,CACb,MAAM7B,EAAWnB,UACXiD,uBAAuBb,EAAe,CAC1C,IACKlH,EACH4G,KAAMkB,EACNP,QAAS,aACTS,SAAU,CACR7H,KAAM,WACN8H,KAAM,SACNC,MAAOjC,EAASzD,mBAChB2F,MAAOxI,EAAoBC,EAAYqG,EAASpD,6BAIxD,CACF,CAGAmE,eAAsBoB,IACpB,MAAMxB,EAAOH,IACb,IAAKG,IAASD,UAA0B,GAExC,MAAM0B,QAAkBjB,aAAaR,GAC/B0B,QAAiBrB,IAGjBsB,qBAAkBC,IACxB,IAAA,MAAWC,KAAOH,EAAS7G,QACzB,IAAA,IAASiH,EAAKD,EAAI9G,iBAAkB+G,GAAMD,EAAI7G,eAAgB8G,IAC5DH,EAAYI,IAAID,GAIpB,OAAOL,EAAU9C,OAAO4B,IACtB,MAAMyB,EAAQzB,EAAMP,KAAKgC,MAAM,qBAC/B,IAAKA,EAAO,OAAO,EACnB,MAAMF,EAAKG,SAASD,EAAM,IAC1B,OAAQL,EAAYO,IAAIJ,IAE5B,CAKA1B,eAAsB+B,IACpB,MAAMnC,EAAOH,IACb,IAAKG,IAASD,IAAmB,OAEjC,MAAMV,EAAWnB,IAEXkE,EADSC,mBACmBhD,EAASnE,eAAiB,EACtDwG,QAAiBrB,IAGjBsB,qBAAkBC,IACxB,IAAA,MAAWC,KAAOH,EAAS7G,QACzB,IAAA,IAASiH,EAAKD,EAAI9G,iBAAkB+G,GAAMD,EAAI7G,eAAgB8G,IAC5DH,EAAYI,IAAID,SAIdf,oBAAoBf,EAAMyB,IAC9B,IAAA,MAAWlB,KAASkB,EAAW,CAC7B,MAAMO,EAAQzB,EAAMP,KAAKgC,MAAM,qBAC/B,IAAKA,EAAO,SACZ,MAAMF,EAAKG,SAASD,EAAM,IAEtBF,GAAMM,GAGCT,EAAYO,IAAIJ,GADzBvB,EAAMlH,SAAU,EAMhBkH,EAAMlH,SAAU,CAEpB,CACA,OAAOoI,GAEX,CCzKArB,eAAekC,EACbC,EACAC,EACAnD,GAEA,MAAMoD,GAAuC,IAA1BpD,EAASjC,aACtBsF,EAAWrD,EAAShC,oBAAsB,eAC1CsF,EAAeC,GACdA,GAASA,EAAKC,QACZJ,EAAa,GAAGC,IAAWE,IADAA,EAI9BE,EAAsC,CAC1CC,gBAAgB,EAChBC,gBAAiB,CACf,CAAE3B,KAAM,SAAUV,QAASgC,EAAYJ,IACvC,CAAElB,KAAM,OAAQV,QAASgC,EAAYH,MAGnCS,EAnCR,SAAwB5D,GACtB,IAAKA,EAAS/C,WAAWC,OAAQ,OACjC,MAAM2G,EAA2B,CAC/B3G,OAAQ8C,EAAS/C,WAAWC,OAC5BE,IAAK4C,EAAS/C,WAAWG,IACzBC,MAAO2C,EAAS/C,WAAWI,MAC3BC,OAAQ0C,EAAS/C,WAAWK,QAM9B,OAHI0C,EAASjD,WAAa,IACxB8G,EAAI9G,WAAaiD,EAASjD,YAErB8G,CACT,CAsBoBC,CAAe9D,GAC7B4D,EACFH,EAAexG,WAAa2G,EACnB5D,EAASjD,WAAa,IAE/B0G,EAAexG,WAAa,CAAEF,WAAYiD,EAASjD,aAGrD,aADqBgH,YAAYN,EAEnC,CAKA1C,eAAsBiD,EAA2BrK,GAC/C,MAAMqG,EAAWnB,IACXoC,EAAgBT,IACtB,IAAKS,EACH,MAAM,IAAIgD,MAAM,yBAElB,MAaMC,SAbkB/C,aAAaF,IAIlC3B,OAAOc,GAAKA,EAAEO,KAAKgC,MAAM,sBACzBwB,IAAI/D,IAAA,CACHqC,GAAIG,SAASxC,EAAEO,KAAKgC,MAAM,WAAY,IACtCrB,QAASlB,EAAEkB,WAEZhC,UAAYc,EAAEqC,GAAK9I,GACnByK,KAAK,CAACC,EAAGC,IAAMD,EAAE5B,GAAK6B,EAAE7B,IACxB8B,OAAM,GAEsBJ,IAAI/D,GAAKA,EAAEkB,SAASkD,KAAK,MAGlDC,EAAWC,gBAAgB/K,GACjC,GAAwB,IAApB8K,EAAS/E,OACX,MAAM,IAAIuE,MAAM,aAAatK,SAE/B,MAAMgL,EAAaF,EAAS,GAAGG,QAG/B,IAAKD,GAAoC,KAAtBA,EAAWnB,OAC5B,MAAO,QAMT,IAAIqB,EACJ,GAHuB7E,EAASrC,aAAamH,QAAUvF,EAAE3B,WAAa2B,EAAE1B,SAKtEgH,EAvJG,SACLD,EACAG,GAGA,MAAMC,EAAYD,EAAYzF,UAAYC,EAAE3B,WAAa2B,EAAE1B,SAC3D,GAAyB,IAArBmH,EAAUtF,OAAc,OAAOkF,EAEnC,MAAMK,EAAuB,GAE7B,IAAA,MAAarH,UAAWsH,EAAUrH,QAASsH,KAAYH,EAAW,CAEhE,MAAMI,EAAeF,EAAW,IAAIlJ,EAAEqJ,aAAaH,MAAe,IAC5DI,EAAaH,EAAS,IAAInJ,EAAEqJ,aAAaF,MAAa,IACtDI,EAAQ,IAAIC,OAAO,GAAGJ,gBAA2BE,IAAc,KAErE,IACI3C,EADA8C,GAAe,EAEnB,KAAyC,QAAjC9C,EAAQ4C,EAAMG,KAAKd,KAAoB,CAC7C,MAAMtD,EAAUqB,EAAM,GAAGa,OACrBlC,IACF2D,EAAWzF,KAAK8B,GAChBmE,GAAe,EAEnB,CAEA,IAAKA,EAAc,CACjB,MAAME,EACJT,GAAYC,EACR,IAAID,SAAgBC,QACpBD,EACE,IAAIA,QACJ,IAAIC,QACZvF,QAAQ4B,KAAK,kBAAkBmE,QACjC,CACF,CAEA,OAA0B,IAAtBV,EAAWvF,QACbE,QAAQ4B,KAAK,gCACNoD,GAGFK,EAAWT,KAAK,OACzB,CA4GuBoB,CAAqBjB,EAAY3E,EAASrC,kBACxD,CAEL,MAAML,EAA8B,SAArBmH,EAAS,GAAGzC,KAAkB,aAAe,YAC5D6C,EAAmBgB,4BAA4BlB,EAAYrH,EAAQ,SACrE,CAEA,MAEMwI,EAlHD,SAAsBlB,EAAiB5E,GAC5C,IAAI8F,EAAUlB,EACd,IAAA,MAAWW,KAASvF,EAASzC,sBAC3B,IACE,MAAMwI,EAAK,IAAIP,OAAOD,EAAM/H,QAAS+H,EAAM9H,OAC3CqI,EAAUA,EAAQE,QAAQD,EAAIR,EAAM7H,YACtC,OAAS0C,GACPR,QAAQC,MAAM,2BAA2B0F,EAAM/H,YAAa4C,EAE9D,CAEF,OAAO0F,CACT,CAsGkBG,CAFEpB,EAEsB7E,GAClCkG,EF5HD,SACLtB,EACAV,GAEA,IAAIf,EAAa,GAMjB,OALIe,IACFf,GAAc,sBAAsBe,gBAEtCf,GAAc,eAAeyB,IAEtB,CACLuB,OAhCetH,IACDZ,eAAeC,qBAAuBmC,EAgCpD+F,KAAMjD,EAEV,CE8GiBkD,CAAqBP,EAAS5B,GAE7C,aAAajB,EAAOiD,EAAOC,OAAQD,EAAOE,KAAMpG,EAClD,CAyBAe,eAAsBuF,IACpB,MAAMtG,EAAWnB,IACX0H,QAA0BpE,IAEhC,GAAiC,IAA7BoE,EAAkB7G,OAAc,OAAO,EAM3C,GAHqB6G,EAAkBpC,IAAI/D,GAAKA,EAAEkB,SAASkD,KAAK,IAC3B9E,OAEfM,EAAS7D,uBAC7B,OAAO,EAIT,IACE,MAKM+J,EFpIH,SAAwCM,GAI7C,IAAIrD,EAAa,uBAMjB,OALAqD,EAAeC,QAAQC,IACrBvD,GAAc,GAAGuD,UAEnBvD,GAAc,0BAEP,CACLgD,OA7DetH,IAENZ,eAAeG,gCAAkCmC,EA4D1D6F,KAAMjD,EAEV,CEsHmBwD,CALOJ,EAAkBpC,IAAI/D,IAC1C,MAAMuC,EAAQvC,EAAEO,KAAKgC,MAAM,WAE3B,MAAO,KADIA,EAAQA,EAAM,GAAK,QACXvC,EAAEkB,aAGjBsF,QAAe3D,EAAOiD,EAAOC,OAAQD,EAAOE,KAAMpG,GAExD,QAAI4G,EAAO/F,SAAS,YAChB+F,EAAO/F,SAAS,YAEpBjB,QAAQ4B,KAAK,uBAAwBoF,IAFE,EAIzC,OAASxG,GAEP,OADAR,QAAQC,MAAM,kBAAmBO,IAC1B,CACT,CACF,CAGAW,eAAsB8F,EACpBL,GAEA,MAAMxG,EAAWnB,IACXrD,QD2ERuF,iBACE,MAAMJ,EAAOH,IACb,OAAKG,GAASD,WAEUS,aAAaR,IACpBrB,OAAO4B,GAAS,yBAAyB4F,KAAK5F,EAAMP,OAH7B,EAI1C,CCjFwBoG,GAehBb,EF9LD,SACLM,EACAQ,GAEA,IAAI7D,EAAa,GAajB,OAZI6D,EAAiBtH,OAAS,IAC5ByD,GAAc,0BACd6D,EAAiBP,QAAQ,CAACjE,EAAKyE,KAC7B9D,GAAc,QAAQ8D,EAAI,WAAWzE,UAEvCW,GAAc,WAEhBA,GAAc,6BACdqD,EAAeC,QAAQC,IACrBvD,GAAc,GAAGuD,UAGZ,CACLP,OAlDetH,IACDZ,eAAeE,uBAAyBmC,EAkDtD8F,KAAMjD,EAEV,CEyKiB+D,CAbMV,EAAerC,IAAI/D,IACtC,MAAMuC,EAAQvC,EAAEO,KAAKgC,MAAM,WAE3B,MAAO,KADIA,EAAQA,EAAM,GAAK,QACXvC,EAAEkB,YAEQ9F,EAC5B4I,KAAK,CAACC,EAAGC,IACK1B,SAASyB,EAAE1D,KAAKgC,MAAM,UAAW,IACjCC,SAAS0B,EAAE3D,KAAKgC,MAAM,UAAW,KAG/CwB,IAAI/D,GAAKA,EAAEkB,UAGd,aAAa2B,EAAOiD,EAAOC,OAAQD,EAAOE,KAAMpG,EAClD,CCrQA,IAAImH,EAAmB,EAGnBC,EAAkC,KAGtC,SAASC,IACP,MAAMrH,EAAWnB,IACjB,QAAKmB,EAAS1D,sBACP6K,EAAmBnH,EAAS9D,iBAAmB,GAAKiL,EAAmB,EAChF,CAGApG,eAAeuG,EAAkB3N,GAC/B,MAAMqG,EAAWnB,IAGjB,IAAKmB,EAAS5D,kBAAmB,OAGjC,MAAMqI,EAAWC,gBAAgB/K,GACjC,GAAwB,IAApB8K,EAAS/E,OAAc,OAC3B,MAAM6H,EAAM9C,EAAS,GACrB,GAAiB,WAAb8C,EAAIvF,MACHuF,EAAI3C,SAAkC,KAAvB2C,EAAI3C,QAAQpB,UAG5B7J,EAAaqG,EAASlD,gBAGrB4D,IAEL,IAEMV,EAASlC,kBAEc,OAArBsJ,UACIxF,EAA6BwF,GACnCD,IACIE,KACFvI,EAAUM,QAAQ,CAAElF,KAAM,mBAE5B4E,EAAUM,QAAQ,CAAElF,KAAM,eAAgBP,WAAYyN,KAGxDA,EAAmBzN,UAKbiI,EAA6BjI,GAGnCwN,IAGIE,KACFvI,EAAUM,QAAQ,CAAElF,KAAM,mBAI5B4E,EAAUM,QAAQ,CAAElF,KAAM,eAAgBP,sBAMtCmJ,UCtEV/B,iBACE,MAAMf,EAAWnB,IACX2I,EAASxE,mBAEf,GAAIwE,EAAS,EAAG,OAGhB,MAAMC,EAAc/C,gBAAgB,KAAK8C,KACzC,GAA2B,IAAvBC,EAAY/H,OAAc,OAE9B,MAAMqD,EAAmByE,EAASxH,EAASnE,eAAiB,EAGtD6L,EAA6D,GAEnE,IAAA,MAAWH,KAAOE,EACC,WAAbF,EAAIvF,OAEJuF,EAAI5N,YAAcoJ,EAEhBwE,EAAII,WACND,EAAQlI,KAAK,CAAE7F,WAAY4N,EAAI5N,WAAYgO,WAAW,IAInDJ,EAAII,WACPD,EAAQlI,KAAK,CAAE7F,WAAY4N,EAAI5N,WAAYgO,WAAW,KAMxDD,EAAQhI,OAAS,SACbkI,gBAAgBF,EAAS,CAAEG,QAAS,eAItC/E,GACR,CDmCUgF,EACR,OAAS1H,GACPR,QAAQC,MAAM,iBAAkBO,EAClC,CACF,CEjEA,MAAM2H,EAAU,yBAGT,SAASC,IACd,MAAMC,EAAkBC,EAAE,mBAC1B,IAAKD,EAAgBvI,OAEnB,YADAS,WAAW6H,EAAa,KAK1BE,EAAE,IAAIH,IAAWE,GAAiBE,SAElC,MAAMC,EAAQF,EAAE,+EAC0DH,oJAM1EK,EAAMC,GAAG,QAAStH,MAAMX,IACtBA,EAAEkI,kBACF,MAAMC,EAAWL,EAAE,yBACfK,EAAS7I,QAAUuI,EAAgBO,GAAG,cACxCD,EAASE,QAAQ,eACX,IAAIxI,QAAQyI,GAAKvI,WAAWuI,EAAG,aAEjCC,MAGRV,EAAgBW,OAAOR,EACzB,CAcA,SAASS,EAAkBlK,GACzB,MAAMmK,EAAgBtI,IAChBuI,EAXR,WACE,IACE,OAAOnI,mBACT,CAAA,MACE,MAAO,EACT,CACF,CAKkBoI,GAEhB,MAAO,2yCA+BsBF,EAA8B,GAAd,2CACjCC,EACC5E,IACCxD,GACE,kBAAkBsI,EAAWtI,OAAUmI,IAAkBnI,EAAO,WAAa,MAAMsI,EAAWtI,eAEjG6D,KAAK,6YAW2C7F,EAAK9C,iRAKL8C,EAAKzC,kSAKGyC,EAAKxC,gRAKbwC,EAAKvC,kBAAoB,UAAY,8LAMnCuC,EAAKrC,oBAAsB,UAAY,2LAM1CqC,EAAKb,iBAAmB,UAAY,yRAO/Ba,EAAKpC,+RAKHoC,EAAKnC,6RAKTmC,EAAK/B,iTAKH+B,EAAK9B,oSAKV8B,EAAK7B,oRAKL6B,EAAKlC,0RAKRkC,EAAK5B,+bAQhD4B,EAAKhB,aAAawG,IAAI,CAAC5E,EAAG0H,IAAMiC,EAAuB3J,EAAG0H,IAAIzC,KAAK,iUAOzB7F,EAAKZ,aAAe,UAAY,gHAGzBkL,EAAWtK,EAAKX,8gCAoBpBiL,EAAWtK,EAAK1B,WAAWC,2OAIvB+L,EAAWtK,EAAK1B,WAAWG,sRAK3B6L,EAAWtK,EAAK1B,WAAWI,0cAQ9E,CAAC,UACA8G,IACCgF,GACE,kBAAkBA,MAAMxK,EAAK1B,WAAWK,SAAW6L,EAAI,WAAa,MAAMA,cAE7E3E,KAAK,ubAW8FyE,EAAWtK,EAAKV,eAAeC,qBAAuBmC,mTAKpD4I,EAAWtK,EAAKV,eAAeE,uBAAyBmC,yTAKpD2I,EAAWtK,EAAKV,eAAeG,gCAAkCmC,ibAa3K5B,EAAKpB,sBAAsB4G,IAAI,CAACuE,EAAGzB,IAAMmC,EAAkBV,EAAGzB,IAAIzC,KAAK,wMAOrF,CAGA,SAAS0E,EACPG,EACAC,GAEA,MAAO,qDACyCA,wKAEaL,EAAWI,EAAIzL,kJAEjBqL,EAAWI,EAAIxL,yMAK5E,CAGA,SAAS0L,IACP,MAAMC,EAAUtB,EAAE,uBACZuB,EAAoD,GAU1D,OATAD,EAAQE,KAAK,WACX,MAAMC,EAAOzB,EAAE/I,MACT+F,GAAayE,EAAKvI,KAAK,yBAAyBwI,OAAoB,IAAIpG,OACxE2B,GAAWwE,EAAKvI,KAAK,uBAAuBwI,OAAoB,IAAIpG,QAEtE0B,GAAYC,IACdsE,EAAQjK,KAAK,CAAE5B,UAAWsH,EAAUrH,QAASsH,GAEjD,GACOsE,CACT,CAGA,SAASL,EACP7D,EACA+D,GAEA,MAAO,+CACmCA,2IACeL,EAAW1D,EAAM/H,0GACnByL,EAAW1D,EAAM9H,kIACXwL,EAAW1D,EAAM7H,4KAIhF,CAGA,SAASuL,EAAWY,GAClB,OAAOA,EACJ7D,QAAQ,KAAM,SACdA,QAAQ,KAAM,QACdA,QAAQ,KAAM,QACdA,QAAQ,KAAM,UACdA,QAAQ,KAAM,SACnB,CAyDAjF,eAAe4H,IACb,MAAMhK,EAAOJ,IACPuL,EAAOjB,EAAkBlK,GAEzBoL,EAAS7B,EAAE4B,GAEjBC,EAAOC,IAAI,CACTC,KAAM,IACN,aAAc,OACd,aAAc,IACd,gBAAiB,QAInB,MAAMC,EAAWhC,EAAE,yCAEbiC,EAAUjC,EAAE,wCAEZkC,EACJlC,EAAE,qhBAMJiC,EAAQvB,OAAOmB,GAAQnB,OAAOwB,GAC9BF,EAAStB,OAAOuB,GAChBjC,EAAE,QAAQU,OAAOsB,GAEjB,MAAMG,EAAMC,OAAOC,KAAOD,OACpBE,EAAa,KACjB,MAAMC,EAAKJ,EAAIK,gBAAkB,CAC/BC,MAAON,EAAIO,WACXC,OAAQR,EAAIS,YACZC,UAAW,EACXC,WAAY,GAERC,EAAIR,EAAGE,OAASN,EAAIO,WACpBM,EAAIT,EAAGI,QAAUR,EAAIS,YAC3BZ,EAAS,GAAGiB,MAAMC,QAAU,4CACSX,EAAGM,WAAa,yBAAyBN,EAAGO,YAAc,iCACpFC,2BAA2BC,wVAMtC,MAAMG,EAAQlB,EAAQ,GAClBkB,GAASJ,GAAK,IAChBI,EAAMF,MAAMC,QAAU,+LAIXH,2BAA2BC,iSAM7BG,IACTA,EAAMF,MAAMC,QAAU,0gBAY1BZ,IACA,MAAMc,EAAQjB,EAAIK,eACdY,IACFA,EAAMC,iBAAiB,SAAUf,GACjCc,EAAMC,iBAAiB,SAAUf,IAEnCH,EAAIkB,iBAAiB,SAAUf,GAE/B,MAQMgB,EAAe,KAPfF,IACFA,EAAMG,oBAAoB,SAAUjB,GACpCc,EAAMG,oBAAoB,SAAUjB,IAEtCH,EAAIoB,oBAAoB,SAAUjB,GAKlCN,EAAS/B,UAIX+B,EAAS7B,GAAG,QAAS,aAAc,KACjCmD,MAIFtB,EAAS7B,GAAG,QAAS,YAAa,KACZ9J,IAGpBG,EADkB,IAAKL,IAEvBqN,OAAOC,QAAQ,YACfH,IAEK7C,MAGPuB,EAAS7B,GAAG,QAAS,WAAY,KAC/B,MAAMuD,EArKV,WACE,MAAMC,EAAY3D,EAAE,iBACd4D,EAAuE,GAC7ED,EAAUnC,KAAK,WACb,MAAMC,EAAOzB,EAAE/I,MACT3B,EAAUmM,EAAKvI,KAAK,qBAAqBwI,MAC3CpM,GACFsO,EAAUtM,KAAK,CACbhC,UACAC,MAAQkM,EAAKvI,KAAK,mBAAmBwI,OAAoB,IACzDlM,YAAciM,EAAKvI,KAAK,yBAAyBwI,OAAoB,IAG3E,GAEA,MAAMmC,GAAe7D,EAAE,mBAAmB0B,OAAoB,IAAIpG,OAC5DwI,GAAiB9D,EAAE,qBAAqB0B,OAAoB,IAAIpG,OAChEyI,GAAqB/D,EAAE,yBAAyB0B,OAAoB,IAAIpG,OAE9E,MAAO,CACL3H,eAAgB+G,SAASsF,EAAE,sBAAsB0B,QAAoB,GACrE1N,eAAgB0G,SAASsF,EAAE,sBAAsB0B,QAAoB,GACrEzN,uBAAwByG,SAASsF,EAAE,8BAA8B0B,QAAoB,IACrFxN,kBAAmB8L,EAAE,yBAAyBM,GAAG,YACjDlM,oBAAqB4L,EAAE,2BAA2BM,GAAG,YACrD1K,iBAAkBoK,EAAE,wBAAwBM,GAAG,YAC/CjM,mBAAoBqG,SAASsF,EAAE,0BAA0B0B,QAAoB,KAC7EpN,qBAAsBoG,SAASsF,EAAE,4BAA4B0B,QAAoB,KACjFhN,yBAA0BgG,SAASsF,EAAE,wBAAwB0B,QAAoB,IACjF/M,mBAAoB+F,SAASsF,EAAE,0BAA0B0B,QAAoB,IAC7E9M,cAAe8F,SAASsF,EAAE,qBAAqB0B,QAAoB,EACnEnN,cAAemG,SAASsF,EAAE,qBAAqB0B,QAAoB,EACnE7M,WAAY6F,SAASsF,EAAE,kBAAkB0B,QAAoB,EAC7DjM,aAAc4L,IACdxL,aAAcmK,EAAE,oBAAoBM,GAAG,YACvCxK,oBAAsBkK,EAAE,0BAA0B0B,OAAoB,IAAIpG,OAC1EvG,WAAY,CACVC,OAASgL,EAAE,sBAAsB0B,OAAoB,GACrDxM,IAAM8K,EAAE,sBAAsB0B,OAAoB,GAClDvM,MAAQ6K,EAAE,wBAAwB0B,OAAoB,GACtDtM,OAAS4K,EAAE,yBAAyB0B,OAAoB,UAE1D3L,eAAgB,CACdC,oBAAqB6N,IAAe1L,EAA4BmD,OAAS,GAAKuI,EAC9E5N,sBACE6N,IAAiB1L,EAA8BkD,OAAS,GAAKwI,EAC/D5N,+BACE6N,IAAqB1L,EAAuCiD,OAAS,GAAKyI,GAE9E1O,sBAAuBuO,EAE3B,CAkHwBI,GAGpBxN,EADe,IADKH,OACgBqN,IAEpCF,OAAOC,QAAQ,SACfH,MAIFtB,EAAS7B,GAAG,SAAU,uBAAwBtH,iBAC5C,MAAMoL,EAAWjE,EAAE/I,MAAMyK,MACzB,GAAIuC,EACF,UJldNpL,eAA2CJ,SAEnCyL,oBAAoB,UAAWzL,GAErCf,QAAQyM,IAAI,kBAAkB1L,IAChC,CI8cc2L,CAAqBH,GAC3BT,OAAOC,QAAQ,WAAWQ,IAC5B,OAAS/L,GACPsL,OAAO7L,MAAM,YAAYsM,KACzBvM,QAAQC,MAAM,kBAAmBO,EACnC,YAGMgM,oBAAoB,UAAW,IACrCV,OAAOa,KAAK,WAEhB,GAGArC,EAAS7B,GAAG,QAAS,uBAAwBtH,UAC3C,IACE,MAAMJ,QJrfZI,eAA6CJ,GAC3C,MAAM6L,EAAWC,0BACXxL,EAAgBN,GAAQ,GAAG6L,GAAY,aAY7C,OAVsB5L,oBACHC,SAASI,WACpByL,gBAAgBzL,EAAe,IACrCrB,QAAQyM,IAAI,kBAAkBpL,YAI1BmL,oBAAoB,UAAWnL,GAErCrB,QAAQyM,IAAI,kBAAkBpL,KACvBA,CACT,CIseyB0L,GAEbC,EAAU1E,EAAE,wBAEiD,IAA/D0E,EAAQxL,KAAK,iBAAiB6H,EAAWtI,QAAWjB,QACtDkN,EAAQhE,OAAO,kBAAkBK,EAAWtI,OAAUsI,EAAWtI,eAEnEiM,EAAQhD,IAAIjJ,GACZ+K,OAAOC,QAAQ,cAAchL,IAC/B,OAASP,GACPsL,OAAO7L,MAAM,WACbD,QAAQC,MAAM,kBAAmBO,EACnC,IAIF8J,EAAS7B,GAAG,QAAS,kBAAmB,KACtC,MAAMb,EAASxE,mBACXwE,GAAU,GACZ1I,EAAUM,QAAQ,CAAElF,KAAM,eAAgBP,WAAY6N,IACtDkE,OAAOa,KAAK,QAAQ/E,iBAEpBkE,OAAOmB,QAAQ,cAKnB3C,EAAS7B,GAAG,QAAS,oBAAqB,KACxCvJ,EAAUM,QAAQ,CAAElF,KAAM,mBAC1BwR,OAAOa,KAAK,iBAIdrC,EAAS7B,GAAG,QAAS,sBAAuBtH,UAC1C,MAAMpC,EAAOJ,IACPiJ,EAASxE,mBAET8J,EAAUnO,EAAK7B,cACrB,GAAIgQ,EAAUtF,EAEZ,YADAkE,OAAOmB,QAAQ,sBAIjB,MAAME,EAASvM,IACf,GAAKuM,EAAL,CAKArB,OAAOa,KAAK,eACZ,IACE,MAAM5K,QAAWR,aAAa4L,GACxBC,qBAAqBzK,IAC3B,IAAA,MAAWrB,KAASS,EAAI,CACtB,MAAMgB,EAAQzB,EAAMP,KAAKgC,MAAM,qBAC3BA,GACFqK,EAAetK,IAAIE,SAASD,EAAM,IAEtC,CAEA,IAAIsK,EAAQ,EACZ,MAAMC,EAAOxI,gBAAgB,GAAGoI,KAAWtF,KAC3C,IAAA,MAAWD,KAAO2F,EAEC,SAAb3F,EAAIvF,MAAgC,WAAbuF,EAAIvF,OAE1BgL,EAAenK,IAAI0E,EAAI5N,cAC1BmF,EAAUM,QAAQ,CAAElF,KAAM,eAAgBP,WAAY4N,EAAI5N,aAC1DsT,MAIAA,EAAQ,GACVnO,EAAUM,QAAQ,CAAElF,KAAM,mBAC1BwR,OAAOC,QAAQ,OAAOsB,iCAEtBvB,OAAOa,KAAK,oBAEhB,OAASnM,GACPsL,OAAO7L,MAAM,kBACbD,QAAQC,MAAM,mBAAoBO,EACpC,CAlCA,MAFEsL,OAAOmB,QAAQ,uBAwCnB3C,EAAS7B,GAAG,QAAS,mBAAoBtH,UACvC,MAAMoM,GAAWjF,EAAE,sBAAsB0B,OAAoB,IAAIpG,OAC3D4J,GAAWlF,EAAE,sBAAsB0B,OAAoB,IAAIpG,OAEjE,IAAK2J,EAEH,YADAzB,OAAOmB,QAAQ,gBAIjB,MAAMQ,EAAOnF,EAAE,oBACfmF,EAAKC,KAAK,YAAY,GAAM/J,KAAK,UAEjC,IAEE,MAAMgK,EAAUJ,EAAOnH,QAAQ,OAAQ,IACjCwH,EAAOD,EAAQE,SAAS,OAC1B,CAAC,GAAGF,YACJ,CAAC,GAAGA,cAAqB,GAAGA,YAEhC,IAAIG,EAAmB,GACvB,IAAA,MAAWC,KAAOH,EAChB,IACE,MAAMI,EAAkC,CAAE,eAAgB,oBACtDR,IAAQQ,EAAuB,cAAI,UAAUR,KAEjD,MAAMS,QAAaC,MAAMH,EAAK,CAAEI,OAAQ,MAAOH,YAC/C,IAAKC,EAAKG,GAAI,SAEd,MAAMC,QAAaJ,EAAKI,OACxB,GAAIA,EAAKtP,MAAQuP,MAAMC,QAAQF,EAAKtP,MAAO,CACzC+O,EAASO,EAAKtP,KACXwF,IAAKiK,GAAWA,EAAE3L,IAAM2L,EAAEzN,MAAQ,IAClCrB,OAAQmD,GAAeA,GACvB2B,OACH,KACF,CACF,CAAA,MAEA,CAGF,GAAsB,IAAlBsJ,EAAOhO,OAET,YADAgM,OAAOmB,QAAQ,8BAKjB,MAAMwB,EAAYnG,EAAE,sBACpBmG,EAAUC,QACV,IAAA,MAAWjR,KAASqQ,EAClBW,EAAUzF,OAAO,kBAAkBK,EAAW5L,QAGhDqO,OAAOC,QAAQ,OAAO+B,EAAOhO,cAG7BwI,EAAE,wBAAwBO,QAAQ,QACpC,OAASrI,GACPsL,OAAO7L,MAAM,YACbD,QAAQC,MAAM,mBAAoBO,EACpC,CAAA,QACEiN,EAAKC,KAAK,YAAY,GAAO/J,KAAK,OACpC,IAIF,IAAIgL,EAAa5P,EAAKpB,sBAAsBmC,OAC5CwK,EAAS7B,GAAG,QAAS,gBAAiB,KACpC,MAAMmG,EAASpF,EAAkB,CAAE5L,QAAS,GAAIC,MAAO,IAAKC,YAAa,IAAM6Q,KAC/ErG,EAAE,kBAAkBU,OAAO4F,KAI7BtE,EAAS7B,GAAG,QAAS,mBAAoB,WACvCH,EAAE/I,MAAMsP,QAAQ,iBAAiBtG,QACnC,GAGA,IAAIuG,EAAkB/P,EAAKhB,aAAa+B,OACxCwK,EAAS7B,GAAG,QAAS,sBAAuB,KAC1C,MAAMmG,EAAStF,EAAuB,CAAEtL,UAAW,GAAIC,QAAS,IAAM6Q,KACtExG,EAAE,yBAAyBU,OAAO4F,KAIpCtE,EAAS7B,GAAG,QAAS,yBAA0B,WAC7CH,EAAE/I,MAAMsP,QAAQ,uBAAuBtG,QACzC,GAGA+B,EAAS7B,GAAG,QAASjI,IACfA,EAAEuO,SAAWzE,EAAS,IACxBsB,KAGN,CCrrBA1M,EAAUI,YAAY,CACpBY,aJwKFiB,eAAwCpH,GAEtC,IAAK+G,IAEH,YADAd,QAAQ4B,KAAK,yBAKf,MAAMkF,QAAgB1C,EAA2BrK,SD3DnDoH,eAA6CpH,EAAoB2H,GAC/D,MAAML,EAAgBT,IACtB,IAAKS,IAAkBP,IAErB,YADAd,QAAQ4B,KAAK,yBAIf,MAAMK,EAAY,UAAUlI,KAI5B,UAHwBwH,aAAaF,IACVG,KAAKhB,GAAKA,EAAEO,OAASkB,SAIxCH,oBAAoBT,EAAeU,IACvC,MAAMT,EAAQS,EAAGP,KAAKhB,GAAKA,EAAEO,OAASkB,GAItC,OAHIX,IACFA,EAAMI,QAAUA,GAEXK,QAEJ,CAEL,MAAM3B,EAAWnB,UACXiD,uBAAuBb,EAAe,CAC1C,IACKlH,EACH4G,KAAMkB,EACNP,UACAS,SAAU,CACR7H,KAAM,WACN8H,KAAM,SACNC,MAAOjC,EAASzD,mBAChB2F,MAAOxI,EAAoBC,EAAYqG,EAASpD,6BAIxD,CACF,CCyBQgS,CAAuBjV,EAAY+M,GAGzC,MAAMmI,QAAa7N,IACnB6N,EAAKtT,0BAA4B5B,QAC3B4H,EAAasN,EACrB,EIxLE9O,eJyPFgB,iBAEE,IAAKL,IAEH,YADAd,QAAQ4B,KAAK,yBAIf,MAAMqN,QAAa7N,IACbuF,QAA0BpE,IAEhC,GAAiC,IAA7BoE,EAAkB7G,OAAc,OAIpC,WAD4B4G,KACR,OAGpB,MAAMwI,EAAMvI,EACTpC,OAASvB,SAASxC,EAAEO,KAAKgC,MAAM,WAAY,KAC3CyB,KAAK,CAACC,EAAGC,IAAMD,EAAIC,GAEtB,IAAIyK,EAAWD,EAAI,GACfE,EAASF,EAAIA,EAAIpP,OAAS,GAG9B,MAAM4B,QAAgBuF,EAA6BN,GAG7C5D,EAAQrB,EAAQqB,MAAM,mBAC5B,GAAIA,EAAO,CACT,MAAMsM,EAAcrM,SAASD,EAAM,IAC7BuM,EAAYtM,SAASD,EAAM,IAC7BsM,GAAeC,GACjBH,EAAWE,EACXD,EAASE,GAETtP,QAAQ4B,KACN,qBAAqByN,OAAiBC,eAG5C,MACEtP,QAAQ4B,KAAK,mCAIf,MAAM2N,EAAe7N,EAAQ0E,QAAQ,qBAAsB,IAAIxC,aDzCjEzC,eACEjH,EACAiV,EACAC,EACA1N,GAEA,MAAML,EAAgBT,IACtB,IAAKS,IAAkBP,IAErB,YADAd,QAAQ4B,KAAK,yBAIf,MAAMK,EAAY,KAAK/H,OAAYiV,OAAcC,WAE3CtN,oBAAoBT,EAAemB,IAEvC,IAAA,MAAWlB,KAASkB,EAAW,CAC7B,MAAMO,EAAQzB,EAAMP,KAAKgC,MAAM,qBAC/B,IAAKA,EAAO,SACZ,MAAMF,EAAKG,SAASD,EAAM,IACtBF,GAAMsM,GAAYtM,GAAMuM,IAC1B9N,EAAMlH,SAAU,EAEpB,CAGA,MAAMgG,EAAWnB,IAcjB,OAbAuD,EAAU5C,KAAK,IACVzF,EACHC,SAAS,EACT2G,KAAMkB,EACNP,UACAS,SAAU,CACR7H,KAAM,WACN8H,KAAM,SACNC,MAAOjC,EAASxD,qBAChB0F,MAAOrI,EAAeC,EAAQkG,EAASnD,uBAIpCuF,IAIT,MAAMyM,QAAa7N,IACnB6N,EAAK1T,eAAiBrB,EAAS,EAC/B+U,EAAKrT,QAAQgE,KAAK,CAAE1F,SAAQ4B,iBAAkBqT,EAAUpT,eAAgBqT,UAClEzN,EAAasN,EACrB,CCJQO,CAAkBP,EAAK1T,eAAgB4T,EAAUC,EAAQG,GAE/DvP,QAAQyM,IAAI,cAAcwC,EAAK1T,qBAAqB4T,OAAcC,IACpE,II1SA9G,EAAE,KACA,WACE,IAEgB3J,IACdqB,QAAQyM,IAAI,kBAGZrE,IHqDGqH,QACLC,cAAcC,iBACdC,aAAc7V,IACP2N,EAAkB3N,MG/E7B,WACE,IAAI8V,EAAUC,YAAYC,mBACnBN,QAAQC,cAAcM,aAAeC,IACtCJ,IAAYI,IACdJ,EAAUI,EACVvF,OAAOwF,SAASC,WAGtB,CAqBMC,GAGA,MAAMxD,EAAWC,0BACXwD,EAASP,YAAYC,mBAC3B,IAAKnD,IAAayD,EAEhB,YADArQ,QAAQyM,IAAI,gCAGdzM,QAAQyM,IAAI,iBAAiBG,KAGzB9L,WLYVK,iBACE,MAAME,EAAgBT,IACtB,IAAKS,IAAkBP,IAAmB,OAK1C,WAHwBS,aAAaF,IACVG,KAAKhB,GAAKA,EAAEO,OAASG,GAEjC,CACb,MAAMoP,EAAclV,EAASsD,MAAM,UAC7BwD,uBAAuBb,EAAe,CAC1C,IACKlH,EACHC,SAAS,EACT2G,KAAMG,EACNQ,QAASD,KAAKI,UAAUyO,MAG5BtQ,QAAQyM,IAAI,0BACd,CACF,CK9Bc8D,SACArN,KAENlD,QAAQyM,IAAI,iCAGdzM,QAAQyM,IAAI,eACd,OAASjM,GACPR,QAAQC,MAAM,gBAAiBO,EACjC,CACF,EApCA"}