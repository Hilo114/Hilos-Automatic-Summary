# Hilo's Automatic Summary

一个运行在 [SillyTavern](https://docs.sillytavern.app/)（酒馆）中的 [酒馆助手](https://n0vi028.github.io/JS-Slash-Runner-Doc/) 脚本，在角色扮演聊天过程中**自动生成消息总结**，并将总结以世界书条目的形式注入到 AI 提示词上下文中，从而在长对话中保留关键剧情信息。

## ✨ 功能特性

- **两级总结体系**
  - **小总结**：每条 AI 回复后自动异步生成简短摘要（≤ 200 字），附带前 2 条小总结作为上下文
  - **大总结（卷总结）**：当小总结累积到一定量时，自动合并为一卷完整叙事（≤ 1000 字）
- **智能触发**
  - 每 N 个小总结自动检查一次大总结条件（可配置）
  - 大总结触发条件：token 数超过阈值 **或** AI 判断当前剧情到达自然段落结尾
- **楼层可见性管理**：自动隐藏旧楼层，仅保留最近 N 楼可见，已总结的旧楼层通过世界书条目注入上下文
- **角色卡隔离**：每个角色卡拥有独立的 `{角色卡名}[自动总结]` 世界书，切换角色卡时自动切换
- **自定义 API**：支持配置独立的 API（URL / Key / 模型）用于总结请求，失败时自动降级到酒馆当前 API
- **消息清洗**：支持自定义正则表达式清洗消息内容（如去除 OOC 标记、状态栏代码块等）
- **任务队列**：所有总结任务串行处理，避免并发冲突，同一楼层的重复任务自动去重
- **设置 UI**：通过酒馆扩展菜单打开设置弹窗，支持手动触发总结和归档

## 📦 安装

### 前置要求

- [SillyTavern](https://docs.sillytavern.app/) 酒馆
- [酒馆助手 (Tavern Helper)](https://n0vi028.github.io/JS-Slash-Runner-Doc/) 插件
- Node.js ≥ 22
- pnpm

### 构建

```bash
# 安装依赖
pnpm install

# 开发模式（监听文件变化自动重新构建）
pnpm dev

# 生产构建
pnpm build
```

构建产物位于 `dist/` 目录，将生成的脚本文件导入到酒馆助手中即可使用。

## ⚙️ 配置说明

所有设置项均可通过酒馆扩展菜单中的 **"自动总结"** 入口打开设置弹窗进行配置。

### 基本设置

| 设置项 | 默认值 | 说明 |
|--------|--------|------|
| 显示楼层数 | 20 | 最近保留多少楼可见 |
| 检查间隔 | 20 | 每多少个小总结触发一次大总结检查 |
| Token 阈值 | 8000 | 大总结触发的 token 阈值 |
| 自动小总结 | ✅ | 是否自动生成小总结 |
| 自动大总结 | ✅ | 是否自动生成大总结 |
| 小总结注入深度 | 9999 | 小总结世界书条目的 `at_depth` 值 |
| 卷总结注入深度 | 9999 | 卷总结世界书条目的 `at_depth` 值 |
| 小总结起始排序 | 10000 | 小总结条目的 order 基数 |
| 卷总结起始排序 | 100 | 卷总结条目的 order 基数 |
| 忽略前 N 层 | 0 | 跳过前多少层消息不进行总结 |

### 自定义 API

| 设置项 | 说明 |
|--------|------|
| 启用自定义 API | 不启用则使用酒馆当前 API |
| API URL | 自定义 API 地址 |
| API Key | API 密钥 |
| 模型名称 | 如 `gpt-4` |
| API 源 | 目前支持 `openai` |

### 消息清洗正则

支持添加多条正则规则，每条规则包含：
- **pattern**：正则表达式模式
- **flags**：正则标志（默认 `g`）
- **replacement**：替换文本（默认为空，即删除匹配内容）

### 手动操作

- **手动总结**：将最新楼层的小总结任务加入队列
- **手动归档**：将大总结任务加入队列

## 🏗️ 项目架构

```
src/
├── index.ts          # 脚本入口：初始化流程 + 事件监听 + 聊天变更重载
├── config.ts         # 设置和元数据：Zod schema + 脚本变量读写
├── trigger.ts        # 触发器：MESSAGE_RECEIVED 事件监听与调度
├── queue.ts          # 任务队列：串行处理总结任务
├── summary.ts        # 总结核心逻辑：消息清洗 + AI 生成
├── prompts.ts        # AI 提示词模板
├── worldbook.ts      # 世界书操作：条目 CRUD + enabled 同步
├── chat-manager.ts   # 聊天楼层管理：隐藏/显示控制
└── ui.ts             # 设置 UI 弹窗
```

### 数据流

#### 自动小总结

```
AI 回复到达 → MESSAGE_RECEIVED
  ├─ [同步] 创建占位世界书条目
  ├─ [同步] 同步所有小总结 enabled 状态
  ├─ [同步] 隐藏旧楼层、显示最近 N 楼
  └─ [异步] 入队小总结任务 → AI 生成摘要 → 写入世界书条目
```

#### 自动大总结

```
小总结计数达到检查间隔
  → 入队大总结任务
    → 检查触发条件（token 阈值 / AI 判断段落结尾）
      → 合并小总结生成卷总结
        → 创建卷条目 + 关闭对应小总结 + 更新元数据
```

### 世界书注入示意

AI 请求发送时，只有 `enabled: true` 的条目被注入：

```
[系统提示]
[卷1-楼层1~楼层30]       ← enabled: true,  order 101
[卷2-楼层31~楼层58]      ← enabled: true,  order 102
[小总结-楼层59]          ← enabled: true,  order 10059 (已隐藏未归档)
[小总结-楼层60]          ← enabled: true,  order 10060 (已隐藏未归档)
...
[正常聊天历史]            ← 最近 N 楼可见
[最新消息]
```

## 📄 许可证

[MIT](LICENSE) © 2025 Hilo114