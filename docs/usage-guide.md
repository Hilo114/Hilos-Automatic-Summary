# Hilo's Automatic Summary — 用户使用指南

## 简介

**Hilo's Automatic Summary** 是一个运行在 [SillyTavern（酒馆）](https://docs.sillytavern.app/) 中的 [酒馆助手](https://n0vi028.github.io/JS-Slash-Runner-Doc/) 脚本。它能在角色扮演聊天过程中**自动生成消息总结**，并将总结以世界书条目的形式注入到 AI 提示词中，从而在长对话中帮助 AI 保留关键剧情信息。

### 它解决了什么问题？

在酒馆的长对话中，随着楼层不断增加，早期的聊天记录会因为上下文窗口限制而被截断，导致 AI "遗忘" 之前的剧情。本脚本通过两级总结机制，自动将旧对话压缩为摘要注入提示词，让 AI 始终能感知历史剧情。

---

## 前置要求

| 组件 | 说明 |
|------|------|
| [SillyTavern](https://docs.sillytavern.app/) | 酒馆本体 |
| [酒馆助手 (Tavern Helper)](https://n0vi028.github.io/JS-Slash-Runner-Doc/) | 酒馆插件，用于运行脚本 |
| 可用的 AI API | 用于生成总结（可使用酒馆当前 API 或自定义独立 API） |

---

## 安装

### 方式一：从构建产物导入

1. 获取构建好的 `dist/` 目录下的脚本文件
2. 在酒馆中打开 **酒馆助手 → 脚本库**
3. 导入脚本文件

### 方式二：自行构建

```bash
# 克隆项目
git clone <项目地址>
cd Hilos-Automatic-Summary

# 安装依赖（需要 Node.js ≥ 22 和 pnpm）
pnpm install

# 生产构建
pnpm build

# 或开发模式（监听文件变化自动重新构建）
pnpm dev
```

构建产物位于 `dist/` 目录，将生成的脚本文件导入到酒馆助手中即可。

---

## 快速上手

### 第一步：打开角色卡

脚本需要在打开某个角色卡的聊天中才会运行。如果未打开角色卡，脚本不会执行任何操作。

### 第二步：创建并绑定世界书

1. 点击左下角的 **扩展按钮(魔术棒)**
2. 点击菜单中的 **「自动总结」** 条目，打开设置弹窗
3. 在 **「世界书管理」** 区域：
   - 点击 **「一键创建」** 按钮 — 将自动创建一个名为 `{角色卡名}[自动总结]` 的世界书并绑定到当前聊天
   - 或从下拉框中选择一个已有的世界书进行绑定

> **提示**：每个角色卡/聊天可以绑定不同的总结世界书，切换聊天时脚本会自动重载。

### 第三步：开始聊天

绑定世界书后，脚本将自动工作：

- 每当 AI 回复一条消息，脚本会在后台自动生成该条消息的 **小总结**
- 当小总结累积到一定数量，脚本会自动检查是否需要生成 **大总结（卷总结）**
- 旧楼层会被自动隐藏，总结内容通过世界书条目注入 AI 提示词

**你无需做任何额外操作，一切都是自动的。**

---

## 工作原理

### 两级总结体系

```
聊天消息 ──→ 小总结（每条消息一个摘要，≤200 字）
                │
                ├── 累积到一定量后 ──→ 大总结（合并为一卷叙事，≤2000 字）
                │
                └── 已被大总结覆盖的小总结会被关闭
```

| 级别 | 名称 | 粒度 | 存储位置 |
|------|------|------|----------|
| 一级 | **小总结** | 每条消息 → 一条简短摘要 | 世界书条目 `[小总结-楼层N]` |
| 二级 | **大总结** | 多条小总结 → 一卷完整叙事 | 世界书条目 `[卷N-楼层M~楼层K]` |

### 楼层可见性管理

脚本会自动管理聊天楼层的显示/隐藏状态：

- **最近 N 楼**（可配置）保持可见，消息本身在 AI 上下文中
- **更早的楼层** 被隐藏，对应的小总结条目被启用（`enabled: true`），通过世界书注入 AI 上下文
- **已被大总结归档的楼层** 对应的小总结被关闭，由卷总结替代

### AI 上下文中的注入效果

```
[系统提示]
[卷1-楼层1~楼层30]       ← 大总结，始终启用
[卷2-楼层31~楼层58]       ← 大总结，始终启用
[小总结-楼层59]           ← 已隐藏但未归档，启用注入
[小总结-楼层60]           ← 已隐藏但未归档，启用注入
...
[正常聊天历史]            ← 最近 N 楼，直接可见
[最新消息]
```

### 大总结触发条件

当以下任一条件满足时，会触发大总结：

1. **Token 阈值**：未归档的小总结内容总字数超过设定的阈值
2. **AI 判断**：AI 认为当前剧情到达了一个自然的段落结尾（如：一个章节结束、一个事件告一段落、场景大幅转换）

---

## 设置详解

通过酒馆扩展菜单中的 **「自动总结」** 打开设置弹窗。

### 世界书管理

| 操作 | 说明 |
|------|------|
| **当前世界书** 下拉框 | 选择要绑定到当前聊天的世界书，选择"（未绑定）"可解除绑定 |
| **一键创建** 按钮 | 自动创建名为 `{角色卡名}[自动总结]` 的世界书并绑定 |

### 基本设置

| 设置项 | 默认值 | 范围 | 说明 |
|--------|--------|------|------|
| **显示楼层数** | 10 | 1~100 | 最近保留多少楼可见。可见楼层的消息会直接出现在 AI 上下文中，不需要通过总结注入 |
| **检查间隔** | 20 | 5~100 | 每产生多少个小总结后，检查一次是否需要生成大总结 |
| **Token 阈值** | 8000 | 1000~50000 | 未归档的小总结总字数超过此值时，强制触发大总结 |
| **自动小总结** | ✅ 开启 | — | 关闭后 AI 回复时不再自动生成小总结 |
| **自动大总结** | ✅ 开启 | — | 关闭后不再自动检查和生成大总结 |
| **小总结注入深度** | 9999 | 0~99999 | 小总结世界书条目的 `at_depth` 值，决定在 AI 提示词中的位置。数值越大越靠前（靠近系统提示） |
| **卷总结注入深度** | 9999 | 0~99999 | 卷总结世界书条目的 `at_depth` 值 |
| **小总结起始排序** | 10000 | 0~99999 | 小总结条目的 `order` 基数。实际 order = 基数 + 楼层号 |
| **卷总结起始排序** | 100 | 0~99999 | 卷总结条目的 `order` 基数。实际 order = 基数 + 卷号 |
| **忽略前 N 层** | 2 | 0~1000 | 前 N 楼的消息不会生成小总结（通常用于跳过角色卡的开场白等固定内容） |

### 内容捕获标签

| 设置项 | 默认值 | 说明 |
|--------|--------|------|
| **起始标签** | （空） | 仅总结 `<起始标签>` 之后的内容 |
| **结束标签** | （空） | 仅总结 `<结束标签>` 之前的内容 |

**使用场景**：如果 AI 回复中包含状态栏、代码块等不需要总结的内容，可以通过设置捕获标签来仅提取需要总结的正文部分。

**示例**：假设 AI 回复的格式为：

```
<status>
HP: 100
MP: 50
</status>
<story>
白娅轻轻推开了门，一缕阳光洒进了房间...
</story>
```

设置起始标签为 `story`、结束标签为 `/story`，脚本就只会总结 `<story>` 标签之间的内容。

> 两个标签均留空则总结消息全部内容。

### 防合并标记

| 设置项 | 默认值 | 说明 |
|--------|--------|------|
| **防合并标记** | 关闭 | 是否在总结请求的提示词前添加防合并标记 |
| **标记内容** | `<\|no-trans\|>` | 自定义防合并标记文本 |

**使用场景**：如果你使用了 kemini 或 noass 等翻译/合并脚本，开启此选项可以防止总结请求的提示词被意外合并或翻译。

### API 配置

如果你希望使用独立的 API 来生成总结（而非使用酒馆当前连接的 API），可以在此配置：

| 设置项 | 说明 |
|--------|------|
| **API URL** | API 地址，如 `https://api.openai.com/v1`。留空则使用酒馆当前 API |
| **API Key** | API 密钥 |
| **模型** | 模型名称，如 `gpt-4o`、`claude-3-haiku-20240307` |
| **API 源** | 目前支持 `openai` 兼容格式 |

> **提示**：使用独立 API 的好处是可以选择更便宜/更快的模型来生成总结，不影响主对话的模型选择。

### 自定义提示词

展开 **「自定义提示词」** 折叠区域可以修改 AI 生成总结时使用的系统提示词：

| 提示词 | 用途 |
|--------|------|
| **小总结系统提示词** | 控制 AI 如何总结单条消息 |
| **大总结系统提示词** | 控制 AI 如何将多条小总结合并为卷总结 |
| **卷完结检测系统提示词** | 控制 AI 如何判断当前剧情是否到达段落结尾 |

- 修改提示词后点击保存即生效
- 如需恢复默认，清空提示词文本框并保存即可

### 消息清洗正则

展开 **「消息清洗正则」** 折叠区域可以添加自定义正则表达式，用于在总结前清洗消息内容：

| 字段 | 说明 |
|------|------|
| **正则** | 正则表达式模式（如 `\[OOC:.*?\]`） |
| **flags** | 正则标志（默认 `g`，即全局匹配） |
| **替换** | 替换文本（默认为空，即删除匹配内容） |

点击 **「+ 添加正则」** 添加新规则，点击行末的 **✕** 删除规则。

**常见用例**：

| 目的 | 正则模式 | flags | 替换 |
|------|----------|-------|------|
| 去除 OOC 标记 | `\[OOC:.*?\]` | `gs` | （空） |
| 去除代码块 | ````[\s\S]*?```` | `g` | （空） |
| 去除 HTML 标签 | `<[^>]+>` | `g` | （空） |

---

## 手动操作

设置弹窗中提供了三个手动操作按钮：

### 手动总结

将当前最新楼层的小总结任务加入处理队列。适用场景：

- 关闭了自动小总结后，手动为特定消息生成总结
- 某条消息的自动总结失败，需要重新生成

### 手动归档

将大总结任务加入处理队列。适用场景：

- 关闭了自动大总结后，手动触发卷归档
- 想要在特定的剧情节点手动归档

### 手动补全

检查从"忽略前 N 层"设置的起始楼层到最新楼层之间，有哪些楼层缺少小总结条目，并将缺失的全部加入处理队列，最后追加一个大总结任务。适用场景：

- 脚本中途安装，需要为之前的聊天记录补全总结
- 部分楼层的总结因错误而缺失，需要批量补全

---

## 常见问题

### Q: 脚本安装后没有任何反应？

1. 确认已安装并启用 **酒馆助手** 插件
2. 确认已打开某个角色卡的聊天（未打开角色卡时脚本不会执行）
3. 在设置弹窗中检查是否已绑定世界书（点击「一键创建」或选择已有世界书）
4. 检查浏览器控制台（F12）是否有 `[自动总结]` 开头的日志或错误信息

### Q: 总结没有被注入到 AI 上下文中？

1. 打开世界书检查条目的 `enabled` 状态
2. 确认小总结条目的 `content` 不是"（总结生成中...）"（如果是，说明 AI 生成还未完成或失败）
3. 检查注入深度（`at_depth`）设置是否合理
4. 最近 N 楼（可见楼层数范围内）的小总结不会被启用，这是正常行为

### Q: AI 生成总结失败？

1. 检查浏览器控制台的错误信息
2. 如果使用自定义 API，确认 API URL、Key、模型名称是否正确
3. 如果使用酒馆当前 API，确认酒馆的 API 连接是否正常
4. 可以尝试点击「手动总结」按钮重新生成

### Q: 如何完全重置脚本数据？

1. 在设置弹窗中点击 **「重置默认」** 按钮可重置所有用户设置
2. 如需清除总结数据，可以手动删除世界书中的 `[小总结-楼层N]` 和 `[卷N-楼层M~楼层K]` 条目
3. 世界书中的 `[data]` 条目存储了运行时元数据（当前卷号、已归档信息等），删除后会自动重新创建

### Q: 切换角色卡/聊天后总结数据会混淆吗？

不会。每个角色卡的聊天可以绑定独立的总结世界书，切换聊天时脚本会自动重载，使用对应的世界书。

### Q: 可以在同一个聊天中使用多个世界书吗？

脚本使用聊天绑定的世界书（chat worldbook）来存储总结数据，每个聊天只能绑定一个总结世界书。但这不影响你使用其他全局世界书或角色卡世界书。

### Q: 小总结和大总结条目在世界书中是什么样的？

打开世界书可以看到类似如下的条目：

- `[小总结-楼层5]` — 第 5 楼消息的摘要
- `[小总结-楼层6]` — 第 6 楼消息的摘要
- `[卷1-楼层2~楼层30]` — 第 1 卷大总结，覆盖楼层 2 到 30
- `[data]` — 运行时元数据（当前卷号、已归档记录等），请勿手动修改

### Q: order 值是什么意思？

`order` 决定了世界书条目在 AI 提示词中的排列顺序。数值越小越靠前。默认配置下：

- 卷总结 order = 100 + 卷号（如卷 1 = 101，卷 2 = 102）
- 小总结 order = 10000 + 楼层号（如楼层 5 = 10005，楼层 6 = 10006）

这确保了卷总结始终在小总结之前，且同类条目按时间顺序排列。

---

## 进阶技巧

### 使用独立的廉价模型生成总结

总结任务不需要最强的模型，你可以配置一个独立的廉价/快速模型来处理总结，节省主对话模型的 token 消耗：

1. 在设置弹窗的 **「API 配置」** 区域填入独立 API 的地址和密钥
2. 选择一个性价比高的模型（如 `gpt-4o-mini`、`claude-3-haiku` 等）

### 微调总结质量

通过自定义提示词可以让总结更符合你的需求：

- **更短的总结**：在小总结提示词中减小字数限制
- **保留特定信息**：在提示词中强调需要保留的信息类型（如"务必保留所有角色的情感变化"）
- **更精确的卷断点**：调整卷完结检测提示词中的判断标准

### 处理包含特殊格式的消息

如果 AI 回复中包含状态栏、代码块等结构化内容：

1. 使用 **内容捕获标签** 仅提取正文部分进行总结
2. 使用 **消息清洗正则** 去除不需要的格式标记
3. 两者可以组合使用：先通过标签提取内容，再通过正则进一步清洗

---

## 许可证

[MIT](../LICENSE) © 2025 Hilo114